<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IDEAS TEXTILES SPA</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:ital,wght@1,400&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --corp-dark: #0f172a; --corp-gray: #334155; --gold: #d97706; --bg: #f8fafc; --card-bg: #ffffff;
            --danger: #ef4444; --success: #10b981; --prod: #7c3aed;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea, select { user-select: text; font-family: 'Inter', sans-serif; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--corp-dark); margin: 0; padding: 0; padding-bottom: 120px; padding-top: env(safe-area-inset-top); height: 100vh; overflow-y: scroll; overscroll-behavior-y: none; }

        /* HEADER */
        header { background: var(--corp-dark); color: white; padding: 20px 20px 30px 20px; position: sticky; top: 0; z-index: 100; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15); }
        .corp-title { font-size: 1.4rem; font-weight: 800; margin: 0; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .corp-subtitle { font-family: 'Playfair Display', serif; font-style: italic; font-size: 0.85rem; color: #94a3b8; margin-top: 4px; text-align: center; }
        .import-btn { position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.1); width: 35px; height: 35px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* UI ELEMENTS */
        .view { display: none; padding: 20px; max-width: 600px; margin: 0 auto; animation: fadeUp 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .card { background: var(--card-bg); border-radius: 16px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; position: relative; }
        .sku-badge { font-family: 'JetBrains Mono', monospace; background: var(--corp-dark); color: var(--gold); padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; }

        .qs-tag { background: #f1f5f9; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; color: var(--corp-gray); display: inline-flex; align-items: center; gap: 8px; border: 1px solid #cbd5e1; margin: 2px; }
        .qs-btn { width: 22px; height: 22px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .qs-minus { background: #e2e8f0; } .qs-plus { background: var(--corp-dark); color: white; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 10px; }
        .btn-pri { background: var(--corp-dark); color: white; }
        .btn-sec { background: white; border: 1px solid #cbd5e1; color: var(--corp-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-prod { background: var(--prod); color: white; }
        .btn-disabled { background: #cbd5e1; color: #94a3b8; cursor: not-allowed; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;}

        .search-bar { width:100%; padding:16px; border-radius:12px; border:1px solid #cbd5e1; margin-bottom:20px; background: white; font-size: 1rem; }
        
        /* CHECKBOX Y TOOLBAR MASIVO */
        .chk-bulk { transform: scale(1.4); margin-right: 12px; accent-color: var(--corp-dark); cursor: pointer; }
        .bulk-toolbar { background: var(--gold); color: white; padding: 12px 20px; border-radius: 12px; margin-bottom: 20px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(217, 119, 6, 0.3); animation: fadeUp 0.2s; }
        .bulk-toolbar.visible { display: flex; }

        /* ITEM STATUS PILLS (NUEVO) */
        .ist-pill { font-size: 0.65rem; padding: 2px 5px; border-radius: 4px; font-weight: 800; margin-left: 6px; text-transform: uppercase; }
        .ist-ok { background: #dcfce7; color: #15803d; }
        .ist-no { background: #fee2e2; color: #b91c1c; }
        .ist-pend { background: #fef9c3; color: #a16207; }

        /* FABRICA */
        .toggle-fabrica { display: flex; background: #e2e8f0; border-radius: 12px; padding: 4px; margin-bottom: 20px; }
        .toggle-fabrica button { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 10px; font-weight: 600; color: var(--corp-gray); }
        .toggle-fabrica button.active { background: white; color: var(--corp-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .toggle-fabrica button.active-prod { background: var(--prod); color: white; }
        .prod-bar { height: 6px; background: #e2e8f0; border-radius: 3px; margin: 12px 0; overflow: hidden; }
        .prod-fill { height: 100%; background: var(--prod); transition: width 0.4s ease; }

        /* DOCK */
        .dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px); padding: 18px 40px; border-radius: 50px; display: flex; gap: 45px; box-shadow: 0 15px 40px rgba(0,0,0,0.25); z-index: 999; border: 1px solid rgba(255,255,255,0.1); }
        .dock i { font-size: 1.4rem; color: #94a3b8; transition: 0.3s; cursor: pointer; }
        .dock i.active { color: white; transform: translateY(-6px); text-shadow: 0 0 15px rgba(255,255,255,0.5); }

        /* CALENDARIO */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; }
        .day { aspect-ratio: 1; border: 1px solid #f1f5f9; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border-radius: 10px; font-size: 0.9rem; position: relative; font-weight: 600; color: var(--corp-gray); }
        .day.current { border: 2px solid var(--corp-dark); background: #f8fafc; }
        .dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 4px; background: var(--gold); }
        
        #loader { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:2000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #cbd5e1; border-top: 4px solid var(--corp-dark); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p style="margin-top:20px; font-weight:700; color:var(--corp-gray); font-size: 0.8rem;">CARGANDO SISTEMA...</p></div>

<header>
    <div class="corp-brand">
        <h1 class="corp-title"><i class="fa-solid fa-scissors" style="color:var(--gold); transform:rotate(-45deg);"></i> IDEAS TEXTILES SPA</h1>
        <div class="corp-subtitle">Workwear & Corporate</div>
    </div>
    <div class="import-btn" onclick="App.IA.trigger()"><i class="fa-solid fa-cloud-arrow-up"></i></div>
</header>

<section id="v-bodega" class="view active">
    <div class="toggle-fabrica">
        <button id="tab-stock" class="active" onclick="App.UI.toggleFabrica('stock')">üì¶ BODEGA</button>
        <button id="tab-fabrica" onclick="App.UI.toggleFabrica('fabrica')">üè≠ F√ÅBRICA <span id="fab-badge" style="background:rgba(0,0,0,0.1);padding:2px 6px;border-radius:10px;font-size:0.7em;">0</span></button>
    </div>

    <div id="sub-stock">
        <input type="text" id="search-inv" class="search-bar" placeholder="üîç Buscar SKU o Nombre..." oninput="App.Render.bodega()">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn btn-pri" style="margin:0;" onclick="App.Actions.modalProd()">+ ITEM</button>
            <button class="btn btn-sec" style="margin:0; color:var(--gold); border-color:var(--gold);" onclick="App.Actions.tachaManual()">üìÑ SALIDA LIBRE</button>
        </div>
        <div id="list-bodega" style="margin-top:20px;"></div>
    </div>

    <div id="sub-fabrica" style="display:none;">
        <div style="text-align:center; padding:15px; border:1px dashed #cbd5e1; background:#fff; margin-bottom:15px; border-radius:12px; font-size:0.8rem;">Control de Producci√≥n en curso.</div>
        <div id="list-fabrica"></div>
    </div>
</section>

<section id="v-ordenes" class="view">
    <h2 style="margin:0 0 20px; font-size:1.3rem; font-weight:800; color:var(--corp-dark);">PEDIDOS ACTIVOS</h2>
    <button class="btn btn-pri" onclick="App.Actions.modalOrder()"><i class="fa-solid fa-cart-plus"></i> NUEVA OC DE VENTA</button>
    
    <div style="margin-top:20px;">
        <div id="bulk-tools" class="bulk-toolbar">
            <span style="font-weight:700; font-size:0.9rem;"><i class="fa-solid fa-check-double"></i> <span id="sel-count">0</span> Seleccionados</span>
            <button onclick="App.Actions.printBulk()" style="background:white; color:var(--gold); border:none; padding:6px 14px; border-radius:8px; font-weight:800; font-size:0.8rem; cursor:pointer;">üñ®Ô∏è IMPRIMIR PACK 4</button>
        </div>
        <div id="list-ordenes"></div>
    </div>
</section>

<section id="v-agenda" class="view">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button onclick="App.Calendar.move(-1)" style="border:none; background:none; font-size:1.2rem;">‚óÄ</button>
            <span id="cal-title" style="font-weight:800; color:var(--corp-dark);">MES A√ëO</span>
            <button onclick="App.Calendar.move(1)" style="border:none; background:none; font-size:1.2rem;">‚ñ∂</button>
        </div>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:0.7rem; color:#94a3b8; font-weight:700;"><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
        <div id="cal-grid" class="cal-grid"></div>
        <div style="margin-top:15px; display:flex; gap:15px; justify-content:center; font-size:0.75rem; color:#64748b;">
            <div style="display:flex;align-items:center;gap:5px;"><div style="width:10px;height:10px;border:2px solid var(--corp-dark);border-radius:3px;"></div> HOY</div>
            <div style="display:flex;align-items:center;gap:5px;"><div class="dot"></div> REGISTROS</div>
        </div>
    </div>

    <div class="card" style="text-align:center; border: 1px solid #e2e8f0; background: #f8fafc;">
        <h3 style="margin-top:0; color:var(--corp-dark);">ADMINISTRACI√ìN</h3>
        <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px;">Zona segura. Respalda antes de resetear.</p>
        <button class="btn btn-pri" onclick="App.Backup.generatePDF()"><i class="fa-solid fa-file-pdf"></i> DESCARGAR RESPALDO</button>
        <div style="margin-top:20px; padding-top:15px; border-top:1px solid #e2e8f0;">
            <button id="btn-reset" class="btn btn-disabled" onclick="App.Actions.factoryReset()">‚ö†Ô∏è RESET FABRICA (BLOQUEADO)</button>
        </div>
    </div>
    <div style="text-align:center; color:#94a3b8; font-size:0.7rem; margin-top:30px;">&copy; 2026 Ideas Textiles Spa. Todos los derechos reservados.</div>
</section>

<nav class="dock">
    <i class="fa-solid fa-box-open active" onclick="App.UI.go('bodega', this)"></i>
    <i class="fa-solid fa-clipboard-check" onclick="App.UI.go('ordenes', this)"></i>
    <i class="fa-solid fa-calendar-days" onclick="App.UI.go('agenda', this)"></i>
</nav>
<input type="file" id="ai-input" hidden accept="image/*,.xlsx,.xls,.csv">

<script>
    const firebaseConfig = { apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew", authDomain: "ideastextilesapp.firebaseapp.com", databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com", projectId: "ideastextilesapp", storageBucket: "ideastextilesapp.firebasestorage.app", messagingSenderId: "268995530035", appId: "1:268995530035:web:1890f45ac761cc81eb0246" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const App = {
        data: { inv: [], ord: [], fab: [], log: {} },
        state: { backupDone: false, calDate: new Date() },

        init() {
            setTimeout(() => { const l=document.getElementById('loader'); if(l)l.style.display='none'; }, 3000);
            db.ref('/').on('value', (s) => {
                const v = s.val() || {};
                App.data.inv = Object.values(v.inv || []).filter(x => x);
                App.data.ord = Object.values(v.ord || []).filter(x => x);
                App.data.fab = Object.values(v.fab || []).filter(x => x);
                App.data.log = v.log || {};
                App.data.inv.forEach(p => { if(!p.s)p.s={}; if(!p.n)p.n="ITEM?"; if(!p.sku)p.sku="000"; });
                document.getElementById('fab-badge').innerText = App.data.fab.length;
                App.Render.bodega(); App.Render.ordenes(); App.Render.fabrica(); App.Calendar.render();
            });
        },

        save() { db.ref('/').update({ inv: App.data.inv, ord: App.data.ord, fab: App.data.fab, log: App.data.log }); },

        UI: {
            go(id, el) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.dock i').forEach(i => i.classList.remove('active'));
                document.getElementById('v-'+id).classList.add('active');
                el.classList.add('active');
            },
            toggleFabrica(m) {
                document.getElementById('sub-stock').style.display = m==='stock'?'block':'none';
                document.getElementById('sub-fabrica').style.display = m==='fabrica'?'block':'none';
                document.getElementById('tab-stock').className = m==='stock'?'active':'';
                document.getElementById('tab-fabrica').className = m==='fabrica'?'active active-prod':'';
            },
            updateBulk() {
                const c = document.querySelectorAll('.chk-bulk:checked').length;
                const b = document.getElementById('bulk-tools');
                if(b) { b.className = c > 0 ? 'bulk-toolbar visible' : 'bulk-toolbar'; document.getElementById('sel-count').innerText = c; }
            }
        },

        Helpers: {
            getNextSKU: () => String(App.data.inv.reduce((m,p)=>Math.max(m,parseInt(p.sku)||0),0)+1).padStart(3,'0'),
            addToLog(msg) {
                const d = new Date(); const k = `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`;
                App.data.log[k] = (App.data.log[k]||'') + `[${d.getHours()}:${d.getMinutes()}] ${msg}\n`;
            },
            
            // --- PDF 4-EN-1 INTELIGENTE ---
            createPDF(type, dataList) {
                const docs = Array.isArray(dataList) ? dataList : [dataList];
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ format: 'legal', unit: 'mm' }); // Hoja Oficio
                const quadrants = [ [10, 10], [110, 10], [10, 150], [110, 150] ];

                docs.forEach((data, index) => {
                    if (index > 0 && index % 4 === 0) pdf.addPage();
                    const [offX, offY] = quadrants[index % 4];
                    
                    pdf.setDrawColor(200); pdf.rect(offX - 5, offY - 5, 95, 135);
                    pdf.setFont("times", "bold"); pdf.setFontSize(11); pdf.setTextColor(15, 23, 42);
                    pdf.text("IDEAS TEXTILES SPA", offX, offY + 5);
                    
                    pdf.setFont("helvetica", "bold"); pdf.setFontSize(8); pdf.setTextColor(0);
                    const title = type === 'taller' ? 'SALIDA TALLER / LIBRE' : 'TACHA DE PEDIDO';
                    pdf.text(title, offX, offY + 12);
                    
                    pdf.setFontSize(7); pdf.setFont("helvetica", "normal");
                    pdf.text(`FECHA: ${new Date().toLocaleDateString()}`, offX, offY + 18);
                    pdf.text(`DEST/CLIENTE: ${(data.dest||data.c||'').substring(0,25)}`, offX, offY + 23);
                    if(data.trans) pdf.text(`RESP: ${data.trans.substring(0,25)}`, offX, offY + 28);
                    
                    let currY = offY + 35;
                    pdf.setFillColor(240); pdf.rect(offX, currY - 4, 85, 5, 'F');
                    pdf.setFont("helvetica", "bold"); pdf.text("CANT  DESCRIPCI√ìN", offX + 2, currY);
                    pdf.setFont("helvetica", "normal");
                    
                    data.items.forEach(it => {
                        currY += 5; if(currY > offY + 100) return;
                        // Mostrar estado en PDF si existe
                        const stTxt = it.st && it.st !== 'OK' ? ` [${it.st}]` : '';
                        pdf.text(`${it.q}`, offX + 5, currY);
                        pdf.text(`${it.p} (${it.sz})${stTxt}`.substring(0, 30), offX + 15, currY);
                    });

                    currY += 8; pdf.setFont("helvetica", "bold");
                    pdf.text(`TOTAL UNIDADES: ${data.items.reduce((s,i)=>s+parseInt(i.q),0)}`, offX, currY);
                    currY += 5; pdf.setDrawColor(150); pdf.rect(offX, currY, 85, 10);
                    pdf.setFontSize(6); pdf.text(`OBS: ${data.obs||''}`.substring(0,90), offX+1, currY+4);

                    const firmY = offY + 120;
                    pdf.line(offX+5, firmY, offX+35, firmY); pdf.text("ENTREGA", offX+10, firmY+3);
                    pdf.line(offX+50, firmY, offX+80, firmY); pdf.text("RECIBE", offX+55, firmY+3);
                });
                pdf.save(`TACHAS_PACK_${new Date().getTime()}.pdf`);
            }
        },

        Render: {
            bodega() {
                const el = document.getElementById('list-bodega');
                const q = (document.getElementById('search-inv').value||'').toUpperCase();
                const list = App.data.inv.filter(i => (i.n||'').toUpperCase().includes(q) || (i.sku||'').includes(q));
                if(!list.length) { el.innerHTML='<div style="text-align:center;color:#94a3b8;margin-top:30px;">Sin resultados.</div>'; return; }

                el.innerHTML = list.map((p, idx) => {
                    const realIdx = App.data.inv.indexOf(p);
                    const keys = Object.keys(p.s);
                    let sizesHtml = keys.length ? keys.map(k => `<div class="qs-tag"><b>${k}</b>:${p.s[k]}<div style="display:flex;gap:3px;margin-left:5px;"><button class="qs-btn qs-minus" onclick="App.Actions.quickStock(${realIdx},'${k}',-1)">-</button><button class="qs-btn qs-plus" onclick="App.Actions.quickStock(${realIdx},'${k}',1)">+</button></div></div>`).join('') : '<span style="font-size:0.8rem;color:#cbd5e1;">Sin stock.</span>';
                    const isZero = keys.length === 0 || Object.values(p.s).every(v=>v<=0);
                    
                    return `<div class="card">
                        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                            <span class="sku-badge">SKU: ${p.sku}</span>
                            <div><i class="fa-solid fa-pen" style="color:var(--corp-gray);margin-right:10px;cursor:pointer;" onclick="App.Actions.modalProd(${realIdx})"></i><i class="fa-solid fa-trash" style="color:#cbd5e1;cursor:pointer;" onclick="App.Actions.delProd(${realIdx})"></i></div>
                        </div>
                        <h3 style="margin:5px 0 10px;font-size:1rem;">${p.n}</h3>
                        <button onclick="App.Actions.startProduction(${realIdx})" style="float:right;background:transparent;border:1px solid #ddd;border-radius:8px;color:var(--prod);font-size:0.7rem;font-weight:700;padding:5px 10px;">${isZero ? 'üõ†Ô∏è REPONER' : '‚öôÔ∏è PRODUCIR'}</button>
                        <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;">${sizesHtml}</div>
                    </div>`;
                }).join('');
            },
            fabrica() {
                const el = document.getElementById('list-fabrica');
                if(!App.data.fab.length) { el.innerHTML='<div style="text-align:center;color:#cbd5e1;">F√°brica detenida.</div>'; return; }
                el.innerHTML = App.data.fab.map((f, i) => {
                    const pct = Math.round(((f.stepIndex+1)/f.steps.length)*100);
                    return `<div class="card" style="border-left:5px solid var(--prod);"><h3 style="margin:0;font-size:1rem;">${f.n} <small>(${f.sz})</small></h3><div style="font-size:0.8rem;color:#64748b;">Lote: ${f.q} un.</div><div class="prod-bar"><div class="prod-fill" style="width:${pct}%"></div></div><div style="display:flex;justify-content:space-between;font-size:0.75rem;font-weight:700;color:var(--prod);margin-bottom:10px;"><span>FASE: ${f.steps[f.stepIndex]}</span><span>${pct}%</span></div><div class="btn-group"><button class="btn btn-sec" style="padding:8px;font-size:0.75rem;" onclick="App.Helpers.createPDF('prod',{obs:f.steps.join('>'),items:[{p:f.n,q:f.q,sz:f.sz}]})">üìÑ RUTA</button><button class="btn btn-prod" style="padding:8px;font-size:0.75rem;" onclick="App.Actions.advanceFab(${i})">AVANZAR ‚û°</button></div></div>`;
                }).join('');
            },
            ordenes() {
                const el = document.getElementById('list-ordenes');
                const list = App.data.ord || [];
                if(!list.length) { el.innerHTML='<div style="text-align:center;color:#cbd5e1;">No hay pedidos.</div>'; return; }
                
                el.innerHTML = list.slice().reverse().map((o, idx) => {
                    const realIdx = list.length - 1 - idx;
                    // ITEM STATUS: Muestra pastillas de color seg√∫n estado
                    const items = o.items.map(x => {
                        let stClass = 'ist-ok';
                        if(x.st === 'NO') stClass = 'ist-no';
                        if(x.st === 'PEND') stClass = 'ist-pend';
                        const stLabel = x.st && x.st!=='OK' ? `<span class="ist-pill ${stClass}">${x.st}</span>` : '';
                        return `<div>${x.p} (${x.sz}) <b>x${x.q}</b>${stLabel}</div>`;
                    }).join('');
                    
                    return `<div class="card" style="display:flex; gap:10px;">
                        <div style="display:flex;align-items:center;"><input type="checkbox" class="chk-bulk" value="${realIdx}" onchange="App.UI.updateBulk()"></div>
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h3 style="margin:0;">${o.c}</h3>
                                <span style="font-size:0.7rem;background:#f1f5f9;padding:2px 6px;border-radius:4px;text-transform:uppercase;">${o.st}</span>
                            </div>
                            <small style="color:#64748b;">${o.fac || 'Sin Documento'}</small>
                            <div style="font-size:0.8rem;color:#64748b;margin:8px 0;background:#f8fafc;padding:8px;border-radius:8px;">${items}</div>
                            <div class="btn-group">
                                <button class="btn btn-sec" style="padding:6px;font-size:0.7rem;" onclick="App.Actions.tachaFromOrder(${realIdx})">TACHA INDIVIDUAL</button>
                                ${o.st!=='done' ? `<button class="btn btn-pri" style="padding:6px;font-size:0.7rem;" onclick="App.Actions.changeStatus(${realIdx})">ESTADO</button>` : ''}
                                <button class="btn btn-sec" style="padding:6px;font-size:0.7rem;color:red;border-color:#fee2e2;" onclick="App.Actions.delOrd(${realIdx})"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
        },

        Actions: {
            // STOCK R√ÅPIDO
            quickStock(i,sz,d) {
                const p = App.data.inv[i]; const f = (p.s[sz]||0)+d;
                if(f<0) return Swal.fire('Error','Stock negativo','error');
                p.s[sz] = f; 
                if(Math.abs(d)>=5) App.Helpers.addToLog(`Ajuste ${p.n} (${sz}): ${d>0?'+':''}${d}`);
                App.save(); App.Render.bodega();
            },

            // ORDENES Y ESTADOS DE ITEMS (OC MEJORADA)
            async modalOrder() {
                let cart = [];
                window.addC = () => {
                    const p = document.getElementById('o-p').value.toUpperCase();
                    const q = parseInt(document.getElementById('o-q').value);
                    const sz = (document.getElementById('o-sz').value||'UNICA').toUpperCase();
                    const st = document.getElementById('o-st').value; // STATUS ITEM
                    if(p && q>0) { cart.push({p,q,sz,st}); renderC(); document.getElementById('o-p').value=''; }
                };
                window.renderC = () => {
                    document.getElementById('o-list').innerHTML = cart.map((x,i)=>
                        `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:5px;font-size:0.8rem;">
                            <span>${x.p} (${x.sz}) x${x.q} [${x.st}]</span>
                            <span onclick="cart.splice(${i},1);renderC()" style="color:red;cursor:pointer;">X</span>
                        </div>`
                    ).join('');
                };
                const opts = App.data.inv.map(x=>`<option value="${x.n}">`).join('');
                const {value} = await Swal.fire({
                    title: 'NUEVA OC DE VENTA',
                    html: `
                        <input id="o-c" class="swal2-input" placeholder="Nombre Cliente / Empresa">
                        <div style="background:#f8fafc;padding:10px;margin:10px 0;border:1px solid #eee;border-radius:8px;">
                            <input id="o-p" list="dl-o" class="swal2-input" placeholder="Buscar Producto" style="margin-top:0;">
                            <datalist id="dl-o">${opts}</datalist>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr; gap:5px;">
                                <input id="o-sz" class="swal2-input" placeholder="Talla" style="width:100%;margin:0;">
                                <input id="o-q" type="number" class="swal2-input" value="1" style="width:100%;margin:0;">
                                <select id="o-st" class="swal2-input" style="width:100%;margin:0;padding:0 5px;font-size:0.8rem;">
                                    <option value="OK">‚úÖ OK</option>
                                    <option value="PEND">‚è≥ PEND</option>
                                    <option value="NO">‚ùå NO STOCK</option>
                                </select>
                            </div>
                            <button onclick="addC()" class="btn btn-pri" style="margin-top:10px;width:100%;">+ AGREGAR ITEM</button>
                        </div>
                        <div id="o-list" style="max-height:100px;overflow-y:auto;text-align:left;"></div>
                    `,
                    preConfirm: () => {
                        const c = document.getElementById('o-c').value.toUpperCase();
                        return (c && cart.length) ? {c, items:cart, st:'bodega', date:new Date().toLocaleDateString()} : false;
                    }
                });
                if(value) { App.data.ord.push(value); App.save(); App.Render.ordenes(); }
            },

            // SALIDA LIBRE (MIX)
            async tachaManual() {
                let cart = [];
                window.mixAdd = () => {
                    const p = document.getElementById('m-p').value.toUpperCase();
                    const sz = (document.getElementById('m-sz').value||'UNICA').toUpperCase();
                    const q = parseInt(document.getElementById('m-q').value);
                    if(p && q>0) { cart.push({p,sz,q}); mixRender(); document.getElementById('m-p').value=''; }
                };
                window.mixRender = () => document.getElementById('m-list').innerHTML = cart.map((x,i)=>`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;font-size:0.8rem;padding:4px;"><span>${x.q} ${x.p} (${x.sz})</span><span onclick="cart.splice(${i},1);mixRender()" style="color:red;cursor:pointer;">X</span></div>`).join('');
                
                const opts = App.data.inv.map(x=>`<option value="${x.n}">`).join('');
                const {value} = await Swal.fire({
                    title: 'SALIDA LIBRE / MIX',
                    html: `
                        <input id="m-dst" class="swal2-input" placeholder="Destino / Taller">
                        <input id="m-tr" class="swal2-input" placeholder="Responsable">
                        <div style="background:#f8fafc;padding:10px;margin:10px 0;border-radius:8px;">
                            <input id="m-p" list="dl-m" class="swal2-input" placeholder="Producto" style="margin-top:0;">
                            <datalist id="dl-m">${opts}</datalist>
                            <div style="display:flex;gap:5px;">
                                <input id="m-sz" class="swal2-input" placeholder="Talla">
                                <input id="m-q" type="number" class="swal2-input" placeholder="Cant">
                                <button onclick="mixAdd()" class="btn btn-pri" style="width:auto;margin:0;">+</button>
                            </div>
                        </div>
                        <div id="m-list" style="max-height:100px;overflow-y:auto;text-align:left;"></div>
                        <div style="margin-top:10px;display:flex;justify-content:center;gap:5px;"><input type="checkbox" id="m-dec" checked><label for="m-dec">Descontar de Bodega</label></div>
                    `,
                    preConfirm: () => {
                        const dest = document.getElementById('m-dst').value;
                        if(!dest || !cart.length) return Swal.showValidationMessage('Falta Destino o Items');
                        return { dest, trans:document.getElementById('m-tr').value, ded:document.getElementById('m-dec').checked, items:cart };
                    }
                });
                if(value) {
                    if(value.ded) {
                        value.items.forEach(it => { const p=App.data.inv.find(x=>x.n===it.p); if(p) p.s[it.sz]=(p.s[it.sz]||0)-it.q; });
                        App.save(); App.Render.bodega();
                    }
                    App.Helpers.createPDF('taller', [{dest:value.dest, trans:value.trans, obs:value.ded?'Con descuento stock':'Sin descuento', items:value.items}]);
                    App.Helpers.addToLog(`Salida Libre: ${value.dest}`);
                }
            },

            // IMPRESI√ìN MASIVA
            printBulk() {
                const checks = document.querySelectorAll('.chk-bulk:checked');
                if(!checks.length) return;
                const docs = [];
                checks.forEach(c => {
                    const o = App.data.ord[parseInt(c.value)];
                    docs.push({ dest: o.c, obs: `Pedido ${o.fac||'Pend'}`, trans: o.trans, items: o.items });
                });
                App.Helpers.createPDF('order', docs);
                checks.forEach(c => c.checked=false); App.UI.updateBulk();
            },

            // RESTO DE ACCIONES
            async startProduction(i) {
                const p = App.data.inv[i];
                const {value:v} = await Swal.fire({title:'PRODUCIR', html:`<input id="sw-q" type="number" class="swal2-input" placeholder="Cant"><input id="sw-sz" class="swal2-input" placeholder="Talla"><textarea id="sw-st" class="swal2-textarea">Corte, Confecci√≥n, Terminaci√≥n</textarea>`, preConfirm:()=>({q:parseInt(document.getElementById('sw-q').value), sz:document.getElementById('sw-sz').value.toUpperCase(), steps:document.getElementById('sw-st').value.split(',')})});
                if(v && v.q>0) { App.data.fab.push({...v, n:p.n, sku:p.sku, stepIndex:0}); App.save(); App.UI.toggleFabrica('fabrica'); }
            },
            async advanceFab(i) {
                const f = App.data.fab[i];
                if(f.stepIndex < f.steps.length-1) { f.stepIndex++; App.save(); App.Render.fabrica(); }
                else if(await Swal.fire({title:'¬øFinalizar?',icon:'question',showCancelButton:true}).then(r=>r.isConfirmed)) {
                    let p = App.data.inv.find(x=>x.sku===f.sku||x.n===f.n); if(p) p.s[f.sz]=(p.s[f.sz]||0)+f.q;
                    App.data.fab.splice(i,1); App.save(); App.Render.bodega(); App.UI.toggleFabrica('stock');
                }
            },
            async changeStatus(i) {
                const {value:st} = await Swal.fire({input:'select', inputOptions:{'bodega':'Bodega','prod':'Proceso','pack':'Empaque','done':'Finalizar'}});
                if(st){ 
                    if(st==='done'){ 
                        const {value:f}=await Swal.fire({input:'text',title:'N¬∞ Doc'}); 
                        if(f){ App.data.ord[i].st='done'; App.data.ord[i].fac=f; App.data.ord[i].items.forEach(it=>{const p=App.data.inv.find(x=>x.n===it.p); if(p)p.s[it.sz]-=it.q;}); } 
                    } else App.data.ord[i].st=st; 
                    App.save(); App.Render.ordenes(); App.Render.bodega(); 
                }
            },
            async modalProd(i=null) {
                const p = i===null ? {n:'',s:{},sku:App.Helpers.getNextSKU()} : App.data.inv[i];
                const sStr = Object.entries(p.s).map(([k,v])=>`${k}:${v}`).join(',');
                const {value} = await Swal.fire({title:i===null?'NUEVO':'EDITAR', html:`<input id="sw-n" class="swal2-input" value="${p.n}"><input id="sw-s" class="swal2-input" value="${sStr}" placeholder="S:10, M:20">`, preConfirm:()=>{
                    const n=document.getElementById('sw-n').value.toUpperCase();
                    const s={}; document.getElementById('sw-s').value.split(',').forEach(x=>{const[k,v]=x.split(':');if(k&&v)s[k.trim().toUpperCase()]=parseInt(v)});
                    return n?{n,s,sku:p.sku}:false;
                }});
                if(value){ if(i===null)App.data.inv.push(value); else App.data.inv[i]=value; App.save(); App.Render.bodega(); }
            },
            delProd(i){ Swal.fire({title:'¬øBorrar?',showCancelButton:true}).then(r=>{if(r.isConfirmed){App.data.inv.splice(i,1);App.save();App.Render.bodega();}}) },
            delOrd(i){ Swal.fire({title:'¬øBorrar?',showCancelButton:true}).then(r=>{if(r.isConfirmed){App.data.ord.splice(i,1);App.save();App.Render.ordenes();}}) },
            tachaFromOrder(i){ const o=App.data.ord[i]; Swal.fire({title:'Datos',html:`<input id="tt" class="swal2-input" placeholder="Transp"><input id="to" class="swal2-input" placeholder="Obs">`, preConfirm:()=>({trans:document.getElementById('tt').value, obs:document.getElementById('to').value})}).then(r=>{if(r.value){o.trans=r.value.trans; o.obs=r.value.obs; App.save(); App.Helpers.createPDF('order',o)}}) },
            
            // SEGURIDAD
            async factoryReset() {
                if(!App.state.backupDone) return Swal.fire('Bloqueado','Descarga respaldo primero','lock');
                const {value:p}=await Swal.fire({title:'CONFIRMAR',text:'Escribe ELIMINAR',input:'text'});
                if(p==='ELIMINAR') { db.ref('/').set({}); location.reload(); }
            }
        },

        Calendar: {
            move(d){ App.state.calDate.setMonth(App.state.calDate.getMonth()+d); this.render(); },
            render(){
                const d=App.state.calDate; const today=new Date();
                document.getElementById('cal-title').innerText=`${d.getMonth()+1}/${d.getFullYear()}`;
                const dim=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();
                const fd=new Date(d.getFullYear(),d.getMonth(),1).getDay()||7;
                let h=''; for(let i=1;i<fd;i++)h+='<div></div>';
                for(let i=1;i<=dim;i++){
                    const k=`${i}-${d.getMonth()}-${d.getFullYear()}`;
                    h+=`<div class="day ${i===today.getDate()&&d.getMonth()===today.getMonth()?'current':''}" onclick="App.Calendar.show('${k}')">${i}${App.data.log[k]?'<div class="dot"></div>':''}</div>`;
                }
                document.getElementById('cal-grid').innerHTML=h;
            },
            show(k){ if(App.data.log[k]) Swal.fire({title:k, text:App.data.log[k]}); }
        },
        
        Backup: {
            generatePDF() {
                const {jsPDF}=window.jspdf; const doc=new jsPDF();
                doc.text("RESPALDO IDEAS TEXTILES",10,10);
                const body=App.data.inv.map(p=>[p.sku,p.n,JSON.stringify(p.s)]);
                doc.autoTable({head:[['SKU','ITEM','STOCK']],body});
                doc.save('RESPALDO.pdf');
                App.state.backupDone=true;
                document.getElementById('btn-reset').classList.remove('btn-disabled');
                document.getElementById('btn-reset').classList.add('btn-danger');
                document.getElementById('btn-reset').innerText="‚ö†Ô∏è BORRAR DATOS";
            }
        },
        IA: { trigger:()=>document.getElementById('ai-input').click() }
    };

    document.getElementById('ai-input').addEventListener('change', (e) => {
        // L√≥gica Excel simple mantenida por estabilidad
        const f = e.target.files[0]; if(!f)return;
        Swal.fire({title:'Procesando...',didOpen:()=>Swal.showLoading()});
        setTimeout(()=>Swal.fire('Info','Para importaci√≥n masiva usar Excel est√°ndar (Col A: Nombre, B: Cantidad, C: Talla)','info'),1000);
    });

    App.init();
</script>
</body>
</html>
