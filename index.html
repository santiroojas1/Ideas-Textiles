<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Sistema ERP Corporativo - Ideas Textiles SpA">
    <meta name="author" content="Ideas Textiles Dev Team">
    <title>IDEAS TEXTILES | SISTEMA ERP </title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        /* --- VARIABLES GLOBALES DEL TEMA (TEAL CORPORATIVO) --- */
        :root {
            --color-primary: #008080;        /* Teal Principal */
            --color-primary-dark: #004d4d;   /* Teal Oscuro para textos */
            --color-primary-light: #e0f2f1;  /* Teal Claro para fondos */
            --color-secondary: #2dd4bf;      /* Turquesa vibrante para acentos */
            --color-surface: #ffffff;        /* Blanco puro */
            --color-background: #f3f4f6;     /* Gris suave de fondo */
            --color-text-main: #111827;      /* Negro suave */
            --color-text-muted: #6b7280;     /* Gris texto secundario */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius-std: 0.75rem;           /* 12px border radius */
        }

        /* --- RESET & BASE --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-main);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden; /* Evita scroll doble */
        }

        /* --- UTILIDADES DE UI ESTILO "GLASSMORPHISM" --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 128, 128, 0.1);
        }

        /* --- BOTONES & INTERACTIVIDAD --- */
        .btn-corporate {
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-std);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 128, 128, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-corporate:hover {
            background-color: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 128, 128, 0.4);
        }

        .btn-corporate:active {
            transform: translateY(0);
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--color-text-muted);
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-ghost:hover {
            background-color: var(--color-primary-light);
            color: var(--color-primary);
        }

        /* --- CAMPOS DE FORMULARIO (INPUTS) --- */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #fff;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 128, 128, 0.15);
        }

        /* --- SCROLLBAR PERSONALIZADO --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }

        /* --- EFECTOS DE CARGA (LOADERS) --- */
        .loader-spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--color-primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- ESTILOS DE TABLAS AVANZADAS --- */
        .table-container {
            border-radius: var(--radius-std);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid #e5e7eb;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .data-table thead {
            background-color: var(--color-primary-light);
            color: var(--color-primary-dark);
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .data-table th, .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-table tr:hover {
            background-color: #f9fafb;
        }

        /* --- SUGERENCIAS FLOTANTES (CHIPS) --- */
        .suggestions-wrapper {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            width: 100%;
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 4px;
        }

        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }
        .suggestion-item:hover {
            background-color: var(--color-primary-light);
            color: var(--color-primary-dark);
        }

        /* --- ESTILOS PARA LA AGENDA (MÓDULO ESPECÍFICO) --- */
        .agenda-card {
            background: white;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.2s;
        }
        .agenda-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }
        .agenda-header {
            background: var(--color-primary-light);
            color: var(--color-primary-dark);
            padding: 1rem;
            text-align: center;
            font-weight: 800;
            letter-spacing: 1px;
            border-bottom: 1px solid #ccfbf1;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }
        .task-item {
            background: #fffbeb; /* Yellow 50 */
            border-left: 4px solid #f59e0b; /* Amber 500 */
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s ease-in;
        }

    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col z-30 shadow-xl hidden md:flex transition-all duration-300">
        
        <div class="h-32 flex flex-col items-center justify-center border-b border-gray-100 bg-gradient-to-b from-white to-teal-50">
            <div class="relative group cursor-pointer" onclick="App.UI.animateLogo()">
                <svg width="60" height="60" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-transform duration-500 group-hover:rotate-12">
                    <circle cx="50" cy="50" r="48" stroke="#008080" stroke-width="2.5" fill="white"/>
                    <circle cx="40" cy="30" r="6" stroke="#008080" stroke-width="2"/>
                    <circle cx="60" cy="30" r="6" stroke="#008080" stroke-width="2"/>
                    <path d="M42 35 L65 80" stroke="#008080" stroke-width="2.5" stroke-linecap="round"/>
                    <path d="M58 35 L35 80" stroke="#008080" stroke-width="2.5" stroke-linecap="round"/>
                    <circle cx="50" cy="55" r="3" fill="#008080"/>
                </svg>
            </div>
            <div class="mt-2 text-center">
                <h1 class="text-xl font-black text-gray-800 tracking-tight">IDEAS TEXTILES</h1>
                <p class="text-[10px] uppercase font-bold text-teal-600 tracking-widest">Ropa de Trabajo & Corporativa</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            
            <p class="text-xs font-bold text-gray-400 uppercase ml-2 mb-2">Principal</p>
            
            <button onclick="App.Router.navigate('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 transition-all group">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 group-hover:bg-white group-hover:shadow-sm text-teal-600">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <span class="font-semibold">Dashboard</span>
            </button>

            <button onclick="App.Router.navigate('orders')" id="nav-orders" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 transition-all group">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 group-hover:bg-white group-hover:shadow-sm text-teal-600">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <span class="font-semibold">Órdenes de Compra</span>
                <span id="badge-orders" class="ml-auto bg-teal-100 text-teal-800 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
            </button>

            <button onclick="App.Router.navigate('inventory')" id="nav-inventory" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 transition-all group">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 group-hover:bg-white group-hover:shadow-sm text-teal-600">
                    <i class="fas fa-boxes-stacked"></i>
                </div>
                <span class="font-semibold">Inventario Bodega</span>
            </button>

            <div class="my-4 border-t border-gray-100"></div>

            <p class="text-xs font-bold text-gray-400 uppercase ml-2 mb-2">Herramientas</p>

            <button onclick="App.Router.navigate('agenda')" id="nav-agenda" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 transition-all group">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 group-hover:bg-white group-hover:shadow-sm text-orange-500">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <span class="font-semibold">Agenda & Planner</span>
            </button>

            <button onclick="App.Modals.openActaGeneral()" class="w-full flex items-center p-3 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 transition-all group border border-dashed border-gray-300 hover:border-teal-300 mt-2">
                <div class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center mr-3 text-teal-600">
                    <i class="fas fa-print"></i>
                </div>
                <span class="font-semibold">Acta Rápida</span>
            </button>
        </nav>

        <div class="p-4 bg-gray-50 border-t border-gray-200">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-teal-700 text-white flex items-center justify-center font-bold shadow-md">
                    AC
                </div>
                <div class="flex-1 overflow-hidden">
                    <p class="text-sm font-bold text-gray-900 truncate">Alejandro Cisterna</p>
                    <p class="text-xs text-gray-500 truncate">Gerente General</p>
                </div>
                <button class="text-gray-400 hover:text-teal-600"><i class="fas fa-cog"></i></button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50">
        
        <header class="md:hidden bg-white h-16 border-b flex items-center justify-between px-4 z-40 shadow-sm">
            <div class="flex items-center gap-2">
                <i class="fas fa-cut text-teal-700"></i>
                <span class="font-bold text-teal-800">IDEAS TEXTILES</span>
            </div>
            <button class="text-gray-600 p-2"><i class="fas fa-bars text-xl"></i></button>
        </header>

        <div id="app-content" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-20">
            </div>

    </main>

    <div id="modal-order" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white w-full max-w-6xl h-[95vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden transform scale-95 transition-transform duration-300" id="modal-order-panel">
            
            <div class="px-6 py-4 bg-white border-b border-gray-100 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="bg-teal-100 p-2 rounded-lg text-teal-700">
                        <i class="fas fa-file-signature text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800" id="modal-order-title">Nueva Orden de Compra</h2>
                        <p class="text-xs text-gray-500 flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span> Sistema de Edición en Tiempo Real
                        </p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="App.Modals.close('modal-order')" class="p-2 text-gray-400 hover:text-red-500 transition-colors rounded-full hover:bg-red-50">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto bg-gray-50 p-6">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">Información General</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="relative group">
                            <label class="block text-xs font-bold text-teal-700 mb-1">CLIENTE / RAZÓN SOCIAL</label>
                            <div class="relative">
                                <i class="fas fa-building absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="input-client" class="input-field pl-10 font-bold text-gray-800" placeholder="Ej: Frusan Planta...">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-teal-700 mb-1">NÚMERO DE O.C.</label>
                            <div class="relative">
                                <i class="fas fa-hashtag absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="input-oc" class="input-field pl-10 font-mono text-teal-800" placeholder="Generación Automática">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-teal-700 mb-1">LUGAR DE DESPACHO (TACHA)</label>
                            <div class="relative">
                                <i class="fas fa-truck-loading absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="input-dispatch" class="input-field pl-10" placeholder="Ej: Bodega 4, Sector Norte">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                    <div class="lg:col-span-4 bg-white p-5 rounded-xl shadow-sm border border-gray-200 h-fit sticky top-0">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-gray-800">Agregar Ítem</h3>
                            <span class="text-xs bg-teal-50 text-teal-700 px-2 py-1 rounded">Manual</span>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="relative">
                                <label class="text-xs text-gray-500 font-bold">PRODUCTO</label>
                                <input type="text" id="add-prod-name" class="input-field" placeholder="Buscar..." oninput="App.Logic.suggestProducts(this)">
                                <div id="suggestions-container" class="suggestions-wrapper hidden"></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-gray-500 font-bold">TALLA</label>
                                    <input type="text" id="add-prod-size" class="input-field text-center uppercase" placeholder="L">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 font-bold">CANTIDAD</label>
                                    <input type="number" id="add-prod-qty" class="input-field text-center font-bold text-teal-600" placeholder="0">
                                </div>
                            </div>

                            <div>
                                <label class="text-xs text-gray-500 font-bold">DETALLE / BORDADO (OPCIONAL)</label>
                                <textarea id="add-prod-msg" rows="2" class="input-field text-sm" placeholder="Ej: Logo pecho izquierdo..."></textarea>
                            </div>

                            <button onclick="App.Controllers.addItemToOrder()" class="w-full btn-corporate justify-center">
                                <i class="fas fa-plus-circle"></i> AGREGAR A LA LISTA
                            </button>
                        </div>
                    </div>

                    <div class="lg:col-span-8 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col min-h-[400px]">
                        <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Detalle de la Orden</h3>
                            <span id="items-counter" class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded-full">0 Ítems</span>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-white text-gray-500 border-b border-gray-100 sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 font-semibold">Descripción</th>
                                        <th class="p-3 font-semibold text-center w-20">Talla</th>
                                        <th class="p-3 font-semibold text-center w-20">Cant.</th>
                                        <th class="p-3 font-semibold text-right w-20"></th>
                                    </tr>
                                </thead>
                                <tbody id="order-items-body" class="divide-y divide-gray-50 text-gray-700">
                                    </tbody>
                            </table>
                            
                            <div id="empty-state-order" class="flex flex-col items-center justify-center h-64 text-gray-300">
                                <i class="fas fa-basket-shopping text-4xl mb-3"></i>
                                <p>La lista está vacía</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-200 flex justify-between items-center">
                <button onclick="App.Modals.close('modal-order')" class="px-6 py-2 rounded-lg text-gray-500 font-medium hover:bg-gray-100 transition-colors">
                    Cancelar Operación
                </button>
                <div class="flex gap-3">
                    <button class="px-4 py-2 rounded-lg bg-teal-50 text-teal-700 font-bold border border-teal-200 hover:bg-teal-100" onclick="alert('Función de borrador...')">
                        <i class="fas fa-save mr-2"></i> Guardar Borrador
                    </button>
                    <button onclick="App.Controllers.saveOrderFinal()" class="btn-corporate shadow-lg px-8">
                        <i class="fas fa-check-circle"></i> FINALIZAR Y GUARDAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-acta" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8 animate__animated animate__fadeInUp">
            <h2 class="text-2xl font-bold text-teal-800 mb-2">Generar Documento PDF</h2>
            <p class="text-sm text-gray-500 mb-6">Herramienta para actas de entrega, muestras, regalos o devoluciones.</p>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Título del Documento</label>
                        <input type="text" id="act-title" class="input-field font-bold" value="ACTA DE ENTREGA">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Destinatario</label>
                        <input type="text" id="act-client" class="input-field" placeholder="Cliente o Persona">
                    </div>
                </div>

                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div class="flex gap-2 mb-2">
                        <input id="act-input-desc" class="input-field" placeholder="Descripción del ítem">
                        <input id="act-input-qty" type="number" class="input-field w-24" placeholder="Cant.">
                        <button onclick="App.Controllers.addActItem()" class="bg-teal-600 text-white px-4 rounded-lg hover:bg-teal-700"><i class="fas fa-plus"></i></button>
                    </div>
                    <ul id="act-list" class="max-h-32 overflow-y-auto space-y-1 text-sm text-gray-700 pl-1"></ul>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Firma Entregador</label>
                        <input type="text" id="act-signer1" class="input-field" value="Alejandro Cisterna">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Firma Receptor</label>
                        <input type="text" id="act-signer2" class="input-field" placeholder="Nombre de quien recibe">
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button onclick="App.Modals.close('modal-acta')" class="text-gray-500 font-medium px-4">Cerrar</button>
                <button onclick="App.PDF.generateGeneralAct()" class="btn-corporate">
                    <i class="fas fa-file-pdf"></i> DESCARGAR PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        
        /**
         * CLASE MAESTRA APP
         * Contiene todos los módulos encapsulados para evitar conflictos globales.
         */
        const App = {
            
            // --- CONSTANTES DE CONFIGURACIÓN ---
            Config: {
                company: "IDEAS TEXTILES SPA",
                rut: "76.577.458-6",
                colors: { primary: "#008080", dark: "#004d4d" }
            },

            // --- ESTADO GLOBAL (STORE) ---
            Store: {
                inventory: [],
                orders: [],
                agenda: {},
                currentOrderEditing: null, // ID de la orden en edición o null
                
                // Carga inicial desde LocalStorage
                init: function() {
                    try {
                        this.inventory = JSON.parse(localStorage.getItem('it_inventory')) || [];
                        this.orders = JSON.parse(localStorage.getItem('it_orders')) || [];
                        this.agenda = JSON.parse(localStorage.getItem('it_agenda')) || {};
                        console.log("Sistema Iniciado. Datos cargados.");
                    } catch (e) {
                        console.error("Error cargando datos:", e);
                        Swal.fire("Error Crítico", "No se pudieron cargar los datos locales.", "error");
                    }
                },

                save: function() {
                    localStorage.setItem('it_inventory', JSON.stringify(this.inventory));
                    localStorage.setItem('it_orders', JSON.stringify(this.orders));
                    localStorage.setItem('it_agenda', JSON.stringify(this.agenda));
                }
            },

            // --- MOTOR DE PARSEO "SABUESO" (ANALIZADOR DE ARCHIVOS) ---
            Sabueso: {
                // Función para limpiar OCs sucias copiadas de Excel o CSV
                parseDirtyText: (text) => {
                    const lines = text.split('\n');
                    let detectedItems = [];
                    
                    // Expresiones regulares para encontrar patrones comunes
                    const regexSize = /\b(XS|S|M|L|XL|XXL|2XL|3XL|4XL)\b/i;
                    const regexQty = /^[\d\.,]+/; // Número al principio de la línea

                    lines.forEach(line => {
                        const cleanLine = line.trim().toUpperCase();
                        // Ignorar cabeceras y basura
                        if(cleanLine.length < 5 || cleanLine.includes("PRECIO") || cleanLine.includes("TOTAL")) return;

                        // Intentar extraer cantidad
                        let qtyMatch = cleanLine.match(regexQty);
                        let qty = qtyMatch ? parseInt(qtyMatch[0].replace(/[.,]/g, '')) : 0;

                        // Intentar extraer talla
                        let sizeMatch = cleanLine.match(regexSize);
                        let size = sizeMatch ? sizeMatch[0] : "ÚNICA";

                        // El resto es descripción
                        let desc = cleanLine
                            .replace(regexQty, '')
                            .replace(regexSize, '')
                            .replace(/,/g, ' ')
                            .replace(/UNID/g, '')
                            .trim();

                        if(qty > 0 && desc.length > 3) {
                            detectedItems.push({ name: desc, size: size, qty: qty, msg: "Importado" });
                        }
                    });
                    return detectedItems;
                },

                // Función específica para PDF tipo "Tiojano" (Paréntesis)
                parseTiojanoPDF: (rawText) => {
                    const lines = rawText.split('\n');
                    let items = [];
                    let lastProduct = null;

                    lines.forEach(line => {
                        line = line.trim();
                        if(!line) return;

                        // Detectar si la línea tiene patrón de paréntesis numéricos ej: (1), (2)
                        const hasQtyParens = /\(\d+\)/.test(line);

                        if (!hasQtyParens && line.length > 5 && !line.includes("PAGE") && !line.includes("IDEAS")) {
                            // Es probablemente un nombre de producto
                            lastProduct = line;
                        } else if (hasQtyParens && lastProduct) {
                            // Es una línea de variantes
                            // Ejemplo: "Negra (1), Azul (2)"
                            const parts = line.split(',');
                            parts.forEach(part => {
                                const match = part.match(/(.*)\((\d+)\)/);
                                if(match) {
                                    items.push({
                                        name: lastProduct,
                                        size: match[1].trim(), // Esto actúa como variante/color
                                        qty: parseInt(match[2]),
                                        msg: "Vía PDF Tiojano"
                                    });
                                }
                            });
                        }
                    });
                    return items;
                }
            },

            // --- MOTOR DE GENERACIÓN PDF (PRINT ENGINE) ---
            PDF: {
                // Dibuja el logo vectorial directamente en el canvas del PDF
                drawLogo: (doc, x, y, scale = 1) => {
                    doc.setDrawColor(0, 128, 128); // Teal
                    doc.setLineWidth(0.5 * scale);
                    doc.circle(x, y, 10 * scale, 'S');
                    // Tijeras simples
                    doc.line(x - 2*scale, y + 2*scale, x + 2*scale, y - 4*scale);
                    doc.line(x - 2*scale, y - 4*scale, x + 2*scale, y + 2*scale);
                    
                    doc.setFontSize(14 * scale);
                    doc.setTextColor(0, 128, 128);
                    doc.setFont("helvetica", "bold");
                    doc.text("IDEAS TEXTILES", x + 15*scale, y + 2*scale);
                },

                // EL GENERADOR DE LA TACHA DE DESPACHO (3 COLUMNAS)
                generateTacha: (order) => {
                    const { jsPDF } = window.jspdf;
                    // Formato Legal (Oficio), Paisaje (Landscape)
                    const doc = new jsPDF('l', 'mm', 'legal'); 
                    
                    const pageWidth = 355.6; // Ancho Oficio apaisado aprox en mm
                    const pageHeight = 215.9;
                    const margin = 10;
                    
                    // Configuración de la cuadrícula
                    const cols = 3;
                    const gap = 5;
                    const colWidth = (pageWidth - (margin * 2) - (gap * (cols - 1))) / cols;
                    
                    const items = order.items;
                    const itemsPerPage = 30; // 10 filas x 3 columnas
                    const totalPages = Math.ceil(items.length / itemsPerPage);

                    for(let p = 0; p < totalPages; p++) {
                        if(p > 0) doc.addPage('legal', 'l');

                        // --- CABECERA REPETITIVA ---
                        // Fondo suave
                        doc.setFillColor(240, 253, 250); 
                        doc.rect(0, 0, pageWidth, 40, 'F');
                        
                        App.PDF.drawLogo(doc, 20, 20, 1.2);

                        doc.setFontSize(24);
                        doc.setTextColor(0, 128, 128);
                        doc.text("TACHA DE DESPACHO", pageWidth - margin, 20, {align: 'right'});
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0);
                        doc.setFont("helvetica", "bold");
                        doc.text(`CLIENTE: ${order.client.toUpperCase()}`, margin, 35);
                        doc.text(`LUGAR: ${order.dispatchPlace || 'NO DEFINIDO'}`, margin + 100, 35);
                        doc.text(`OC: #${order.number}`, pageWidth - margin, 30, {align: 'right'});
                        doc.text(`FECHA: ${new Date(order.date).toLocaleDateString()}`, pageWidth - margin, 35, {align: 'right'});

                        // --- CUERPO (GRID DE 3 COLUMNAS) ---
                        let startY = 45;
                        let rowHeight = 14; 
                        
                        // Obtener items de esta página
                        const pageItems = items.slice(p * itemsPerPage, (p + 1) * itemsPerPage);

                        pageItems.forEach((item, idx) => {
                            // Cálculo matemático de coordenadas
                            // Columna actual (0, 1, 2)
                            const colIndex = Math.floor(idx / 10); 
                            // Fila actual (0 a 9)
                            const rowIndex = idx % 10;

                            const x = margin + (colIndex * (colWidth + gap));
                            const y = startY + (rowIndex * rowHeight);

                            // Caja contenedora
                            doc.setDrawColor(200);
                            doc.setFillColor(255);
                            doc.rect(x, y, colWidth, rowHeight, 'FD');

                            // Contenido
                            doc.setFontSize(10);
                            doc.setFont("helvetica", "bold");
                            doc.text(`${item.name.substring(0, 35)}`, x + 2, y + 5);
                            
                            doc.setFont("helvetica", "normal");
                            doc.text(`Talla: ${item.size}`, x + 2, y + 10);
                            
                            // Cantidad Gigante
                            doc.setFontSize(12);
                            doc.setFont("helvetica", "bold");
                            doc.text(`${item.qty}`, x + colWidth - 25, y + 9, {align: 'right'});

                            // Mensaje (pequeño)
                            if(item.msg) {
                                doc.setFontSize(7);
                                doc.setTextColor(100);
                                doc.text(item.msg.substring(0,30), x + 35, y + 10);
                                doc.setTextColor(0);
                            }

                            // --- EL TICKET (CHECKBOX) A LA DERECHA ---
                            doc.setDrawColor(0);
                            doc.setLineWidth(0.7);
                            // Cuadrado de 8x8mm alineado a la derecha
                            doc.rect(x + colWidth - 10, y + 3, 8, 8);
                        });

                        // Pie de página
                        doc.setFontSize(8);
                        doc.text(`Página ${p+1} de ${totalPages}`, pageWidth - margin, pageHeight - 5, {align: 'right'});
                        doc.setFontSize(12);
                        doc.text("BULTO ______ DE ______", pageWidth/2, pageHeight - 10, {align: 'center'});
                    }

                    doc.save(`TACHA_${order.client}_${order.number}.pdf`);
                },

                generateGeneralAct: () => {
                    const title = document.getElementById('act-title').value;
                    const items = document.querySelectorAll('#act-list li');
                    
                    if(items.length === 0) return Swal.fire("Error", "La lista está vacía", "warning");

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    App.PDF.drawLogo(doc, 20, 20);
                    
                    doc.setFontSize(18);
                    doc.text(title.toUpperCase(), 105, 40, {align:'center'});
                    
                    doc.setFontSize(11);
                    doc.text(`FECHA: ${new Date().toLocaleDateString()}`, 20, 55);
                    doc.text(`PARA: ${document.getElementById('act-client').value}`, 20, 62);

                    const tableData = Array.from(items).map(li => [li.dataset.desc, li.dataset.qty]);

                    doc.autoTable({
                        startY: 70,
                        head: [['DESCRIPCIÓN', 'CANTIDAD']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [0, 128, 128] }
                    });

                    // Firmas
                    const y = doc.lastAutoTable.finalY + 40;
                    doc.line(30, y, 90, y);
                    doc.text(document.getElementById('act-signer1').value, 60, y+5, {align:'center'});
                    
                    doc.line(120, y, 180, y);
                    doc.text(document.getElementById('act-signer2').value || "RECIBIDO", 150, y+5, {align:'center'});

                    doc.save("ACTA_ENTREGA.pdf");
                }
            },

            // --- CONTROLADORES DE INTERFAZ (UI LOGIC) ---
            Controllers: {
                // Maneja la subida de archivos (Excel/PDF)
                handleFileUpload: async (input) => {
                    const file = input.files[0];
                    if(!file) return;

                    Swal.fire({
                        title: 'Analizando...',
                        text: 'El Sabueso está procesando el archivo',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    try {
                        let extractedItems = [];

                        if(file.type === "application/pdf") {
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                            let fullText = "";
                            for(let i=1; i<=pdf.numPages; i++){
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                fullText += content.items.map(item => item.str).join('\n');
                            }
                            extractedItems = App.Sabueso.parseTiojanoPDF(fullText);
                        } else {
                            const data = await file.arrayBuffer();
                            const workbook = XLSX.read(data);
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            const csv = XLSX.utils.sheet_to_csv(sheet);
                            extractedItems = App.Sabueso.parseDirtyText(csv);
                        }

                        if(extractedItems.length > 0) {
                            Swal.close();
                            App.Modals.openOrderEditor('new');
                            extractedItems.forEach(item => App.UI.addItemToOrderTable(item));
                            Swal.fire("Éxito", `Se importaron ${extractedItems.length} productos.`, "success");
                        } else {
                            Swal.fire("Error", "No se detectaron productos válidos.", "error");
                        }
                    } catch (e) {
                        console.error(e);
                        Swal.fire("Error Técnico", e.message, "error");
                    }
                },

                // Agrega un item desde el formulario manual
                addItemToOrder: () => {
                    const name = document.getElementById('add-prod-name').value;
                    const size = document.getElementById('add-prod-size').value || "ÚNICA";
                    const qty = document.getElementById('add-prod-qty').value;
                    const msg = document.getElementById('add-prod-msg').value;

                    if(!name || !qty) return Swal.fire("Atención", "Nombre y Cantidad requeridos", "warning");

                    App.UI.addItemToOrderTable({
                        name, size: size.toUpperCase(), qty: parseInt(qty), msg
                    });

                    // Limpiar campos para entrada rápida
                    document.getElementById('add-prod-size').value = '';
                    document.getElementById('add-prod-qty').value = '';
                    document.getElementById('add-prod-msg').value = '';
                    document.getElementById('add-prod-name').focus();
                },
                
                addActItem: () => {
                    const desc = document.getElementById('act-input-desc').value;
                    const qty = document.getElementById('act-input-qty').value;
                    if(!desc) return;
                    const ul = document.getElementById('act-list');
                    const li = document.createElement('li');
                    li.className = "flex justify-between border-b py-1";
                    li.dataset.desc = desc;
                    li.dataset.qty = qty;
                    li.innerHTML = `<span>${desc}</span> <b>${qty}</b>`;
                    ul.appendChild(li);
                    document.getElementById('act-input-desc').value = '';
                    document.getElementById('act-input-qty').value = '';
                },

                saveOrderFinal: () => {
                    const client = document.getElementById('input-client').value;
                    const number = document.getElementById('input-oc').value || Date.now().toString().slice(-6);
                    const dispatch = document.getElementById('input-dispatch').value;

                    // Recopilar items de la tabla DOM
                    const items = [];
                    document.querySelectorAll('#order-items-body tr').forEach(tr => {
                        items.push(JSON.parse(tr.dataset.json));
                    });

                    if(!client || items.length === 0) return Swal.fire("Incompleto", "Falta cliente o productos", "warning");

                    const newOrder = {
                        id: App.Store.currentOrderEditing || Date.now(),
                        client,
                        number,
                        dispatchPlace: dispatch,
                        date: new Date().toISOString(),
                        items,
                        status: 'Pendiente'
                    };

                    // Enlace Inteligente: Crear items en inventario si no existen
                    items.forEach(item => {
                        const exists = App.Store.inventory.find(i => i.name === item.name && i.size === item.size);
                        if(!exists) {
                            App.Store.inventory.push({
                                id: Date.now() + Math.random(),
                                name: item.name,
                                size: item.size,
                                stock: 0 // Se crea en 0 para no bloquear
                            });
                        }
                    });

                    if(App.Store.currentOrderEditing) {
                        const idx = App.Store.orders.findIndex(o => o.id === App.Store.currentOrderEditing);
                        App.Store.orders[idx] = newOrder;
                    } else {
                        App.Store.orders.unshift(newOrder);
                    }

                    App.Store.save();
                    App.Modals.close('modal-order');
                    App.Router.navigate('orders'); // Refrescar vista
                    Swal.fire("Guardado", "La orden se ha registrado correctamente", "success");
                },

                deleteOrder: (id) => {
                    Swal.fire({
                        title: '¿Eliminar?',
                        text: "No podrás revertir esto",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, borrar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            App.Store.orders = App.Store.orders.filter(o => o.id !== id);
                            App.Store.save();
                            App.Router.navigate('orders');
                        }
                    })
                }
            },

            // --- GESTOR DE UI Y DOM ---
            UI: {
                addItemToOrderTable: (item) => {
                    const tbody = document.getElementById('order-items-body');
                    const emptyState = document.getElementById('empty-state-order');
                    if(emptyState) emptyState.style.display = 'none';

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-teal-50 transition-colors border-b border-gray-100 animate__animated animate__fadeIn";
                    tr.dataset.json = JSON.stringify(item);
                    
                    tr.innerHTML = `
                        <td class="p-3">
                            <div class="font-bold text-gray-800">${item.name}</div>
                            ${item.msg ? `<div class="text-xs text-orange-600 italic"><i class="fas fa-comment-alt mr-1"></i>${item.msg}</div>` : ''}
                        </td>
                        <td class="p-3 text-center"><span class="bg-gray-200 px-2 py-1 rounded text-xs font-bold">${item.size}</span></td>
                        <td class="p-3 text-center font-bold text-teal-700 text-lg">${item.qty}</td>
                        <td class="p-3 text-right">
                            <button onclick="this.closest('tr').remove(); App.UI.updateCounter()" class="text-red-300 hover:text-red-500 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    App.UI.updateCounter();
                },

                updateCounter: () => {
                    const count = document.getElementById('order-items-body').children.length;
                    document.getElementById('items-counter').innerText = `${count} Ítems`;
                },
                
                animateLogo: () => {
                    // Pequeña animación JS de click
                    const logo = document.querySelector('svg');
                    logo.classList.add('scale-110');
                    setTimeout(() => logo.classList.remove('scale-110'), 200);
                }
            },

            // --- LÓGICA DE AGENDA (PRESERVADA) ---
            Agenda: {
                days: ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'],
                
                render: () => {
                    const container = document.getElementById('app-content');
                    let html = `
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Planner Semanal Corporativo</h2>
                            <div class="text-sm text-gray-500">Semana del ${new Date().toLocaleDateString()}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 h-[calc(100vh-180px)]">`;
                    
                    App.Agenda.days.forEach(day => {
                        const tasks = App.Store.agenda[day] || [];
                        html += `
                            <div class="agenda-card">
                                <div class="agenda-header">${day}</div>
                                <div class="flex-1 p-3 overflow-y-auto space-y-2 bg-gray-50" id="agenda-${day}">
                                    ${tasks.map((t, i) => `
                                        <div class="task-item group">
                                            <span>${t}</span>
                                            <button onclick="App.Agenda.remove('${day}', ${i})" class="text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <i class="fas fa-times-circle"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="p-3 bg-white border-t">
                                    <input type="text" placeholder="+ Tarea" 
                                        class="w-full text-sm border rounded p-2 focus:ring-2 focus:ring-teal-500 outline-none"
                                        onkeypress="if(event.key === 'Enter') App.Agenda.add('${day}', this)">
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                    container.innerHTML = html;
                },

                add: (day, input) => {
                    const val = input.value.trim();
                    if(!val) return;
                    if(!App.Store.agenda[day]) App.Store.agenda[day] = [];
                    App.Store.agenda[day].push(val);
                    App.Store.save();
                    App.Agenda.render();
                },

                remove: (day, index) => {
                    App.Store.agenda[day].splice(index, 1);
                    App.Store.save();
                    App.Agenda.render();
                }
            },

            // --- LÓGICA DE RUTEO (SPA) ---
            Router: {
                navigate: (route) => {
                    // Update Active States
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-teal-50', 'text-teal-700'));
                    const activeBtn = document.getElementById(`nav-${route}`);
                    if(activeBtn) activeBtn.classList.add('bg-teal-50', 'text-teal-700');

                    const container = document.getElementById('app-content');
                    container.innerHTML = ''; // Clean

                    switch(route) {
                        case 'dashboard':
                            App.Router.renderDashboard(container);
                            break;
                        case 'orders':
                            App.Router.renderOrders(container);
                            break;
                        case 'inventory':
                            App.Router.renderInventory(container);
                            break;
                        case 'agenda':
                            App.Agenda.render();
                            break;
                    }
                },

                renderDashboard: (container) => {
                    const pending = App.Store.orders.filter(o => o.status === 'Pendiente').length;
                    container.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 animate__animated animate__fadeIn">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 relative overflow-hidden">
                                <div class="absolute right-0 top-0 w-24 h-24 bg-teal-50 rounded-full -mr-8 -mt-8"></div>
                                <div class="w-12 h-12 bg-teal-100 text-teal-700 rounded-xl flex items-center justify-center text-xl z-10">
                                    <i class="fas fa-shopping-bag"></i>
                                </div>
                                <div class="z-10">
                                    <h3 class="text-2xl font-black text-gray-800">${App.Store.orders.length}</h3>
                                    <p class="text-sm text-gray-500 font-medium">Órdenes Totales</p>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 relative overflow-hidden">
                                <div class="absolute right-0 top-0 w-24 h-24 bg-orange-50 rounded-full -mr-8 -mt-8"></div>
                                <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center text-xl z-10">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="z-10">
                                    <h3 class="text-2xl font-black text-gray-800">${pending}</h3>
                                    <p class="text-sm text-gray-500 font-medium">Pendientes de Despacho</p>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-teal-600 to-teal-800 p-6 rounded-2xl shadow-lg text-white flex flex-col justify-center cursor-pointer hover:shadow-xl transition-shadow" onclick="App.Modals.openOrderEditor('new')">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-plus-circle text-2xl text-teal-200"></i>
                                    <span class="font-bold text-lg">Nueva Orden Rápida</span>
                                </div>
                                <p class="text-teal-100 text-xs">Crear manual o importar Excel</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-800 mb-4">Actividad Reciente</h3>
                            <div class="space-y-4">
                                ${App.Store.orders.slice(0, 5).map(o => `
                                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border-b border-gray-50">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-xs">
                                                ${o.client.substring(0,2).toUpperCase()}
                                            </div>
                                            <div>
                                                <p class="font-bold text-sm text-gray-800">${o.client}</p>
                                                <p class="text-xs text-gray-500">OC: ${o.number}</p>
                                            </div>
                                        </div>
                                        <span class="text-xs font-bold px-2 py-1 rounded bg-teal-50 text-teal-700">${new Date(o.date).toLocaleDateString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                },

                renderOrders: (container) => {
                    container.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Gestión de Órdenes</h2>
                            <div class="flex gap-2">
                                <label class="btn-corporate bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 cursor-pointer">
                                    <i class="fas fa-file-import"></i> Importar Archivo
                                    <input type="file" hidden onchange="App.Controllers.handleFileUpload(this)">
                                </label>
                                <button onclick="App.Modals.openOrderEditor('new')" class="btn-corporate">
                                    <i class="fas fa-plus"></i> Crear Manual
                                </button>
                            </div>
                        </div>
                        <div class="grid gap-4">
                            ${App.Store.orders.map(o => `
                                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-all flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h3 class="font-bold text-lg text-teal-900">${o.client}</h3>
                                            <span class="text-xs bg-gray-100 px-2 py-0.5 rounded font-mono border">OC.NRO: ${o.number}</span>
                                        </div>
                                        <p class="text-sm text-gray-500 flex items-center gap-4">
                                            <span><i class="fas fa-box mr-1"></i> ${o.items.length} Productos</span>
                                            <span><i class="fas fa-map-marker-alt mr-1"></i> ${o.dispatchPlace || 'Sin lugar'}</span>
                                        </p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="App.PDF.generateTacha(App.Store.orders.find(x => x.id === ${o.id}))" class="px-4 py-2 bg-teal-50 text-teal-700 rounded-lg font-bold text-sm hover:bg-teal-100 transition-colors border border-teal-200">
                                            <i class="fas fa-print mr-2"></i> IMPRIMIR TACHA
                                        </button>
                                        <button onclick="App.Modals.openOrderEditor('edit', ${o.id})" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded"><i class="fas fa-pen"></i></button>
                                        <button onclick="App.Controllers.deleteOrder(${o.id})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                },

                renderInventory: (container) => {
                    container.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Inventario</h2>
                            <button class="btn-corporate"><i class="fas fa-sync"></i> Actualizar</button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Talla</th>
                                        <th>Stock Actual</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${App.Store.inventory.map(i => `
                                        <tr>
                                            <td class="font-medium">${i.name}</td>
                                            <td><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold">${i.size}</span></td>
                                            <td class="font-mono font-bold">${i.stock}</td>
                                            <td>
                                                ${i.stock < 5 
                                                    ? '<span class="text-red-600 text-xs font-bold"><i class="fas fa-exclamation-circle"></i> Crítico</span>' 
                                                    : '<span class="text-green-600 text-xs font-bold">OK</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            },

            // --- GESTOR DE MODALES ---
            Modals: {
                openOrderEditor: (mode, id = null) => {
                    const modal = document.getElementById('modal-order');
                    const panel = document.getElementById('modal-order-panel');
                    const title = document.getElementById('modal-order-title');
                    
                    // Limpiar formulario
                    document.getElementById('input-client').value = "";
                    document.getElementById('input-oc').value = "";
                    document.getElementById('input-dispatch').value = "";
                    document.getElementById('order-items-body').innerHTML = "";
                    document.getElementById('empty-state-order').style.display = 'flex';

                    App.Store.currentOrderEditing = null;

                    if(mode === 'edit' && id) {
                        const order = App.Store.orders.find(o => o.id === id);
                        if(order) {
                            App.Store.currentOrderEditing = id;
                            title.innerText = `Editando OC #${order.number}`;
                            document.getElementById('input-client').value = order.client;
                            document.getElementById('input-oc').value = order.number;
                            document.getElementById('input-dispatch').value = order.dispatchPlace || "";
                            
                            order.items.forEach(item => App.UI.addItemToOrderTable(item));
                        }
                    } else {
                        title.innerText = "Nueva Orden de Compra";
                    }

                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        panel.classList.remove('scale-95');
                        panel.classList.add('scale-100');
                    }, 10);
                },

                openActaGeneral: () => {
                    const modal = document.getElementById('modal-acta');
                    document.getElementById('act-list').innerHTML = '';
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                },

                close: (modalId) => {
                    const modal = document.getElementById(modalId);
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            },

            Logic: {
                suggestProducts: (input) => {
                    // Implementación de autocompletado aquí
                    // Simulado para brevedad del bloque, pero la estructura está lista
                }
            }
        };

        // --- INICIALIZACIÓN ---
        window.addEventListener('DOMContentLoaded', () => {
            App.Store.init();
            App.Router.navigate('dashboard');
        });

    </script>
</body>
</html>
