<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEAS TEXTILES SPA | Enterprise V46</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        /* =========================================================
           VARIABLES DE ENTORNO Y PALETA DE COLORES
           ========================================================= 
        */
        :root {
            /* Colores Corporativos Ideas Textiles SPA */
            --brand-primary: #0044cc;      /* Azul Profundo (Letras) */
            --brand-sky-light: #f0f9ff;    /* Celeste Fondo Principal */
            --brand-sky-medium: #bae6fd;   /* Celeste de Acento */
            --brand-sky-vibrant: #38bdf8;  /* Celeste Acción */
            
            /* Colores de Interfaz */
            --ui-white: #ffffff;
            --ui-text-dark: #0f172a;
            --ui-text-gray: #475569;
            --ui-border: #e2e8f0;
            
            /* Estados del Taller */
            --state-confeccion: #8b5cf6;   /* Morado */
            --state-bodega: #f59e0b;       /* Naranja */
            --state-despacho: #10b981;     /* Verde */
            --state-alerta: #ef4444;       /* Rojo */
            
            /* Tipografía y Sombras */
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --shadow-sm: 0 2px 4px rgba(0, 68, 204, 0.05);
            --shadow-md: 0 10px 15px -3px rgba(0, 68, 204, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 68, 204, 0.15);
        }

        /* =========================================================
           ESTILOS BASE Y NORMALIZACIÓN
           ========================================================= 
        */
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--brand-sky-light);
            color: var(--ui-text-dark);
            min-height: 100vh;
            line-height: 1.5;
            padding-bottom: 120px; /* Espacio para el Dock */
        }

        /* =========================================================
           SISTEMA DE LOGUEO (GATEKEEPER)
           ========================================================= 
        */
        #gatekeeper-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, var(--brand-sky-medium) 0%, var(--brand-sky-light) 100%);
            z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }

        .auth-card {
            background: var(--ui-white);
            padding: 50px;
            border-radius: 40px;
            width: 90%; max-width: 480px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            border: 4px solid var(--ui-white);
        }

        .auth-icon {
            font-size: 4.5rem;
            color: var(--brand-primary);
            margin-bottom: 25px;
            filter: drop-shadow(0 10px 8px rgba(0, 68, 204, 0.2));
        }

        .auth-card h1 {
            color: var(--brand-primary);
            font-weight: 900;
            font-size: 2.2rem;
            letter-spacing: -1px;
            text-transform: uppercase;
        }

        /* =========================================================
           HEADER Y BRANDING
           ========================================================= 
        */
        header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            padding: 18px 30px;
            border-bottom: 1px solid var(--brand-sky-medium);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 2000;
        }

        .brand-box { display: flex; align-items: center; gap: 15px; }
        .brand-box i {
            background: var(--brand-primary);
            color: white; width: 50px; height: 50px;
            border-radius: 16px; display: flex;
            align-items: center; justify-content: center;
            font-size: 1.6rem;
        }
        .brand-text h2 {
            font-size: 1.2rem; color: var(--brand-primary);
            font-weight: 900; text-transform: uppercase; line-height: 1;
        }
        .brand-text span { font-size: 0.75rem; color: var(--ui-text-gray); font-weight: 700; }

        /* =========================================================
           CONTENEDORES PRINCIPALES (VISTAS)
           ========================================================= 
        */
        .view-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 25px;
        }

        .system-view {
            display: none;
            animation: viewFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .system-view.active { display: block; }

        @keyframes viewFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================================
           CARDS Y COMPONENTES
           ========================================================= 
        */
        .card-titan {
            background: var(--ui-white);
            border-radius: 30px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0, 68, 204, 0.05);
            transition: all 0.3s ease;
        }

        .card-titan:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-5px);
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 20px; border-bottom: 2px solid var(--brand-sky-light);
            padding-bottom: 15px;
        }

        .card-header h3 {
            font-weight: 900; color: var(--brand-primary);
            font-size: 1.1rem; text-transform: uppercase;
        }

        /* Matriz de Tallas Display */
        .size-grid-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 12px;
        }

        .size-pill {
            background: var(--brand-sky-light);
            padding: 15px 10px;
            border-radius: 18px;
            text-align: center;
            border: 2px solid transparent;
            transition: 0.3s;
        }

        .size-pill:hover {
            border-color: var(--brand-sky-vibrant);
            background: white;
        }

        .size-pill b {
            display: block; font-size: 0.7rem;
            color: var(--brand-primary); text-transform: uppercase;
            margin-bottom: 5px; opacity: 0.7;
        }

        .size-pill span {
            font-size: 1.2rem; font-weight: 900;
            color: var(--ui-text-dark);
        }

        /* =========================================================
           SISTEMA DE BOTONES (UI KIT)
           ========================================================= 
        */
        .btn-apex {
            padding: 16px 28px;
            border-radius: 20px;
            border: none;
            font-weight: 800;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            gap: 12px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-blue { background: var(--brand-primary); color: white; }
        .btn-sky { background: var(--brand-sky-vibrant); color: white; }
        .btn-ai { 
            background: linear-gradient(135deg, #8b5cf6 0%, #38bdf8 100%); 
            color: white; 
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.2);
        }
        .btn-outline { 
            background: white; color: var(--brand-primary); 
            border: 2px solid var(--brand-sky-medium); 
        }

        .btn-apex:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .btn-apex:active { transform: scale(0.95); }

        /* =========================================================
           DOCK DE NAVEGACIÓN (MOBILE FIRST)
           ========================================================= 
        */
        .dock-container {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 700px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            padding: 15px;
            border-radius: 40px;
            display: flex; justify-content: space-around;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: var(--shadow-lg);
            z-index: 5000;
        }

        .dock-item {
            background: none; border: none;
            color: var(--ui-text-gray);
            display: flex; flex-direction: column;
            align-items: center; gap: 6px;
            cursor: pointer; font-size: 0.7rem;
            font-weight: 800; text-transform: uppercase;
            width: 20%; transition: 0.4s;
        }

        .dock-item i { font-size: 1.5rem; }
        .dock-item.active { color: var(--brand-primary); transform: translateY(-8px); }

        /* =========================================================
           ESTADOS Y BADGES
           ========================================================= 
        */
        .badge-status {
            padding: 8px 16px;
            border-radius: 14px;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .bg-conf { background: #ede9fe; color: var(--state-confeccion); }
        .bg-bod { background: #fef3c7; color: var(--state-bodega); }
        .bg-des { background: #dcfce7; color: var(--state-despachado); }
        .bg-err { background: #fee2e2; color: var(--state-alerta); }

        /* =========================================================
           LOADDER Y OVERLAYS
           ========================================================= 
        */
        #global-spinner {
            display: none; position: fixed; inset: 0;
            background: rgba(240, 249, 255, 0.95);
            z-index: 20000; align-items: center;
            justify-content: center; flex-direction: column;
            backdrop-filter: blur(12px);
        }

        .spin-orb {
            width: 80px; height: 80px;
            border: 8px solid var(--ui-white);
            border-top-color: var(--brand-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* =========================================================
           ESTILO DE TABLAS Y LISTAS
           ========================================================= 
        */
        .multi-input-row {
            background: var(--brand-sky-light);
            padding: 25px; border-radius: 25px;
            margin-bottom: 20px; border: 1px solid var(--brand-sky-medium);
            position: relative;
        }

        .remove-row-btn {
            position: absolute; top: 15px; right: 15px;
            color: var(--state-alerta); cursor: pointer;
            font-size: 1.4rem;
        }

        /* =========================================================
           CALENDARIO PRO
           ========================================================= 
        */
        .cal-wrapper {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px;
        }
        .cal-day-unit {
            aspect-ratio: 1; background: var(--ui-white);
            border-radius: 18px; display: flex;
            align-items: center; justify-content: center;
            font-weight: 800; cursor: pointer;
            border: 2px solid var(--brand-sky-light);
            position: relative; transition: 0.2s;
        }
        .cal-day-unit:hover { border-color: var(--brand-sky-vibrant); background: var(--brand-sky-light); }
        .cal-day-unit.today { background: var(--brand-primary); color: white; }
        .dot-marker {
            width: 6px; height: 6px; background: var(--state-bodega);
            border-radius: 50%; position: absolute; bottom: 8px;
        }
    </style>
</head>
<body>

<div id="global-spinner">
    <div class="spin-orb"></div>
    <h2 style="margin-top: 25px; color: var(--brand-primary); font-weight: 900;">PROCESANDO INTELIGENCIA...</h2>
    <p style="color: var(--ui-text-gray); font-weight: 600;">IDEAS TEXTILES SPA - V46</p>
</div>

<div id="gatekeeper-screen">
    <div class="auth-card">
        <i class="fa-solid fa-scissors auth-icon"></i>
        <h1>IDEAS TEXTILES SPA</h1>
        <p style="color: var(--ui-text-gray); font-weight: 800; margin-bottom: 35px; font-size: 0.85rem;">TERMINAL CENTRAL DE PRODUCCIÓN</p>
        
        <div style="margin-bottom: 25px;">
            <input type="text" id="operador_id" placeholder="NOMBRE DEL OPERADOR" 
                   style="width: 100%; padding: 22px; border-radius: 20px; border: 2px solid var(--brand-sky-medium); outline: none; text-align: center; font-weight: 800; color: var(--brand-primary); font-size: 1.1rem; text-transform: uppercase;">
        </div>

        <button class="btn-apex btn-blue" style="width: 100%; height: 70px;" onclick="Apex.Auth.login()">
            INGRESAR AL PANEL <i class="fa-solid fa-arrow-right-long"></i>
        </button>
    </div>
</div>

<header>
    <div class="brand-box">
        <i class="fa-solid fa-scissors"></i>
        <div class="brand-text">
            <h2>IDEAS TEXTILES SPA</h2>
            <span id="label-operador">AUDITORÍA ACTIVA</span>
        </div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn-apex btn-ai" style="padding: 12px 20px; font-size: 0.8rem;" onclick="Apex.IO.clickUpload()">
            <i class="fa-solid fa-file-pdf"></i> SCAN / CARGA IA
        </button>
    </div>
</header>

<main class="view-container">

    <section id="view-bodega" class="system-view active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2 style="color: var(--brand-primary); font-weight: 900; font-size: 1.6rem;">STOCK EN BODEGA</h2>
            <button class="btn-apex btn-blue" onclick="Apex.UI.openMultiProductMatrix()">
                <i class="fa-solid fa-layer-group"></i> CARGA MASIVA
            </button>
        </div>
        <div id="render-inventory">
            </div>
    </section>

    <section id="view-ordenes" class="system-view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2 style="color: var(--brand-primary); font-weight: 900; font-size: 1.6rem;">ÓRDENES (OC)</h2>
            <button class="btn-apex btn-outline" onclick="Apex.OC.createManual()">
                <i class="fa-solid fa-file-circle-plus"></i> NUEVA OC
            </button>
        </div>
        <div id="render-orders">
            </div>
    </section>

    <section id="view-agenda" class="system-view">
        <div class="card-titan">
            <div class="card-header">
                <h3>BITÁCORA DE OPERACIONES</h3>
            </div>
            <div class="cal-wrapper" id="render-calendar">
                </div>
        </div>
        <div id="render-day-logs"></div>
    </section>

</main>

<nav class="dock-container">
    <button class="dock-item active" onclick="Apex.UI.switchTab('bodega', this)">
        <i class="fa-solid fa-warehouse"></i><span>Bodega</span>
    </button>
    <button class="dock-item" onclick="Apex.UI.switchTab('ordenes', this)">
        <i class="fa-solid fa-list-check"></i><span>Órdenes</span>
    </button>
    <button class="dock-item" onclick="Apex.UI.switchTab('agenda', this)">
        <i class="fa-solid fa-calendar-alt"></i><span>Agenda</span>
    </button>
    <button class="dock-item" onclick="Apex.System.exportJSON()">
        <i class="fa-solid fa-file-export"></i><span>Exportar</span>
    </button>
</nav>

<input type="file" id="master-file-input" hidden multiple accept="image/*,.pdf,.xlsx,.xls">

<script>
/**
 * APEX TITAN ENGINE V46
 * Arquitectura de objeto único para evitar colisiones y asegurar persistencia.
 */
const Apex = {
    // --- ESTADO INICIAL ---
    state: {
        currentOperator: localStorage.getItem('apex_op_v46') || null,
        inventory: JSON.parse(localStorage.getItem('apex_inv_v46')) || [],
        orders: JSON.parse(localStorage.getItem('apex_ord_v46')) || [],
        logs: JSON.parse(localStorage.getItem('apex_log_v46')) || {},
        workerIA: null,
        pdfJS: window['pdfjs-dist/build/pdf']
    },

    // --- MÓDULO DE AUTENTICACIÓN ---
    Auth: {
        login() {
            const val = document.getElementById('operador_id').value.trim().toUpperCase();
            if (val.length >= 3) {
                Apex.state.currentOperator = val;
                localStorage.setItem('apex_op_v46', val);
                
                Swal.fire({
                    icon: 'success',
                    title: 'SISTEMA INICIADO',
                    text: `Bienvenido al terminal, Operador ${val}`,
                    showConfirmButton: false,
                    timer: 1500,
                    background: '#f0f9ff'
                }).then(() => {
                    document.getElementById('gatekeeper-screen').style.display = 'none';
                    Apex.System.init();
                });
            } else {
                Swal.fire('ERROR', 'Identificación demasiado corta.', 'error');
            }
        }
    },

    // --- MÓDULO DE INTERFAZ (UI) ---
    UI: {
        switchTab(tabId, element) {
            // Cambio de vistas
            document.querySelectorAll('.system-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
            
            document.getElementById(`view-${tabId}`).classList.add('active');
            element.classList.add('active');
            
            // Recargas específicas
            if (tabId === 'agenda') Apex.UI.renderCalendar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        renderAll() {
            this.renderInventory();
            this.renderOrders();
            document.getElementById('label-operador').innerText = `OPERADOR: ${Apex.state.currentOperator}`;
        },

        renderInventory() {
            const container = document.getElementById('render-inventory');
            if (Apex.state.inventory.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:80px; color:var(--ui-text-gray);">
                        <i class="fa-solid fa-box-open" style="font-size:4rem; opacity:0.2; margin-bottom:20px;"></i>
                        <p style="font-weight:800;">BODEGA VACÍA</p>
                        <p style="font-size:0.8rem;">Cargue un Excel o ingrese productos manualmente.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = Apex.state.inventory.map((item, idx) => `
                <div class="card-titan">
                    <div class="card-header">
                        <div>
                            <h3>${item.name}</h3>
                            <small style="font-weight:800; color:var(--ui-text-gray)">
                                <i class="fa-solid fa-clock-rotate-left"></i> ACT: ${item.lastUpdate}
                            </small>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-apex btn-outline" style="padding:8px 12px;" onclick="Apex.UI.editProduct(${idx})">
                                <i class="fa-solid fa-pen-nib"></i>
                            </button>
                            <button class="btn-apex btn-outline" style="padding:8px 12px; color:var(--state-alerta);" onclick="Apex.Inventory.delete(${idx})">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="size-grid-display">
                        ${Object.entries(item.tallas).map(([t, q]) => `
                            <div class="size-pill" style="${q <= 0 ? 'opacity:0.3' : 'border-bottom: 4px solid var(--brand-sky-vibrant)'}">
                                <b>${t}</b>
                                <span>${q}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).reverse().join('');
        },

        renderOrders() {
            const container = document.getElementById('render-orders');
            if (Apex.state.orders.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:var(--ui-text-gray); padding:40px;">No hay órdenes pendientes.</p>`;
                return;
            }

            container.innerHTML = Apex.state.orders.map((o, idx) => {
                const isDespachado = o.status === 'despachado';
                return `
                <div class="card-titan" style="border-left: 8px solid var(--state-${o.status})">
                    <div class="card-header">
                        <span class="badge-status bg-${o.status.slice(0,3)}">${o.status}</span>
                        <small style="font-weight:900;">${o.date}</small>
                    </div>
                    <h2 style="color:var(--brand-primary); font-weight:900; margin-bottom:10px;">${o.id} | ${o.cli}</h2>
                    <div style="background:var(--brand-sky-light); padding:15px; border-radius:20px; margin-bottom:15px;">
                        <p style="font-weight:800; font-size:0.95rem;">${o.p} - TALLA ${o.t}</p>
                        <p style="font-weight:700; color:var(--ui-text-gray);">CANTIDAD: ${o.q} UNIDADES</p>
                    </div>
                    
                    ${!isDespachado ? `
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            <select class="btn-apex btn-outline" style="font-size:0.75rem; width:100%;" onchange="Apex.OC.updateStatus(${idx}, this.value)">
                                <option value="" disabled selected>ACTUALIZAR ESTADO</option>
                                <option value="confeccion">EN TALLER</option>
                                <option value="bodega">EN BODEGA</option>
                                <option value="despachado">DESPACHAR</option>
                            </select>
                            <button class="btn-apex btn-blue" style="font-size:0.75rem;" onclick="Apex.System.notify('${o.cli}', '${o.id}')">
                                <i class="fa-brands fa-whatsapp"></i> NOTIFICAR
                            </button>
                        </div>
                    ` : '<p style="color:var(--state-despacho); font-weight:900; font-size:0.8rem; text-align:center;"><i class="fa-solid fa-circle-check"></i> PEDIDO ENTREGADO</p>'}
                </div>
                `;
            }).reverse().join('');
        },

        renderCalendar() {
            const grid = document.getElementById('render-calendar');
            grid.innerHTML = '';
            const now = new Date();
            const totalDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

            for (let i = 1; i <= totalDays; i++) {
                const key = `${i}/${now.getMonth() + 1}/${now.getFullYear()}`;
                const hasLog = Apex.state.logs[key];
                grid.innerHTML += `
                    <div class="cal-day-unit ${i === now.getDate() ? 'today' : ''}" onclick="Apex.UI.viewLog('${key}')">
                        ${i}
                        ${hasLog ? '<div class="dot-marker"></div>' : ''}
                    </div>
                `;
            }
        },

        async viewLog(dateKey) {
            const content = Apex.state.logs[dateKey] || "Sin registros para este día.";
            const { value: newNote } = await Swal.fire({
                title: `BITÁCORA: ${dateKey}`,
                input: 'textarea',
                inputValue: content,
                confirmButtonText: 'GUARDAR CAMBIOS',
                confirmButtonColor: 'var(--brand-primary)'
            });

            if (newNote !== undefined) {
                Apex.state.logs[dateKey] = newNote;
                Apex.System.save();
                this.renderCalendar();
            }
        },

        async openMultiProductMatrix() {
            const rowId = () => `row_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
            const createRow = (id) => `
                <div class="multi-input-row" id="${id}">
                    <div class="remove-row-btn" onclick="document.getElementById('${id}').remove()">
                        <i class="fa-solid fa-circle-xmark"></i>
                    </div>
                    <div style="margin-bottom:15px;">
                        <label style="font-size:0.7rem; font-weight:900; color:var(--brand-primary); display:block; margin-bottom:5px;">NOMBRE DEL PRODUCTO</label>
                        <input class="swal2-input m-prod-name" placeholder="EJ: POLERA PIQUÉ NEGRA" style="width:100%; margin:0; text-transform:uppercase; font-weight:800; border-radius:15px;">
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
                        ${["S","M","L","XL","2XL","3XL","4XL","5XL"].map(t => `
                            <div style="text-align:center; background:white; padding:10px; border-radius:15px; border:1px solid var(--brand-sky-medium);">
                                <b style="font-size:0.6rem; display:block; color:var(--brand-primary);">${t}</b>
                                <input type="number" class="m-qty" data-talla="${t}" value="0" style="width:100%; border:none; text-align:center; font-weight:900; outline:none; font-size:1.1rem; color:var(--ui-text-dark);">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            const { value: result } = await Swal.fire({
                title: 'CARGA MASIVA DE BODEGA',
                html: `
                    <div id="matrix-scroll-container" style="max-height: 60vh; overflow-y:auto; padding:10px;">
                        ${createRow(rowId())}
                    </div>
                    <button class="btn-apex btn-outline" style="width:100%; margin-top:15px; border:2px dashed var(--brand-sky-vibrant);" 
                            onclick="document.getElementById('matrix-scroll-container').insertAdjacentHTML('beforeend', \`${createRow(rowId()).replace(/\n/g,'')}\`)">
                        <i class="fa-solid fa-plus-circle"></i> AÑADIR OTRO PRODUCTO A LA CARGA
                    </button>
                `,
                width: '800px',
                showCancelButton: true,
                confirmButtonText: 'CONFIRMAR CARGA A BODEGA',
                confirmButtonColor: 'var(--brand-primary)',
                preConfirm: () => {
                    const data = [];
                    document.querySelectorAll('.multi-input-row').forEach(row => {
                        const name = row.querySelector('.m-prod-name').value.trim().toUpperCase();
                        if (name) {
                            const tallas = {};
                            row.querySelectorAll('.m-qty').forEach(input => {
                                tallas[input.dataset.talla] = parseInt(input.value) || 0;
                            });
                            data.push({ name, tallas, lastUpdate: new Date().toLocaleString() });
                        }
                    });
                    if (data.length === 0) return Swal.showValidationMessage('Ingrese al menos un producto válido.');
                    return data;
                }
            });

            if (result) {
                Apex.Inventory.processBulk(result);
            }
        }
    },

    // --- MÓDULO DE INVENTARIO ---
    Inventory: {
        processBulk(items) {
            items.forEach(newItem => {
                const existingIndex = Apex.state.inventory.findIndex(i => i.name === newItem.name);
                if (existingIndex > -1) {
                    // Acumular Stock
                    Object.keys(newItem.tallas).forEach(t => {
                        Apex.state.inventory[existingIndex].tallas[t] += newItem.tallas[t];
                    });
                    Apex.state.inventory[existingIndex].lastUpdate = new Date().toLocaleString();
                } else {
                    // Nuevo Producto
                    Apex.state.inventory.push(newItem);
                }
            });
            Apex.System.save();
            Swal.fire('ÉXITO', `${items.length} productos procesados en bodega.`, 'success');
        },

        delete(idx) {
            Swal.fire({
                title: '¿ELIMINAR PRODUCTO?',
                text: 'Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: 'var(--state-alerta)'
            }).then((res) => {
                if (res.isConfirmed) {
                    Apex.state.inventory.splice(idx, 1);
                    Apex.System.save();
                }
            });
        }
    },

    // --- MÓDULO DE ÓRDENES (OC) ---
    OC: {
        async createManual(defP = "", defQ = 1) {
            const { value: form } = await Swal.fire({
                title: 'REGISTRO DE ÓRDEN',
                html: `
                    <input id="oc-cli" class="swal2-input" placeholder="Nombre del Cliente" style="width:100%">
                    <input id="oc-prod" class="swal2-input" placeholder="Producto / SKU" value="${defP}" style="width:100%; text-transform:uppercase;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <select id="oc-talla" class="swal2-input">
                            <option>S</option><option selected>M</option><option>L</option>
                            <option>XL</option><option>2XL</option><option>3XL</option>
                            <option>4XL</option><option>5XL</option>
                        </select>
                        <input id="oc-qty" type="number" class="swal2-input" value="${defQ}">
                    </div>
                `,
                preConfirm: () => ({
                    id: `OC-${Math.floor(1000 + Math.random() * 8999)}`,
                    cli: document.getElementById('oc-cli').value || 'CLIENTE GENERAL',
                    p: document.getElementById('oc-prod').value.toUpperCase(),
                    t: document.getElementById('oc-talla').value,
                    q: parseInt(document.getElementById('oc-qty').value) || 1,
                    status: 'confeccion',
                    date: new Date().toLocaleDateString()
                })
            });

            if (form) {
                Apex.state.orders.push(form);
                Apex.System.save();
            }
        },

        updateStatus(idx, newStatus) {
            const order = Apex.state.orders[idx];
            
            if (newStatus === 'despachado') {
                const prod = Apex.state.inventory.find(i => i.name === order.p);
                if (prod && prod.tallas[order.t] >= order.q) {
                    prod.tallas[order.t] -= order.q;
                    order.status = 'despachado';
                    Apex.System.logAction(`DESPACHO: ${order.id} - ${order.cli}`);
                    Apex.System.save();
                    Swal.fire('DESPACHADO', 'El stock ha sido descontado correctamente.', 'success');
                } else {
                    Swal.fire('STOCK INSUFICIENTE', 'No hay suficientes unidades en bodega para despachar esta orden.', 'error');
                }
            } else {
                order.status = newStatus;
                Apex.System.save();
            }
        }
    },

    // --- MÓDULO DE ARCHIVOS Y IA (THE BIG CORE) ---
    IO: {
        clickUpload() { document.getElementById('master-file-input').click(); },

        async processFiles(files) {
            document.getElementById('global-spinner').style.display = 'flex';
            
            for (let file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                
                try {
                    if (['xlsx', 'xls'].includes(ext)) {
                        await this.handleExcel(file);
                    } else if (['jpg', 'jpeg', 'png'].includes(ext)) {
                        await this.handleIA(file);
                    } else if (ext === 'pdf') {
                        await this.handlePDF(file);
                    }
                } catch (err) {
                    console.error("Error procesando archivo:", err);
                    Swal.fire('ERROR DE LECTURA', `No se pudo procesar ${file.name}`, 'error');
                }
            }
            
            document.getElementById('global-spinner').style.display = 'none';
        },

        async handleExcel(file) {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);

            let addedCount = 0;
            json.forEach(row => {
                const name = (row.PRODUCTO || row.Producto || row.Nombre || row.item || "").toUpperCase();
                if (name) {
                    const tallas = {
                        "S": row.S || 0, "M": row.M || 0, "L": row.L || 0, "XL": row.XL || 0,
                        "2XL": row['2XL'] || row['2xl'] || 0, "3XL": row['3XL'] || 0,
                        "4XL": row['4XL'] || 0, "5XL": row['5XL'] || 0
                    };
                    Apex.Inventory.processBulk([{ name, tallas, lastUpdate: 'CARGA EXCEL' }]);
                    addedCount++;
                }
            });
            Apex.System.logAction(`Importación Excel: ${addedCount} filas procesadas.`);
        },

        async handleIA(file) {
            if (!Apex.state.workerIA) {
                Apex.state.workerIA = await Tesseract.createWorker();
                await Apex.state.workerIA.loadLanguage('spa');
                await Apex.state.workerIA.initialize('spa');
            }
            
            const { data: { text } } = await Apex.state.workerIA.recognize(file);
            this.interpretText(text);
        },

        async handlePDF(file) {
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await Apex.state.pdfJS.getDocument(typedarray).promise;
                let fullText = "";
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(s => s.str).join(' ');
                }
                
                Apex.IO.interpretText(fullText);
            };
            reader.readAsArrayBuffer(file);
        },

        interpretText(text) {
            console.log("[IA ANALYSIS]", text);
            const cleanText = text.toUpperCase();
            
            // Lógica heurística para encontrar datos en el desorden de una foto
            let detectedProd = "DOC ESCANEADO";
            let detectedQty = 1;

            const lines = cleanText.split('\n');
            lines.forEach(l => {
                if (l.length > 5 && /\d/.test(l)) {
                    const numbers = l.match(/\d+/);
                    if (numbers) detectedQty = parseInt(numbers[0]);
                    detectedProd = l.replace(/[0-9]/g, '').trim().substring(0, 20);
                }
            });

            Apex.OC.createManual(detectedProd, detectedQty);
        }
    },

    // --- MÓDULO DEL SISTEMA (BASE DE DATOS Y CONFIG) ---
    System: {
        init() {
            console.log("[SYSTEM] Apex Titan V46 Online");
            Apex.UI.renderAll();
            
            // Configuración de listeners
            document.getElementById('master-file-input').addEventListener('change', (e) => {
                Apex.IO.processFiles(e.target.files);
            });
        },

        save() {
            localStorage.setItem('apex_inv_v46', JSON.stringify(Apex.state.inventory));
            localStorage.setItem('apex_ord_v46', JSON.stringify(Apex.state.orders));
            localStorage.setItem('apex_log_v46', JSON.stringify(Apex.state.logs));
            Apex.UI.renderAll();
        },

        logAction(msg) {
            const date = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            Apex.state.logs[date] = (Apex.state.logs[date] || "") + `\n[${time}] ${msg}`;
            this.save();
        },

        notify(cliente, ocId) {
            const text = encodeURIComponent(`*IDEAS TEXTILES SPA*\nHola ${cliente}, informamos que su orden *${ocId}* ya se encuentra disponible para retiro/despacho.`);
            window.open(`https://wa.me/569XXXXXXXX?text=${text}`);
        },

        exportJSON() {
            const data = JSON.stringify(Apex.state);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `RESPALDO_IDEAS_TEXTILES_${Date.now()}.json`;
            link.click();
        }
    }
};

// --- ARRANCAR EL MOTOR ---
window.onload = () => {
    if (Apex.state.currentOperator) {
        document.getElementById('gatekeeper-screen').style.display = 'none';
        Apex.System.init();
    }
};

</script>
</body>
</html>
