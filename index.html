<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEAS TEXTILES | SISTEMA INTEGRAL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #f59e0b; --dark: #0f172a; }
        body { font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        
        /* SYNC STATUS */
        .sync-indicator { position: fixed; top: 20px; right: 20px; z-index: 999; display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 50px; font-size: 11px; font-weight: 800; text-transform: uppercase; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .sync-online { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .sync-offline { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        /* LAYOUT */
        .sidebar { background: var(--dark); height: 100vh; position: sticky; top: 0; transition: all 0.3s; z-index: 50; }
        .nav-link { display: flex; align-items: center; padding: 12px 16px; border-radius: 12px; color: #94a3b8; font-weight: 600; transition: 0.2s; cursor: pointer; margin-bottom: 4px; }
        .nav-link:hover { background: #1e293b; color: white; }
        .nav-link.active { background: var(--primary); color: var(--dark); }

        /* TARJETAS */
        .card-stat { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; }
        .lote-card { background: white; border-radius: 16px; border-left: 6px solid var(--primary); padding: 16px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .step-pill { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; display: inline-block; margin-right: 4px; margin-bottom: 4px; }
        .step-done { background: #22c55e; color: white; border-color: #22c55e; }

        /* --- PDF WORKSPACE (SOLUCI√ìN TACHA BLANCA) --- */
        /* Ahora es un overlay visible que tapa la pantalla mientras genera */
        #pdf-workspace { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: white; 
            z-index: 20000; /* Encima de todo */
            overflow-y: auto;
            display: none; /* Se muestra solo al imprimir */
            padding: 20px;
        }
        
        /* Dise√±o Hoja A4 */
        .pdf-sheet-6up { width: 210mm; min-height: 297mm; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; gap: 15px; padding: 10px; box-sizing: border-box; page-break-after: always; background: white; border: 1px solid #eee; }
        .tacha-card-6up { border: 2px dashed #94a3b8; background: #fff; padding: 0; display: flex; flex-direction: column; height: 100%; border-radius: 6px; overflow: hidden; position: relative; }

        /* CALENDARIO */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .calendar-day { min-height: 80px; background: white; padding: 4px; font-size: 0.8rem; cursor: pointer; }
        .calendar-day.today { background: #fffbeb; }
        .cal-event { font-size: 0.65rem; padding: 2px 4px; border-radius: 3px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; font-weight: bold; }

        /* M√ìVIL FIX (Espacio inferior) */
        @media (max-width: 1024px) {
            .sidebar { position: fixed; width: 100%; height: auto; bottom: 0; top: auto; flex-direction: row; padding: 10px; justify-content: space-around; border-top: 1px solid #334155; }
            .sidebar h1, .sidebar p, .sidebar .mt-auto { display: none; }
            .nav-link span { display: none; }
            .nav-link { padding: 10px; justify-content: center; }
            main { padding-bottom: 150px !important; } /* AUMENTADO PARA QUE NO TAPE */
        }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-white/95 z-[9999] flex flex-col justify-center items-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-amber-500 rounded-full animate-spin mb-4"></div>
        <h2 class="font-bold text-slate-700 text-sm tracking-widest">CARGANDO...</h2>
    </div>

    <div id="pdf-workspace"></div>

    <div id="sync-status" class="sync-indicator sync-offline">
        <i class="fas fa-circle text-[8px] animate-pulse"></i> <span id="sync-text">Conectando...</span>
    </div>

    <div class="flex flex-col lg:flex-row min-h-screen">
        <aside class="sidebar w-full lg:w-72 flex flex-col p-6 shadow-2xl">
            <div class="mb-10 hidden lg:block">
                <h1 class="text-white text-2xl font-black tracking-tighter italic">IDEAS<span class="text-amber-500">TEXTILES</span></h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[3px]">Gesti√≥n Integral</p>
            </div>

            <nav class="flex-1 lg:space-y-2 flex lg:block w-full justify-between lg:justify-start">
                <div onclick="ui.show('dashboard')" class="nav-link active" id="btn-dashboard"><i class="fas fa-chart-pie w-6"></i> <span class="ml-3">Dashboard</span></div>
                <div onclick="ui.show('inventory')" class="nav-link" id="btn-inventory"><i class="fas fa-boxes w-6"></i> <span class="ml-3">Bodega</span></div>
                <div onclick="ui.show('production')" class="nav-link" id="btn-production"><i class="fas fa-industry w-6"></i> <span class="ml-3">Taller</span></div>
                <div onclick="ui.show('orders')" class="nav-link" id="btn-orders"><i class="fas fa-file-invoice w-6"></i> <span class="ml-3">√ìrdenes</span></div>
                <div onclick="ui.show('calendar')" class="nav-link" id="btn-calendar"><i class="fas fa-calendar-alt w-6"></i> <span class="ml-3">Agenda</span></div>
            </nav>

            <div class="mt-auto pt-6 border-t border-slate-800 hidden lg:block">
                <button onclick="ReportEngine.generateGeneralPDF()" class="w-full bg-slate-800 text-white p-3 rounded-xl text-xs font-bold hover:bg-slate-700 transition mb-2">
                    <i class="fas fa-file-pdf text-red-500 mr-2"></i> REPORTE GENERAL
                </button>
            </div>
        </aside>

        <main class="flex-1 p-4 lg:p-10 overflow-x-hidden">
            
            <section id="dashboard" class="animate-in fade-in">
                <h2 class="text-2xl font-black text-slate-800 mb-6">PANEL DE CONTROL</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="card-stat"><div class="text-slate-400 text-[10px] font-bold uppercase">Items Bodega</div><div class="text-3xl font-black text-slate-800" id="st-inv">0</div></div>
                    <div class="card-stat"><div class="text-slate-400 text-[10px] font-bold uppercase">Lotes Activos</div><div class="text-3xl font-black text-amber-500" id="st-prod">0</div></div>
                    <div class="card-stat"><div class="text-slate-400 text-[10px] font-bold uppercase">OC Pendientes</div><div class="text-3xl font-black text-blue-600" id="st-ord">0</div></div>
                    <div class="card-stat cursor-pointer hover:bg-red-50" onclick="actions.reset()"><div class="text-red-400 text-[10px] font-bold uppercase">Zona de Peligro</div><div class="text-xs font-bold text-red-600 mt-2">RESET DATOS</div></div>
                </div>
            </section>

            <section id="inventory" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-slate-800">BODEGA</h2>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('ai-file').click()" class="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg hover:bg-indigo-700"><i class="fas fa-file-import"></i></button>
                        <button onclick="ui.modalItem()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg">+ ITEM</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase"><tr><th class="p-4">SKU</th><th class="p-4">Producto</th><th class="p-4 text-center">Stock</th><th class="p-4 text-right">Acci√≥n</th></tr></thead>
                        <tbody id="tb-inv" class="text-sm"></tbody>
                    </table>
                </div>
            </section>

            <section id="production" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-slate-800">TALLER</h2>
                    <button onclick="ui.modalProd()" class="bg-amber-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-amber-200">+ LOTE</button>
                </div>
                <div id="grid-prod" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </section>

            <section id="orders" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-slate-800">√ìRDENES</h2>
                    <div class="flex gap-2">
                        <button onclick="ui.printTachas()" class="bg-slate-700 text-white px-3 py-2 rounded-xl text-xs font-bold"><i class="fas fa-print"></i> TACHAS</button>
                        <button onclick="ui.modalOrder()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-blue-200">+ OC</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase"><tr><th class="p-4 w-8"><input type="checkbox" onchange="ui.checkAll(this)"></th><th class="p-4">Cliente / OC</th><th class="p-4">Estado</th><th class="p-4 text-right">Acci√≥n</th></tr></thead>
                        <tbody id="tb-ord" class="text-sm"></tbody>
                    </table>
                </div>
            </section>

            <section id="calendar" class="hidden">
                <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm">
                    <button onclick="cal.move(-1)"><i class="fas fa-chevron-left text-slate-400"></i></button>
                    <h2 class="text-lg font-black text-slate-800 uppercase" id="cal-title"></h2>
                    <button onclick="cal.move(1)"><i class="fas fa-chevron-right text-slate-400"></i></button>
                </div>
                <div id="cal-grid" class="calendar-grid"></div>
            </section>

        </main>
    </div>

    <div id="modal-wrapper" class="fixed inset-0 bg-slate-900/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div id="modal-content" class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl transform transition-all scale-95 opacity-0"></div>
    </div>

    <input type="file" id="ai-file" hidden accept=".xlsx,.xls,.csv,.pdf,image/*" onchange="IA.process(this)">

    <script>
        // UTILIDADES
        function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

        // FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew", authDomain: "ideastextilesapp.firebaseapp.com", databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com", projectId: "ideastextilesapp", storageBucket: "ideastextilesapp.firebasestorage.app", messagingSenderId: "268995530035", appId: "1:268995530035:web:1890f45ac761cc81eb0246" };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref();

        // ESTADO
        let state = { inv: [], ord: [], prod: [], cal: {} };
        let tempItems = [], iaDetectedItems = [];

        // SYNC
        const Sync = {
            init() {
                firebase.database().ref('.info/connected').on('value', snap => {
                    const el = document.getElementById('sync-status');
                    const txt = document.getElementById('sync-text');
                    if(snap.val()) { el.className='sync-indicator sync-online'; txt.innerText="ONLINE"; }
                    else { el.className='sync-indicator sync-offline'; txt.innerText="OFFLINE"; }
                });

                const nodes = ['inv', 'ord', 'prod', 'cal'];
                let loadedCount = 0;
                nodes.forEach(node => {
                    dbRef.child(node).on('value', snap => {
                        let data = snap.val() || (node==='cal'?{}:[]);
                        if(node!=='cal' && data && typeof data==='object' && !Array.isArray(data)) data = Object.values(data);
                        state[node] = data;
                        ui.refresh(node);
                        ui.updateStats();
                        loadedCount++;
                        if(loadedCount >= 1) ui.toggleLoader(false);
                    });
                });
            },
            save(node) {
                dbRef.child(node).set(state[node]).catch(e => alert("Error guardando: "+e.message));
            }
        };

        // UI
        const ui = {
            toggleLoader(show, txt){ 
                const l=document.getElementById('loader'); 
                if(!l) return; 
                if(txt) document.querySelector('#loader h2').innerText = txt;
                if(show){ l.style.display='flex'; setTimeout(()=>l.style.opacity='1',10); } 
                else { l.style.opacity='0'; setTimeout(()=>l.style.display='none',400); } 
            },
            show(id) {
                document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const btn = document.getElementById('btn-'+id); if(btn) btn.classList.add('active');
                if(id==='calendar') cal.render();
            },
            updateStats() {
                document.getElementById('st-inv').innerText = state.inv.length;
                document.getElementById('st-prod').innerText = state.prod.length;
                document.getElementById('st-ord').innerText = state.ord.filter(o=>o.st!=='Despachado').length;
            },
            refresh(node) {
                if(node === 'inv') {
                    document.getElementById('tb-inv').innerHTML = state.inv.map((p,i) => `
                        <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                            <td class="p-4 font-mono text-xs text-slate-500 font-bold">${esc(p.sku)}</td>
                            <td class="p-4 font-medium">${esc(p.n)}</td>
                            <td class="p-4 text-center"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-md text-xs font-bold">${p.q}</span></td>
                            <td class="p-4 text-right flex justify-end gap-2">
                                <button onclick="actions.openSalida(${i})" class="bg-red-50 text-red-600 px-2 py-1 rounded-md text-[10px] font-bold border border-red-100">SALIDA</button>
                                <button onclick="ui.modalItem(${i})" class="text-slate-400 hover:text-blue-500"><i class="fas fa-edit"></i></button>
                                <button onclick="actions.del('inv',${i})" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('');
                }
                if(node === 'ord') {
                    document.getElementById('tb-ord').innerHTML = state.ord.map((o,i) => {
                        // DETALLE EN LISTA (SOLICITADO)
                        let itemsSummary = (o.its||[]).map(it => `${it.n} (${it.q})`).join(', ');
                        if(itemsSummary.length > 50) itemsSummary = itemsSummary.substring(0,50) + '...';
                        if(!itemsSummary) itemsSummary = "Sin productos";

                        return `
                        <tr class="border-b border-slate-50 hover:bg-slate-50 transition border-l-4 ${o.st==='Pendiente'?'border-l-amber-400':(o.st==='Despachado'?'border-l-green-500':'border-l-blue-500')}">
                            <td class="p-4 text-center"><input type="checkbox" class="chk-ord w-4 h-4" value="${i}"></td>
                            <td class="p-4">
                                <div class="font-bold text-slate-800 text-sm">#${esc(o.id)}</div>
                                <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wide">${esc(o.c)}</div>
                                <div class="text-[10px] text-slate-400 mt-1 italic"><i class="fas fa-box-open mr-1"></i>${itemsSummary}</div>
                            </td>
                            <td class="p-4"><span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase ${o.st==='Pendiente'?'bg-amber-100 text-amber-700':(o.st==='Despachado'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700')}">${esc(o.st)}</span></td>
                            <td class="p-4 text-right">
                                <button onclick="ui.modalOrder(${i})" class="text-slate-400 hover:text-blue-500 mr-2"><i class="fas fa-edit"></i></button>
                                <button onclick="actions.del('ord',${i})" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `}).join('');
                }
                if(node === 'prod') {
                    document.getElementById('grid-prod').innerHTML = state.prod.map((w,i) => {
                        const pct = Math.round((w.s.filter(s=>s.d).length/4)*100);
                        return `
                        <div class="lote-card">
                            <div class="flex justify-between mb-2">
                                <h4 class="font-bold text-sm uppercase">${esc(w.n)}</h4>
                                <button onclick="actions.del('prod',${i})" class="text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="text-xs text-slate-500 mb-3 font-mono">${w.total} UNIDADES</div>
                            <div class="h-1.5 bg-slate-100 rounded-full mb-3 overflow-hidden"><div class="h-full bg-amber-500 transition-all duration-500" style="width:${pct}%"></div></div>
                            <div>
                                ${w.s.map((s,si) => `<span onclick="actions.step(${i},${si})" class="step-pill ${s.d?'step-done':''}">${s.l}</span>`).join('')}
                            </div>
                        </div>`;
                    }).join('');
                }
            },
            openModal(html, wide=false) {
                const w = document.getElementById('modal-wrapper');
                const c = document.getElementById('modal-content');
                c.className = `bg-white rounded-3xl p-6 shadow-2xl transform transition-all scale-95 opacity-0 ${wide?'w-full max-w-2xl':'w-full max-w-md'}`;
                c.innerHTML = html;
                w.classList.remove('hidden');
                setTimeout(() => { c.classList.remove('scale-95', 'opacity-0'); }, 10);
            },
            closeModal() {
                const w = document.getElementById('modal-wrapper');
                const c = document.getElementById('modal-content');
                c.classList.add('scale-95', 'opacity-0');
                setTimeout(() => w.classList.add('hidden'), 200);
            },
            modalItem(i=-1) {
                window.currInv = i;
                const p = i>=0 ? state.inv[i] : {sku:'SKU-'+Date.now(), n:'', q:0};
                this.openModal(`
                    <h3 class="text-xl font-black text-slate-800 mb-4">${i>=0?'Editar':'Nuevo'} Producto</h3>
                    <input id="m-sku" class="w-full bg-slate-50 p-3 rounded-xl mb-3 border border-slate-200 font-mono text-sm" value="${esc(p.sku)}">
                    <input id="m-n" class="w-full bg-slate-50 p-3 rounded-xl mb-3 border border-slate-200" placeholder="Nombre" value="${esc(p.n)}">
                    <input id="m-q" type="number" class="w-full bg-slate-50 p-3 rounded-xl mb-6 border border-slate-200" placeholder="Stock" value="${p.q}">
                    <button onclick="actions.saveItem()" class="w-full bg-slate-900 text-white p-3 rounded-xl font-bold">GUARDAR</button>
                    <button onclick="ui.closeModal()" class="w-full mt-2 text-slate-400 text-xs">CANCELAR</button>
                `);
            },
            modalOrder(i=-1) {
                window.currOrd = i;
                const o = i>=0 ? state.ord[i] : {id:Math.floor(Math.random()*10000), c:'', d:new Date().toISOString().split('T')[0], st:'Pendiente', its:[]};
                tempItems = JSON.parse(JSON.stringify(o.its||[]));
                window.renderTempOrd = () => {
                    document.getElementById('m-lst').innerHTML = tempItems.map((x,ix)=>`<div class="flex justify-between text-xs p-2 border-b"><span>${x.n} (${x.q})</span> <span onclick="tempItems.splice(${ix},1); renderTempOrd()" class="text-red-500 cursor-pointer">x</span></div>`).join('');
                };
                this.openModal(`
                    <h3 class="text-xl font-black text-slate-800 mb-4">Orden de Compra</h3>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input id="m-id" class="bg-slate-50 p-2 rounded-lg border text-sm" value="${esc(o.id)}">
                        <input id="m-d" type="date" class="bg-slate-50 p-2 rounded-lg border text-sm" value="${o.d}">
                    </div>
                    <input id="m-c" class="w-full bg-slate-50 p-3 rounded-xl mb-3 border" placeholder="Cliente" value="${esc(o.c)}">
                    <select id="m-st" class="w-full bg-white p-3 rounded-xl mb-3 border"><option>${o.st}</option><option>Pendiente</option><option>En Proceso</option><option>Despachado</option></select>
                    <div class="bg-slate-50 p-3 rounded-xl mb-4 border h-32 overflow-y-auto">
                        <div class="flex gap-2 mb-2"><input id="tmp-n" class="w-full p-1 text-xs border rounded" placeholder="Prod"><input id="tmp-q" class="w-12 p-1 text-xs border rounded" placeholder="#"><button onclick="if(document.getElementById('tmp-n').value){tempItems.push({n:document.getElementById('tmp-n').value, q:document.getElementById('tmp-q').value}); renderTempOrd();}" class="bg-blue-500 text-white px-2 rounded">+</button></div>
                        <div id="m-lst"></div>
                    </div>
                    <button onclick="actions.saveOrder()" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">GUARDAR</button>
                    <button onclick="ui.closeModal()" class="w-full mt-2 text-slate-400 text-xs">CANCELAR</button>
                `);
                window.renderTempOrd();
            },
            modalProd() {
                tempItems = [];
                window.renderTempProd = () => {
                    document.getElementById('p-lst').innerHTML = tempItems.map((x,ix)=>`<div class="flex justify-between text-xs p-2 border-b"><span>${x.n} (${x.talla||'U'}) x${x.q}</span> <span onclick="tempItems.splice(${ix},1); renderTempProd()" class="text-red-500 cursor-pointer">x</span></div>`).join('');
                };
                const opts = state.inv.map(p=>`<option value="${p.n}">${p.n}</option>`).join('');
                this.openModal(`
                    <h3 class="text-xl font-black text-slate-800 mb-4">Lanzar Lote</h3>
                    <input id="p-n" class="w-full bg-slate-50 p-3 rounded-xl mb-3 border" placeholder="Nombre Lote (Ej: Pantalones)">
                    <div class="bg-slate-50 p-3 rounded-xl mb-4 border">
                        <div class="flex gap-1 mb-2">
                            <select id="p-sel" class="w-full p-1 text-xs border rounded"><option value="">Selec...</option>${opts}</select>
                            <input id="p-t" class="w-16 p-1 text-xs border rounded" placeholder="Talla">
                            <input id="p-q" class="w-12 p-1 text-xs border rounded" placeholder="#">
                            <button onclick="if(document.getElementById('p-sel').value){tempItems.push({n:document.getElementById('p-sel').value, talla:document.getElementById('p-t').value, q:parseInt(document.getElementById('p-q').value)}); renderTempProd();}" class="bg-amber-500 text-white px-2 rounded">+</button>
                        </div>
                        <div id="p-lst" class="h-24 overflow-y-auto bg-white border rounded p-1"></div>
                    </div>
                    <button onclick="actions.createLote()" class="w-full bg-amber-500 text-white p-3 rounded-xl font-bold">LANZAR</button>
                    <button onclick="ui.closeModal()" class="w-full mt-2 text-slate-400 text-xs">CANCELAR</button>
                `);
            },
            checkAll(el) { document.querySelectorAll('.chk-ord').forEach(c => c.checked = el.checked); },
            printTachas() {
                if(document.querySelectorAll('.chk-ord:checked').length === 0) return alert("Selecciona OCs");
                this.openModal(`
                    <h3 class="text-xl font-black text-slate-800 mb-4">Datos Despacho</h3>
                    <input id="pr-b" class="w-full p-3 border rounded-xl mb-2" placeholder="Bultos (Ej: 3 Cajas)">
                    <input id="pr-t" class="w-full p-3 border rounded-xl mb-2" placeholder="Transporte / Chofer">
                    <input id="pr-r" class="w-full p-3 border rounded-xl mb-4" placeholder="Quien Recibe">
                    <button onclick="ReportEngine.tachasVenta()" class="w-full bg-slate-800 text-white p-3 rounded-xl font-bold">IMPRIMIR</button>
                `);
            },
            verifyIA(items) {
                iaDetectedItems = items;
                window.renderIATable = () => {
                    const html = iaDetectedItems.map((it, idx) => `
                        <tr class="text-xs border-b">
                            <td><input class="w-full p-1 border rounded" value="${it.sku||''}" onchange="iaDetectedItems[${idx}].sku=this.value"></td>
                            <td><input class="w-full p-1 border rounded" value="${it.n||''}" onchange="iaDetectedItems[${idx}].n=this.value"></td>
                            <td><input class="w-12 p-1 border rounded text-center" value="${it.q||0}" onchange="iaDetectedItems[${idx}].q=parseInt(this.value)"></td>
                            <td class="text-center text-red-500 cursor-pointer font-bold" onclick="iaDetectedItems.splice(${idx},1); renderIATable()">X</td>
                        </tr>
                    `).join('');
                    document.getElementById('ia-tbody').innerHTML = html;
                };
                this.openModal(`
                    <h3 class="text-xl font-black text-indigo-600 mb-2">Revisi√≥n de Datos</h3>
                    <p class="text-xs text-gray-500 mb-4">Confirma los datos detectados antes de importar.</p>
                    <div class="bg-gray-50 border rounded-xl h-64 overflow-y-auto mb-4 p-2">
                        <table class="w-full">
                            <thead class="bg-gray-200 text-xs text-gray-600 sticky top-0"><tr><th>SKU</th><th>Descripci√≥n</th><th>Cant</th><th></th></tr></thead>
                            <tbody id="ia-tbody"></tbody>
                        </table>
                        <button onclick="iaDetectedItems.push({sku:'',n:'',q:0}); renderIATable()" class="w-full mt-2 py-2 border-2 border-dashed border-gray-300 text-xs text-gray-500 font-bold rounded">+ AGREGAR FILA</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="ui.closeModal()" class="px-4 py-3 text-slate-400 font-bold text-xs">CANCELAR</button>
                        <button onclick="actions.confirmIA()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl font-bold hover:bg-indigo-700">CONFIRMAR IMPORTACI√ìN</button>
                    </div>
                `, true); 
                window.renderIATable();
            }
        };

        // ACTIONS
        const actions = {
            saveItem() {
                const p = { sku: document.getElementById('m-sku').value, n: document.getElementById('m-n').value, q: parseInt(document.getElementById('m-q').value) };
                if(p.n){ if(window.currInv>=0) state.inv[window.currInv]=p; else state.inv.push(p); Sync.save('inv'); ui.closeModal(); }
            },
            saveOrder() {
                const o = { id:document.getElementById('m-id').value, c:document.getElementById('m-c').value, d:document.getElementById('m-d').value, st:document.getElementById('m-st').value, its:tempItems };
                if(o.c){ if(window.currOrd>=0) state.ord[window.currOrd]=o; else state.ord.push(o); Sync.save('ord'); ui.closeModal(); }
            },
            createLote() {
                const n = document.getElementById('p-n').value;
                if(n && tempItems.length){ 
                    const total = tempItems.reduce((a,b)=>a+b.q,0);
                    state.prod.push({n, total, s:[{l:'Corte',d:false},{l:'Confecci√≥n',d:false},{l:'Terminaci√≥n',d:false},{l:'Bodega',d:false}], items:tempItems});
                    Sync.save('prod'); ui.closeModal();
                }
            },
            del(node, i) { if(confirm("¬øEliminar registro?")) { state[node].splice(i,1); Sync.save(node); } },
            openSalida(i) {
                window.currInv = i;
                ui.openModal(`
                    <h3 class="text-xl font-black text-red-600 mb-2">Salida Stock</h3>
                    <p class="text-sm font-bold text-slate-500 mb-4">${state.inv[i].n}</p>
                    <input id="out-q" type="number" class="w-full p-3 border-2 border-red-100 rounded-xl text-center text-xl font-bold mb-2" placeholder="Cant">
                    <input id="out-m" class="w-full p-3 border rounded-xl mb-2" placeholder="Motivo">
                    <input id="out-r" class="w-full p-3 border rounded-xl mb-4" placeholder="Responsable">
                    <button onclick="actions.execSalida()" class="w-full bg-red-600 text-white p-3 rounded-xl font-bold">CONFIRMAR</button>
                `);
            },
            execSalida() {
                const q = parseInt(document.getElementById('out-q').value);
                const m = document.getElementById('out-m').value;
                const r = document.getElementById('out-r').value;
                if(q && m && r) {
                    const item = state.inv[window.currInv];
                    if(item.q >= q) {
                        item.q -= q;
                        Sync.save('inv');
                        ReportEngine.tachaInterna(item, q, m, r);
                        ui.closeModal();
                    } else alert("Stock insuficiente");
                }
            },
            step(i, si) {
                const w = state.prod[i];
                if(w.s[si].l === 'Bodega' && !w.s[si].d) {
                    if(confirm("¬øIngresar lote a inventario?")) {
                        w.items.forEach(it => {
                            const ex = state.inv.find(p=>p.n === it.n);
                            if(ex) ex.q += it.q; else state.inv.push({sku:'LOTE-'+Date.now(), n:it.n, q:it.q});
                        });
                        Sync.save('inv'); w.s[si].d = true; 
                        if(confirm("¬øArchivar lote finalizado?")) state.prod.splice(i,1);
                        Sync.save('prod');
                    }
                } else { w.s[si].d = !w.s[si].d; Sync.save('prod'); }
            },
            reset() { if(confirm("¬øBORRAR TODOS LOS DATOS?")) firebase.database().ref('/').set(null); },
            confirmIA() {
                let count = 0;
                iaDetectedItems.forEach(it => {
                    if(it.n && it.q > 0) {
                        state.inv.push({sku: it.sku || 'IMP-'+Date.now(), n: it.n, q: it.q});
                        count++;
                    }
                });
                if(count > 0) {
                    Sync.save('inv');
                    alert(`‚úÖ ${count} productos importados.`);
                    ui.closeModal();
                } else alert("Datos incompletos.");
            }
        };

        // IA ENGINE
        const IA = {
            process(input) {
                const f = input.files[0]; if(!f) return;
                ui.toggleLoader(true, "Analizando...");
                if(f.name.match(/\.(xlsx|xls|csv)$/i)) this.parseExcel(f);
                else if(f.type === 'application/pdf') this.parsePDF(f);
                else if(f.type.startsWith('image/')) this.parseImage(f);
                input.value = '';
            },
            parseExcel(f) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    const js = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    let found = [];
                    js.forEach(row => {
                        const r = row.map(c=>String(c));
                        const nIdx = r.findIndex(c => c.length > 3 && isNaN(c)); 
                        const qIdx = r.findIndex(c => c.match(/^\d+$/) && parseInt(c) < 10000);
                        if(nIdx !== -1 && qIdx !== -1) found.push({sku: 'XLS', n: r[nIdx].trim(), q: parseInt(r[qIdx])});
                    });
                    this.finish(found);
                };
                reader.readAsArrayBuffer(f);
            },
            async parsePDF(f) {
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        for(let i=1; i<=pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ') + '\n';
                        }
                        this.analyzeText(fullText);
                    };
                    reader.readAsArrayBuffer(f);
                } catch(e) { alert("Error PDF: " + e.message); ui.toggleLoader(false); }
            },
            async parseImage(f) {
                try {
                    const { data: { text } } = await Tesseract.recognize(f, 'spa');
                    this.analyzeText(text);
                } catch(e) { alert("Error OCR: " + e.message); ui.toggleLoader(false); }
            },
            analyzeText(text) {
                const lines = text.split('\n');
                let found = [];
                lines.forEach(line => {
                    const clean = line.replace(/[^\w\s√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö\(\)\.\-]/g, '').trim();
                    if(clean.length < 5) return;
                    let m = clean.match(/^([a-zA-Z\s√±√ë\(\)\.\-]+)\s+(\d+)$/);
                    if(!m) m = clean.match(/^(\d+)\s+([a-zA-Z\s√±√ë\(\)\.\-]+)$/);
                    if(m) {
                        const val1 = m[1].trim(); const val2 = m[2].trim();
                        let n, q;
                        if(isNaN(val1)) { n = val1; q = val2; } else { q = val1; n = val2; }
                        if(n.length > 3 && parseInt(q) > 0) found.push({sku: 'SCAN', n: n, q: parseInt(q)});
                    }
                });
                this.finish(found);
            },
            finish(items) {
                ui.toggleLoader(false);
                if(items.length === 0) items.push({sku:'', n:'', q:0});
                ui.verifyIA(items);
            }
        };

        // REPORTES
        const ReportEngine = {
            async generateGeneralPDF() {
                const { jsPDF } = window.jspdf; const doc = new jsPDF();
                doc.text("IDEAS TEXTILES - REPORTE GENERAL", 14, 20);
                doc.autoTable({startY:30, head:[['SKU','Item','Stock']], body:state.inv.map(x=>[x.sku,x.n,x.q])});
                doc.save('Reporte.pdf');
            },
            async tachasVenta() {
                const b = document.getElementById('pr-b').value, t = document.getElementById('pr-t').value, r = document.getElementById('pr-r').value;
                let html = '<div style="font-family:sans-serif; display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:10px;">';
                const selected = Array.from(document.querySelectorAll('.chk-ord:checked'));
                if(selected.length === 0) return alert("Selecciona OCs");
                selected.forEach(c => {
                    const o = state.ord[c.value];
                    o.its.forEach(it => {
                        html += `
                        <div style="border:2px dashed #999; padding:10px; height:250px; display:flex; flex-direction:column; justify-content:space-between;">
                            <div style="background:#1e293b; color:white; padding:5px; text-align:center; font-size:10px; font-weight:bold;">IDEAS TEXTILES</div>
                            <div>
                                <div style="font-size:14px; font-weight:bold;">OC #${o.id}</div>
                                <div style="font-size:10px;">${o.c}</div>
                                <div style="font-size:18px; font-weight:900; margin-top:5px;">${it.n}</div>
                                <div style="font-size:12px;">Cant: <b>${it.q}</b></div>
                            </div>
                            <div style="font-size:9px; border-top:1px solid #eee; padding-top:5px;">
                                üì¶ ${b} | üöõ ${t} | üë§ ${r}
                            </div>
                        </div>`;
                    });
                });
                html += '</div>';
                this.renderPDF(html, 'Tachas_Venta.pdf');
            },
            async tachaInterna(item, q, m, r) {
                const html = `
                <div style="font-family:sans-serif; border:4px solid #ef4444; padding:20px; text-align:center; width:100%;">
                    <h1 style="color:#ef4444; margin:0;">SALIDA DE BODEGA</h1>
                    <p style="color:#666;">${new Date().toLocaleString()}</p>
                    <hr>
                    <h2 style="font-size:40px; margin:20px 0;">${q} UNIDADES</h2>
                    <h3>${item.n}</h3>
                    <p>SKU: ${item.sku}</p>
                    <div style="background:#fee2e2; padding:15px; margin-top:20px; text-align:left;">
                        <p><b>MOTIVO:</b> ${m}</p>
                        <p><b>AUTORIZA:</b> ${r}</p>
                    </div>
                </div>`;
                this.renderPDF(html, `Salida_${item.sku}.pdf`);
            },
            // [SOLUCI√ìN DEFINITIVA PDF]
            // Forzar renderizado visible + pausa para m√≥viles
            async renderPDF(html, name){ 
                ui.toggleLoader(true, "Generando PDF..."); 
                const c = document.getElementById('pdf-workspace'); 
                
                // 1. Mostrar contenedor (Overlay)
                c.style.display = 'block'; 
                c.innerHTML = html;
                
                // 2. Espera OBLIGATORIA (El m√≥vil necesita tiempo para pintar)
                await new Promise(r => setTimeout(r, 2000)); 
                
                // 3. Captura
                await html2pdf().set({ 
                    margin:5, 
                    filename:name, 
                    image:{type:'jpeg',quality:0.98}, 
                    html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff'}, 
                    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} 
                }).from(c).save(); 
                
                // 4. Limpieza
                c.style.display = 'none'; 
                c.innerHTML = ''; 
                ui.toggleLoader(false); 
                ui.closeModal(); 
            }
        };

        // CALENDARIO
        let curDate = new Date();
        const cal = {
            move(d) { curDate.setMonth(curDate.getMonth()+d); this.render(); },
            render() {
                const y = curDate.getFullYear(), m = curDate.getMonth();
                document.getElementById('cal-title').innerText = new Date(y,m).toLocaleString('es-ES', {month:'long', year:'numeric'});
                const days = new Date(y, m+1, 0).getDate();
                const start = new Date(y, m, 1).getDay();
                let html = '';
                for(let i=0; i<start; i++) html += '<div></div>';
                for(let i=1; i<=days; i++) {
                    const k = `${y}-${(m+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
                    const hasNote = state.cal[k] ? `<div class="cal-event bg-purple-500 text-white">üìù Nota</div>` : '';
                    const ords = state.ord.filter(o=>o.d===k);
                    let ocHtml = '';
                    ords.forEach(o => {
                        let col = o.st==='Pendiente'?'bg-amber-500':(o.st==='Despachado'?'bg-green-500':'bg-blue-500');
                        ocHtml += `<div class="cal-event ${col} text-white">üì¶ ${o.c}</div>`;
                    });
                    html += `<div onclick="cal.open('${k}')" class="calendar-day border rounded p-1 hover:bg-slate-50 ${k===new Date().toISOString().split('T')[0]?'today':''}"><div class="font-bold">${i}</div>${hasNote}${ocHtml}</div>`;
                }
                document.getElementById('cal-grid').innerHTML = html;
            },
            open(k) {
                const note = state.cal[k] || '';
                const ords = state.ord.filter(o=>o.d===k).map(o=>`<li>${o.c} (${o.st})</li>`).join('');
                ui.openModal(`
                    <h3 class="font-bold text-lg mb-2">${k}</h3>
                    ${ords ? `<ul class="text-xs mb-3 bg-blue-50 p-2 rounded">${ords}</ul>` : ''}
                    <textarea id="cal-txt" class="w-full border p-2 rounded h-24" placeholder="Nota...">${note}</textarea>
                    <button onclick="cal.save('${k}')" class="w-full bg-slate-800 text-white p-2 rounded mt-2">GUARDAR</button>
                `);
            },
            save(k) {
                const txt = document.getElementById('cal-txt').value;
                if(txt) state.cal[k] = txt; else delete state.cal[k];
                Sync.save('cal'); ui.closeModal();
            }
        };

        // INICIALIZACI√ìN
        Sync.init();
        ui.show('dashboard');
    </script>
</body>
</html>
