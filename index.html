<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEAS TEXTILES SpA - Control V25</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --p-dark: #0f172a; --accent: #2563eb; --bg: #f1f5f9; 
            --danger: #e11d48; --warning: #f59e0b; --success: #10b981; --info: #3b82f6;
            --card-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--p-dark); padding-bottom: 120px; overflow-x: hidden; }

        /* HEADER PREMIUM CON LOGO DESTACADO */
        .brand-header { 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
            color: white; padding: 60px 20px; text-align: center;
            border-bottom: 6px solid var(--accent); position: relative;
        }
        .brand-header h1 { 
            font-size: 2.8em; font-weight: 900; letter-spacing: -2px; 
            text-transform: uppercase; margin-bottom: 10px; text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .brand-header h1 span { color: var(--accent); }
        
        /* REGISTRO DE USUARIO ELEGANTE */
        .user-config {
            background: rgba(255,255,255,0.08); backdrop-filter: blur(5px);
            padding: 10px 25px; border-radius: 50px; display: inline-flex;
            align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .user-config:hover { background: rgba(255,255,255,0.15); }

        /* TARJETA DE CONTROL INDUSTRIAL */
        .order-card { 
            background: white; margin: 25px 15px; border-radius: 30px; 
            overflow: hidden; box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.05);
        }
        .status-banner { 
            padding: 18px 25px; font-weight: 900; font-size: 0.85em; 
            display: flex; align-items: center; justify-content: center; gap: 12px; text-transform: uppercase;
        }
        .card-content { padding: 30px; }
        .pending-hero { 
            background: #f8fafc; border-radius: 25px; padding: 25px; 
            text-align: center; margin: 20px 0; border: 2px dashed #cbd5e1;
        }
        .pending-hero big { display: block; font-size: 4em; font-weight: 900; color: var(--danger); line-height: 1; letter-spacing: -3px; }
        
        /* TABLA DE ITEMS ALTA DENSIDAD */
        .item-list { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .item-list td { padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9em; }
        .st-badge { padding: 4px 10px; border-radius: 8px; font-weight: 800; font-size: 0.7em; text-transform: uppercase; }

        /* SECCI√ìN GESTI√ìN */
        .mgmt-container { padding: 20px; }
        .glass-input {
            background: white; border: 2px solid #e2e8f0; border-radius: 20px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .glass-input label { font-size: 0.75em; font-weight: 900; color: var(--accent); text-transform: uppercase; display: block; margin-bottom: 10px; }
        .glass-input input, .glass-input textarea { 
            width: 100%; border: none; outline: none; font-size: 1.1em; font-weight: 700; color: var(--p-dark);
        }

        /* BOTONES DE ACCI√ìN */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 30px 30px; }
        .btn { 
            padding: 18px; border-radius: 18px; border: none; font-weight: 900; 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            cursor: pointer; font-size: 0.8em; text-decoration: none; transition: 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: #22c55e; color: white; }
        .btn-dark { background: var(--p-dark); color: white; }
        .btn-outline { background: white; border: 2px solid var(--p-dark); color: var(--p-dark); }

        /* NAVEGACI√ìN ESTILO APP */
        .nav-app { 
            position: fixed; bottom: 0; width: 100%; background: white; 
            display: flex; padding: 15px 0 35px; border-top: 1px solid #e2e8f0; z-index: 1000;
        }
        .nav-link { flex: 1; border: none; background: none; color: #94a3b8; font-weight: 800; font-size: 0.7em; text-align: center; }
        .nav-link.active { color: var(--accent); }
        .nav-link i { font-size: 1.8em; display: block; margin-bottom: 5px; }

        .footer-text { text-align: center; padding: 30px; font-size: 0.7em; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 20px; }
        .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-weight: 900; background: white; border-radius: 12px; font-size: 0.9em; border: 1px solid #e2e8f0; }
        .today { background: var(--accent) !important; color: white; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <header class="brand-header">
        <h1>IDEAS <span>TEXTILES</span></h1>
        <div class="user-config" onclick="registerUser()">
            <i class="fa-solid fa-circle-user"></i>
            <span id="userNameDisplay">Registrar Operador</span>
        </div>
    </header>

    <div id="view-orders">
        <div style="padding: 0 20px; margin-top: -30px;">
            <div style="background:white; padding:10px 25px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.1); display:flex; align-items:center; gap:15px; border:1px solid #ddd">
                <i class="fa-solid fa-search" style="color:var(--accent)"></i>
                <input type="text" id="mainSearch" placeholder="Buscar cliente o pedido..." onkeyup="search()" style="width:100%; border:none; outline:none; font-weight:700; font-size:1.1em">
            </div>
        </div>
        <div id="orders-container"></div>
    </div>

    <div id="view-mgmt" class="hidden">
        <div class="mgmt-container">
            <a href="https://docs.google.com/spreadsheets/d/1GvK0A_30mI82eO5yYf6xR6yE_u95zWshnN3y2z9vG2U/edit" target="_blank" class="btn btn-outline" style="margin-bottom:20px; width:100%">
                <i class="fa-solid fa-file-excel"></i> ABRIR EXCEL COMPLETO
            </a>

            <div class="glass-input">
                <label>N√∫mero WhatsApp del Jefe</label>
                <input type="text" id="bossPhone" placeholder="Ej: 56912345678" onchange="saveConfig()">
            </div>

            <div class="glass-input">
                <label>Calendario de Entregas</label>
                <h3 id="monthName" style="font-weight:900; margin-top:5px">Enero 2024</h3>
                <div id="calendar"></div>
            </div>

            <div class="glass-input">
                <label>Notas y Novedades del D√≠a</label>
                <textarea id="dailyNotes" placeholder="Escribe aqu√≠ los pendientes importantes..." rows="6" onchange="saveConfig()"></textarea>
            </div>
            
            <button class="btn btn-dark" style="width:100%" onclick="sendGeneralReport()">
                <i class="fa-brands fa-whatsapp"></i> ENVIAR REPORTE AL JEFE
            </button>
        </div>
    </div>

    <div class="footer-text">¬© 2024 Ideas Textiles SpA ‚Ä¢ Sistema de Gesti√≥n de Despacho</div>

    <nav class="nav-app">
        <button class="nav-link active" onclick="switchTab('orders', this)"><i class="fa-solid fa-truck-ramp-box"></i>LOG√çSTICA</button>
        <button class="nav-link" onclick="switchTab('mgmt', this)"><i class="fa-solid fa-gears"></i>GESTI√ìN</button>
    </nav>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR709g0cB4EtdROEnIWBrK2O4FQrKHUd3jXNUTWwdWvT1F5UraKHGOr6dDQHsJtgrdv4-ARqow_jKi0/pub?output=csv";
    let allData = [];

    async function fetchData() {
        const r = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(CSV_URL) + "&t=" + Date.now());
        const t = await r.text();
        const rows = t.split('\n').slice(1);
        const map = {};
        rows.forEach(row => {
            const c = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/"/g, '').trim());
            if(c.length < 10) return;
            if(!map[c[1]]) map[c[1]] = { id: c[1], name: c[2], client: c[3], phone: c[11], items: [] };
            map[c[1]].items.push({ p: c[5], q: parseInt(c[7])||0, st: c[8].toUpperCase(), d: parseInt(c[9])||0 });
        });
        allData = Object.values(map);
        renderOrders(allData);
    }

    function renderOrders(list) {
        const cont = document.getElementById('orders-container');
        cont.innerHTML = list.map(o => {
            let tQ = 0, tD = 0;
            let statuses = new Set();
            o.items.forEach(i => { tQ += i.q; tD += i.d; statuses.add(i.st); });
            
            const pend = tQ - tD;
            let banner = { bg: "#e2e8f0", col: "#475569", label: "EN PROCESO", icon: "fa-spinner" };

            // L√ìGICA DE ESTADO ROBUSTA
            if (pend <= 0) {
                banner = { bg: "#dcfce7", col: "#15803d", label: "‚úÖ DESPACHADO TOTALMENTE", icon: "fa-check-double" };
            } else if (Array.from(statuses).some(s => s.includes("STOCK"))) {
                banner = { bg: "#fee2e2", col: "#b91c1c", label: "‚ö†Ô∏è BLOQUEADO POR STOCK", icon: "fa-ban" };
            } else if (Array.from(statuses).some(s => s.includes("BORDADO"))) {
                banner = { bg: "#fef3c7", col: "#92400e", label: "üßµ EN BORDADO / TALLER", icon: "fa-scissors" };
            } else if (tD > 0 && pend > 0) {
                banner = { bg: "#e0f2fe", col: "#0369a1", label: "üöö DESPACHO PARCIAL", icon: "fa-truck-arrow-right" };
            } else {
                banner = { bg: "#f1f5f9", col: "#0f172a", label: "üì¶ LISTO EN BODEGA", icon: "fa-box-archive" };
            }

            return `
                <div class="order-card">
                    <div class="status-banner" style="background:${banner.bg}; color:${banner.col}">
                        <i class="fa-solid ${banner.icon}"></i> ${banner.label}
                    </div>
                    <div class="card-content">
                        <span style="font-size:0.7em; font-weight:900; color:var(--accent)">ORDEN: #${o.id}</span>
                        <h2 style="font-size:1.6em; font-weight:900; margin-top:5px">${o.name}</h2>
                        <p style="font-size:0.85em; font-weight:600; color:#64748b">${o.client}</p>

                        <div class="pending-hero">
                            <span style="font-size:0.75em; font-weight:900; color:#64748b">FALTAN POR ENTREGAR</span>
                            <big>${pend}</big>
                        </div>

                        <table class="item-list">
                            ${o.items.map(i => `
                                <tr>
                                    <td style="font-weight:700">${i.p}</td>
                                    <td style="text-align:right"><span class="st-badge" style="background:#f1f5f9">${i.st}</span></td>
                                    <td style="text-align:right; font-weight:900">${i.q} ud.</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                    <div class="btn-grid">
                        <a href="https://wa.me/${o.phone}" class="btn btn-green"><i class="fa-brands fa-whatsapp"></i> CLIENTE</a>
                        <button class="btn btn-dark" onclick="sendOrderReport('${o.id}', '${o.name}', ${pend})">AVISAR JEFE</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // GESTI√ìN DE CONFIGURACI√ìN
    function registerUser() {
        const n = prompt("Ingresa tu Nombre:");
        if(n) { localStorage.setItem('it_user', n); document.getElementById('userNameDisplay').innerText = n; }
    }

    function saveConfig() {
        localStorage.setItem('it_boss', document.getElementById('bossPhone').value);
        localStorage.setItem('it_notes', document.getElementById('dailyNotes').value);
    }

    function switchTab(view, btn) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById('view-' + view).classList.remove('hidden');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        btn.classList.add('active');
        if(view === 'mgmt') buildCalendar();
    }

    function buildCalendar() {
        const d = new Date(), m = d.getMonth(), y = d.getFullYear();
        const names = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        document.getElementById('monthName').innerText = `${names[m]} ${y}`;
        const grid = document.getElementById('calendar'); grid.innerHTML = "";
        const last = new Date(y, m+1, 0).getDate();
        for(let i=1; i<=last; i++) {
            const today = i === d.getDate() ? 'today' : '';
            grid.innerHTML += `<div class="day ${today}">${i}</div>`;
        }
    }

    function sendOrderReport(id, name, pend) {
        const p = localStorage.getItem('it_boss');
        if(!p) return alert("Configura el WhatsApp del Jefe en la pesta√±a GESTI√ìN");
        const user = localStorage.getItem('it_user') || 'Operador';
        const msg = encodeURIComponent(`*REPORTE DE ORDEN #${id}*\nCliente: ${name}\nEstado: Pendiente ${pend} unidades.\nResponsable: ${user}`);
        window.open(`https://wa.me/${p}?text=${msg}`);
    }

    function sendGeneralReport() {
        const p = localStorage.getItem('it_boss');
        const notes = document.getElementById('dailyNotes').value;
        if(!p) return alert("Configura el WhatsApp del Jefe");
        const user = localStorage.getItem('it_user') || 'Operador';
        const msg = encodeURIComponent(`*REPORTE DIARIO IDEAS TEXTILES*\nResponsable: ${user}\n---\nNOVEDADES:\n${notes}`);
        window.open(`https://wa.me/${p}?text=${msg}`);
    }

    function search() {
        const q = document.getElementById('mainSearch').value.toLowerCase();
        renderOrders(allData.filter(o => o.name.toLowerCase().includes(q) || o.client.toLowerCase().includes(q)));
    }

    window.onload = () => {
        document.getElementById('userNameDisplay').innerText = localStorage.getItem('it_user') || 'Registrar Operador';
        document.getElementById('bossPhone').value = localStorage.getItem('it_boss') || '';
        document.getElementById('dailyNotes').value = localStorage.getItem('it_notes') || '';
        fetchData();
    }
</script>
</body>
</html>
