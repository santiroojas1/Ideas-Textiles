<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEAS TEXTILES SPA | SISTEMA ERP PROFESIONAL</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --ios-blue: #007AFF;
            --sea-blue: #0051A8;
            --ios-bg: #F2F2F7;
            --glass: rgba(255, 255, 255, 0.72);
            --glass-dark: rgba(255, 255, 255, 0.4);
            --border-ios: rgba(0, 0, 0, 0.1);
            --text-main: #1C1C1E;
        }

        * {
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
            scrollbar-width: thin;
            scrollbar-color: var(--sea-blue) transparent;
        }

        body {
            background-color: #FFFFFF;
            background-image: 
                radial-gradient(at 0% 0%, rgba(0, 122, 255, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(0, 81, 168, 0.05) 0px, transparent 50%);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        /* --- DISEO ESTILO BURBUJA iOS --- */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-ios);
            border-radius: 24px;
        }

        .bubble-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border-ios);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.01);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .bubble-card:hover {
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
        }

        /* --- INPUTS MINIMALISTAS --- */
        .editable-field {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .editable-field:hover {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--ios-blue);
        }

        .editing-input {
            background: white;
            border: 2px solid var(--ios-blue) !important;
            outline: none;
            width: 100%;
            padding: 4px 8px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.2);
        }

        /* --- NAVEGACIN iOS --- */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8E8E93;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--ios-blue);
        }

        /* --- BARRAS DE BSQUEDA --- */
        .ios-search-bar {
            background: rgba(118, 118, 128, 0.12);
            border-radius: 12px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }

        .ios-search-bar input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            font-size: 15px;
        }

        /* --- TABLA DINMICA --- */
        .table-container {
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid var(--border-ios);
        }

        .table-header {
            background: rgba(242, 242, 247, 0.8);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            color: #8E8E93;
        }

        /* --- BOTONES PROFESIONALES --- */
        .btn-ios-primary {
            background: var(--sea-blue);
            color: white;
            padding: 12px 24px;
            border-radius: 14px;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 14px rgba(0, 81, 168, 0.3);
        }

        .btn-ios-primary:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* --- ESTRUCTURA DE CAPAS --- */
        #app-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100vh;
        }

        @media (max-width: 1024px) {
            #app-layout {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
            .mobile-nav {
                display: flex !important;
            }
        }

        /* --- LOADERS Y ANIMACIONES --- */
        .ios-loader {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 122, 255, 0.2);
            border-top: 3px solid var(--ios-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="main-loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="ios-loader mb-4"></div>
        <h1 class="text-xl font-black text-slate-800 tracking-tighter italic">IDEAS TEXTILES <span class="text-blue-600">SPA</span></h1>
        <p class="text-[10px] uppercase tracking-widest font-bold text-slate-400 mt-2">Sincronizando con la Nube...</p>
    </div>

    <div id="toast-container" class="fixed top-6 right-6 z-[110] space-y-4"></div>

    <div id="app-layout">
        
        <aside class="sidebar bg-[#F9F9F9] border-r border-slate-200 p-8 flex flex-col justify-between">
            <div>
                <div class="mb-12">
                    <img id="logo-main" src="https://i.ibb.co/VmxP6Xh/Logo-Ideas-Textiles.png" alt="Logo" class="w-48 mb-2">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter pl-1">Ropa de Trabajo y Corporativa</p>
                </div>

                <nav class="space-y-2">
                    <button onclick="App.UI.switchView('dashboard')" id="btn-dashboard" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-500 font-bold transition-all active-nav">
                        <i class="fas fa-chart-pie text-lg"></i> Dashboard
                    </button>
                    <button onclick="App.UI.switchView('inventory')" id="btn-inventory" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-500 font-bold transition-all">
                        <i class="fas fa-boxes-stacked text-lg"></i> Bodega
                    </button>
                    <button onclick="App.UI.switchView('orders')" id="btn-orders" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-500 font-bold transition-all">
                        <i class="fas fa-receipt text-lg"></i> rdenes de Compra
                    </button>
                    <button onclick="App.UI.switchView('movements')" id="btn-movements" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-500 font-bold transition-all">
                        <i class="fas fa-truck-ramp-box text-lg"></i> Movimientos
                    </button>
                    <button onclick="App.UI.switchView('calendar')" id="btn-calendar" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-500 font-bold transition-all">
                        <i class="fas fa-calendar-day text-lg"></i> Agenda & Fotos
                    </button>
                </nav>
            </div>

            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                <p class="text-[10px] font-black text-blue-600 uppercase mb-1">Usuario Activo</p>
                <p class="font-bold text-slate-800 text-sm">Administrador Pro</p>
                <div class="flex items-center gap-2 mt-3 text-[10px] font-bold text-blue-500">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Sistema En L铆nea
                </div>
            </div>
        </aside>

        <main class="relative h-screen overflow-y-auto p-6 md:p-12">
            
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
                <div>
                    <h2 id="view-title" class="text-4xl font-black text-slate-900 tracking-tight">Cargando...</h2>
                    <p id="view-subtitle" class="text-slate-500 font-medium">Espere un momento</p>
                </div>

                <div class="flex items-center gap-4 w-full md:w-auto">
                    <div class="ios-search-bar flex-1 md:flex-none">
                        <i class="fas fa-search text-slate-400"></i>
                        <input type="text" id="global-search" placeholder="Buscar en todo el ERP..." oninput="App.Core.search(this.value)">
                    </div>
                    <button onclick="App.PDF.generateGlobalReport()" class="w-12 h-12 glass-panel flex items-center justify-center text-slate-700 hover:text-blue-600 transition shadow-sm">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </header>

            <div id="views-wrapper">
                
                <section id="view-dashboard" class="view-content fade-in space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bubble-card bg-gradient-to-br from-blue-600 to-blue-800 text-white">
                            <p class="text-xs font-bold opacity-80 uppercase tracking-widest">Stock Total</p>
                            <h3 class="text-4xl font-black mt-2" id="stat-total-stock">0</h3>
                            <div class="mt-4 text-[10px] font-bold bg-white/20 p-2 rounded-lg inline-block">BODEGA CENTRAL</div>
                        </div>
                        <div class="bubble-card">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">OC en Proceso</p>
                            <h3 class="text-4xl font-black mt-2 text-slate-800" id="stat-pending-orders">0</h3>
                            <div class="mt-4 text-[10px] font-bold text-orange-500 flex items-center gap-1">
                                <i class="fas fa-clock"></i> ACTUALIZADO AHORA
                            </div>
                        </div>
                        <div class="bubble-card">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Facturado Mes</p>
                            <h3 class="text-4xl font-black mt-2 text-slate-800" id="stat-monthly-total">0</h3>
                            <div class="mt-4 text-[10px] font-bold text-blue-500">PENDIENTE DE PAGO</div>
                        </div>
                        <div class="bubble-card">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Despachado</p>
                            <h3 class="text-4xl font-black mt-2 text-green-600" id="stat-dispatched">0</h3>
                            <div class="mt-4 text-[10px] font-bold text-green-500 flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> ENTREGAS EXITOSAS
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="glass-panel p-8">
                            <h4 class="font-black text-lg mb-6 flex items-center gap-3">
                                <i class="fas fa-bolt text-yellow-500"></i> Acciones R谩pidas
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="App.UI.openModal('new-order')" class="p-6 rounded-2xl border-2 border-dashed border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition text-left group">
                                    <i class="fas fa-file-circle-plus text-2xl mb-2 text-slate-400 group-hover:text-blue-500"></i>
                                    <p class="font-bold text-slate-800">Nueva OC</p>
                                    <p class="text-[10px] text-slate-400">Crear pedido de cliente</p>
                                </button>
                                <button onclick="App.UI.openModal('new-product')" class="p-6 rounded-2xl border-2 border-dashed border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition text-left group">
                                    <i class="fas fa-box-open text-2xl mb-2 text-slate-400 group-hover:text-blue-500"></i>
                                    <p class="font-bold text-slate-800">Ingreso Stock</p>
                                    <p class="text-[10px] text-slate-400">Aumentar inventario</p>
                                </button>
                            </div>
                        </div>

                        <div class="glass-panel p-8">
                            <h4 class="font-black text-lg mb-6">Alertas de Stock Bajo</h4>
                            <div id="stock-alerts-list" class="space-y-4">
                                </div>
                        </div>
                    </div>
                </section>

                <section id="view-inventory" class="view-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-4">
                            <button onclick="App.Store.Inventory.exportExcel()" class="bg-green-100 text-green-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-green-200 transition">
                                <i class="fas fa-file-excel mr-2"></i> EXCEL
                            </button>
                        </div>
                        <button onclick="App.UI.openModal('new-product')" class="btn-ios-primary">
                            <i class="fas fa-plus"></i> AGREGAR PRODUCTO
                        </button>
                    </div>

                    <div class="table-container bg-white">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="table-header">
                                    <th class="py-5 px-6">SKU / PRODUCTO</th>
                                    <th class="py-5 px-4 text-center">TALLAS (TOTAL)</th>
                                    <th class="py-5 px-4 text-center">CATEGORA</th>
                                    <th class="py-5 px-4 text-right">ACCIONES</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y divide-slate-100">
                                </tbody>
                        </table>
                    </div>
                </section>

                <section id="view-orders" class="view-content hidden fade-in">
                    <div class="flex flex-col md:flex-row gap-4 mb-8">
                        <div class="ios-search-bar">
                            <i class="fas fa-filter text-slate-400"></i>
                            <select id="filter-order-status" class="bg-transparent border-none outline-none text-sm font-bold w-full" onchange="App.Core.filterOrders()">
                                <option value="all">Todos los Estados</option>
                                <option value="pendiente">Pendientes</option>
                                <option value="proceso">En Producci贸n</option>
                                <option value="empaquetado">Empaquetado</option>
                                <option value="despachado">Despachado</option>
                            </select>
                        </div>
                    </div>

                    <div id="orders-kanban" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="kanban-col">
                            <h5 class="font-black text-slate-400 text-[10px] uppercase mb-4 tracking-widest flex items-center justify-between">
                                Pendientes <span id="count-pendiente" class="bg-slate-200 px-2 py-0.5 rounded-full">0</span>
                            </h5>
                            <div id="col-pendiente" class="space-y-4 min-h-[500px]"></div>
                        </div>
                        <div class="kanban-col">
                            <h5 class="font-black text-blue-500 text-[10px] uppercase mb-4 tracking-widest flex items-center justify-between">
                                Producci贸n <span id="count-proceso" class="bg-blue-100 px-2 py-0.5 rounded-full">0</span>
                            </h5>
                            <div id="col-proceso" class="space-y-4 min-h-[500px]"></div>
                        </div>
                        <div class="kanban-col">
                            <h5 class="font-black text-orange-500 text-[10px] uppercase mb-4 tracking-widest flex items-center justify-between">
                                Empaque <span id="count-empaquetado" class="bg-orange-100 px-2 py-0.5 rounded-full">0</span>
                            </h5>
                            <div id="col-empaquetado" class="space-y-4 min-h-[500px]"></div>
                        </div>
                        <div class="kanban-col">
                            <h5 class="font-black text-green-600 text-[10px] uppercase mb-4 tracking-widest flex items-center justify-between">
                                Despachado <span id="count-despachado" class="bg-green-100 px-2 py-0.5 rounded-full">0</span>
                            </h5>
                            <div id="col-despachado" class="space-y-4 min-h-[500px]"></div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <nav class="mobile-nav fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-xl border-t border-slate-200 h-20 hidden items-center justify-around px-4 z-[90]">
        <div onclick="App.UI.switchView('dashboard')" class="nav-item active">
            <i class="fas fa-chart-pie"></i> Panel
        </div>
        <div onclick="App.UI.switchView('inventory')" class="nav-item">
            <i class="fas fa-boxes-stacked"></i> Bodega
        </div>
        <div onclick="App.UI.switchView('orders')" class="nav-item">
            <i class="fas fa-receipt"></i> OC
        </div>
        <div onclick="App.UI.switchView('calendar')" class="nav-item">
            <i class="fas fa-camera"></i> Fotos
        </div>
    </nav>

    <div id="ios-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-2xl max-h-[90vh] overflow-y-auto animate__animated animate__fadeInUp">
            <div class="sticky top-0 bg-white/80 backdrop-blur-md px-8 py-6 border-b border-slate-100 flex justify-between items-center z-10">
                <h3 id="modal-title" class="text-2xl font-black text-slate-800 tracking-tighter">Nueva Operaci贸n</h3>
                <button onclick="App.UI.closeModal()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-content" class="p-8">
                </div>
        </div>
    </div>

    <script>
        /**
         * IDEAS TEXTILES SPA - NCLEO ARQUITECTNICO V1.0
         * Sistema de Gesti贸n de Alta Disponibilidad
         */

        const App = {
            // --- ESTADO GLOBAL (SINGLE SOURCE OF TRUTH) ---
            State: {
                inventory: {},
                orders: {},
                movements: [],
                currentView: 'dashboard',
                searchQuery: '',
                isOnline: false
            },

            // --- MOTOR PRINCIPAL ---
            Core: {
                init: function() {
                    console.log(" Iniciando IDEAS TEXTILES ERP...");
                    
                    // Configuraci贸n Firebase del Usuario
                    const firebaseConfig = {
                        databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com/"
                    };

                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }

                    this.bindDatabase();
                    App.UI.switchView('dashboard');
                    
                    setTimeout(() => {
                        document.getElementById('main-loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('main-loader').classList.add('hidden'), 500);
                    }, 2000);
                },

                bindDatabase: function() {
                    const db = firebase.database();
                    
                    // Escuchar Bodega
                    db.ref('inventory').on('value', (snap) => {
                        App.State.inventory = snap.val() || {};
                        App.UI.renderInventory();
                        App.UI.updateStats();
                    });

                    // Escuchar rdenes
                    db.ref('orders').on('value', (snap) => {
                        App.State.orders = snap.val() || {};
                        App.UI.renderOrders();
                        App.UI.updateStats();
                    });

                    // Conexi贸n Status
                    db.ref('.info/connected').on('value', (snap) => {
                        App.State.isOnline = snap.val();
                    });
                },

                search: function(query) {
                    App.State.searchQuery = query.toLowerCase();
                    App.UI.renderInventory();
                    App.UI.renderOrders();
                }
            },

            // --- INTERFAZ DE USUARIO (iOS DESIGN) ---
            UI: {
                switchView: function(viewId) {
                    document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                    document.getElementById(`view-${viewId}`).classList.remove('hidden');
                    
                    document.querySelectorAll('.nav-btn, .nav-item').forEach(b => b.classList.remove('active-nav', 'active'));
                    const btn = document.getElementById(`btn-${viewId}`);
                    if(btn) btn.classList.add('active-nav');

                    const titles = {
                        'dashboard': { t: 'Panel de Control', s: 'Vista general del rendimiento hoy' },
                        'inventory': { t: 'Bodega de Stock', s: 'Gesti贸n de SKUs y tallas por producto' },
                        'orders': { t: 'rdenes de Compra', s: 'Flujo de producci贸n y despachos' },
                        'movements': { t: 'Movimientos', s: 'Historial de entradas y salidas' },
                        'calendar': { t: 'Agenda & Fotos', s: 'Confirmaciones visuales de entrega' }
                    };

                    document.getElementById('view-title').innerText = titles[viewId].t;
                    document.getElementById('view-subtitle').innerText = titles[viewId].s;
                    App.State.currentView = viewId;
                },

                updateStats: function() {
                    // C谩lculo de Stock Total
                    let totalItems = 0;
                    Object.values(App.State.inventory).forEach(prod => {
                        if(prod.sizes) {
                            Object.values(prod.sizes).forEach(qty => totalItems += parseInt(qty || 0));
                        }
                    });
                    document.getElementById('stat-total-stock').innerText = totalItems.toLocaleString();

                    // rdenes en Proceso (Pendiente + Proceso + Empaque)
                    const activeOrders = Object.values(App.State.orders).filter(o => o.status !== 'despachado').length;
                    document.getElementById('stat-pending-orders').innerText = activeOrders;

                    // Despachos
                    const dispatched = Object.values(App.State.orders).filter(o => o.status === 'despachado').length;
                    document.getElementById('stat-dispatched').innerText = dispatched;
                },

                renderInventory: function() {
                    const tbody = document.getElementById('inventory-table-body');
                    if(!tbody) return;
                    
                    let html = '';
                    Object.entries(App.State.inventory).forEach(([id, prod]) => {
                        if(App.State.searchQuery && !prod.name.toLowerCase().includes(App.State.searchQuery) && !prod.sku.toLowerCase().includes(App.State.searchQuery)) return;

                        let totalStock = 0;
                        let sizesHtml = '';
                        if(prod.sizes) {
                            Object.entries(prod.sizes).forEach(([size, qty]) => {
                                totalStock += parseInt(qty || 0);
                                sizesHtml += `
                                    <div class="flex flex-col items-center bg-slate-50 px-3 py-1 rounded-lg border border-slate-100">
                                        <span class="text-[9px] font-black text-slate-400 uppercase">${size}</span>
                                        <span class="text-xs font-bold text-slate-700 editable-field" onclick="App.UI.editInline('inventory', '${id}', 'sizes/${size}', this)">${qty}</span>
                                    </div>
                                `;
                            });
                        }

                        html += `
                            <tr class="hover:bg-slate-50/50 transition">
                                <td class="py-6 px-6">
                                    <p class="text-[10px] font-black text-blue-600 mb-1">${prod.sku}</p>
                                    <p class="font-bold text-slate-800 text-sm editable-field" onclick="App.UI.editInline('inventory', '${id}', 'name', this)">${prod.name}</p>
                                </td>
                                <td class="py-6 px-4">
                                    <div class="flex flex-wrap gap-2 justify-center">
                                        ${sizesHtml}
                                        <div class="flex flex-col items-center bg-blue-600 px-3 py-1 rounded-lg shadow-sm">
                                            <span class="text-[9px] font-black text-white/70 uppercase">TOTAL</span>
                                            <span class="text-xs font-black text-white">${totalStock}</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-6 px-4 text-center">
                                    <span class="text-[10px] font-black px-3 py-1 bg-slate-100 rounded-full text-slate-500 uppercase">${prod.category || 'General'}</span>
                                </td>
                                <td class="py-6 px-4 text-right">
                                    <div class="flex justify-end gap-2">
                                        <button onclick="App.UI.openHistory('${id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 hover:bg-blue-50 hover:text-blue-500 transition"><i class="fas fa-history text-xs"></i></button>
                                        <button onclick="App.Store.Inventory.delete('${id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-trash-alt text-xs"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html || '<tr><td colspan="4" class="py-12 text-center text-slate-400 font-bold">No hay productos en bodega</td></tr>';
                },

                renderOrders: function() {
                    const cols = ['pendiente', 'proceso', 'empaquetado', 'despachado'];
                    cols.forEach(status => {
                        const container = document.getElementById(`col-${status}`);
                        const counter = document.getElementById(`count-${status}`);
                        if(!container) return;

                        let html = '';
                        let count = 0;

                        Object.entries(App.State.orders).forEach(([id, order]) => {
                            if(order.status !== status) return;
                            if(App.State.searchQuery && !order.client.toLowerCase().includes(App.State.searchQuery) && !order.ocNumber.toLowerCase().includes(App.State.searchQuery)) return;
                            
                            count++;
                            html += `
                                <div class="bubble-card animate__animated animate__fadeInUp cursor-grab active:cursor-grabbing" onclick="App.UI.editOrder('${id}')">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded-md">OC #${order.ocNumber}</span>
                                        <div class="flex gap-1">
                                            <button onclick="event.stopPropagation(); App.PDF.generateOC('${id}')" class="w-7 h-7 bg-slate-100 rounded-full flex items-center justify-center hover:bg-blue-500 hover:text-white transition"><i class="fas fa-file-pdf text-[10px]"></i></button>
                                        </div>
                                    </div>
                                    <h6 class="font-black text-slate-800 text-sm mb-1">${order.client}</h6>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-3"><i class="fas fa-file-invoice mr-1"></i> FAC: ${order.invoice || 'PENDIENTE'}</p>
                                    
                                    <div class="space-y-1 mb-4">
                                        ${Object.values(order.items || {}).map(i => `
                                            <div class="flex justify-between text-[10px] font-bold text-slate-600 bg-slate-50 p-1.5 rounded-lg border border-slate-100">
                                                <span>${i.name}</span>
                                                <span class="text-blue-600">${i.total} UN</span>
                                            </div>
                                        `).join('')}
                                    </div>

                                    <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                                        <div class="flex -space-x-2">
                                            <div class="w-6 h-6 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center text-[8px] font-black text-slate-500">AC</div>
                                        </div>
                                        <p class="text-[9px] font-bold text-slate-400">${order.date || ''}</p>
                                    </div>
                                </div>
                            `;
                        });

                        container.innerHTML = html;
                        counter.innerText = count;
                    });
                },

                // --- LGICA DE EDICIN INLINE (CLICK TO EDIT) ---
                editInline: function(path, id, field, element) {
                    const currentValue = element.innerText;
                    const input = document.createElement('input');
                    input.value = currentValue;
                    input.className = 'editing-input';
                    
                    element.innerHTML = '';
                    element.appendChild(input);
                    input.focus();

                    const save = () => {
                        const newValue = input.value;
                        if(newValue !== currentValue) {
                            firebase.database().ref(`${path}/${id}/${field}`).set(newValue);
                            App.UI.notify('Cambio guardado en la nube', 'success');
                        }
                        element.innerText = newValue;
                    };

                    input.onblur = save;
                    input.onkeydown = (e) => { if(e.key === 'Enter') save(); };
                },

                // --- GESTIN DE MODALES ---
                openModal: function(type) {
                    const modal = document.getElementById('ios-modal');
                    const content = document.getElementById('modal-content');
                    const title = document.getElementById('modal-title');
                    modal.classList.remove('hidden');

                    if(type === 'new-product') {
                        title.innerText = 'Ingresar Producto a Bodega';
                        content.innerHTML = `
                            <div class="space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-[10px] font-black text-slate-400 uppercase">C贸digo SKU</label>
                                        <input id="new-sku" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 font-bold outline-none focus:border-blue-500" placeholder="Ej: POL-001">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-[10px] font-black text-slate-400 uppercase">Categor铆a</label>
                                        <select id="new-cat" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 font-bold outline-none focus:border-blue-500">
                                            <option value="Poleras">Poleras</option>
                                            <option value="Pantalones">Pantalones</option>
                                            <option value="Chaquetas">Chaquetas</option>
                                            <option value="Seguridad">Seguridad</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase">Nombre Completo del Producto</label>
                                    <input id="new-name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 font-bold outline-none focus:border-blue-500" placeholder="Ej: Polera Piqu茅 100% Algod贸n">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase">Definir Tallas Iniciales</label>
                                    <div class="grid grid-cols-4 gap-3">
                                        <input id="size-S" class="bg-slate-50 border border-slate-100 rounded-lg p-3 text-center font-bold" placeholder="S">
                                        <input id="size-M" class="bg-slate-50 border border-slate-100 rounded-lg p-3 text-center font-bold" placeholder="M">
                                        <input id="size-L" class="bg-slate-50 border border-slate-100 rounded-lg p-3 text-center font-bold" placeholder="L">
                                        <input id="size-XL" class="bg-slate-50 border border-slate-100 rounded-lg p-3 text-center font-bold" placeholder="XL">
                                    </div>
                                </div>
                                <button onclick="App.Store.Inventory.save()" class="btn-ios-primary w-full justify-center py-5">
                                    GUARDAR PRODUCTO EN BODEGA
                                </button>
                            </div>
                        `;
                    }
                },

                closeModal: function() {
                    document.getElementById('ios-modal').classList.add('hidden');
                },

                notify: function(msg, type) {
                    const id = Date.now();
                    const container = document.getElementById('toast-container');
                    const color = type === 'success' ? 'bg-blue-600' : 'bg-red-600';
                    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

                    const toast = document.createElement('div');
                    toast.id = `toast-${id}`;
                    toast.className = `animate__animated animate__fadeInRight ${color} text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 min-w-[300px] border border-white/20 backdrop-blur-md`;
                    toast.innerHTML = `
                        <i class="fas ${icon} text-xl"></i>
                        <div>
                            <p class="font-black text-xs uppercase tracking-widest">SISTEMA</p>
                            <p class="text-sm font-bold">${msg}</p>
                        </div>
                    `;
                    container.appendChild(toast);
                    setTimeout(() => {
                        toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);
                }
            },

            // --- ALMACENAMIENTO DE DATOS ---
            Store: {
                Inventory: {
                    save: function() {
                        const product = {
                            sku: document.getElementById('new-sku').value,
                            name: document.getElementById('new-name').value,
                            category: document.getElementById('new-cat').value,
                            sizes: {
                                S: parseInt(document.getElementById('size-S').value || 0),
                                M: parseInt(document.getElementById('size-M').value || 0),
                                L: parseInt(document.getElementById('size-L').value || 0),
                                XL: parseInt(document.getElementById('size-XL').value || 0)
                            }
                        };

                        if(!product.sku || !product.name) return App.UI.notify('Faltan campos obligatorios', 'error');

                        firebase.database().ref('inventory').push(product).then(() => {
                            App.UI.notify('Producto registrado con 茅xito', 'success');
                            App.UI.closeModal();
                        });
                    },

                    delete: function(id) {
                        Swal.fire({
                            title: '驴Eliminar producto?',
                            text: "Esta acci贸n no se puede deshacer",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#0051A8',
                            cancelButtonColor: '#EF4444',
                            confirmButtonText: 'S铆, eliminar de bodega'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                firebase.database().ref(`inventory/${id}`).remove();
                                App.UI.notify('Producto eliminado', 'success');
                            }
                        });
                    }
                }
            },

            // --- MOTOR DE PDF (CORPORATIVO) ---
            PDF: {
                generateOC: function(id) {
                    const order = App.State.orders[id];
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Configuraci贸n Visual
                    const azulMar = "#0051A8";
                    const grisSuave = "#F8FAFC";

                    // Cabecera Profesional
                    doc.setFillColor(azulMar);
                    doc.rect(0, 0, 210, 40, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.text("IDEAS TEXTILES SPA", 15, 20);
                    
                    doc.setFontSize(9);
                    doc.text("ROPA DE TRABAJO Y CORPORATIVA", 15, 27);
                    doc.text(`ORDEN DE COMPRA #${order.ocNumber}`, 150, 20);
                    doc.text(`FACTURA/GUA: ${order.invoice || 'PENDIENTE'}`, 150, 27);

                    // Informaci贸n del Cliente
                    doc.setTextColor(azulMar);
                    doc.setFontSize(10);
                    doc.text("CLIENTE / DESTINATARIO", 15, 55);
                    doc.line(15, 57, 100, 57);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(14);
                    doc.text(order.client.toUpperCase(), 15, 65);
                    doc.setFontSize(10);
                    doc.text(`Fecha de Emisi贸n: ${order.date || 'N/A'}`, 15, 72);

                    // Tabla de Productos con RESUMEN Y CASILLA DE CONFIRMACIN
                    const tableData = Object.values(order.items || {}).map(i => {
                        const tallasStr = Object.entries(i.sizes || {}).map(([s, q]) => `${s}: ${q}`).join(' | ');
                        return [
                            i.name.toUpperCase(),
                            tallasStr,
                            `${i.total} UN`,
                            "[   ]" // Casilla de bodega
                        ];
                    });

                    doc.autoTable({
                        startY: 85,
                        head: [['DESCRIPCIN DEL PRODUCTO', 'DESGLOSE DE TALLAS', 'CANT.', 'EMPAQUE']],
                        body: tableData,
                        theme: 'striped',
                        headStyles: { fillColor: azulMar, fontSize: 10, fontStyle: 'bold' },
                        styles: { fontSize: 9, cellPadding: 6 },
                        columnStyles: {
                            0: { cellWidth: 60 },
                            1: { cellWidth: 80 },
                            2: { cellWidth: 20, halign: 'center' },
                            3: { cellWidth: 25, halign: 'center', fontStyle: 'bold' }
                        }
                    });

                    // Mensajes Extra
                    let finalY = doc.lastAutoTable.finalY + 20;
                    doc.setFillColor(grisSuave);
                    doc.rect(15, finalY, 180, 25, 'F');
                    doc.setTextColor(azulMar);
                    doc.setFontSize(8);
                    doc.text("NOTAS Y MENSAJES ADICIONALES:", 20, finalY + 8);
                    doc.setTextColor(0, 0, 0);
                    doc.text(order.notes || "Sin observaciones adicionales para esta orden.", 20, finalY + 16);

                    // Pie de p谩gina
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    const now = new Date().toLocaleString();
                    doc.text(`Documento generado por ERP Ideas Textiles SPA el ${now}`, 105, 285, { align: "center" });

                    doc.save(`OC_${order.ocNumber}_${order.client}.pdf`);
                }
            }
        };

        // INICIALIZACIN
        window.onload = () => App.Core.init();
    </script>
</body>
</html>
