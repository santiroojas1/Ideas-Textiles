<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEAS TEXTILES | WORKWEAR AND CORPORATE</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* --- ESTILOS VISUALES PREMIUM --- */
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-color: #f1f5f9; overflow-x: hidden; color: #1e293b; }
        
        /* Layout Responsivo */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        @media (min-width: 1024px) { .app-container { flex-direction: row; } }

        /* Scrollbars Estilizadas */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Indicador de Estado (Online/Offline) */
        .status-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; background: #334155; color: #94a3b8; border: 1px solid #475569; transition: all 0.3s; }
        .status-badge.online { background: #064e3b; color: #34d399; border-color: #059669; box-shadow: 0 0 10px rgba(16, 185, 129, 0.2); }
        .live-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; margin-right: 6px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Calendario */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 0 0 8px 8px; overflow: hidden; }
        .calendar-day { min-height: 100px; background: white; padding: 6px; font-size: 0.85rem; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: background 0.2s; }
        .calendar-day:hover { background: #f8fafc; }
        .calendar-day.today { background: #fffbeb; box-shadow: inset 0 0 0 2px #f59e0b; }
        .cal-event { font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; margin-bottom: 3px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* Taller de Producci√≥n */
        .stage-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; transition: all 0.2s; cursor: pointer; }
        .stage-row:hover { border-color: #cbd5e1; transform: translateX(2px); }
        .stage-row.completed { background-color: #f0fdf4; border-color: #86efac; }
        .stage-check { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #cbd5e1; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: transparent; transition: all 0.2s; }
        .stage-row.completed .stage-check { background: #22c55e; border-color: #22c55e; color: white; font-size: 10px; }

        /* --- MOTOR PDF FANTASMA (SOLUCI√ìN CR√çTICA PANTALLA BLANCA) --- */
        #pdf-render-zone { 
            position: fixed; 
            left: -10000px; /* Fuera de la pantalla pero RENDERIZADO */
            top: 0; 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            z-index: -100;
        }
        
        /* Layout Hoja A4 (6 Etiquetas) */
        .pdf-page-a4 { 
            width: 210mm; 
            height: 297mm; 
            padding: 10mm; 
            box-sizing: border-box; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr 1fr; 
            gap: 15px; 
            page-break-after: always;
            background: white;
        }
        .pdf-page-a4:last-child { page-break-after: avoid; }

        /* Estilos de las Tachas (Tarjetas) */
        .tacha-card { 
            border: 2px dashed #94a3b8; 
            background: #fff; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            height: 100%; 
            border-radius: 8px; 
            overflow: hidden; 
            position: relative;
            box-sizing: border-box;
        }
        
        /* Tablas Responsive */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .data-table { width: 100%; min-width: 800px; border-collapse: collapse; background: white; }
        .data-table th { background: #f8fafc; color: #64748b; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 12px 16px; border-bottom: 2px solid #e2e8f0; text-align: left; font-weight: 700; }
        .data-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; vertical-align: middle; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background: #f8fafc; }

        /* Botones Animados */
        .btn-action { transition: all 0.2s; active: scale: 0.95; }
        .btn-action:hover { transform: translateY(-1px); shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-amber-100 selection:text-amber-900">

    <div id="loader" class="fixed inset-0 bg-white/95 backdrop-blur-sm z-[9999] flex flex-col justify-center items-center transition-opacity duration-500">
        <div class="relative w-20 h-20">
            <div class="absolute inset-0 border-4 border-slate-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-amber-500 rounded-full border-t-transparent animate-spin"></div>
            <i class="fas fa-tshirt absolute inset-0 flex items-center justify-center text-slate-400 text-2xl"></i>
        </div>
        <h2 id="loading-text" class="mt-4 font-bold text-slate-700 text-lg tracking-tight animate-pulse">Sincronizando Nube...</h2>
    </div>

    <div id="pdf-render-zone"></div>

    <div class="app-container">
        <nav class="bg-slate-900 text-white lg:w-72 lg:h-full flex-shrink-0 flex flex-col z-50 shadow-2xl relative">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center lg:block bg-slate-900 lg:bg-transparent sticky top-0 z-50">
                <div>
                    <h1 class="text-2xl font-black tracking-tighter text-white flex items-center gap-2">
                        IDEAS<span class="text-amber-500">TEXTILES</span>
                    </h1>
                    <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest font-bold">Workwear & Corporate</p>
                    <div class="mt-3">
                        <span id="connection-badge" class="status-badge"><span class="live-dot"></span> Offline</span>
                    </div>
                </div>
                <button onclick="toggleMobileMenu()" class="lg:hidden text-2xl p-2 text-slate-300 hover:text-white focus:outline-none"><i class="fas fa-bars"></i></button>
            </div>
            
            <div id="mobile-menu" class="hidden lg:flex flex-col flex-1 p-4 space-y-2 overflow-y-auto bg-slate-900 lg:bg-transparent absolute lg:static top-full left-0 w-full lg:w-auto shadow-xl lg:shadow-none h-[calc(100vh-85px)] lg:h-auto">
                <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-2">M√≥dulos Principales</p>
                
                <a onclick="ui.showSection('calendar')" class="nav-btn group flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all cursor-pointer bg-slate-800 text-amber-400 shadow-lg border border-slate-700">
                    <i class="fas fa-calendar-alt w-6 text-center group-hover:scale-110 transition-transform"></i> <span class="ml-3">Calendario</span>
                </a>
                
                <a onclick="ui.showSection('inventory')" class="nav-btn group flex items-center px-4 py-3 text-sm font-medium text-slate-300 rounded-xl hover:bg-slate-800 hover:text-white transition-all cursor-pointer">
                    <i class="fas fa-boxes w-6 text-center group-hover:scale-110 transition-transform"></i> <span class="ml-3">Inventario & Taller</span>
                </a>
                
                <a onclick="ui.showSection('orders')" class="nav-btn group flex items-center px-4 py-3 text-sm font-medium text-slate-300 rounded-xl hover:bg-slate-800 hover:text-white transition-all cursor-pointer">
                    <i class="fas fa-clipboard-list w-6 text-center group-hover:scale-110 transition-transform"></i> <span class="ml-3">√ìrdenes (OC)</span>
                </a>

                <div class="mt-auto border-t border-slate-800 pt-6 pb-4">
                    <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Gesti√≥n & Reportes</p>
                    
                    <a onclick="ReportEngine.generateGeneralPDF()" class="flex items-center px-4 py-2.5 text-sm text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg cursor-pointer transition-colors mb-1">
                        <i class="fas fa-file-pdf w-6 text-center text-red-500"></i> <span class="ml-3">Reporte General</span>
                    </a>
                    
                    <a onclick="actions.factoryReset()" class="flex items-center px-4 py-2.5 text-sm text-slate-400 hover:text-red-400 hover:bg-slate-800 rounded-lg cursor-pointer transition-colors">
                        <i class="fas fa-trash-alt w-6 text-center"></i> <span class="ml-3">Borrar Base de Datos</span>
                    </a>
                    
                    <div class="mt-6 text-center px-4">
                        <p class="text-[10px] text-slate-600">
                            &copy; 2026 IDEAS TEXTILES<br>
                            Todos los derechos reservados<br>
                           
                        </p>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-8 relative scroll-smooth">
            
            <section id="calendar" class="space-y-6 animate-fade-in">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div>
                        <h2 class="text-2xl font-black text-slate-800">AGENDA DE ENTREGAS</h2>
                        <p class="text-sm text-slate-500">Visualiza OCs y compromisos</p>
                    </div>
                    <div class="flex items-center gap-4 bg-slate-50 p-2 rounded-xl border border-slate-200">
                        <button onclick="cal.move(-1)" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white hover:shadow-sm text-slate-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <h3 class="text-lg font-bold text-slate-800 w-40 text-center uppercase" id="cal-month-name"></h3>
                        <button onclick="cal.move(1)" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white hover:shadow-sm text-slate-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </header>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="grid grid-cols-7 gap-0 text-center py-3 bg-slate-50 border-b border-slate-200">
                        <div class="text-xs font-bold text-red-500 uppercase tracking-widest">Dom</div>
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">Lun</div>
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">Mar</div>
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">Mie</div>
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">Jue</div>
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">Vie</div>
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">Sab</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                </div>
            </section>

            <section id="inventory" class="hidden space-y-8 animate-fade-in">
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-orange-400 to-amber-500"></div>
                    <div class="p-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fas fa-industry text-amber-500"></i> TALLER DE CONFECCI√ìN
                                </h3>
                                <p class="text-sm text-slate-500 mt-1">Control de Lotes en Proceso</p>
                            </div>
                            <button onclick="ui.openProductionModal()" class="btn-action bg-amber-500 hover:bg-amber-600 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-amber-500/20 font-bold text-sm flex items-center gap-2">
                                <i class="fas fa-plus"></i> NUEVO LOTE
                            </button>
                        </div>
                        <div id="production-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">BODEGA PRINCIPAL</h2>
                            <p class="text-xs text-slate-500">Stock f√≠sico disponible</p>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-end w-full md:w-auto">
                            <button onclick="document.getElementById('ai-input-inv').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-md shadow-indigo-500/20 text-sm font-medium transition flex items-center gap-2">
                                <i class="fas fa-wand-magic-sparkles"></i> IA Importar
                            </button>
                            <input type="file" id="ai-input-inv" hidden onchange="IAEngine.process(this.files[0], 'inv')">
                            
                            <button onclick="ui.openEditItemModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow-md shadow-emerald-500/20 text-sm font-medium transition flex items-center gap-2">
                                <i class="fas fa-box-open"></i> Nuevo Item
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container bg-white border border-slate-200">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th width="20%">SKU / C√ìDIGO</th>
                                    <th width="40%">PRODUCTO</th>
                                    <th width="15%" class="text-center">STOCK</th>
                                    <th width="25%" class="text-right">GESTI√ìN</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="orders" class="hidden space-y-6 animate-fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">√ìRDENES DE COMPRA</h2>
                        <p class="text-sm text-slate-500">Gesti√≥n de pedidos y despachos</p>
                    </div>
                    <div class="flex flex-wrap gap-3 justify-end">
                        <button onclick="document.getElementById('ai-input-oc').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg shadow-md text-sm font-bold flex items-center gap-2">
                            <i class="fas fa-file-import"></i> Importar OC
                        </button>
                        <input type="file" id="ai-input-oc" hidden onchange="IAEngine.process(this.files[0], 'oc')">
                        
                        <button onclick="ui.printSelectedOrders()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-lg shadow-md text-sm font-bold flex items-center gap-2 border border-slate-700">
                            <i class="fas fa-print"></i> TACHAS VENTA
                        </button>
                        
                        <button onclick="ui.openOrderModal()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2.5 rounded-lg shadow-md shadow-amber-500/20 text-sm font-bold flex items-center gap-2">
                            <i class="fas fa-plus"></i> NUEVA OC
                        </button>
                    </div>
                </div>
                
                <div class="table-container bg-white border border-slate-200">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="w-10 text-center bg-slate-50">
                                    <input type="checkbox" onchange="ui.selectAll(this)" class="w-4 h-4 rounded border-gray-300 text-amber-500 focus:ring-amber-500 cursor-pointer">
                                </th>
                                <th>OC / CLIENTE</th>
                                <th>FECHA ENTREGA</th>
                                <th>ESTADO</th>
                                <th class="text-right">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="prodItemModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-cut text-amber-500"></i> Nuevo Lote Producci√≥n</h3>
                <button onclick="ui.closeModal('prodItemModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Nombre Lote / Referencia</label>
                    <input id="prodWorkName" class="w-full mt-1 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition" placeholder="Ej: Lote Pantalones Cargo">
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <h4 class="text-xs font-bold text-slate-500 mb-3 uppercase flex items-center gap-1"><i class="fas fa-list"></i> Agregar Productos</h4>
                    <div class="flex gap-2 mb-3">
                        <select id="prodSelect" class="flex-1 p-2.5 border border-slate-200 rounded-lg text-sm bg-white focus:outline-none focus:border-amber-500"></select>
                    </div>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="prodSizeInput" class="flex-1 p-2.5 border border-slate-200 rounded-lg text-sm text-center" placeholder="Talla (Ej: M)">
                        <input type="number" id="prodQtyInput" class="w-24 p-2.5 border border-slate-200 rounded-lg text-sm text-center font-bold" placeholder="Cant.">
                        <button onclick="actions.addProdToLote()" class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus"></i></button>
                    </div>
                    
                    <div class="max-h-40 overflow-y-auto pr-1 space-y-1" id="tempProdList">
                        </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="ui.closeModal('prodItemModal')" class="px-4 py-2 text-slate-500 font-medium hover:bg-white rounded-lg transition">Cancelar</button>
                <button onclick="actions.createWorkOrder()" class="px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600 shadow-md transition">LANZAR LOTE</button>
            </div>
        </div>
    </div>

    <div id="itemModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" id="itemModalTitle">Gesti√≥n de Item</h3>
                <button onclick="ui.closeModal('itemModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">SKU / C√≥digo</label>
                    <input id="itemSku" class="w-full mt-1 p-3 border border-slate-200 rounded-xl bg-slate-50 font-mono text-sm" placeholder="Generado Autom√°tico">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Nombre Producto</label>
                    <input id="itemName" class="w-full mt-1 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Descripci√≥n completa">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Stock Inicial</label>
                    <input id="itemQty" type="number" class="w-full mt-1 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-bold" placeholder="0">
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="ui.closeModal('itemModal')" class="px-4 py-2 text-slate-500 font-medium hover:bg-white rounded-lg">Cancelar</button>
                <button onclick="actions.saveItem()" class="px-6 py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 shadow-md">GUARDAR</button>
            </div>
        </div>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" id="orderModalTitle">Orden de Compra</h3>
                <button onclick="ui.closeModal('orderModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">ID Orden</label>
                        <input id="orderId" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg bg-slate-50 font-mono" placeholder="N¬∞ OC">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Fecha Entrega</label>
                        <input id="orderDate" type="date" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="text-xs font-bold text-slate-500 uppercase">Cliente</label>
                    <input id="orderClient" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nombre del Cliente / Empresa">
                </div>
                
                <div class="mb-6">
                    <label class="text-xs font-bold text-slate-500 uppercase">Estado</label>
                    <select id="orderStatus" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg bg-white">
                        <option value="Pendiente">üü° Pendiente</option>
                        <option value="En Proceso">üîµ En Proceso</option>
                        <option value="Despachado">üü¢ Despachado</option>
                    </select>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs font-bold text-slate-500 uppercase">Detalle Productos</h4>
                        <button onclick="actions.addTempItemToOrder()" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 font-bold">+ AGREGAR</button>
                    </div>
                    <div id="orderItemsList" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                        </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="ui.closeModal('orderModal')" class="px-4 py-2 text-slate-500 font-medium hover:bg-white rounded-lg">Cancelar</button>
                <button onclick="actions.saveOrder()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md">GUARDAR ORDEN</button>
            </div>
        </div>
    </div>

    <div id="printOcModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-1 text-slate-800"><i class="fas fa-truck text-slate-600 mr-2"></i> Tacha de Venta</h3>
            <p class="text-xs text-slate-500 mb-4">Datos para log√≠stica y despacho</p>
            
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-bold text-slate-500">TOTAL BULTOS</label>
                    <input id="printBultos" type="text" placeholder="Ej: 3 Cajas, 1 Bolsa" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">TRANSPORTE / CHOFER</label>
                    <input id="printCarrier" type="text" placeholder="Ej: Starken / Juan Perez" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">QUIEN RECIBE (CLIENTE)</label>
                    <input id="printReceiver" type="text" placeholder="Nombre persona que recibe" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-slate-100">
                <button onclick="ui.closeModal('printOcModal')" class="px-4 py-2 text-slate-500 font-medium hover:bg-slate-50 rounded-lg">Cancelar</button>
                <button onclick="ReportEngine.generateTachaVenta()" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-900 shadow-lg">GENERAR PDF</button>
            </div>
        </div>
    </div>

    <div id="exitStockModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 border-l-8 border-red-500">
            <h3 class="text-xl font-bold mb-1 text-slate-800 text-red-600">Salida de Stock</h3>
            <p id="exitItemName" class="text-sm font-bold text-slate-700 mb-4 bg-slate-100 p-2 rounded block">Producto Seleccionado</p>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500">CANTIDAD A RETIRAR</label>
                    <input id="exitQty" type="number" placeholder="0" class="w-full mt-1 p-3 border-2 border-red-100 rounded-xl text-center text-xl font-bold text-red-600 focus:border-red-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">MOTIVO / DESTINO</label>
                    <input id="exitReason" type="text" placeholder="Ej: Muestras, Merma, Taller" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">RESPONSABLE</label>
                    <input id="exitResp" type="text" placeholder="Quien autoriza" class="w-full mt-1 p-2.5 border border-slate-200 rounded-lg">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="ui.closeModal('exitStockModal')" class="px-4 py-2 text-slate-500 font-medium hover:bg-slate-50 rounded-lg">Cancelar</button>
                <button onclick="actions.confirmExitStock()" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 shadow-lg">RETIRAR & PDF</button>
            </div>
        </div>
    </div>

    <div id="calNoteModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-6">
            <h3 class="text-lg font-bold mb-2 text-slate-800">Nota de Agenda</h3>
            <p id="calSelectedDate" class="text-xs font-mono text-slate-500 mb-3 bg-slate-100 p-1 rounded inline-block"></p>
            <textarea id="calNoteText" class="w-full p-3 border border-slate-200 rounded-xl mb-3 h-28 resize-none focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Escribe un recordatorio..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="ui.closeModal('calNoteModal')" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg">Cerrar</button>
                <button onclick="actions.saveCalNote()" class="px-4 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // === 1. CONFIGURACI√ìN FIREBASE (NUBE) ===
        const firebaseConfig = { 
            apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew", 
            authDomain: "ideastextilesapp.firebaseapp.com", 
            databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com", 
            projectId: "ideastextilesapp", 
            storageBucket: "ideastextilesapp.firebasestorage.app", 
            messagingSenderId: "268995530035", 
            appId: "1:268995530035:web:1890f45ac761cc81eb0246" 
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Estado Global (Reactivo)
        let state = { inventory: [], orders: [], production: [], calendarNotes: {} };
        let isSyncing = false;

        // === 2. GESTOR DE DATOS (NUBE) ===
        const db = {
            init: () => {
                // Monitor de Conexi√≥n
                database.ref('.info/connected').on('value', snap => {
                    const el = document.getElementById('connection-badge');
                    const dot = document.getElementById('status-dot');
                    if (snap.val() === true) {
                        el.innerHTML = '<span class="live-dot online"></span> ONLINE';
                        el.classList.add('online');
                        dot.classList.add('online'); dot.title = "Conectado a la Nube";
                    } else {
                        el.innerHTML = '<span class="live-dot"></span> OFFLINE';
                        el.classList.remove('online');
                        dot.classList.remove('online'); dot.title = "Sin Conexi√≥n";
                    }
                });

                // Sincronizaci√≥n en Tiempo Real
                database.ref('/').on('value', snap => {
                    const data = snap.val();
                    if(data) {
                        state.inventory = data.inventory || [];
                        state.orders = data.orders || [];
                        state.production = data.production || [];
                        state.calendarNotes = data.calendarNotes || {};
                        
                        // Solo renderizar si no estoy escribiendo yo mismo (evita saltos)
                        if(!isSyncing) { 
                            ui.renderInventory(); 
                            ui.renderOrders(); 
                            ui.renderProduction(); 
                            cal.render(); 
                        }
                    }
                    document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                });
            },
            save: () => {
                isSyncing = true;
                database.ref('/').set(state).then(() => {
                    isSyncing = false;
                }).catch(e => {
                    alert("‚ö†Ô∏è Error de conexi√≥n: " + e.message);
                    isSyncing = false;
                });
            }
        };

        // Variables Auxiliares UI
        let editingIndex = -1;
        let tempOrderItems = [];
        let tempProdList = [];
        let currentDate = new Date();
        let currentExitItemIdx = null;

        // === 3. MOTOR IA (H√çBRIDO EXCEL/OCR) ===
        const IAEngine = {
            async process(f, type) {
                if(!f) return;
                ui.toggleLoader(true);
                try {
                    // MODO EXCEL
                    if(f.name.match(/\.(xlsx|xls|csv)$/i)) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const wb = XLSX.read(e.target.result, {type:'array'});
                            const js = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                            
                            // Detectar columnas inteligentes
                            let map = {prod:-1, qty:-1, client:-1}, hRow = 0;
                            for(let i=0; i<Math.min(js.length,10); i++) {
                                const row = js[i].map(x=>String(x).toUpperCase());
                                row.forEach((c,idx)=>{
                                    if(c.includes('PROD')||c.includes('DESC')) map.prod=idx;
                                    if(c.includes('CANT')||c.includes('CTD')) map.qty=idx;
                                    if(c.includes('CLIENTE')||c.includes('ORDEN')) map.client=idx;
                                });
                                if(map.prod!==-1 && map.qty!==-1){ hRow=i+1; break; }
                            }
                            
                            let cnt=0;
                            if(type==='inv'){
                                for(let i=hRow; i<js.length; i++){
                                    const r=js[i], n=String(r[map.prod]||'').trim(), q=parseInt(r[map.qty]);
                                    if(n && q>0) { state.inventory.push({sku:'IMP-'+Date.now()+cnt, name:n, total:q, hasSizes:false, stockData:{unique:q}}); cnt++; }
                                }
                            } else {
                                let ordMap={};
                                for(let i=hRow; i<js.length; i++){
                                    const r=js[i], n=String(r[map.prod]||'').trim(), q=parseInt(r[map.qty]), c=(map.client!==-1&&r[map.client])?String(r[map.client]):"Importaci√≥n Masiva";
                                    if(n && q>0) { if(!ordMap[c]) ordMap[c]=[]; ordMap[c].push({name:n, total:q, note:''}); }
                                }
                                Object.keys(ordMap).forEach(k=>{ state.orders.push({id:Math.floor(Math.random()*10000), client:k, date:new Date().toISOString().split('T')[0], status:'Pendiente', items:ordMap[k]}); cnt++; });
                            }
                            db.save(); alert(`‚úÖ Procesados ${cnt} registros exitosamente.`);
                        };
                        reader.readAsArrayBuffer(f);
                    } 
                    // MODO FOTO (OCR)
                    else {
                        const {data:{text}} = await Tesseract.recognize(f,'spa');
                        let lines = text.split('\n'), cnt=0;
                        lines.forEach(l=>{
                            let m = l.match(/(.+?)\s+(\d+)$/); // Busca "Producto 123"
                            if(m && m[1].length>3) { 
                                state.inventory.push({sku:'OCR-'+Date.now()+cnt, name:m[1].trim(), total:parseInt(m[2]), hasSizes:false, stockData:{unique:parseInt(m[2])}}); 
                                cnt++; 
                            }
                        });
                        db.save(); alert(`üì∏ OCR detect√≥ ${cnt} items nuevos.`);
                    }
                } catch(e){ alert("Error IA: "+e.message); }
                ui.toggleLoader(false);
            }
        };

        // === 4. MOTOR REPORTES PDF (FIXED & BRANDED) ===
        const ReportEngine = {
            // Reporte Lista General (jsPDF puro)
            async generateGeneralPDF() {
                ui.toggleLoader(true);
                const { jsPDF } = window.jspdf; 
                const doc = new jsPDF(); 
                const now = new Date().toLocaleDateString();
                
                // Header Corporativo
                doc.setFillColor(15, 23, 42); doc.rect(0,0,210,40,'F'); 
                doc.setTextColor(255); doc.setFontSize(22); doc.setFont("helvetica","bold");
                doc.text("IDEAS TEXTILES", 105, 20, {align:"center"}); 
                doc.setFontSize(12); doc.setFont("helvetica","normal");
                doc.text("WORKWEAR AND CORPORATE", 105, 28, {align:"center"});
                doc.setFontSize(10); doc.text(`Reporte de Gesti√≥n al ${now}`, 105, 35, {align:"center"});
                
                let y=50; 
                doc.setTextColor(30); doc.setFontSize(14); doc.setFont("helvetica","bold");
                doc.text("1. INVENTARIO BODEGA", 14, y); y+=5;
                doc.autoTable({startY:y, head:[['SKU','PRODUCTO','STOCK']], body:state.inventory.map(p=>[p.sku, p.name, p.total]), theme:'striped', headStyles:{fillColor:[59,130,246]}});
                
                y = doc.lastAutoTable.finalY + 15; 
                doc.text("2. PEDIDOS EN CURSO", 14, y); y+=5;
                const ordBody = state.orders.filter(o=>o.status!=='Despachado').map(o=>[o.client, o.items.map(i=>`${i.name}(${i.total})`).join(', '), o.status]);
                doc.autoTable({startY:y, head:[['CLIENTE','DETALLE','ESTADO']], body:ordBody, theme:'grid', headStyles:{fillColor:[245,158,11]}});
                
                doc.save(`Reporte_IdeasTextiles_${Date.now()}.pdf`); 
                ui.toggleLoader(false);
            },
            
            // TACHA DE VENTA (Desde OC) - Usando Contenedor Fantasma
            async generateTachaVenta() {
                ui.toggleLoader(true); 
                const bultos=document.getElementById('printBultos').value||"--";
                const carrier=document.getElementById('printCarrier').value||"--";
                const receiver=document.getElementById('printReceiver').value||"--";
                
                let items=[]; 
                Array.from(document.querySelectorAll('.order-check:checked')).forEach(chk=>{ 
                    const o=state.orders[parseInt(chk.value)]; 
                    o.items.forEach(it=>items.push({...it, orderId:o.id, client:o.client})); 
                });

                if(items.length===0){ ui.toggleLoader(false); return alert("‚ö†Ô∏è Selecciona al menos una OC."); }
                
                // Paginaci√≥n 6 por hoja
                const chunks=(arr,n)=>Array.from({length:Math.ceil(arr.length/n)},(_,i)=>arr.slice(i*n,i*n+n));
                let html=`<div style="font-family:Arial,sans-serif;">`;
                
                chunks(items,6).forEach(page=>{
                    html+=`<div class="pdf-sheet-6up">`;
                    page.forEach(it=>{
                        html+=`
                        <div class="tacha-card-6up">
                            <div style="background:#1e293b; color:white; text-align:center; font-weight:bold; font-size:12px; padding:8px; border-bottom:3px solid #f59e0b;">
                                IDEAS TEXTILES - WORKWEAR
                            </div>
                            <div style="padding:10px; flex-grow:1;">
                                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:5px;">
                                    <div style="width:70%;">
                                        <div style="font-weight:900; font-size:16px;">OC #${it.orderId}</div>
                                        <div style="font-size:11px; color:#64748b; white-space:nowrap; overflow:hidden;">${it.client}</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-weight:bold; font-size:20px; color:#1e293b;">${it.total}</div>
                                        <div style="font-size:9px; text-transform:uppercase;">UNIDADES</div>
                                    </div>
                                </div>
                                <div style="font-weight:bold; font-size:14px; margin-bottom:5px; line-height:1.2;">${it.name}</div>
                                ${it.note ? `<div style="background:#fffbeb; color:#b45309; padding:4px; font-size:10px; border-radius:4px; margin-top:5px;">NOTA: ${it.note}</div>` : ''}
                            </div>
                            <div style="background:#f8fafc; padding:8px; border-top:1px solid #e2e8f0; font-size:10px;">
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
                                    <div>üì¶ <b>${bultos}</b></div>
                                    <div>üöõ <b>${carrier}</b></div>
                                </div>
                                <div style="text-align:center; border-top:1px dashed #cbd5e1; padding-top:4px;">
                                    RECIBE: <b>${receiver}</b>
                                </div>
                            </div>
                        </div>`;
                    });
                    html+=`</div>`;
                });
                html+=`</div>`;

                // Renderizar en contenedor oculto (fixed off-screen)
                const c = document.getElementById('pdf-container'); 
                c.innerHTML = html;
                
                // Espera cr√≠tica para renderizado
                await new Promise(r=>setTimeout(r, 1500)); 
                
                await html2pdf().set({
                    margin:0, 
                    filename:'Tachas_Venta_IdeasTextiles.pdf', 
                    image:{type:'jpeg',quality:0.98}, 
                    html2canvas:{scale:2, useCORS:true, letterRendering:true}, 
                    jsPDF:{unit:'mm',format:'a4', orientation:'portrait'}
                }).from(c).save();
                
                c.innerHTML=''; 
                ui.closeModal('printOcModal'); 
                ui.toggleLoader(false);
            },

            // TACHA INTERNA (SALIDA BODEGA)
            async generateTachaInventario(item, qty, reason, resp) {
                ui.toggleLoader(true); const now=new Date().toLocaleString();
                let html=`
                <div class="pdf-sheet-6up" style="font-family:Arial,sans-serif;">
                    <div class="tacha-card-6up" style="border:2px solid #ef4444;">
                        <div style="background:#ef4444; color:white; text-align:center; font-weight:bold; font-size:12px; padding:8px;">
                            TACHA DE PEDIDO (INTERNO)
                        </div>
                        <div style="padding:15px; text-align:center; flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                            <div style="font-size:10px; color:#64748b; margin-bottom:5px;">${now}</div>
                            <div style="font-size:50px; font-weight:900; color:#ef4444; line-height:1;">${qty}</div>
                            <div style="font-size:12px; text-transform:uppercase; color:#ef4444; margin-bottom:10px;">UNIDADES RETIRADAS</div>
                            <div style="font-size:16px; font-weight:bold; color:#1e293b; border-top:1px solid #eee; padding-top:10px;">${item.name}</div>
                            <div style="font-size:12px; color:#64748b;">SKU: ${item.sku}</div>
                        </div>
                        <div style="background:#fef2f2; padding:10px; font-size:11px; border-top:1px solid #fca5a5;">
                            <div style="margin-bottom:5px;"><b>DESTINO:</b> ${reason.toUpperCase()}</div>
                            <div style="margin-bottom:10px;"><b>RESPONSABLE:</b> ${resp.toUpperCase()}</div>
                            <div style="border-top:1px dashed #ef4444; padding-top:15px; text-align:center; color:#ef4444;">
                                FIRMA CONFORME
                            </div>
                        </div>
                    </div>
                </div>`;
                
                const c = document.getElementById('pdf-container'); 
                c.innerHTML = html;
                await new Promise(r=>setTimeout(r,1500));
                await html2pdf().set({margin:0, filename:`Tacha_Salida_${item.sku}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'}}).from(c).save();
                c.innerHTML=''; ui.toggleLoader(false);
            }
        };

        // === 5. CONTROLADOR DE INTERFAZ (UI) ===
        const ui = {
            toggleLoader: (s) => {
                const l = document.getElementById('loader');
                if(s) { l.style.display='flex'; setTimeout(()=>l.classList.remove('opacity-0'),10); } 
                else { l.classList.add('opacity-0'); setTimeout(()=>l.style.display='none',500); }
            },
            showSection: (id) => {
                document.querySelectorAll('main>section').forEach(s=>s.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden'); 
                document.getElementById('mobile-menu').classList.add('hidden'); // Cerrar men√∫ m√≥vil al navegar
                if(id==='calendar') cal.render(); 
                if(id==='inventory') { ui.renderInventory(); ui.renderProduction(); } 
                if(id==='orders') ui.renderOrders();
            },
            openModal: (id) => {
                const m = document.getElementById(id); m.classList.remove('hidden');
                setTimeout(() => m.children[0].classList.remove('scale-95', 'opacity-0'), 10);
            },
            closeModal: (id) => {
                const m = document.getElementById(id);
                m.children[0].classList.add('scale-95', 'opacity-0');
                setTimeout(() => m.classList.add('hidden'), 200);
            },
            
            // Renderizadores
            renderInventory: () => { 
                document.getElementById('inventory-table-body').innerHTML = state.inventory.map((p,i)=>`
                    <tr class="transition-colors hover:bg-slate-50">
                        <td class="font-mono text-xs font-bold text-slate-500">${p.sku}</td>
                        <td class="font-medium text-slate-700">${p.name}</td>
                        <td class="text-center"><span class="bg-blue-100 text-blue-700 px-2.5 py-1 rounded-full text-xs font-bold">${p.total}</span></td>
                        <td class="text-right">
                            <button onclick="actions.openExitModal(${i})" class="bg-red-50 text-red-600 border border-red-200 px-2 py-1 rounded text-xs font-bold hover:bg-red-600 hover:text-white transition mr-2">SALIDA</button>
                            <button onclick="ui.openEditItemModal(${i})" class="text-slate-400 hover:text-blue-600 mr-2 transition"><i class="fas fa-edit"></i></button>
                            <button onclick="actions.delItem(${i})" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join(''); 
            },
            renderOrders: () => { 
                document.getElementById('orders-table-body').innerHTML = state.orders.map((o,i)=>`
                    <tr class="transition-colors hover:bg-slate-50 border-l-4 ${o.status==='Pendiente'?'border-amber-400':(o.status==='Despachado'?'border-green-500':'border-blue-500')}">
                        <td class="text-center"><input type="checkbox" class="order-check w-4 h-4 text-amber-500 rounded focus:ring-amber-500" value="${i}"></td>
                        <td>
                            <div class="font-bold text-slate-800">#${o.id}</div>
                            <div class="text-xs text-slate-500 uppercase font-semibold">${o.client}</div>
                        </td>
                        <td class="text-xs font-medium text-slate-500">${o.date}</td>
                        <td><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${o.status==='Pendiente'?'bg-amber-100 text-amber-700':(o.status==='Despachado'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700')}">${o.status}</span></td>
                        <td class="text-right">
                            <button onclick="ui.openOrderModal(${i})" class="text-slate-400 hover:text-blue-600 mr-3 transition"><i class="fas fa-edit"></i></button>
                            <button onclick="actions.delOrd(${i})" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join(''); 
            },
            renderProduction: () => {
                const c = document.getElementById('production-grid'); c.innerHTML='';
                if(state.production.length === 0) c.innerHTML = '<div class="col-span-full text-center text-slate-400 py-10 italic">No hay lotes en producci√≥n activa.</div>';
                
                state.production.forEach((w,i)=>{
                    const completed = w.stages.filter(s=>s.done).length;
                    const pct = Math.round((completed/4)*100);
                    let stagesHtml = w.stages.map((s,si)=>`
                        <div onclick="actions.toggleStage(${i},${si})" class="stage-row ${s.done?'completed':''}">
                            <div class="flex items-center">
                                <div class="stage-check"><i class="fas fa-check"></i></div>
                                <span class="text-xs font-bold text-slate-600">${s.label}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    c.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm uppercase group-hover:text-amber-600 transition">${w.name}</h4>
                                <span class="text-xs font-medium text-slate-400">${w.total} Unidades</span>
                            </div>
                            <button onclick="actions.delProdWork(${i})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="h-2 w-full bg-slate-100 rounded-full mb-4 overflow-hidden">
                            <div class="h-full bg-amber-500 rounded-full transition-all duration-500 ease-out" style="width:${pct}%"></div>
                        </div>
                        <div class="space-y-1.5">${stagesHtml}</div>
                    </div>`;
                });
            },
            
            // Gesti√≥n de Modales
            openEditItemModal: (i=-1) => { 
                editingIndex=i; 
                document.getElementById('itemModalTitle').innerText = i===-1 ? "Nuevo Producto" : "Editar Producto"; 
                if(i>=0){ 
                    let p=state.inventory[i]; 
                    document.getElementById('itemSku').value=p.sku; 
                    document.getElementById('itemName').value=p.name; 
                    document.getElementById('itemQty').value=p.total; 
                } else { 
                    document.getElementById('itemSku').value='PROD-'+Date.now(); 
                    document.getElementById('itemName').value=''; 
                    document.getElementById('itemQty').value=''; 
                } 
                ui.openModal('itemModal'); 
            },
            
            openProductionModal: () => { 
                tempProdList=[]; 
                document.getElementById('prodWorkName').value=''; 
                const s=document.getElementById('prodSelect'); 
                s.innerHTML='<option value="">Seleccione producto...</option>'; 
                state.inventory.forEach((p,i)=>s.innerHTML+=`<option value="${i}">${p.name}</option>`); 
                ui.renderTempProdList(); 
                ui.openModal('prodItemModal'); 
            },
            renderTempProdList: () => { 
                document.getElementById('tempProdList').innerHTML = tempProdList.map((x,i)=>`
                    <div class="flex justify-between items-center text-sm bg-slate-50 p-2 rounded border border-slate-100">
                        <span class="font-medium text-slate-700">${x.name} <span class="text-xs text-slate-400">(${x.size})</span></span>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-amber-600">${x.qty}</span>
                            <button onclick="actions.remProdFromLote(${i})" class="text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                `).join(''); 
            },
            
            openOrderModal: (i=-1) => { 
                editingIndex=i; 
                document.getElementById('orderModalTitle').innerText = i===-1 ? "Nueva Orden" : "Editar Orden"; 
                if(i>=0){ 
                    let o=state.orders[i]; 
                    document.getElementById('orderId').value=o.id; 
                    document.getElementById('orderClient').value=o.client; 
                    document.getElementById('orderDate').value=o.date; 
                    document.getElementById('orderStatus').value=o.status; 
                    tempOrderItems=JSON.parse(JSON.stringify(o.items)); 
                } else { 
                    document.getElementById('orderId').value=Math.floor(Math.random()*10000); 
                    document.getElementById('orderClient').value=''; 
                    document.getElementById('orderDate').value=new Date().toISOString().split('T')[0]; 
                    tempOrderItems=[]; 
                } 
                ui.renderTempOrderItems(); 
                ui.openModal('orderModal'); 
            },
            renderTempOrderItems: () => { 
                document.getElementById('orderItemsList').innerHTML = tempOrderItems.map((it,ix)=>`
                    <div class="flex justify-between items-center text-sm bg-white p-2.5 rounded-lg border border-slate-200">
                        <span class="font-medium text-slate-700">${it.name} <span class="font-bold text-amber-600">(${it.total})</span></span> 
                        <div class="flex items-center gap-2">
                            <input class="border border-slate-200 text-xs p-1.5 w-24 rounded focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Nota..." value="${it.note||''}" onchange="actions.updOrdNote(${ix},this.value)"> 
                            <button onclick="actions.remOrdItem(${ix})" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                `).join(''); 
            },
            
            openCalNote: (k) => { 
                document.getElementById('calSelectedDate').innerText=k; 
                document.getElementById('calSelectedDate').dataset.val=k; 
                document.getElementById('calNoteText').value=state.calendarNotes[k]||''; 
                ui.openModal('calNoteModal'); 
            },
            
            selectAll: (e) => document.querySelectorAll('.order-check').forEach(c=>c.checked=e.checked),
            printSelectedOrders: () => { 
                if(document.querySelectorAll('.order-check:checked').length===0) return alert("‚ö†Ô∏è Selecciona al menos una OC."); 
                ui.openModal('printOcModal'); 
            }
        };

        // === 6. ACCIONES DE NEGOCIO ===
        const actions = {
            // Inventario
            saveItem: () => { 
                const n=document.getElementById('itemName').value, q=parseInt(document.getElementById('itemQty').value), s=document.getElementById('itemSku').value; 
                if(n && q>=0){ 
                    if(editingIndex>=0) state.inventory[editingIndex]={sku:s,name:n,total:q,hasSizes:false,stockData:{unique:q}}; 
                    else state.inventory.push({sku:s,name:n,total:q,hasSizes:false,stockData:{unique:q}}); 
                    db.save(); ui.renderInventory(); ui.closeModal('itemModal'); 
                } 
            },
            delItem: (i) => { if(confirm("¬øEliminar item del inventario?")){ state.inventory.splice(i,1); db.save(); ui.renderInventory(); } },
            
            // Salida Stock (Tacha Interna)
            openExitModal: (i) => { 
                currentExitItemIdx=i; 
                document.getElementById('exitItemName').innerText=state.inventory[i].name; 
                document.getElementById('exitQty').value=''; 
                document.getElementById('exitReason').value=''; 
                document.getElementById('exitResp').value=''; 
                ui.openModal('exitStockModal'); 
            },
            confirmExitStock: () => { 
                const qty=parseInt(document.getElementById('exitQty').value); 
                const reason=document.getElementById('exitReason').value; 
                const resp=document.getElementById('exitResp').value; 
                
                if(!qty||qty<=0||!reason||!resp) return alert("‚ö†Ô∏è Completa todos los campos"); 
                
                let item=state.inventory[currentExitItemIdx]; 
                if(item.total<qty) return alert("‚ö†Ô∏è Stock insuficiente"); 
                
                // Descuento
                item.total-=qty; 
                if(item.stockData) item.stockData.unique-=qty; 
                
                db.save(); 
                ui.renderInventory(); 
                ui.closeModal('exitStockModal'); 
                
                // Generar Tacha
                ReportEngine.generateTachaInventario(item,qty,reason,resp); 
            },

            // Producci√≥n
            addProdToLote: () => { 
                const idx=document.getElementById('prodSelect').value; 
                const q=parseInt(document.getElementById('prodQtyInput').value); 
                const sz=document.getElementById('prodSizeInput').value||'UNICA'; 
                
                if(idx && q){ 
                    const p=state.inventory[idx]; 
                    tempProdList.push({name:p.name,qty:q,size:sz}); 
                    ui.renderTempProdList(); 
                    document.getElementById('prodSizeInput').value=''; 
                    document.getElementById('prodQtyInput').value=''; 
                } 
            },
            remProdFromLote: (i) => { tempProdList.splice(i,1); ui.renderTempProdList(); },
            createWorkOrder: () => { 
                const n=document.getElementById('prodWorkName').value; 
                if(n && tempProdList.length>0){ 
                    state.production.push({ id:Date.now(), name:n, total:tempProdList.reduce((a,b)=>a+b.qty,0), items:tempProdList, stages:[{label:'Corte',done:false},{label:'Confecci√≥n',done:false},{label:'Terminaci√≥n',done:false},{label:'Bodega',done:false}]}); 
                    db.save(); ui.renderProduction(); ui.closeModal('prodItemModal'); 
                } else alert("‚ö†Ô∏è Agrega un nombre y al menos un producto."); 
            },
            delProdWork: (i) => { if(confirm("¬øEliminar lote de producci√≥n?")){ state.production.splice(i,1); db.save(); ui.renderProduction(); } },
            toggleStage: (i, si) => { 
                let w=state.production[i]; 
                // L√≥gica Fin de Ciclo (Bodega)
                if(w.stages[si].label==='Bodega' && !w.stages[si].done) { 
                    if(confirm("¬øIngresar productos terminados al inventario?")) { 
                        w.items.forEach(it=>{ 
                            let p=state.inventory.find(x=>x.name===it.name); 
                            if(p){ p.total+=it.qty; if(p.stockData) p.stockData.unique+=it.qty; } 
                            else { state.inventory.push({sku:'PROD-'+Date.now(), name:it.name, total:it.qty, hasSizes:false, stockData:{unique:it.qty}}); } 
                        }); 
                        w.stages[si].done=true; 
                        db.save(); 
                        if(confirm("‚úÖ Stock actualizado. ¬øArchivar Lote?")) { state.production.splice(i,1); db.save(); }
                        ui.renderProduction();
                    } 
                } else { 
                    w.stages[si].done=!w.stages[si].done; 
                    db.save(); 
                    ui.renderProduction(); 
                }
            },

            // √ìrdenes
            addTempItemToOrder: () => { const n=prompt("Nombre Producto:"), q=prompt("Cantidad:"); if(n&&q) { tempOrderItems.push({name:n, total:parseInt(q), note:''}); ui.renderTempOrderItems(); } },
            remOrdItem: (i) => { tempOrderItems.splice(i,1); ui.renderTempOrderItems(); },
            updOrdNote: (i,v) => { tempOrderItems[i].note=v; },
            saveOrder: () => { 
                const c=document.getElementById('orderClient').value; 
                if(c){ 
                    const o={id:document.getElementById('orderId').value, client:c, date:document.getElementById('orderDate').value, status:document.getElementById('orderStatus').value, items:tempOrderItems}; 
                    if(editingIndex>=0) state.orders[editingIndex]=o; else state.orders.push(o); 
                    db.save(); ui.renderOrders(); ui.closeModal('orderModal'); 
                } else alert("‚ö†Ô∏è Falta nombre del cliente");
            },
            delOrd: (i) => { if(confirm("¬øEliminar Orden de Compra?")){ state.orders.splice(i,1); db.save(); ui.renderOrders(); } },
            
            // Calendario
            saveCalNote: () => { 
                const k=document.getElementById('calSelectedDate').dataset.val, txt=document.getElementById('calNoteText').value; 
                if(txt) state.calendarNotes[k]=txt; else delete state.calendarNotes[k]; 
                db.save(); cal.render(); ui.closeModal('calNoteModal'); 
            },
            
            // Sistema
            factoryReset: () => { if(confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO?\nEsto borrar√° TODOS los datos de la nube permanentemente.")){ database.ref('/').set(null); location.reload(); } }
        };

        // Funci√≥n Auxiliar Menu Movil
        function toggleMobileMenu() {
            const m = document.getElementById('mobile-menu');
            m.classList.toggle('hidden');
        }

        // --- INICIALIZACI√ìN ---
        cal.render = cal.render.bind(cal); // Bind context
        db.init(); 
        ui.showSection('calendar'); // Vista inicial
    </script>
</body>
</html>
