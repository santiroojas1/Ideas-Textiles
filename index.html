<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEAS TEXTILES SPA | ERP CORPORATE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --brand-dark: #0f172a;
            --brand-primary: #2563eb;
            --brand-accent: #3b82f6;
            --bg-app: #f1f5f9;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-ios-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-ios-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: #334155;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        .nav-bubble {
            position: relative;
            transition: all 0.3s var(--transition-bounce);
            overflow: hidden;
            border: 1px solid transparent;
        }
        
        .nav-bubble:hover {
            transform: translateY(-4px) scale(1.02);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .nav-bubble.active {
            background: white;
            color: var(--brand-dark);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .nav-bubble.active i { color: var(--brand-primary); }

        .card-glass {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card-glass:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-ios-lg);
            border-color: #cbd5e1;
        }

        .btn-ios { transition: all 0.2s active; }
        .btn-ios:active { transform: scale(0.95); }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        
        .cal-day {
            min-height: 110px;
            background: white;
            border-radius: 16px;
            border: 1px solid #f1f5f9;
            padding: 8px;
            display: flex; flex-direction: column;
            cursor: pointer; transition: 0.2s;
        }
        
        .cal-day:hover { border-color: var(--brand-primary); background: #f8fafc; }
        .cal-day.today { background: #eff6ff; border: 2px solid var(--brand-primary); }
        
        .cal-event {
            font-size: 0.6rem; padding: 4px 6px; border-radius: 6px; margin-top: 3px;
            font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 4px; border-left-width: 3px;
        }
        .evt-pending { background: #fffbeb; color: #b45309; border-color: #fcd34d; }
        .evt-dispatch { background: #f0fdf4; color: #15803d; border-color: #4ade80; }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed; bottom: 0; left: 0; width: 100%; height: auto;
                flex-direction: row; justify-content: space-evenly;
                border-radius: 24px 24px 0 0; padding: 10px; z-index: 50;
                background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px);
            }
            .sidebar-logo, .nav-label, .sidebar-footer { display: none; }
            .nav-bubble { padding: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
            main { padding-bottom: 110px; }
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col justify-center items-center text-white transition-opacity duration-700">
        <div class="relative mb-6">
            <div class="w-20 h-20 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"></div>
            <i class="fas fa-scissors absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl text-white"></i>
        </div>
        <h2 class="font-black text-3xl tracking-[8px] uppercase">Ideas Textiles</h2>
        <p class="text-xs font-bold text-slate-500 mt-2 uppercase tracking-widest">Cargando ...</p>
    </div>

    <div id="connection-widget" class="fixed top-4 right-4 z-50 bg-white/90 backdrop-blur px-3 py-1.5 rounded-full border border-slate-200 shadow-lg flex items-center gap-2 transition-all">
        <span class="relative flex h-2.5 w-2.5">
          <span id="ping-dot" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
          <span id="static-dot" class="relative inline-flex rounded-full h-2.5 w-2.5 bg-slate-500"></span>
        </span>
        <span id="conn-text" class="text-[10px] font-bold text-slate-600">INICIANDO</span>
    </div>

    <div class="flex flex-col lg:flex-row min-h-screen">
        <aside class="sidebar bg-[#0f172a] text-slate-300 w-full lg:w-72 lg:p-6 flex lg:flex-col justify-between relative shadow-2xl z-40">
            <div class="sidebar-logo z-10 mb-8">
                <div class="flex items-center gap-3 text-white">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/40">
                        <i class="fas fa-scissors text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-black italic text-lg leading-none tracking-tight">IDEAS<br><span class="text-blue-500">TEXTILES</span></h1>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-800">
                    <p class="text-[9px] font-bold text-slate-500 tracking-[2px] uppercase">Workwear & Corporate</p>
                </div>
            </div>

            <nav class="flex lg:flex-col gap-2 w-full lg:flex-1 z-10">
                <div onclick="App.Router.go('dashboard')" id="nav-dashboard" class="nav-bubble active p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400">
                    <i class="fas fa-chart-pie w-6 text-center"></i> <span class="nav-label">Dashboard</span>
                </div>
                <div onclick="App.Router.go('inventory')" id="nav-inventory" class="nav-bubble p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400">
                    <i class="fas fa-tshirt w-6 text-center"></i> <span class="nav-label">Bodega</span>
                </div>
                <div onclick="App.Router.go('orders')" id="nav-orders" class="nav-bubble p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400">
                    <i class="fas fa-file-invoice w-6 text-center"></i> <span class="nav-label">Ã“rdenes</span>
                </div>
                <div onclick="App.Router.go('calendar')" id="nav-calendar" class="nav-bubble p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400">
                    <i class="fas fa-calendar-alt w-6 text-center"></i> <span class="nav-label">Agenda</span>
                </div>
            </nav>

            <div class="sidebar-footer z-10 mt-auto pt-4 border-t border-slate-800">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white">AC</div>
                    <div>
                        <p class="text-xs font-bold text-white">Alejandro Cisterna</p>
                        <p class="text-[10px] text-slate-500">Gerente General</p>
                    </div>
                </div>
            </div>
            <div class="absolute top-0 right-0 w-48 h-48 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-10 pointer-events-none"></div>
        </aside>

        <main class="flex-1 p-4 lg:p-8 overflow-y-auto relative scroll-smooth">
            <section id="view-dashboard" class="fade-in">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">Panel General</h2>
                        <p class="text-slate-500 text-sm font-medium mt-1">VisiÃ³n global de operaciones</p>
                    </div>
                    <button onclick="App.Actions.systemReset()" class="btn-ios text-[10px] font-bold text-red-500 bg-red-50 px-4 py-2 rounded-lg hover:bg-red-100 transition">
                        <i class="fas fa-exclamation-triangle mr-1"></i> RESET DB
                    </button>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card-glass bg-gradient-to-br from-slate-800 to-slate-900 text-white border-none">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-xs font-bold opacity-60 uppercase">Items en Bodega</p>
                                <h3 class="text-4xl font-black mt-2" id="dash-stock">0</h3>
                            </div>
                            <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center"><i class="fas fa-box text-lg"></i></div>
                        </div>
                    </div>
                    
                    <div class="card-glass">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">Ã“rdenes Activas</p>
                                <h3 class="text-4xl font-black text-slate-800 mt-2" id="dash-pending">0</h3>
                            </div>
                            <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-clock text-lg"></i></div>
                        </div>
                    </div>

                    <div class="card-glass">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">Despachos Mes</p>
                                <h3 class="text-4xl font-black text-slate-800 mt-2" id="dash-dispatch">0</h3>
                            </div>
                            <div class="w-10 h-10 bg-green-50 text-green-600 rounded-full flex items-center justify-center"><i class="fas fa-truck text-lg"></i></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-inventory" class="hidden fade-in">
                <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">Bodega</h2>
                        <p class="text-slate-500 text-sm">GestiÃ³n de stock multi-talla</p>
                    </div>
                    <button onclick="App.UI.Modals.newProduct()" class="btn-ios bg-[#0f172a] text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-slate-300 flex items-center gap-2 text-sm hover:bg-slate-800">
                        <i class="fas fa-plus"></i> NUEVO PRODUCTO
                    </button>
                </header>
                <div id="inventory-grid" class="grid grid-cols-1 gap-4"></div>
            </section>

            <section id="view-orders" class="hidden fade-in">
                <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">Ã“rdenes</h2>
                        <p class="text-slate-500 text-sm">Ventas, Despachos y Etiquetas</p>
                    </div>
                    <button onclick="App.UI.Modals.newOrder()" class="btn-ios bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 flex items-center gap-2 text-sm hover:bg-blue-700">
                        <i class="fas fa-cart-shopping"></i> CREAR OC
                    </button>
                </header>
                <div id="orders-grid" class="grid grid-cols-1 gap-6"></div>
            </section>

            <section id="view-calendar" class="hidden fade-in">
                <div class="card-glass p-6 mb-6 flex justify-between items-center">
                    <button onclick="App.Logic.Calendar.move(-1)" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-white hover:shadow flex items-center justify-center transition"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-xl font-black text-slate-800 uppercase tracking-widest" id="cal-month-title">MES AÃ‘O</h2>
                    <button onclick="App.Logic.Calendar.move(1)" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-white hover:shadow flex items-center justify-center transition"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-8 text-center mb-4">
                    <div class="text-xs font-bold text-slate-400 uppercase">Lun</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Mar</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">MiÃ©</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Jue</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Vie</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">SÃ¡b</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Dom</div>
                </div>
                <div id="calendar-grid" class="cal-grid"></div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew", authDomain: "ideastextilesapp.firebaseapp.com", databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com", projectId: "ideastextilesapp", storageBucket: "ideastextilesapp.firebasestorage.app", messagingSenderId: "268995530035", appId: "1:268995530035:web:1890f45ac761cc81eb0246" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const State = {
            inventory: [],
            orders: [],
            calendar: {},
            dateContext: new Date()
        };

        window.App = {
            init: () => {
                onValue(ref(db, 'inventory'), s => { State.inventory = s.val() || []; App.UI.renderInventory(); App.UI.updateDashboard(); });
                onValue(ref(db, 'orders'), s => { State.orders = s.val() || []; App.UI.renderOrders(); App.UI.updateDashboard(); App.Logic.Calendar.render(); });
                onValue(ref(db, 'calendar'), s => { State.calendar = s.val() || {}; App.Logic.Calendar.render(); });
                onValue(ref(db, ".info/connected"), s => {
                    const txt = document.getElementById('conn-text');
                    const dot = document.getElementById('ping-dot');
                    if(s.val()){ txt.innerText = "ONLINE"; dot.classList.add('bg-green-400'); dot.classList.remove('bg-red-400'); }
                    else { txt.innerText = "OFFLINE"; dot.classList.add('bg-red-400'); dot.classList.remove('bg-green-400'); }
                });
                setTimeout(()=> document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none'), 1200);
            },

            Router: {
                go: (page) => {
                    document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
                    document.getElementById('view-'+page).classList.remove('hidden');
                    document.querySelectorAll('.nav-bubble').forEach(n => n.classList.remove('active'));
                    document.getElementById('nav-'+page).classList.add('active');
                    if(page === 'calendar') App.Logic.Calendar.render();
                }
            },

            UI: {
                updateDashboard: () => {
                    document.getElementById('dash-stock').innerText = State.inventory.length;
                    document.getElementById('dash-pending').innerText = State.orders.filter(o => o.status !== 'Despachado').length;
                    const month = new Date().toISOString().slice(0, 7);
                    document.getElementById('dash-dispatch').innerText = State.orders.filter(o => o.status === 'Despachado' && o.dispatchDate?.startsWith(month)).length;
                },

                renderInventory: () => {
                    const grid = document.getElementById('inventory-grid');
                    if(State.inventory.length === 0) { grid.innerHTML = '<div class="p-8 text-center text-slate-400 font-medium">Inventario vacÃ­o.</div>'; return; }
                    grid.innerHTML = State.inventory.map((p, i) => {
                        let badges = ''; let total = 0;
                        if(p.stock) Object.entries(p.stock).forEach(([sz, qty]) => {
                            badges += `<span class="bg-slate-100 text-slate-600 border border-slate-200 px-2 py-1 rounded text-xs font-bold mr-2 mb-1 inline-block">${sz}: ${qty}</span>`;
                            total += qty;
                        });
                        return `
                        <div class="card-glass flex flex-col md:flex-row justify-between items-center group">
                            <div class="mb-4 md:mb-0">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center font-bold text-lg">${p.name.charAt(0)}</div>
                                    <div>
                                        <div class="font-bold text-lg text-slate-800">${p.name}</div>
                                        <div class="text-[10px] text-slate-400 font-mono">SKU: ${p.sku}</div>
                                    </div>
                                    <button onclick="App.UI.Modals.editProduct(${i})" class="ml-2 text-slate-300 hover:text-blue-500 transition"><i class="fas fa-edit"></i></button>
                                </div>
                                <div class="mt-3">${badges}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] font-bold text-slate-400 uppercase">Stock Total</div>
                                <div class="text-3xl font-black text-slate-700">${total}</div>
                            </div>
                        </div>`;
                    }).join('');
                },

                renderOrders: () => {
                    const grid = document.getElementById('orders-grid');
                    const list = [...State.orders].sort((a,b) => a.status === 'Pendiente' ? -1 : 1);
                    grid.innerHTML = list.map((o) => {
                        const idx = State.orders.indexOf(o);
                        // FIX 3: HACER ITEMS CLICKEABLES PARA EDITAR
                        const itemsHtml = o.items.map((it, i) => `
                            <div onclick="App.UI.Modals.editOrderItem(${idx}, ${i})" class="flex justify-between items-start border-b border-slate-100 py-2 last:border-0 text-sm hover:bg-blue-50 cursor-pointer px-1 rounded transition">
                                <div>
                                    <span class="font-bold text-blue-600">${it.qty}</span> x ${it.name} <span class="bg-slate-100 px-1 rounded text-xs font-bold text-slate-500">${it.size}</span>
                                    ${it.msg ? `<div class="text-[10px] text-amber-600 mt-1 italic"><i class="fas fa-comment-alt mr-1"></i>${it.msg}</div>` : ''}
                                </div>
                                <i class="fas fa-pencil-alt text-[10px] text-slate-300 mt-1"></i>
                            </div>`).join('');

                        return `
                        <div class="card-glass border-l-4 ${o.status==='Despachado'?'border-l-green-500 opacity-80':'border-l-blue-500'}">
                            <div class="flex flex-col md:flex-row justify-between items-start mb-4">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h3 class="font-bold text-xl text-slate-800">${o.client}</h3>
                                        <button onclick="App.UI.Modals.editOrderHeader(${idx})" class="text-slate-300 hover:text-blue-500 text-xs"><i class="fas fa-edit"></i></button>
                                    </div>
                                    <div class="text-xs text-slate-500 font-medium mt-1 flex gap-3">
                                        <span><i class="far fa-calendar mr-1"></i>${o.date}</span>
                                        <span><i class="fas fa-hashtag mr-1"></i>${o.id}</span>
                                        ${o.place ? `<span><i class="fas fa-map-marker-alt mr-1"></i>${o.place}</span>` : ''}
                                    </div>
                                </div>
                                <span class="mt-2 md:mt-0 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${o.status==='Despachado'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'}">${o.status}</span>
                            </div>
                            <div class="bg-slate-50 rounded-xl p-4 mb-4 border border-slate-100 shadow-inner max-h-48 overflow-y-auto">${itemsHtml}</div>
                            <div class="flex flex-wrap justify-end gap-3">
                                <button onclick="App.PDF.downloadTachas(${idx})" class="btn-ios bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow flex items-center gap-2"><i class="fas fa-tags"></i> PDF TACHAS</button>
                                ${o.status !== 'Despachado' ? 
                                `<button onclick="App.Actions.dispatch(${idx})" class="btn-ios bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow flex items-center gap-2"><i class="fas fa-truck-loading"></i> DESPACHAR</button>` : 
                                `<div class="text-xs font-bold text-green-600 border border-green-200 bg-green-50 px-3 py-2 rounded flex items-center gap-1"><i class="fas fa-check-circle"></i> Fac: ${o.invoice}</div>`}
                                <button onclick="App.Actions.deleteOrder(${idx})" class="text-red-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                    }).join('');
                },

                Modals: {
                    newProduct: async () => {
                        await Swal.fire({
                            title: 'Nuevo Producto Multi-Talla',
                            width: '600px',
                            html: `
                                <input id="np-name" class="swal2-input" placeholder="Nombre del Producto">
                                <div class="bg-slate-50 p-3 rounded mt-3 border border-slate-200">
                                    <label class="text-xs font-bold text-slate-400 uppercase">ConfiguraciÃ³n de Tallas</label>
                                    <div id="size-rows-container"></div>
                                    <button type="button" onclick="App.UI.Helpers.addSizeRow()" class="mt-2 text-xs font-bold text-blue-600 hover:underline">+ Agregar otra talla</button>
                                </div>
                            `,
                            didOpen: () => { App.UI.Helpers.addSizeRow(); },
                            preConfirm: () => {
                                const name = document.getElementById('np-name').value.trim();
                                const rows = document.querySelectorAll('.size-row');
                                let stock = {};
                                rows.forEach(r => {
                                    let s = r.querySelector('.sz-in').value.trim().toUpperCase();
                                    const q = parseInt(r.querySelector('.qt-in').value);
                                    if (!isNaN(q)) {
                                        // FIX 1: SI LA TALLA ESTA VACIA, ES UNICA
                                        let finalSize = (s === "") ? "ÃšNICA" : s;
                                        stock[finalSize] = q;
                                    }
                                });
                                if (!name) return Swal.showValidationMessage('El nombre es obligatorio');
                                // Si no hay filas pero hay nombre, creamos ÃšNICA con 0
                                if(Object.keys(stock).length === 0) stock["ÃšNICA"] = 0;
                                return { name: name.toUpperCase(), stock };
                            }
                        }).then(res => { if(res.isConfirmed) App.Logic.Inventory.add(res.value); });
                    },

                    editProduct: async (index) => {
                        const p = State.inventory[index];
                        const {value: newName} = await Swal.fire({title:'Editar Nombre', input:'text', inputValue: p.name});
                        if(newName) {
                            State.inventory[index].name = newName.toUpperCase();
                            set(ref(db, 'inventory'), State.inventory);
                        }
                    },

                    newOrder: async () => {
                        let cart = [];
                        const renderCart = () => {
                            document.getElementById('cart-view').innerHTML = cart.map((it, i) => `
                                <div class="flex justify-between text-xs border-b p-1">
                                    <span>${it.qty} x ${it.name} (${it.size}) <i class="text-gray-400">${it.msg||''}</i></span>
                                    <span class="text-red-500 cursor-pointer font-bold" onclick="document.getElementById('btn-rm-${i}').click()" id="btn-rm-${i}">X</span>
                                </div>
                            `).join('');
                            cart.forEach((_,i)=> document.getElementById(`btn-rm-${i}`).onclick = ()=> { cart.splice(i,1); renderCart(); });
                        };

                        await Swal.fire({
                            title: 'Crear Orden de Compra',
                            width: '700px',
                            html: `
                                <div class="grid grid-cols-2 gap-4">
                                    <input id="oc-client" class="swal2-input" placeholder="Cliente">
                                    <input id="oc-place" class="swal2-input" placeholder="Lugar Despacho (Opcional)">
                                </div>
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mt-4 text-left">
                                    <div class="grid grid-cols-12 gap-2">
                                        <div class="col-span-4"><input id="oc-prod" class="swal2-input m-0 text-sm h-10" placeholder="Producto"></div>
                                        <div class="col-span-2"><input id="oc-size" class="swal2-input m-0 text-sm h-10" placeholder="Talla"></div>
                                        <div class="col-span-2"><input id="oc-qty" type="number" class="swal2-input m-0 text-sm h-10" placeholder="Cant"></div>
                                        <div class="col-span-4"><input id="oc-msg" class="swal2-input m-0 text-sm h-10" placeholder="Nota Item"></div>
                                    </div>
                                    <div class="mt-2 text-right">
                                        <button type="button" id="btn-add-item" class="bg-slate-800 text-white px-4 py-2 rounded font-bold text-xs">AGREGAR AL CARRITO</button>
                                    </div>
                                </div>
                                <div class="mt-4 text-left">
                                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Carrito de Compras</div>
                                    <div id="cart-view" class="h-32 overflow-y-auto bg-white border rounded p-2"></div>
                                </div>
                            `,
                            didOpen: () => {
                                document.getElementById('btn-add-item').onclick = () => {
                                    const name = document.getElementById('oc-prod').value.toUpperCase();
                                    const size = document.getElementById('oc-size').value.toUpperCase() || 'ÃšNICA';
                                    const qty = parseInt(document.getElementById('oc-qty').value);
                                    const msg = document.getElementById('oc-msg').value;
                                    
                                    if(name && qty > 0) {
                                        const exists = State.inventory.find(p => p.name === name);
                                        if(!exists) {
                                            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 2000});
                                            Toast.fire({icon: 'info', title: 'Producto nuevo preparado'});
                                            // FIX 2: NO GUARDAMOS EN FIREBASE AUN. SOLO EN MEMORIA
                                            State.inventory.push({ sku: 'NEW-'+Date.now().toString().slice(-4), name: name, stock: { [size]: 0 } });
                                        } else if(!exists.stock[size]) {
                                            exists.stock[size] = 0;
                                        }
                                        cart.push({name, size, qty, msg});
                                        renderCart();
                                        document.getElementById('oc-prod').value = '';
                                        document.getElementById('oc-qty').value = '';
                                        document.getElementById('oc-msg').value = '';
                                        document.getElementById('oc-prod').focus();
                                    }
                                };
                            },
                            preConfirm: () => {
                                const c = document.getElementById('oc-client').value;
                                const p = document.getElementById('oc-place').value;
                                if(!c || cart.length===0) return Swal.showValidationMessage('Cliente y Productos requeridos');
                                return { client: c, place: p, cart };
                            }
                        }).then(res => { if(res.isConfirmed) App.Logic.Orders.create(res.value); });
                    },

                    // NUEVA FUNCIÃ“N: EDITAR ITEM DE UNA OC YA CREADA
                    editOrderItem: async (orderIdx, itemIdx) => {
                        const item = State.orders[orderIdx].items[itemIdx];
                        const { value: form } = await Swal.fire({
                            title: 'Editar Item en OC',
                            html: `
                                <div class="text-left">
                                    <label class="text-[10px] font-bold text-slate-400">CANTIDAD</label>
                                    <input id="ed-qty" type="number" class="swal2-input m-0 mb-3" value="${item.qty}">
                                    <label class="text-[10px] font-bold text-slate-400">TALLA</label>
                                    <input id="ed-size" class="swal2-input m-0 mb-3" value="${item.size}">
                                    <label class="text-[10px] font-bold text-slate-400">MENSAJE / NOTA</label>
                                    <input id="ed-msg" class="swal2-input m-0" value="${item.msg || ''}">
                                </div>
                            `,
                            preConfirm: () => ({
                                qty: parseInt(document.getElementById('ed-qty').value),
                                size: document.getElementById('ed-size').value.toUpperCase(),
                                msg: document.getElementById('ed-msg').value
                            })
                        });
                        if(form && !isNaN(form.qty)) {
                            State.orders[orderIdx].items[itemIdx] = { ...item, ...form };
                            set(ref(db, 'orders'), State.orders);
                            Swal.fire({ icon: 'success', title: 'Item Actualizado', timer: 1000, showConfirmButton: false });
                        }
                    },

                    editOrderHeader: async (index) => {
                        const o = State.orders[index];
                        const { value: form } = await Swal.fire({
                            title: 'Editar Cabecera OC',
                            html: `
                                <label class="block text-xs font-bold text-left text-gray-500">ID Orden</label>
                                <input id="eo-id" class="swal2-input m-0 mb-3" value="${o.id}">
                                <label class="block text-xs font-bold text-left text-gray-500">Lugar Despacho</label>
                                <input id="eo-place" class="swal2-input m-0" value="${o.place || ''}">
                            `,
                            preConfirm: () => ({ id: document.getElementById('eo-id').value, place: document.getElementById('eo-place').value })
                        });
                        if(form) {
                            o.id = form.id;
                            o.place = form.place;
                            set(ref(db, 'orders'), State.orders);
                        }
                    }
                },

                Helpers: {
                    addSizeRow: () => {
                        const div = document.createElement('div');
                        div.className = 'flex gap-2 mb-2 size-row';
                        div.innerHTML = `<input class="swal2-input m-0 text-sm sz-in" placeholder="Talla (Vacio = UNICA)" style="width:50%"><input type="number" class="swal2-input m-0 text-sm qt-in" placeholder="Cant" style="width:50%">`;
                        document.getElementById('size-rows-container').appendChild(div);
                    }
                }
            },

            Logic: {
                Inventory: {
                    add: (data) => {
                        let p = State.inventory.find(x => x.name === data.name.toUpperCase());
                        if(p) {
                            Object.keys(data.stock).forEach(sz => { p.stock[sz] = (p.stock[sz]||0) + data.stock[sz]; });
                        } else {
                            State.inventory.push({ sku: 'SKU-'+Date.now().toString().slice(-5), name: data.name.toUpperCase(), stock: data.stock });
                        }
                        set(ref(db, 'inventory'), State.inventory);
                    }
                },

                Orders: {
                    create: async (data) => {
                        // FIX 2: AHORA SI GUARDAMOS EL INVENTARIO CON LOS POSIBLES PRODUCTOS NUEVOS
                        await set(ref(db, 'inventory'), State.inventory);

                        const order = {
                            id: Date.now().toString().slice(-6),
                            client: data.client.toUpperCase(),
                            place: data.place || 'Bodega Central',
                            date: new Date().toISOString().split('T')[0],
                            status: 'Pendiente',
                            items: data.cart
                        };
                        State.orders.push(order);
                        await set(ref(db, 'orders'), State.orders);
                        Swal.fire('Ã‰xito', 'Orden Creada Correctamente', 'success');
                    }
                },

                Calendar: {
                    move: (d) => { State.dateContext.setMonth(State.dateContext.getMonth()+d); App.Logic.Calendar.render(); },
                    render: () => {
                        const y = State.dateContext.getFullYear(), m = State.dateContext.getMonth();
                        document.getElementById('cal-month-title').innerText = new Date(y,m).toLocaleString('es-ES',{month:'long',year:'numeric'});
                        const days = new Date(y,m+1,0).getDate();
                        const start = new Date(y,m,1).getDay() || 7; 
                        let html = '';
                        for(let i=1; i<start; i++) html+=`<div></div>`;
                        for(let i=1; i<=days; i++) {
                            const k = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                            const isToday = k === new Date().toISOString().split('T')[0] ? 'today' : '';
                            let content = '';
                            if(State.calendar[k]) content += `<div class="cal-event evt-pending">ðŸ“Œ ${State.calendar[k]}</div>`;
                            const ds = State.orders.filter(o => o.dispatchDate === k);
                            ds.forEach(o => content += `<div class="cal-event evt-dispatch">ðŸšš ${o.client.substring(0,8)}...</div>`);
                            html += `<div class="cal-day ${isToday}" onclick="App.Actions.addNote('${k}')">
                                <span class="text-xs font-bold text-slate-400">${i}</span>
                                <div class="flex-1 overflow-hidden flex flex-col justify-end">${content}</div>
                            </div>`;
                        }
                        document.getElementById('calendar-grid').innerHTML = html;
                    }
                }
            },

            Actions: {
                dispatch: async (index) => {
                    const { value: f } = await Swal.fire({
                        title: 'Confirmar Despacho',
                        html: `<input id="d-inv" class="swal2-input" placeholder="NÂ° Factura"><input id="d-bul" class="swal2-input" placeholder="NÂ° Bultos">`,
                        focusConfirm: false,
                        preConfirm: () => {
                            const i = document.getElementById('d-inv').value, b = document.getElementById('d-bul').value;
                            if(!i || !b) return Swal.showValidationMessage('Factura y Bultos requeridos');
                            return { i, b };
                        }
                    });
                    if(f) {
                        const o = State.orders[index];
                        o.items.forEach(it => {
                            const p = State.inventory.find(x => x.name === it.name);
                            if(p && p.stock && p.stock[it.size] !== undefined) {
                                p.stock[it.size] -= it.qty;
                                if(p.stock[it.size] < 0) p.stock[it.size] = 0;
                            }
                        });
                        o.status = 'Despachado';
                        o.invoice = f.i;
                        o.bultos = f.b;
                        o.dispatchDate = new Date().toISOString().split('T')[0];
                        set(ref(db, 'inventory'), State.inventory);
                        set(ref(db, 'orders'), State.orders);
                        Swal.fire('Despachado', 'Inventario actualizado', 'success');
                    }
                },
                addNote: async (date) => {
                    const {value:n} = await Swal.fire({title:`Nota ${date}`, input:'text', inputValue:State.calendar[date]||''});
                    if(n!==undefined) {
                        if(n) State.calendar[date]=n; else delete State.calendar[date];
                        set(ref(db,'calendar'), State.calendar);
                    }
                },
                deleteOrder: (i) => {
                    if(confirm('Â¿Eliminar Orden?')) { State.orders.splice(i,1); set(ref(db, 'orders'), State.orders); }
                },
                systemReset: () => {
                    if(confirm('ALERTA: Â¿Borrar toda la base de datos?')) set(ref(db), null);
                }
            },

            PDF: {
                // FIX 4: EXIGIR FACTURA SOLO AL IMPRIMIR PDF TACHAS
                downloadTachas: async (index) => {
                    const o = State.orders[index];

                    if (!o.invoice) {
                        const { value: fac } = await Swal.fire({
                            title: 'NÂ° de Factura Requerido',
                            text: 'Para generar las etiquetas, ingresa el nÃºmero de factura o guÃ­a:',
                            input: 'text',
                            showCancelButton: true,
                            inputValidator: (value) => { if (!value) return 'Debes ingresar un nÃºmero' }
                        });
                        if (!fac) return; 
                        o.invoice = fac;
                        await set(ref(db, 'orders'), State.orders); // Guardamos la factura en la OC
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ unit: 'mm', format: [216, 356] }); 
                    const cards = o.items;
                    const margin = 10;
                    const w = (216 - (margin*3)) / 2;
                    const h = (356 - (margin*3)) / 2;
                    let x = margin, y = margin, count = 0;

                    cards.forEach((it, i) => {
                        doc.setLineWidth(0.5); doc.setDrawColor(0); doc.rect(x, y, w, h);
                        doc.setFont("helvetica", "bold"); doc.setFontSize(14);
                        doc.text("IDEAS TEXTILES SPA", x + w/2, y + 15, { align: "center" });
                        doc.setFontSize(8); doc.setFont("helvetica", "normal");
                        doc.text("Rep: Alejandro Cisterna O.", x + w/2, y + 20, { align: "center" });
                        doc.line(x+5, y+23, x+w-5, y+23);
                        doc.setFont("helvetica", "bold"); doc.setFontSize(10);
                        doc.text(`CLIENTE: ${o.client}`, x + w/2, y + 35, { align: "center" });
                        doc.setFontSize(16);
                        doc.text(it.name, x + w/2, y + 50, { align: "center", maxWidth: w-10 });
                        doc.setLineWidth(1); doc.rect(x + w/2 - 15, y + 60, 30, 15);
                        doc.setFontSize(22); doc.text(it.size, x + w/2, y + 71, { align: "center" });
                        doc.setFontSize(12); doc.text(`CANTIDAD: ${it.qty}`, x + w/2, y + 90, { align: "center" });
                        if(it.msg) {
                            doc.setFontSize(9); doc.setFont("helvetica", "italic");
                            doc.text(`"${it.msg}"`, x + w/2, y + 100, { align: "center" });
                        }
                        const fy = y + h - 15;
                        doc.setLineWidth(0.2); doc.line(x+5, fy, x+w-5, fy);
                        doc.setFont("helvetica", "normal"); doc.setFontSize(8);
                        doc.text(`OC #${o.id} | FAC: ${o.invoice}`, x+5, fy+5);
                        doc.text("NÂ° BULTOS:", x+w-40, fy+5);
                        doc.rect(x+w-15, fy-2, 10, 8); 

                        count++;
                        if (count % 4 === 0 && i < cards.length - 1) {
                            doc.addPage(); x = margin; y = margin;
                        } else {
                            if (count % 2 !== 0) x += w + margin;
                            else { x = margin; y += h + margin; }
                        }
                    });
                    doc.save(`Tachas_${o.client}_OC${o.id}.pdf`);
                }
            }
        };

        App.init();
    </script>
</body>
</html>
