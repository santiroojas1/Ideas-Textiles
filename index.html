<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IDEAS TEXTILES SPA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --dark: #0f172a; --gold: #d97706; --bg: #f8fafc; 
            --prod: #4f46e5; --danger: #ef4444; --success: #10b981; --gray: #64748b;
        }
        * { box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); margin: 0; padding-bottom: 120px; color: var(--dark); user-select: none; }
        
        /* HEADER */
        header { 
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%); 
            color: white; padding: 20px; border-bottom: 4px solid var(--gold); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .corp-title { font-weight: 900; font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
        .version-badge { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; color: var(--gold); }

        /* NAVEGACI√ìN INTERNA */
        .sub-nav { 
            display: flex; gap: 10px; background: white; padding: 10px; 
            margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .sub-tab { 
            flex: 1; border: none; background: transparent; padding: 10px; 
            font-weight: 700; color: var(--gray); cursor: pointer; border-radius: 8px; transition: 0.2s;
        }
        .sub-tab.active { background: var(--dark); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* VISTAS */
        .view { display: none; padding: 20px 15px; max-width: 900px; margin: auto; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TARJETAS */
        .card { background: white; border-radius: 16px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #e2e8f0; position: relative; }
        
        /* BOTONES */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 8px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-pri { background: var(--dark); color: white; }
        .btn-gold { background: var(--gold); color: white; }
        .btn-magic { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        .btn-sec { background: #f1f5f9; color: var(--dark); border: 1px solid #cbd5e1; }

        /* INPUTS */
        .search-input { width: 100%; padding: 14px; border-radius: 10px; border: 2px solid #e2e8f0; font-size: 1rem; margin-bottom: 15px; }
        .search-input:focus { border-color: var(--gold); }

        /* FABRICA VISUAL */
        .step-track { display: flex; gap: 5px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; scrollbar-width: none; }
        .step-pill { 
            white-space: nowrap; padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; 
            background: #f1f5f9; color: #94a3b8; display: flex; align-items: center; gap: 5px; 
        }
        .step-pill.done { background: var(--success); color: white; }
        .step-pill.active { background: var(--gold); color: white; transform: scale(1.05); box-shadow: 0 2px 8px rgba(217,119,6,0.3); }

        /* CALENDARIO */
        .cal-header { text-align: center; font-weight: 900; font-size: 1.2rem; margin-bottom: 15px; text-transform: uppercase; color: var(--dark); letter-spacing: 1px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { aspect-ratio: 1; background: white; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; font-size: 0.85rem; cursor: pointer; }
        .cal-day.today { border: 2px solid var(--gold); background: var(--gold); color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(217, 119, 6, 0.4); }
        .dot-marker { width: 6px; height: 6px; border-radius: 50%; margin-top: 3px; }

        /* DOCK DE NAVEGACI√ìN */
        .dock { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: #0f172a; padding: 16px 35px; border-radius: 40px; display: flex; gap: 40px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); z-index: 2000; }
        .dock i { font-size: 1.5rem; color: #64748b; cursor: pointer; transition: 0.2s; }
        .dock i.active { color: var(--gold); transform: translateY(-5px); }
    </style>
</head>
<body>

<header>
    <div class="corp-title"><i class="fa-solid fa-layer-group"></i> IDEAS TEXTILES</div>
    <span class="version-badge">WORKWEAR AND CORPORATE</span>
    
</header>

<section id="v-ops" class="view active">
    <div class="sub-nav">
        <button class="sub-tab active" onclick="App.UI.subTab('bodega', this)">BODEGA</button>
        <button class="sub-tab" onclick="App.UI.subTab('fabrica', this)">F√ÅBRICA (<span id="fab-count">0</span>)</button>
    </div>

    <div id="mod-bodega">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <button class="btn btn-magic" onclick="App.IA.importInventory()"><i class="fa-solid fa-wand-magic-sparkles"></i> CARGA R√ÅPIDA (IA)</button>
            <button class="btn btn-pri" onclick="App.Actions.prodModal()"><i class="fa-solid fa-plus"></i> NUEVO MANUAL</button>
        </div>
        <input type="text" id="search-inv" class="search-input" placeholder="üîç Buscar SKU o Nombre..." oninput="App.Render.bodega()">
        <div id="list-bodega"></div>
    </div>

    <div id="mod-fabrica" style="display:none;">
        <div id="list-fabrica"></div>
    </div>
</section>

<section id="v-ordenes" class="view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0">PEDIDOS</h2>
        <span style="font-size:0.8rem; color:gray;">Gesti√≥n Comercial</span>
    </div>
    
    <button class="btn btn-magic" onclick="App.IA.importOrders()"><i class="fa-solid fa-bolt"></i> IA: SEPARAR PEDIDOS</button>
    <button class="btn btn-gold" onclick="App.Actions.newOC()">üìÑ NUEVA OC INDIVIDUAL</button>
    
    <div id="list-ordenes" style="margin-top:20px;"></div>
</section>

<section id="v-agenda" class="view">
    <div class="card">
        <div id="cal-header" class="cal-header"></div> 
        <div id="cal-grid" class="cal-grid"></div>
        <div style="text-align:center; font-size:0.75rem; color:#64748b; margin-top:10px;">
            <span style="color:#ef4444">‚óè</span> Entrega &nbsp; <span style="color:#d97706">‚óè</span> Nota
        </div>
    </div>
    <div style="background:#fff1f2; border-left:4px solid #ef4444; padding:15px; border-radius:10px; margin-top:15px;">
        <h4 style="margin:0 0 10px 0; color:#991b1b;"><i class="fa-solid fa-triangle-exclamation"></i> URGENTE (7 D√çAS)</h4>
        <div id="upcoming-list"></div>
    </div>
    <div class="card" style="margin-top:20px;">
        <button class="btn btn-pri" onclick="App.Backup.download()">DESCARGAR REPORTE (PDF)</button>
    </div>
</section>

<nav class="dock">
    <i class="fa-solid fa-industry active" onclick="App.UI.go('ops', this)"></i>
    <i class="fa-solid fa-file-invoice" onclick="App.UI.go('ordenes', this)"></i>
    <i class="fa-solid fa-calendar-days" onclick="App.UI.go('agenda', this)"></i>
</nav>

<script>
const firebaseConfig = { apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew", authDomain: "ideastextilesapp.firebaseapp.com", databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com", projectId: "ideastextilesapp", storageBucket: "ideastextilesapp.firebasestorage.app", messagingSenderId: "268995530035", appId: "1:268995530035:web:1890f45ac761cc81eb0246" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const App = {
    data: { inv: [], ord: [], fab: [], logs: {} },

    init() {
        db.ref('/').on('value', snap => {
            const v = snap.val() || {};
            App.data.inv = v.inv || [];
            App.data.ord = v.ord || [];
            App.data.fab = v.fab || [];
            App.data.logs = v.logs || {};
            
            // Auto-reparaci√≥n y renderizado inicial
            App.data.ord.forEach(o => { if(!o.deadline) o.deadline = o.date; });
            document.getElementById('fab-count').innerText = App.data.fab.length;
            App.Render.all();
        });
    },
    save() { db.ref('/').update(App.data); },

    // --- CEREBRO IA (TEXTO A DATOS) ---
    IA: {
        parseLine(line) {
            const clean = line.trim();
            if(!clean) return null;
            const parts = clean.split(/\s+/);
            let qty = 1, size = 'UNICA', nameParts = [], foundQty = false;
            const sizes = ['XS','S','M','L','XL','XXL','3XL'];

            parts.forEach(p => {
                const up = p.toUpperCase();
                if(!foundQty && !isNaN(p) && p.length < 5) { qty = parseInt(p); foundQty = true; }
                else if(sizes.includes(up)) { size = up; }
                else { nameParts.push(p); }
            });

            const name = nameParts.join(' ').replace(/[^a-zA-Z0-9\s√±√ë]/g, '').trim().toUpperCase();
            if(!name) return null;
            return { n: name, q: qty, sz: size };
        },

        async importInventory() {
            const { value: text } = await Swal.fire({
                title: 'DICTADO DE INVENTARIO',
                input: 'textarea',
                inputPlaceholder: '50 poleras M\n20 gorros rojos',
                inputAttributes: { style: 'height:200px' }
            });
            if(text) {
                const lines = text.split('\n');
                let c = 0;
                lines.forEach(l => {
                    const item = App.IA.parseLine(l);
                    if(item) {
                        if (!App.data.inv) App.data.inv = [];
                        let p = App.data.inv.find(x => x.n === item.n);
                        if(!p) { p = {n:item.n, sku:'REF-'+Math.floor(Math.random()*9999), s:{}}; App.data.inv.push(p); }
                        p.s[item.sz] = (p.s[item.sz]||0) + item.q;
                        c++;
                    }
                });
                App.save();
                App.Render.bodega(); // REFUERZO VISUAL
                Swal.fire('Listo', `Se procesaron ${c} lineas.`, 'success');
            }
        },

        async importOrders() {
            const { value: text } = await Swal.fire({
                title: 'IA: SEPARADOR DE PEDIDOS',
                html: '<small>Usa ":" para clientes. Ej: "JUAN: 10 poleras"</small>',
                input: 'textarea',
                inputAttributes: { style: 'height:250px' }
            });
            if(text) {
                const lines = text.split('\n');
                let client = 'VARIOS', items = [], count = 0;
                
                const save = () => {
                    if(items.length > 0) {
                        App.data.ord.push({c:client, date:new Date().toLocaleDateString(), deadline:new Date().toLocaleDateString(), st:'PROCESO', items:items});
                        count++; items = [];
                    }
                };

                lines.forEach(l => {
                    const clean = l.trim();
                    if(!clean) return;
                    if(clean.includes(':') || (isNaN(clean.charAt(0)) && clean.length<20 && !clean.match(/\d/))) {
                        save(); client = clean.replace(':','').toUpperCase();
                    } else {
                        const it = App.IA.parseLine(clean);
                        if(it) items.push({p:it.n, q:it.q, sz:it.sz, st:'PENDIENTE'});
                    }
                });
                save();
                App.save();
                App.Render.ordenes(); // REFUERZO VISUAL
                Swal.fire('Procesado', `Se crearon ${count} √≥rdenes distintas.`, 'success');
            }
        }
    },

    // --- ACCIONES MANUALES ---
    Actions: {
        async prodModal() {
            const { value: form } = await Swal.fire({
                title: 'ALTA MANUAL',
                html: `
                    <input id="new-n" class="swal2-input" placeholder="Nombre Producto (Ej: POLERA PIQUE)">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                        <input id="new-s" type="number" class="swal2-input" placeholder="Cant. S" style="margin:0">
                        <input id="new-m" type="number" class="swal2-input" placeholder="Cant. M" style="margin:0">
                        <input id="new-l" type="number" class="swal2-input" placeholder="Cant. L" style="margin:0">
                        <input id="new-xl" type="number" class="swal2-input" placeholder="Cant. XL" style="margin:0">
                    </div>
                `,
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        n: document.getElementById('new-n').value,
                        s: document.getElementById('new-s').value,
                        m: document.getElementById('new-m').value,
                        l: document.getElementById('new-l').value,
                        xl: document.getElementById('new-xl').value
                    }
                }
            });

            if(form && form.n) {
                const stock = {};
                if(form.s) stock['S'] = parseInt(form.s);
                if(form.m) stock['M'] = parseInt(form.m);
                if(form.l) stock['L'] = parseInt(form.l);
                if(form.xl) stock['XL'] = parseInt(form.xl);
                
                // ASEGURAR ARRAY
                if (!App.data.inv) App.data.inv = [];

                App.data.inv.push({
                    n: form.n.toUpperCase(),
                    sku: 'REF-'+Math.floor(Math.random()*99999),
                    s: stock
                });
                App.save();
                
                // *** LA CORRECCI√ìN CLAVE: ACTUALIZAR PANTALLA ***
                App.Render.bodega(); 
                Swal.fire('Guardado', `${form.n} ingresado correctamente.`, 'success');
            }
        },

        delInv(i) {
            Swal.fire({title:'¬øEliminar?', icon:'warning', showCancelButton:true}).then(r=>{
                if(r.isConfirmed){ App.data.inv.splice(i,1); App.save(); App.Render.bodega(); }
            });
        },

        async sendFab(i) {
            const p = App.data.inv[i];
            const {value:form} = await Swal.fire({
                title: `PRODUCIR: ${p.n}`,
                html: `
                    <input id="f-q" type="number" class="swal2-input" placeholder="Cantidad Total">
                    <label style="display:block;margin-top:10px;font-weight:bold;">Ruta (Separa con >):</label>
                    <textarea id="f-r" class="swal2-textarea" style="margin:5px 0;">CORTE (JUAN) > TALLER > PLANCHA</textarea>
                `,
                preConfirm:() => ({q:document.getElementById('f-q').value, r:document.getElementById('f-r').value})
            });

            if(form && form.q && form.r) {
                const steps = form.r.split('>').map(s => {
                    const m = s.trim().match(/([^(]+)(?:\(([^)]+)\))?/);
                    return { n: m[1].trim().toUpperCase(), r: m[2]?m[2].trim().toUpperCase():'TALLER' };
                });
                if(!App.data.fab) App.data.fab = [];
                App.data.fab.push({ n:p.n, qty:parseInt(form.q), route:steps, stepIdx:0, start:Date.now() });
                App.save();
                App.UI.subTab('fabrica', document.querySelectorAll('.sub-tab')[1]);
            }
        },

        advanceFab(i) {
            const f = App.data.fab[i];
            if(f.stepIdx < f.route.length-1) {
                f.stepIdx++; App.save(); App.Render.fabrica(); // Render forzado
            } else {
                Swal.fire({title:'¬øTerminado?', text:'Vuelve a stock', showCancelButton:true}).then(r=>{
                    if(r.isConfirmed) {
                        let p = App.data.inv.find(x=>x.n===f.n);
                        if(p) p.s['PROD'] = (p.s['PROD']||0) + parseInt(f.qty);
                        App.data.fab.splice(i,1); App.save(); App.Render.fabrica();
                    }
                });
            }
        },

        async newOC() {
            const {value:form} = await Swal.fire({
                title:'NUEVO PEDIDO',
                html:`<input id="c" class="swal2-input" placeholder="Cliente"><input id="d" type="date" class="swal2-input">`,
                preConfirm:()=>({c:document.getElementById('c').value, d:document.getElementById('d').value})
            });
            if(form) {
                if(!App.data.ord) App.data.ord = [];
                App.data.ord.push({c:form.c.toUpperCase(), deadline:form.d, st:'PROCESO', items:[]});
                App.save();
                App.Render.ordenes();
            }
        },

        logDay(k) {
            Swal.fire({title:'Nota del D√≠a', input:'textarea', inputValue:App.data.logs[k]||''}).then(r=>{
                if(r.value!==undefined) { App.data.logs[k]=r.value; App.save(); App.Render.calendar(); }
            });
        }
    },

    UI: {
        go(id, el) {
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            document.querySelectorAll('.dock i').forEach(i=>i.classList.remove('active'));
            document.getElementById('v-'+id).classList.add('active');
            el.classList.add('active');
        },
        subTab(t, el) {
            document.getElementById('mod-bodega').style.display = t==='bodega'?'block':'none';
            document.getElementById('mod-fabrica').style.display = t==='fabrica'?'block':'none';
            document.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active'));
            el.classList.add('active');
        }
    },

    Render: {
        all() { this.bodega(); this.fabrica(); this.ordenes(); this.calendar(); },

        bodega() {
            const q = document.getElementById('search-inv').value.toUpperCase();
            const list = App.data.inv || [];
            document.getElementById('list-bodega').innerHTML = list.filter(x=>x.n.includes(q)).map((p,i)=>`
                <div class="card">
                    <div style="display:flex;justify-content:space-between;"><b>${p.n}</b> <small>${p.sku}</small></div>
                    <div style="margin:5px 0; color:#64748b; font-size:0.8rem;">
                        ${Object.entries(p.s).map(([k,v])=>`<span style="background:#f1f5f9;margin-right:5px;padding:2px 6px;border-radius:4px;">${k}:${v}</span>`).join('')}
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-sec" onclick="App.Actions.sendFab(${i})">PRODUCIR</button>
                        <button class="btn btn-sec" style="width:auto; color:red;" onclick="App.Actions.delInv(${i})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`).join('');
        },

        fabrica() {
            const list = App.data.fab || [];
            document.getElementById('list-fabrica').innerHTML = list.map((f,i)=>`
                <div class="card" style="border-left:4px solid var(--gold);">
                    <div style="display:flex;justify-content:space-between;"><b>${f.n}</b> <b>${f.qty} un.</b></div>
                    <div class="step-track">${f.route.map((s,x)=>`<div class="step-pill ${x<f.stepIdx?'done':(x===f.stepIdx?'active':'')}">${x+1}.${s.n}</div>`).join('')}</div>
                    <button class="btn btn-pri" onclick="App.Actions.advanceFab(${i})">${f.stepIdx===f.route.length-1?'FINALIZAR':'AVANZAR ETAPA'}</button>
                </div>`).join('');
        },

        ordenes() {
            const list = App.data.ord || [];
            document.getElementById('list-ordenes').innerHTML = list.map(o=>`
                <div class="card">
                    <div style="display:flex;justify-content:space-between;"><b>${o.c}</b> <small>${o.deadline}</small></div>
                    <ul style="padding-left:20px;font-size:0.85rem;">${o.items.map(it=>`<li>${it.q} ${it.p} (${it.sz})</li>`).join('')}</ul>
                </div>`).join('');
        },

        calendar() {
            const d = new Date();
            const months = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
            document.getElementById('cal-header').innerText = `${months[d.getMonth()]} ${d.getFullYear()}`;

            const days = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
            let h = '';
            for(let i=1; i<=days; i++) {
                const dk = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const lk = `${i}-${d.getMonth()}-${d.getFullYear()}`;
                const isToday = i === d.getDate();
                const hasOc = (App.data.ord||[]).some(o=>o.deadline===dk);
                const hasLog = (App.data.logs||{})[lk];

                h+=`<div class="cal-day ${isToday?'today':''}" onclick="App.Actions.logDay('${lk}')">
                    ${i} <div style="display:flex;gap:2px;">
                        ${hasOc?'<div class="dot-marker" style="background:#ef4444"></div>':''}
                        ${hasLog?'<div class="dot-marker" style="background:#d97706"></div>':''}
                    </div>
                </div>`;
            }
            document.getElementById('cal-grid').innerHTML = h;
            
            const up = (App.data.ord||[]).filter(o=>{
                const diff = (new Date(o.deadline)-d)/(1000*60*60*24);
                return diff>=-1 && diff<=7;
            });
            document.getElementById('upcoming-list').innerHTML = up.length ? up.map(o=>`<div><b>${o.c}</b>: ${o.deadline}</div>`).join('') : '<small>Todo en orden.</small>';
        },

        Backup: {
            download() {
                const doc = new window.jspdf.jsPDF();
                doc.text("REPORTE V16",10,20);
                doc.autoTable({startY:30, head:[['Producto','Stock']], body:App.data.inv.map(x=>[x.n, JSON.stringify(x.s)])});
                doc.save('IdeasTextiles.pdf');
            }
        }
    }
};

App.init();
</script>
</body>
</html>
