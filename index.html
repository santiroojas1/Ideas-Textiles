<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ideas Textiles SPA </title>
    
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        /* Typography & Reset */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background-color: #F2F2F7; /* iOS System Gray 6 */
            color: #1C1C1E;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        /* iOS Design System - Glassmorphism & Cards */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .sidebar-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            border-right: 1px solid rgba(0,0,0,0.05);
        }

        .ios-card {
            background: #FFFFFF;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.2s ease;
        }

        .ios-card:active {
            transform: scale(0.98);
        }

        .ios-input {
            background: #F2F2F7;
            border-radius: 10px;
            border: none;
            padding: 12px;
            font-size: 16px; /* Prevents zoom on iOS */
            width: 100%;
            outline: none;
            transition: background 0.2s;
        }
        .ios-input:focus { background: #E5E5EA; }

        .ios-btn {
            border-radius: 12px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .ios-btn:active { opacity: 0.7; }

        /* Responsive Layout Handling */
        @media (max-width: 1024px) {
            .desktop-sidebar { display: none; }
            .mobile-tabbar { display: flex; }
            .main-content { margin-left: 0; padding-bottom: 80px; }
        }
        @media (min-width: 1025px) {
            .desktop-sidebar { display: flex; }
            .mobile-tabbar { display: none; }
            .main-content { margin-left: 280px; padding-bottom: 0; }
        }

        /* Calendar Grid System */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #E5E5EA; /* Grid lines color */
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #E5E5EA;
        }
        .calendar-day {
            background: white;
            aspect-ratio: 1;
            padding: 8px;
            font-size: 14px;
            position: relative;
            cursor: pointer;
        }
        .calendar-day.today { color: #007AFF; font-weight: 700; }
        .calendar-day.other-month { background: #F9F9F9; color: #AEAEB2; }
        .event-dot {
            width: 5px; height: 5px; background: #007AFF; border-radius: 50%;
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
        }

        /* Modals & Overlays */
        .modal-enter { animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalSlideUp {
            from { transform: translateY(100%); } to { transform: translateY(0); }
        }
    </style>
</head>
<body>

    <aside class="desktop-sidebar fixed inset-y-0 left-0 w-[280px] sidebar-glass z-50 flex flex-col p-6">
        <div class="mb-10 px-2">
            <h1 class="text-2xl font-bold tracking-tight text-black">IDEAS TEXTILES</h1>
            <p class="text-[10px] uppercase font-bold text-gray-400 tracking-widest mt-1">Ropa de trabajo y corporativa</p>
        </div>
        <nav class="space-y-2 flex-1">
            <button onclick="App.Router.go('inventory')" id="nav-d-inventory" class="nav-item w-full flex items-center p-3 rounded-xl text-gray-500 hover:bg-gray-100 hover:text-[#007AFF] transition-all">
                <i class="fa-solid fa-box w-8 text-center"></i> <span class="font-medium">Inventario</span>
            </button>
            <button onclick="App.Router.go('orders')" id="nav-d-orders" class="nav-item w-full flex items-center p-3 rounded-xl text-gray-500 hover:bg-gray-100 hover:text-[#007AFF] transition-all">
                <i class="fa-solid fa-clipboard-list w-8 text-center"></i> <span class="font-medium">Órdenes</span>
            </button>
            <button onclick="App.Router.go('calendar')" id="nav-d-calendar" class="nav-item w-full flex items-center p-3 rounded-xl text-gray-500 hover:bg-gray-100 hover:text-[#007AFF] transition-all">
                <i class="fa-solid fa-calendar w-8 text-center"></i> <span class="font-medium">Calendario</span>
            </button>
            <button onclick="App.Router.go('pdfs')" id="nav-d-pdfs" class="nav-item w-full flex items-center p-3 rounded-xl text-gray-500 hover:bg-gray-100 hover:text-[#007AFF] transition-all">
                <i class="fa-solid fa-file-pdf w-8 text-center"></i> <span class="font-medium">Documentos</span>
            </button>
        </nav>
        <div class="pt-6 border-t border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-[#007AFF] text-white flex items-center justify-center font-bold text-sm">AC</div>
            <div>
                <p class="text-xs font-bold text-black">Alejandro Cisterna</p>
                <p class="text-[10px] text-gray-400">Gerente General</p>
            </div>
        </div>
    </aside>

    <main class="main-content h-screen overflow-y-auto bg-[#F2F2F7]">
        <header class="sticky top-0 z-40 glass h-16 flex items-center justify-between px-6">
            <h2 id="page-title" class="text-lg font-bold">Resumen General</h2>
            <div id="header-actions" class="flex gap-2">
                </div>
        </header>

        <div id="view-container" class="p-6 md:p-8 max-w-7xl mx-auto min-h-[calc(100vh-64px)]">
            </div>
    </main>

    <div class="mobile-tabbar fixed bottom-0 left-0 right-0 h-20 glass z-50 justify-around items-center pb-4 px-2">
        <button onclick="App.Router.go('inventory')" class="flex flex-col items-center justify-center w-16 h-full text-gray-400 hover:text-[#007AFF]">
            <i class="fa-solid fa-box text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Stock</span>
        </button>
        <button onclick="App.Router.go('orders')" class="flex flex-col items-center justify-center w-16 h-full text-gray-400 hover:text-[#007AFF]">
            <i class="fa-solid fa-clipboard-list text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Órdenes</span>
        </button>
        <button onclick="App.Router.go('calendar')" class="flex flex-col items-center justify-center w-16 h-full text-[#007AFF]">
            <i class="fa-solid fa-calendar text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Agenda</span>
        </button>
        <button onclick="App.Router.go('pdfs')" class="flex flex-col items-center justify-center w-16 h-full text-gray-400 hover:text-[#007AFF]">
            <i class="fa-solid fa-file-pdf text-xl mb-1"></i>
            <span class="text-[10px] font-medium">PDF</span>
        </button>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] hidden flex items-end md:items-center justify-center">
        <div id="modal-content" class="bg-white w-full md:w-[600px] md:rounded-2xl rounded-t-2xl p-6 modal-enter max-h-[90vh] overflow-y-auto">
            </div>
    </div>

    <div id="camera-overlay" class="fixed inset-0 bg-black z-[100] hidden flex flex-col">
        <div class="flex-1 relative">
            <video id="camera-feed" autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="absolute inset-0 border-[30px] border-black/50 pointer-events-none"></div> </div>
        <div class="h-32 bg-black flex items-center justify-around">
            <button onclick="App.Hardware.closeCamera()" class="text-white p-4"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <button onclick="App.Hardware.takePhoto()" class="w-16 h-16 rounded-full border-4 border-white bg-white/20 active:bg-white transition-all"></button>
            <div class="w-12"></div>
        </div>
    </div>

    <script>
        /**
         * IDEAS TEXTILES ERP - CORE ENGINE
         * Clean Architecture: Data Layer -> Domain Logic -> UI Presentation
         */

        // 1. DATA LAYER (Firebase Integration)
        const firebaseConfig = {
            databaseURL: "https://ideas-textiles-default-rtdb.firebaseio.com", // Placeholder
            projectId: "ideas-textiles"
        };
        // Mocking Firebase for standalone demonstration if SDK fails to load
        const mockDB = {
            inventory: [
                { id: '1', sku: 'POL-001', name: 'Polera Piqué', type: 'prenda', stock: { S: 10, M: 15, L: 5 } },
                { id: '2', sku: 'TEL-002', name: 'Tela Gabardina', type: 'tela', stock: { Metros: 150 } }
            ],
            orders: [
                { id: '101', oc: 'OC-2023-88', client: 'Minera Escondida', date: '2023-11-15', status: 'proceso', items: [] },
                { id: '102', oc: 'OC-2023-89', client: 'Codelco', date: '2023-11-20', status: 'despachado', items: [] }
            ],
            movements: []
        };
        
        const App = {
            State: {
                inventory: [],
                orders: [],
                movements: [],
                currentView: 'inventory',
                tempData: {} // For modal forms
            },

            Init: () => {
                // In production: firebase.initializeApp(firebaseConfig);
                // In production: bind real listeners. Here we simulate sync.
                App.State.inventory = mockDB.inventory;
                App.State.orders = mockDB.orders;
                App.Router.go('inventory');
                console.log("System Initialized: Multi-device Sync Ready");
            },

            // 2. LOGIC LAYER (Business Rules & Orchestration)
            Logic: {
                Inventory: {
                    adjustStock: (id, type, qty, reason, photo) => {
                        // Rule: Photo mandatory for movements
                        if (!photo) return { success: false, msg: "Falta evidencia fotográfica" };
                        
                        // Update Local State (optimistic UI) & Push to Remote
                        const product = App.State.inventory.find(p => p.id === id);
                        if (product) {
                            // Logic would update specific variant
                            App.State.movements.push({
                                id: Date.now(), type, productId: id, qty, reason, photo, timestamp: new Date()
                            });
                            // db.ref('inventory/' + id).update(...)
                            return { success: true };
                        }
                        return { success: false, msg: "Producto no encontrado" };
                    }
                },

                Orders: {
                    dispatch: (orderId, invoice, packs, photo) => {
                        // Rule: Invoice & Photo mandatory
                        if (!invoice || !photo) return { success: false, msg: "Factura y Foto son obligatorias" };
                        
                        const order = App.State.orders.find(o => o.id === orderId);
                        if (order) {
                            order.status = 'despachado';
                            order.invoice = invoice;
                            order.evidence = photo;
                            // db.ref('orders/' + orderId).update(...)
                            return { success: true };
                        }
                        return { success: false, msg: "Orden no encontrada" };
                    }
                }
            },

            // 3. UI LAYER (Presentation & Interaction)
            Router: {
                go: (view) => {
                    App.State.currentView = view;
                    document.getElementById('page-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
                    
                    // Reset active states
                    document.querySelectorAll('.nav-item, .mobile-tabbar button').forEach(el => el.classList.remove('text-[#007AFF]'));
                    
                    // Render View
                    const container = document.getElementById('view-container');
                    container.innerHTML = ''; // Clear
                    
                    if (view === 'inventory') App.UI.renderInventory(container);
                    if (view === 'orders') App.UI.renderOrders(container);
                    if (view === 'calendar') App.UI.renderCalendar(container);
                    if (view === 'pdfs') App.UI.renderPDFs(container);
                }
            },

            UI: {
                renderInventory: (container) => {
                    // Header Action
                    document.getElementById('header-actions').innerHTML = `
                        <button class="bg-[#007AFF] text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-blue-200">
                            <i class="fa-solid fa-plus mr-1"></i> Nuevo
                        </button>`;

                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
                    
                    App.State.inventory.forEach(item => {
                        const card = document.createElement('div');
                        card.className = "ios-card p-5";
                        
                        let stockHtml = '';
                        Object.entries(item.stock).forEach(([key, val]) => {
                            stockHtml += `<div class="flex justify-between text-xs py-1 border-b border-gray-50">
                                <span class="text-gray-500">${key}</span>
                                <span class="font-bold">${val}</span>
                            </div>`;
                        });

                        card.innerHTML = `
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-12 h-12 rounded-2xl bg-gray-50 flex items-center justify-center text-2xl text-[#007AFF]">
                                    <i class="fa-solid ${item.type === 'tela' ? 'fa-scroll' : 'fa-shirt'}"></i>
                                </div>
                                <span class="text-[10px] font-mono bg-gray-100 px-2 py-1 rounded text-gray-500">${item.sku}</span>
                            </div>
                            <h3 class="font-bold text-lg mb-1">${item.name}</h3>
                            <p class="text-xs text-gray-400 mb-4 capitalize">${item.type}</p>
                            <div class="mb-4 space-y-1">${stockHtml}</div>
                            <div class="flex gap-2">
                                <button onclick="App.UI.modals.openAdjust('${item.id}', 'in')" class="flex-1 bg-green-50 text-green-600 py-2 rounded-lg text-xs font-bold">Ingreso</button>
                                <button onclick="App.UI.modals.openAdjust('${item.id}', 'out')" class="flex-1 bg-red-50 text-red-600 py-2 rounded-lg text-xs font-bold">Salida</button>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                    container.appendChild(grid);
                },

                renderOrders: (container) => {
                    document.getElementById('header-actions').innerHTML = '';
                    const list = document.createElement('div');
                    list.className = "space-y-4";

                    App.State.orders.forEach(order => {
                        const el = document.createElement('div');
                        el.className = "ios-card p-4 flex flex-col md:flex-row md:items-center justify-between gap-4";
                        const isDone = order.status === 'despachado';
                        
                        el.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full ${isDone ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'} flex items-center justify-center">
                                    <i class="fa-solid ${isDone ? 'fa-check' : 'fa-clock'}"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-sm">${order.client}</h4>
                                    <p class="text-xs text-gray-500">${order.oc} • ${order.date}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 self-end md:self-auto">
                                ${!isDone ? `
                                    <button onclick="App.UI.modals.openDispatch('${order.id}')" class="ios-btn bg-[#007AFF] text-white px-6 py-2 text-xs">DESPACHAR</button>
                                ` : `
                                    <button class="ios-btn bg-gray-100 text-gray-600 px-4 py-2 text-xs"><i class="fa-solid fa-print"></i> Tacha</button>
                                `}
                            </div>
                        `;
                        list.appendChild(el);
                    });
                    container.appendChild(list);
                },

                renderCalendar: (container) => {
                    // Core Calendar Logic connected to Orders
                    const today = new Date();
                    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                    
                    const header = document.createElement('div');
                    header.className = "flex justify-between items-center mb-6";
                    header.innerHTML = `
                        <h3 class="text-2xl font-bold">${monthNames[today.getMonth()]} ${today.getFullYear()}</h3>
                        <div class="flex gap-2">
                            <button class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                            <button class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    `;

                    const grid = document.createElement('div');
                    grid.className = "calendar-grid";

                    // Week headers
                    ['L', 'M', 'M', 'J', 'V', 'S', 'D'].forEach(d => {
                        grid.innerHTML += `<div class="text-center py-2 text-[10px] font-bold text-gray-400 bg-gray-50">${d}</div>`;
                    });

                    // Days generation (simplified for demo)
                    for(let i=1; i<=30; i++) {
                        const day = document.createElement('div');
                        day.className = "calendar-day";
                        day.innerHTML = `<span class="${i===15 ? 'today' : ''}">${i}</span>`;
                        
                        // Check for orders on this day (Mock check)
                        const hasOrder = App.State.orders.some(o => o.date.endsWith(`-${i}`));
                        if(hasOrder) day.innerHTML += `<div class="event-dot"></div>`;
                        
                        day.onclick = () => {
                            if(hasOrder) alert(`Entregas para el día ${i}: \n- Minera Escondida`);
                        };
                        grid.appendChild(day);
                    }

                    container.appendChild(header);
                    container.appendChild(grid);
                },

                renderPDFs: (container) => {
                    container.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div class="ios-card p-6 flex items-center gap-4 cursor-pointer hover:scale-[1.02] transition-transform">
                                <div class="w-12 h-12 rounded-xl bg-red-100 text-red-600 flex items-center justify-center"><i class="fa-solid fa-file-pdf text-xl"></i></div>
                                <div>
                                    <h4 class="font-bold">Informe General</h4>
                                    <p class="text-xs text-gray-500">Stock y Movimientos del mes</p>
                                </div>
                            </div>
                        </div>
                    `;
                },

                modals: {
                    openDispatch: (id) => {
                        const modal = document.getElementById('modal-content');
                        const overlay = document.getElementById('modal-overlay');
                        
                        modal.innerHTML = `
                            <h3 class="font-bold text-xl mb-6">Despachar Orden</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Nro. Factura (Obligatorio)</label>
                                    <input type="text" id="disp-invoice" class="ios-input mt-1" placeholder="Ej: 123456">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Evidencia (Obligatorio)</label>
                                    <div onclick="App.Hardware.openCamera('dispatch')" class="mt-1 h-32 bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center cursor-pointer text-gray-400">
                                        <i class="fa-solid fa-camera text-2xl mb-2"></i>
                                        <span class="text-xs font-bold">Tomar Foto</span>
                                        <img id="disp-preview" class="hidden w-full h-full object-cover rounded-xl absolute inset-0">
                                    </div>
                                </div>
                                <button onclick="App.UI.modals.confirmDispatch('${id}')" class="w-full bg-[#007AFF] text-white py-4 rounded-xl font-bold mt-4">CONFIRMAR DESPACHO</button>
                            </div>
                        `;
                        overlay.classList.remove('hidden');
                    },
                    
                    confirmDispatch: (id) => {
                        const invoice = document.getElementById('disp-invoice').value;
                        const photo = document.getElementById('disp-preview')?.src; // In real app, check src existence
                        
                        // Use mocked photo for demo if empty, to allow flow
                        const mockPhoto = photo || "data:image/png;base64,mock"; 

                        const result = App.Logic.Orders.dispatch(id, invoice, "1/1", mockPhoto);
                        
                        if(result.success) {
                            document.getElementById('modal-overlay').classList.add('hidden');
                            App.Router.go('orders'); // Refresh
                        } else {
                            alert(result.msg);
                        }
                    },

                    openAdjust: (id, type) => {
                         const modal = document.getElementById('modal-content');
                         const overlay = document.getElementById('modal-overlay');
                         modal.innerHTML = `
                            <h3 class="font-bold text-xl mb-4">${type === 'in' ? 'Ingreso' : 'Salida'} de Stock</h3>
                            <input type="number" id="adj-qty" class="ios-input mb-4" placeholder="Cantidad">
                            <textarea id="adj-reason" class="ios-input mb-4" placeholder="Motivo del movimiento"></textarea>
                            <button onclick="App.Hardware.openCamera('adj')" class="w-full py-3 mb-4 bg-gray-100 rounded-xl font-bold text-gray-500"><i class="fa-solid fa-camera mr-2"></i>Evidencia</button>
                            <button onclick="alert('Movimiento Guardado'); document.getElementById('modal-overlay').classList.add('hidden')" class="w-full bg-[#007AFF] text-white py-3 rounded-xl font-bold">GUARDAR</button>
                         `;
                         overlay.classList.remove('hidden');
                    }
                }
            },

            Hardware: {
                openCamera: (context) => {
                    document.getElementById('camera-overlay').classList.remove('hidden');
                    // In a real device, use navigator.mediaDevices.getUserMedia
                },
                closeCamera: () => {
                    document.getElementById('camera-overlay').classList.add('hidden');
                },
                takePhoto: () => {
                    // Logic to capture frame from video element
                    App.Hardware.closeCamera();
                    // Set preview in modal
                }
            }
        };

        // Start System
        window.addEventListener('load', App.Init);
    </script>
</body>
</html>
