<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workwear & Corporate - Sistema de Gestión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Estilos específicos para impresión y calendario */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .page-break { page-break-after: always; }
        }
        .print-only { display: none; }
        
        /* Grid del Calendario */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .calendar-day {
            background-color: white;
            min-height: 100px;
            padding: 4px;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .calendar-day:hover { background-color: #f9fafb; }
        
        /* Estilos personalizados de Scroll */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden flex">

    <aside class="w-64 bg-gray-900 text-white flex-col flex-shrink-0 hidden md:flex z-20 shadow-2xl no-print">
        <div class="p-6 flex items-center justify-center border-b border-gray-800">
            <i class="fas fa-scissors text-3xl text-yellow-500 mr-3"></i>
            <h1 class="text-lg font-bold tracking-wider">GESTIÓN WW</h1>
        </div>
        
        <nav class="mt-6 flex-1 px-4 space-y-2">
            <button onclick="showSection('inventory')" class="nav-item w-full text-left py-3 px-4 rounded hover:bg-gray-800 transition flex items-center bg-gray-800 text-yellow-500">
                <i class="fas fa-boxes w-6"></i> Inventario
            </button>
            <button onclick="showSection('orders')" class="nav-item w-full text-left py-3 px-4 rounded hover:bg-gray-800 transition flex items-center">
                <i class="fas fa-file-invoice w-6"></i> Órdenes (OC)
            </button>
            <button onclick="showSection('calendar')" class="nav-item w-full text-left py-3 px-4 rounded hover:bg-gray-800 transition flex items-center">
                <i class="fas fa-calendar-alt w-6"></i> Calendario
            </button>
            <button onclick="showSection('analysis')" class="nav-item w-full text-left py-3 px-4 rounded hover:bg-gray-800 transition flex items-center">
                <i class="fas fa-brain w-6"></i> IA / Análisis
            </button>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <button onclick="confirmFullReset()" class="w-full bg-red-900 hover:bg-red-700 text-xs py-2 rounded text-red-200 transition">
                <i class="fas fa-bomb mr-1"></i> RESET TOTAL SISTEMA
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-full relative">
        
        <header class="bg-white shadow-md z-10 p-4 flex justify-between items-center border-b-4 border-yellow-500 no-print">
            <div class="flex items-center">
                <button class="md:hidden mr-4 text-gray-600"><i class="fas fa-bars"></i></button>
                <h2 class="text-2xl font-black text-gray-800 tracking-wider uppercase flex items-center">
                    WORKWEAR AND CORPORATE 
                    <i class="fas fa-scissors ml-3 text-yellow-600"></i>
                </h2>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="generateCompanyReport()" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm flex items-center">
                    <i class="fas fa-file-pdf mr-2"></i> Reporte General
                </button>
                <div class="h-8 w-8 rounded-full bg-yellow-500 flex items-center justify-center text-white font-bold">A</div>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6 no-print">
            
            <div id="inventory" class="section-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Inventario</h2>
                        <p class="text-sm text-gray-500">Gestión de productos, tallas dinámicas y stock.</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="invMagicInput" class="hidden" accept="image/*, .xlsx, .xls" onchange="processInventoryFile(this)">
                        <button onclick="document.getElementById('invMagicInput').click()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded shadow flex items-center transition transform hover:scale-105" title="Subir Foto de Cuaderno o Excel">
                            <i class="fas fa-magic mr-2"></i> IA Import
                        </button>
                        
                        <button onclick="confirmReset('inventory')" class="bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 text-sm">
                            <i class="fas fa-trash-alt mr-1"></i>
                        </button>
                        <button onclick="openProductModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow-lg flex items-center transition transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i> Nuevo
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                    <table class="min-w-full leading-normal">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">SKU</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Producto</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Categoría</th>
                                <th class="px-5 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Distribución Tallas</th>
                                <th class="px-5 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Total</th>
                                <th class="px-5 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body">
                            </tbody>
                    </table>
                    <div id="empty-inventory" class="p-10 text-center text-gray-400 hidden">
                        <i class="fas fa-box-open text-4xl mb-3"></i>
                        <p>No hay productos en inventario.</p>
                    </div>
                </div>
            </div>

            <div id="orders" class="section-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Órdenes de Compra</h2>
                        <p class="text-sm text-gray-500">Seguimiento de producción y despachos.</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="orderMagicInput" class="hidden" accept=".xlsx, .xls" onchange="processOrdersFile(this)">
                        <button onclick="document.getElementById('orderMagicInput').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow flex items-center transition transform hover:scale-105" title="Cargar Excel con Multiples OC">
                            <i class="fas fa-file-import mr-2"></i> Cargar Excel
                        </button>

                        <button onclick="confirmReset('orders')" class="bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 text-sm">
                            <i class="fas fa-trash-alt mr-1"></i>
                        </button>
                        <button onclick="openOrderModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow-lg flex items-center transition transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i> Nueva OC
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                    <table class="min-w-full leading-normal">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ID OC</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Cliente</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Entrega</th>
                                <th class="px-5 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Estado</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Detalles</th>
                                <th class="px-5 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            </tbody>
                    </table>
                    <div id="empty-orders" class="p-10 text-center text-gray-400 hidden">
                        <i class="fas fa-clipboard-list text-4xl mb-3"></i>
                        <p>No hay órdenes registradas.</p>
                    </div>
                </div>
            </div>

            <div id="calendar" class="section-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-gray-800">Calendario de Despachos</h2>
                    <div class="flex items-center space-x-4">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="calendar-header" class="text-xl font-bold uppercase w-48 text-center">Enero 2026</h3>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-7 text-center font-bold text-gray-500 bg-gray-200 py-2 rounded-t-lg">
                    <div>DOM</div><div>LUN</div><div>MAR</div><div>MIE</div><div>JUE</div><div>VIE</div><div>SAB</div>
                </div>
                <div id="calendar-grid" class="calendar-grid bg-white shadow-lg rounded-b-lg border-l border-r border-b">
                    </div>
            </div>

            <div id="analysis" class="section-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-brain text-purple-600 mr-3"></i> Inteligencia de Negocio (IA)
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500 flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-bold uppercase">Salud Operativa</p>
                            <h3 id="ia-health-score" class="text-3xl font-black text-gray-800">100%</h3>
                        </div>
                        <i class="fas fa-heartbeat text-3xl text-purple-200"></i>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500 flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-bold uppercase">En Producción</p>
                            <h3 id="ia-production-count" class="text-3xl font-black text-gray-800">0</h3>
                        </div>
                        <i class="fas fa-tshirt text-3xl text-blue-200"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500 flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-bold uppercase">Total Despachado</p>
                            <h3 id="ia-shipped-count" class="text-3xl font-black text-gray-800">0</h3>
                        </div>
                        <i class="fas fa-shipping-fast text-3xl text-green-200"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4 text-gray-700 border-b pb-2">Diagnóstico del Sistema</h3>
                        <div id="ia-diagnosis-list" class="space-y-4">
                            </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4 text-gray-700 border-b pb-2 flex items-center">
                            <i class="fas fa-magic text-yellow-500 mr-2"></i> Sugerencias de Reposición
                        </h3>
                        <p class="text-xs text-gray-400 mb-3">Basado en stock actual vs umbral de seguridad (20 un.)</p>
                        <div id="ia-suggestion-list" class="space-y-3 max-h-64 overflow-y-auto">
                            </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="productModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Gestión de Producto</h3>
                <button onclick="closeModal('productModal')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="productForm">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">SKU (Auto)</label>
                        <input type="text" id="prodSku" readonly class="w-full bg-gray-100 border border-gray-300 rounded px-3 py-2 text-gray-600 font-mono">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Categoría</label>
                        <select id="prodCat" class="w-full border border-gray-300 rounded px-3 py-2">
                            <option>Ropa Ignífuga</option><option>Corporativo</option><option>EPP</option><option>Calzado</option><option>Accesorios</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Nombre Producto</label>
                    <input type="text" id="prodName" required class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-yellow-400 outline-none">
                </div>
                
                <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="hasSizes" class="mr-2 h-4 w-4" checked onchange="toggleSizeInputs()">
                        <label for="hasSizes" class="text-sm font-semibold text-gray-700">Producto con Tallas</label>
                    </div>
                    <button type="button" id="btnAddSize" onclick="addCustomSizeInput()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold hover:bg-blue-200 hidden">+ Nueva Talla</button>
                </div>

                <div id="dynamicSizeContainer" class="grid grid-cols-4 gap-2 mb-4 bg-gray-50 p-3 rounded border border-gray-200 max-h-40 overflow-y-auto">
                    </div>

                <div id="singleStockInput" class="mb-4 hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Stock Total</label>
                    <input type="number" id="stockUnique" value="0" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>

                <div class="flex justify-end pt-4 border-t">
                    <button type="button" onclick="closeModal('productModal')" class="mr-3 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold shadow">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl p-6 h-5/6 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800" id="orderModalTitle">Nueva Orden de Compra</h3>
                <button onclick="closeModal('orderModal')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <form id="orderForm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded border">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">ID Orden</label>
                            <input type="text" id="orderId" required class="w-full bg-white border rounded px-3 py-2 font-mono">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">Cliente</label>
                            <input type="text" id="orderClient" required class="w-full bg-white border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">Fecha Entrega</label>
                            <input type="date" id="orderDate" required class="w-full bg-white border rounded px-3 py-2">
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-bold text-gray-700 mb-2 border-b">Agregar Productos a la Orden</h4>
                        <div class="flex gap-2 mb-2">
                            <select id="orderProductSelect" class="flex-1 border rounded px-2 py-2" onchange="updateOrderSizeInputs()">
                                <option value="">Seleccione un producto del Inventario...</option>
                                </select>
                            <button type="button" onclick="addProductToOrder()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="orderSizeInputs" class="flex flex-wrap gap-2 items-end hidden bg-blue-50 p-2 rounded mb-2">
                            </div>
                        <div id="orderItemNoteContainer" class="hidden mt-2">
                             <input type="text" id="addOrder_Note" placeholder="Añadir nota al producto: (ej: Logo bordado izq, Basta +2cm, etc.)" class="w-full border-2 border-yellow-200 rounded px-3 py-2 text-sm bg-yellow-50 focus:border-yellow-400 outline-none">
                        </div>
                    </div>

                    <div class="bg-white border rounded shadow-inner min-h-[150px] overflow-hidden">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left">Producto</th>
                                    <th class="px-4 py-2 text-center">Detalle Cantidades</th>
                                    <th class="px-4 py-2 text-right">Total</th>
                                    <th class="px-4 py-2"></th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsList">
                                </tbody>
                        </table>
                        <div id="no-order-items" class="text-center p-4 text-gray-400 text-sm">Sin productos agregados.</div>
                    </div>
                </form>
            </div>

            <div class="pt-4 border-t flex justify-between items-center">
                <span class="text-xs text-gray-500">* Verifica stock antes de guardar.</span>
                <div class="flex">
                    <button type="button" onclick="closeModal('orderModal')" class="mr-3 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="button" onclick="saveOrder()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow">Guardar Orden</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dispatchModal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[60] flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl w-96 p-6 border-l-4 border-green-600">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Confirmar Despacho</h3>
            <p class="text-sm text-gray-600 mb-4">Ingrese datos de facturación para cerrar la orden.</p>
            <div class="mb-3">
                <label class="block text-sm font-bold text-gray-700">Nro. Factura</label>
                <input type="text" id="dispatchInvoice" class="w-full border-2 border-green-100 rounded px-3 py-2 focus:border-green-500 outline-none">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700">Cantidad de Cajas</label>
                <input type="number" id="dispatchBoxes" class="w-full border-2 border-green-100 rounded px-3 py-2 focus:border-green-500 outline-none">
            </div>
            <div class="flex justify-end">
                <button onclick="closeModal('dispatchModal')" class="mr-2 text-gray-500 hover:text-gray-700 px-3 py-1">Cancelar</button>
                <button onclick="confirmDispatch()" class="bg-green-600 text-white font-bold px-4 py-2 rounded hover:bg-green-700 shadow">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-4 rounded shadow-lg w-80">
            <h3 class="font-bold mb-2">Nota para el día</h3>
            <textarea id="calendarNoteText" class="w-full border rounded p-2 mb-2" rows="3"></textarea>
            <div class="flex justify-end">
                <button onclick="saveCalendarNote()" class="bg-blue-600 text-white px-3 py-1 rounded">Guardar</button>
            </div>
        </div>
    </div>

    <div id="print-area" class="print-only p-8"></div>

    <script>
        // --- 1. DATOS ---
        let inventory = JSON.parse(localStorage.getItem('ww_inventory')) || [];
        let orders = JSON.parse(localStorage.getItem('ww_orders')) || [];
        let calendarNotes = JSON.parse(localStorage.getItem('ww_notes')) || {};
        
        let tempOrderItems = []; 
        let currentDispatchOrderId = null;
        let currentDate = new Date();
        let currentNoteDate = null;
        let editingOrderIndex = null; // Para saber si editamos o creamos

        // Tallas base por defecto
        const defaultSizes = ['S', 'M', 'L', 'XL', 'XXL'];

        // --- 2. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            showSection('inventory');
            renderInventory();
            updateAnalysis();
        });

        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            if(id === 'orders') renderOrders();
            if(id === 'calendar') renderCalendar();
            if(id === 'analysis') updateAnalysis();
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-gray-800', 'text-yellow-500');
                if(btn.getAttribute('onclick').includes(id)) {
                    btn.classList.add('bg-gray-800', 'text-yellow-500');
                }
            });
        }

        // --- 3. INVENTARIO CON TALLAS DINÁMICAS ---
        
        function openProductModal() {
            document.getElementById('productForm').reset();
            let nextId = inventory.length + 1;
            document.getElementById('prodSku').value = `WW-${String(nextId).padStart(4, '0')}`;
            
            // Renderizar tallas por defecto
            renderDynamicSizeInputs(defaultSizes, {});
            
            toggleSizeInputs();
            document.getElementById('productModal').classList.remove('hidden');
        }

        function renderDynamicSizeInputs(sizesArray, valuesObj) {
            const container = document.getElementById('dynamicSizeContainer');
            container.innerHTML = '';
            
            sizesArray.forEach(size => {
                const val = valuesObj[size] || 0;
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="text-xs font-bold text-center block text-gray-600">${size}</label>
                    <input type="number" name="size_${size}" value="${val}" class="w-full border rounded px-1 py-1 text-center font-mono focus:border-blue-500 outline-none size-input-field" data-size="${size}">
                `;
                container.appendChild(div);
            });
        }

        function addCustomSizeInput() {
            const sizeName = prompt("Ingrese el nombre de la nueva talla (ej: XS, 3XL, 40):");
            if(sizeName && sizeName.trim() !== "") {
                const cleanName = sizeName.trim().toUpperCase();
                // Verificar si ya existe en el DOM
                const existing = document.querySelector(`input[data-size="${cleanName}"]`);
                if(existing) {
                    alert("Esa talla ya existe.");
                    return;
                }
                
                const container = document.getElementById('dynamicSizeContainer');
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="text-xs font-bold text-center block text-blue-600">${cleanName}</label>
                    <input type="number" name="size_${cleanName}" value="0" class="w-full border-2 border-blue-100 rounded px-1 py-1 text-center font-mono focus:border-blue-500 outline-none size-input-field" data-size="${cleanName}">
                `;
                container.appendChild(div);
            }
        }

        function toggleSizeInputs() {
            const hasSizes = document.getElementById('hasSizes').checked;
            const container = document.getElementById('dynamicSizeContainer');
            const btn = document.getElementById('btnAddSize');
            const single = document.getElementById('singleStockInput');

            if(hasSizes) {
                container.classList.remove('hidden');
                container.classList.add('grid');
                btn.classList.remove('hidden');
                single.classList.add('hidden');
            } else {
                container.classList.add('hidden');
                container.classList.remove('grid');
                btn.classList.add('hidden');
                single.classList.remove('hidden');
            }
        }

        document.getElementById('productForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const sku = document.getElementById('prodSku').value;
            const name = document.getElementById('prodName').value;
            const cat = document.getElementById('prodCat').value;
            const hasSizes = document.getElementById('hasSizes').checked;
            
            let stockData = {};
            let total = 0;

            if(hasSizes) {
                // Iterar sobre todos los inputs generados dinámicamente
                const inputs = document.querySelectorAll('.size-input-field');
                inputs.forEach(input => {
                    const size = input.getAttribute('data-size');
                    const qty = parseInt(input.value) || 0;
                    if(qty > 0 || defaultSizes.includes(size)) { // Guardar si tiene cantidad o es standard
                         stockData[size] = qty;
                         total += qty;
                    }
                });
            } else {
                total = parseInt(document.getElementById('stockUnique').value) || 0;
                stockData = { unique: total };
            }

            inventory.push({ sku, name, cat, hasSizes, stockData, total });
            localStorage.setItem('ww_inventory', JSON.stringify(inventory));
            
            renderInventory();
            closeModal('productModal');
        });

        function renderInventory() {
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';
            
            if(inventory.length === 0) {
                document.getElementById('empty-inventory').classList.remove('hidden');
            } else {
                document.getElementById('empty-inventory').classList.add('hidden');
                inventory.forEach((item, index) => {
                    let sizeStr = '';
                    if(item.hasSizes) {
                        sizeStr = `<div class="flex flex-wrap justify-center gap-1 text-xs">`;
                        for (const [key, value] of Object.entries(item.stockData)) {
                             sizeStr += `<span class="bg-gray-100 border border-gray-200 px-1 rounded text-gray-600">${key}:${value}</span>`;
                        }
                        sizeStr += `</div>`;
                    } else {
                        sizeStr = '<span class="text-gray-400 text-xs">Sin Talla</span>';
                    }

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 border-b border-gray-100";
                    tr.innerHTML = `
                        <td class="px-5 py-3 text-sm font-mono text-gray-600">${item.sku}</td>
                        <td class="px-5 py-3 text-sm font-bold text-gray-800">${item.name}</td>
                        <td class="px-5 py-3 text-sm text-gray-600">${item.cat}</td>
                        <td class="px-5 py-3">${sizeStr}</td>
                        <td class="px-5 py-3 text-sm font-bold text-right ${item.total < 10 ? 'text-red-600' : 'text-green-600'}">${item.total}</td>
                        <td class="px-5 py-3 text-center">
                            <button onclick="deleteItem(${index})" class="text-red-500 hover:text-red-700 transition"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            updateOrderProductSelect();
        }

        function deleteItem(index) {
            if(confirm('¿Eliminar producto?')) {
                inventory.splice(index, 1);
                localStorage.setItem('ww_inventory', JSON.stringify(inventory));
                renderInventory();
            }
        }

        // --- 4. ÓRDENES (CON EDICIÓN + NOTAS) ---
        
        function openOrderModal(editIndex = null) {
            document.getElementById('orderForm').reset();
            document.getElementById('orderSizeInputs').innerHTML = '';
            document.getElementById('orderSizeInputs').classList.add('hidden');
            document.getElementById('orderItemNoteContainer').classList.add('hidden'); // Ocultar input nota
            
            editingOrderIndex = editIndex;

            if(editIndex !== null) {
                // MODO EDICIÓN
                const ord = orders[editIndex];
                document.getElementById('orderModalTitle').innerText = "Editar Orden " + ord.id;
                document.getElementById('orderId').value = ord.id;
                document.getElementById('orderId').readOnly = true; // No cambiar ID
                document.getElementById('orderClient').value = ord.client;
                document.getElementById('orderDate').value = ord.date;
                
                // Clonar items para no modificar referencia directa hasta guardar
                tempOrderItems = JSON.parse(JSON.stringify(ord.items));
            } else {
                // MODO NUEVO
                document.getElementById('orderModalTitle').innerText = "Nueva Orden de Compra";
                document.getElementById('orderId').readOnly = false;
                tempOrderItems = [];
            }
            
            renderTempOrderItems();
            document.getElementById('orderModal').classList.remove('hidden');
        }

        function updateOrderProductSelect() {
            const select = document.getElementById('orderProductSelect');
            select.innerHTML = '<option value="">Seleccione Producto...</option>';
            inventory.forEach((p, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = `${p.sku} - ${p.name}`;
                select.appendChild(opt);
            });
        }

        function updateOrderSizeInputs() {
            const idx = document.getElementById('orderProductSelect').value;
            const container = document.getElementById('orderSizeInputs');
            const noteContainer = document.getElementById('orderItemNoteContainer');
            container.innerHTML = '';
            
            if(idx === "") {
                container.classList.add('hidden');
                noteContainer.classList.add('hidden');
                return;
            }
            
            const product = inventory[idx];
            container.classList.remove('hidden');
            noteContainer.classList.remove('hidden'); // Mostrar campo nota
            
            if(product.hasSizes) {
                // Generar inputs para TODAS las tallas que tenga el producto
                for (const sizeKey of Object.keys(product.stockData)) {
                    container.innerHTML += `
                        <div class="flex flex-col">
                            <span class="text-[10px] text-center font-bold text-gray-600">${sizeKey}</span>
                            <input type="number" id="addOrder_${sizeKey}" placeholder="0" class="w-12 text-center border rounded text-sm focus:border-blue-500" data-size-key="${sizeKey}">
                        </div>`;
                }
            } else {
                 container.innerHTML += `
                    <div class="flex flex-col flex-1">
                        <span class="text-[10px] font-bold">Cantidad</span>
                        <input type="number" id="addOrder_Unique" placeholder="0" class="w-full text-center border rounded text-sm">
                    </div>`;
            }
        }

        function addProductToOrder() {
            const idx = document.getElementById('orderProductSelect').value;
            if(idx === "") return;
            
            const product = inventory[idx];
            const note = document.getElementById('addOrder_Note').value; // CAPTURAR NOTA

            let itemEntry = {
                sku: product.sku,
                name: product.name,
                hasSizes: product.hasSizes,
                quantities: {},
                totalItem: 0,
                note: note || '' // GUARDAR NOTA
            };

            if(product.hasSizes) {
                const inputs = document.querySelectorAll('#orderSizeInputs input');
                inputs.forEach(inp => {
                    const val = parseInt(inp.value) || 0;
                    if(val > 0) {
                        const sKey = inp.getAttribute('data-size-key');
                        itemEntry.quantities[sKey] = val;
                        itemEntry.totalItem += val;
                    }
                });
            } else {
                let q = parseInt(document.getElementById('addOrder_Unique').value) || 0;
                itemEntry.quantities = { unique: q };
                itemEntry.totalItem = q;
            }

            if(itemEntry.totalItem > 0) {
                tempOrderItems.push(itemEntry);
                renderTempOrderItems();
                // Limpiar
                document.getElementById('orderProductSelect').value = "";
                document.getElementById('orderSizeInputs').classList.add('hidden');
                document.getElementById('orderItemNoteContainer').classList.add('hidden');
                document.getElementById('addOrder_Note').value = "";
            }
        }

        function renderTempOrderItems() {
            const tbody = document.getElementById('orderItemsList');
            tbody.innerHTML = '';
            
            if(tempOrderItems.length === 0) {
                document.getElementById('no-order-items').classList.remove('hidden');
            } else {
                document.getElementById('no-order-items').classList.add('hidden');
                tempOrderItems.forEach((item, idx) => {
                    let detail = '';
                    if(item.hasSizes) {
                        for(let [size, cant] of Object.entries(item.quantities)) {
                            detail += `<span class="mr-2 text-xs bg-gray-200 px-1 rounded">${size}:${cant}</span>`;
                        }
                    } else {
                        detail = `${item.quantities.unique} Unidades`;
                    }
                    
                    // Mostrar Nota si existe
                    let noteHtml = item.note ? `<div class="text-[10px] text-blue-600 font-bold mt-1 bg-blue-50 p-1 inline-block rounded"><i class="fas fa-comment-dots mr-1"></i>${item.note}</div>` : '';

                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-bold text-gray-700">
                                ${item.name}
                                <br>${noteHtml}
                            </td>
                            <td class="px-4 py-2 text-center text-gray-600">${detail}</td>
                            <td class="px-4 py-2 text-right font-bold">${item.totalItem}</td>
                            <td class="px-4 py-2 text-right">
                                <button onclick="tempOrderItems.splice(${idx},1); renderTempOrderItems()" class="text-red-500"><i class="fas fa-times"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
        }

        function saveOrder() {
            const id = document.getElementById('orderId').value;
            const client = document.getElementById('orderClient').value;
            const date = document.getElementById('orderDate').value;
            
            if(!id || !client || !date || tempOrderItems.length === 0) {
                alert('Faltan datos o productos.');
                return;
            }

            const orderObj = {
                id, client, date,
                items: tempOrderItems,
                status: editingOrderIndex !== null ? orders[editingOrderIndex].status : 'Pendiente', // Mantener estado si edita
                invoice: editingOrderIndex !== null ? orders[editingOrderIndex].invoice : '',
                boxes: editingOrderIndex !== null ? orders[editingOrderIndex].boxes : ''
            };

            if(editingOrderIndex !== null) {
                // Actualizar existente
                orders[editingOrderIndex] = orderObj;
            } else {
                // Crear nueva
                orders.push(orderObj);
            }

            localStorage.setItem('ww_orders', JSON.stringify(orders));
            closeModal('orderModal');
            renderOrders();
            updateAnalysis();
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';
            
            if(orders.length === 0) {
                document.getElementById('empty-orders').classList.remove('hidden');
            } else {
                document.getElementById('empty-orders').classList.add('hidden');
                orders.forEach((o, idx) => {
                    let statusColor = "bg-gray-200 text-gray-800";
                    if(o.status === 'En Producción') statusColor = "bg-blue-100 text-blue-800";
                    if(o.status === 'Listo') statusColor = "bg-green-100 text-green-800";
                    if(o.status === 'Despachado') statusColor = "bg-green-600 text-white";

                    let itemsSummary = o.items.map(i => `${i.name}`).join(', ');
                    if(itemsSummary.length > 25) itemsSummary = itemsSummary.substring(0,25) + '...';

                    let dispatchInfo = o.status === 'Despachado' 
                        ? `<div class="text-xs"><p class="font-bold">FAC: ${o.invoice}</p><p>Cajas: ${o.boxes}</p></div>` 
                        : '<span class="text-gray-300 text-xs">-</span>';

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 border-b";
                    tr.innerHTML = `
                        <td class="px-5 py-3 font-bold">${o.id}</td>
                        <td class="px-5 py-3 text-sm">${o.client}</td>
                        <td class="px-5 py-3 text-xs text-gray-500">${o.date}</td>
                        <td class="px-5 py-3 text-center">
                            <button onclick="cycleStatus(${idx})" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide cursor-pointer ${statusColor} shadow-sm transition hover:opacity-80">
                                ${o.status}
                            </button>
                        </td>
                        <td class="px-5 py-3">${dispatchInfo}</td>
                        <td class="px-5 py-3 text-center flex justify-center space-x-2">
                             <button onclick="openOrderModal(${idx})" class="text-blue-500 hover:text-blue-700" title="Editar OC"><i class="fas fa-edit"></i></button>
                             <button onclick="printTachas(${idx})" class="text-gray-600 hover:text-black" title="Imprimir Tachas"><i class="fas fa-print"></i></button>
                             <button onclick="deleteOrder(${idx})" class="text-red-500 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function cycleStatus(index) {
            const states = ['Pendiente', 'En Producción', 'Listo', 'Despachado'];
            const current = orders[index].status;
            let nextIndex = states.indexOf(current) + 1;
            
            if (states[nextIndex] === 'Despachado') {
                currentDispatchOrderId = index;
                document.getElementById('dispatchModal').classList.remove('hidden');
                return; 
            }
            if (nextIndex >= states.length) nextIndex = 0; 
            
            orders[index].status = states[nextIndex];
            localStorage.setItem('ww_orders', JSON.stringify(orders));
            renderOrders();
            updateAnalysis();
        }

        function confirmDispatch() {
            const inv = document.getElementById('dispatchInvoice').value;
            const boxes = document.getElementById('dispatchBoxes').value;
            if(!inv || !boxes) return alert("Datos incompletos.");
            
            orders[currentDispatchOrderId].status = 'Despachado';
            orders[currentDispatchOrderId].invoice = inv;
            orders[currentDispatchOrderId].boxes = boxes;
            localStorage.setItem('ww_orders', JSON.stringify(orders));
            closeModal('dispatchModal');
            document.getElementById('dispatchInvoice').value = '';
            document.getElementById('dispatchBoxes').value = '';
            renderOrders();
            updateAnalysis();
        }

        // --- 5. CALENDARIO ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const header = document.getElementById('calendar-header');
            grid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            header.innerText = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="bg-gray-100"></div>`;
            
            for(let day=1; day<=daysInMonth; day++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                
                let eventsHtml = '';
                orders.filter(o => o.status === 'Despachado' && o.date === dateKey).forEach(o => {
                    eventsHtml += `<div class="bg-green-100 text-green-800 text-[9px] p-1 mb-1 rounded border border-green-200 truncate">
                        <i class="fas fa-check"></i> ${o.client} (#${o.invoice})
                    </div>`;
                });
                if(calendarNotes[dateKey]) {
                    eventsHtml += `<div class="bg-yellow-100 text-yellow-800 text-[9px] p-1 rounded border border-yellow-200 truncate">
                        <i class="fas fa-sticky-note"></i> ${calendarNotes[dateKey]}
                    </div>`;
                }

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day relative group';
                dayEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-gray-700 ml-1 ${day === new Date().getDate() && month === new Date().getMonth() ? 'text-blue-600' : ''}">${day}</span>
                        <button onclick="openNoteModal('${dateKey}')" class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-blue-500 mr-1"><i class="fas fa-edit"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto mt-1 px-1">${eventsHtml}</div>
                `;
                grid.appendChild(dayEl);
            }
        }

        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); }
        function openNoteModal(d) { currentNoteDate = d; document.getElementById('calendarNoteText').value = calendarNotes[d] || ''; document.getElementById('noteModal').classList.remove('hidden'); }
        function saveCalendarNote() {
            const txt = document.getElementById('calendarNoteText').value;
            if(txt.trim()) calendarNotes[currentNoteDate] = txt; else delete calendarNotes[currentNoteDate];
            localStorage.setItem('ww_notes', JSON.stringify(calendarNotes));
            closeModal('noteModal');
            renderCalendar();
        }

        // --- 6. IA / ANÁLISIS MEJORADO ---
        function updateAnalysis() {
            // Contadores
            let pending = orders.filter(o => o.status === 'Pendiente').length;
            let production = orders.filter(o => o.status === 'En Producción').length;
            let shipped = orders.filter(o => o.status === 'Despachado').length;
            let totalOrders = orders.length || 1; 

            // Actualizar Tarjetas Superiores
            document.getElementById('ia-production-count').innerText = production;
            document.getElementById('ia-shipped-count').innerText = shipped;
            
            // Calculo de Score de Salud (Simple: Si hay mucho pendiente y poco despachado, baja el score)
            let score = 100;
            if (production > 5) score -= 20; // Cuello de botella
            if (pending > 10) score -= 10;
            if (shipped > 0) score += 5; // Bonificación por movimiento
            if (score > 100) score = 100;
            
            const scoreEl = document.getElementById('ia-health-score');
            scoreEl.innerText = score + '%';
            scoreEl.className = `text-3xl font-black ${score > 80 ? 'text-green-600' : score > 50 ? 'text-yellow-600' : 'text-red-600'}`;

            // Lista de Diagnóstico
            const diagList = document.getElementById('ia-diagnosis-list');
            diagList.innerHTML = '';
            
            if(production === 0 && pending > 0) {
                 diagList.innerHTML += `<div class="p-3 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-yellow-700">⚠️ La producción está detenida. Tienes órdenes pendientes sin iniciar.</div>`;
            } else if (production > 5) {
                 diagList.innerHTML += `<div class="p-3 bg-red-50 border-l-4 border-red-500 text-sm text-red-700">🚨 <strong>Sobrecarga:</strong> Hay demasiadas órdenes en taller simultáneamente.</div>`;
            } else {
                 diagList.innerHTML += `<div class="p-3 bg-green-50 border-l-4 border-green-500 text-sm text-green-700">✅ Flujo de trabajo óptimo.</div>`;
            }

            // Lista de Sugerencias de Stock (IA Predictiva Simple)
            const suggestList = document.getElementById('ia-suggestion-list');
            suggestList.innerHTML = '';
            let hasSuggestions = false;
            
            inventory.forEach(p => {
                if(p.total < 20) {
                    hasSuggestions = true;
                    // Sugerencia: Reponer hasta llegar a 50
                    let buyAmount = 50 - p.total;
                    suggestList.innerHTML += `
                        <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200 text-sm">
                            <div>
                                <span class="font-bold text-gray-700">${p.sku}</span> <span class="text-xs text-gray-500">${p.name}</span>
                                <div class="text-xs text-red-500">Stock actual: ${p.total}</div>
                            </div>
                            <div class="text-right">
                                <span class="block text-[10px] text-gray-400 uppercase">Sugerencia</span>
                                <span class="font-bold text-blue-600">+${buyAmount} un.</span>
                            </div>
                        </div>
                    `;
                }
            });
            
            if(!hasSuggestions) {
                suggestList.innerHTML = '<div class="text-gray-400 text-sm text-center italic">Inventario suficiente. No se requieren compras.</div>';
            }
        }

        // --- 7. IMPRESIÓN CON NOTAS ---
        function printTachas(orderIdx) {
            const order = orders[orderIdx];
            const area = document.getElementById('print-area');
            let html = `<div class="grid grid-cols-2 gap-8 w-full">`;
            
            order.items.forEach(item => {
                let tallasHtml = '';
                if(item.hasSizes) {
                    tallasHtml = `<table class="w-full text-xs border mt-2 text-center"><tr class="bg-gray-200 font-bold">`;
                    // Cabeceras dinámicas
                    for (const size in item.quantities) tallasHtml += `<td>${size}</td>`;
                    tallasHtml += `</tr><tr>`;
                    // Valores
                    for (const size in item.quantities) tallasHtml += `<td class="border p-1">${item.quantities[size]}</td>`;
                    tallasHtml += `</tr></table>`;
                } else {
                    tallasHtml = `<div class="mt-2 font-bold text-center border p-2">CANT: ${item.quantities.unique}</div>`;
                }
                
                // RENDERIZAR NOTA EN LA TACHA
                let noteDiv = item.note ? `<div class="mt-2 border-2 border-dashed border-gray-400 bg-gray-50 p-2 text-sm font-bold uppercase text-gray-800">NOTA: ${item.note}</div>` : '';

                html += `
                <div class="border-4 border-gray-800 p-4 bg-white flex flex-col justify-between" style="min-height: 400px; page-break-inside: avoid;">
                    <div class="flex justify-between border-b-2 border-gray-800 pb-2 mb-2">
                        <div><h1 class="font-black text-xl uppercase">WW CORP <i class="fas fa-scissors"></i></h1><p class="text-xs">Control de Producción</p></div>
                        <div class="text-right"><p class="font-bold text-lg">OC: ${order.id}</p><p class="text-xs">${order.client}</p></div>
                    </div>
                    <div class="mb-4">
                        <p class="font-bold text-lg">${item.name}</p>
                        <p class="text-xs font-mono mb-2">${item.sku}</p>
                        ${tallasHtml}
                        ${noteDiv}
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs font-bold mb-4">
                        <div class="border p-2 pt-6 relative">CORTE</div>
                        <div class="border p-2 pt-6 relative">CONFECCIÓN</div>
                        <div class="border p-2 pt-6 relative">TERMINACIÓN</div>
                    </div>
                    <div class="border-t-2 border-gray-800 pt-2 mt-auto text-xs">
                        <div class="flex justify-between mb-4"><span>Factura: ____________</span><span>Cajas: ____/____</span></div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            area.innerHTML = html;
            window.print();
        }

        // --- 8. MÓDULO DE INTELIGENCIA DE IMPORTACIÓN (NUEVO) ---

        // A. PROCESADOR DE INVENTARIO (Foto o Excel Simple)
        async function processInventoryFile(input) {
            const file = input.files[0];
            if (!file) return;
            showLoadingToast('Analizando inventario...');

            try {
                if (file.type.includes('image')) {
                    // OCR Tesseract para Cuadernos
                    const worker = Tesseract.createWorker();
                    await worker.load(); await worker.loadLanguage('spa'); await worker.initialize('spa');
                    const { data: { text } } = await worker.recognize(file);
                    await worker.terminate();
                    parseInventoryText(text);
                } else {
                    // Excel Simple
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                    parseInventoryExcel(jsonData);
                }
            } catch (e) { alert('Error: ' + e.message); } 
            finally { removeToast(); input.value = ''; }
        }

        function parseInventoryText(text) {
            const lines = text.split('\n');
            let count = 0;
            lines.forEach(line => {
                // Busca patrón: "Nombre Producto 50"
                if(line.length > 3) {
                    const numbers = line.match(/\d+/g);
                    if(numbers) {
                        const qty = parseInt(numbers[numbers.length-1]);
                        const name = line.replace(qty, '').replace(/[^\w\s]/g, '').trim();
                        if(name.length > 2) { addOrUpdateInventory(name, qty); count++; }
                    }
                }
            });
            alert(`✅ Se detectaron ${count} productos desde la imagen.`);
            renderInventory(); updateAnalysis();
        }

        function parseInventoryExcel(rows) {
            let count = 0;
            rows.forEach((row, i) => {
                if(i===0) return; // Cabecera
                if(row[0]) {
                    addOrUpdateInventory(String(row[0]), parseInt(row[1])||0);
                    count++;
                }
            });
            alert(`✅ Se importaron ${count} productos del Excel.`);
            renderInventory(); updateAnalysis();
        }

        function addOrUpdateInventory(name, qty) {
            // BUSCAR SI YA EXISTE (Inteligencia de coincidencia)
            const existingIdx = inventory.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
            
            if (existingIdx >= 0) {
                // Si existe, suma al stock
                inventory[existingIdx].total += qty;
                if(!inventory[existingIdx].hasSizes) inventory[existingIdx].stockData.unique += qty;
            } else {
                // Si no, crea uno nuevo
                let nextId = inventory.length + 1;
                inventory.push({
                    sku: `WW-IMP-${String(nextId).padStart(3,'0')}`,
                    name: name,
                    cat: 'Importado',
                    hasSizes: false,
                    stockData: { unique: qty },
                    total: qty
                });
            }
            localStorage.setItem('ww_inventory', JSON.stringify(inventory));
        }

        // B. PROCESADOR DE ÓRDENES COMPLEJAS (Separador Automático)
        async function processOrdersFile(input) {
            const file = input.files[0];
            if (!file) return;
            showLoadingToast('Procesando Tabla de Órdenes...');

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                parseComplexOrderExcel(jsonData);
            } catch (e) { alert('Error en OC: ' + e.message); }
            finally { removeToast(); input.value = ''; }
        }

        function parseComplexOrderExcel(rows) {
            // Lógica basada en tu PDF: Agrupar filas por ID DE ORDEN
            // Estructura esperada columnas (aprox): 
            // [1] ID, [2] Nombre/Lugar, [3] Cliente/Valor, [4] Producto, [5] Talla, [6] Cantidad
            
            const ordersMap = {}; // Diccionario temporal para agrupar

            rows.forEach((row, index) => {
                if (index < 1 || !row[1]) return; // Saltar cabecera o filas vacías

                const idRaw = String(row[1]).trim(); // Columna ID ORDEN
                const clientRaw = String(row[3] || "Cliente Genérico").split('$')[0].trim(); // Limpiar valor monetario
                const prodName = row[4];
                const sizeRaw = String(row[5] || "UNICA").trim().toUpperCase();
                const qty = parseInt(row[6]) || 0;

                // Si es una fila válida de producto
                if (idRaw && prodName && qty > 0) {
                    
                    // 1. Si la orden no existe en el mapa, crearla (SEPARACIÓN AUTOMÁTICA)
                    if (!ordersMap[idRaw]) {
                        ordersMap[idRaw] = {
                            id: idRaw,
                            client: clientRaw,
                            date: new Date().toISOString().split('T')[0], // Fecha hoy por defecto
                            status: 'Pendiente',
                            items: [], // Lista de items
                            invoice: '',
                            boxes: ''
                        };
                    }

                    // 2. Agregar el item a esa orden específica
                    let existingItem = ordersMap[idRaw].items.find(i => i.name === prodName);
                    
                    if (existingItem) {
                        // Si ya existe el producto en la orden, agregamos la talla
                        if (existingItem.hasSizes) {
                            existingItem.quantities[sizeRaw] = (existingItem.quantities[sizeRaw] || 0) + qty;
                            existingItem.totalItem += qty;
                        }
                    } else {
                        // Nuevo item en la orden
                        let newItem = {
                            sku: 'OC-IMP', // SKU genérico
                            name: prodName,
                            hasSizes: true, 
                            quantities: {},
                            totalItem: qty,
                            note: ''
                        };
                        newItem.quantities[sizeRaw] = qty;
                        ordersMap[idRaw].items.push(newItem);
                    }
                }
            });

            // 3. Convertir el mapa a Array y guardar
            let addedOrders = 0;
            Object.values(ordersMap).forEach(order => {
                orders.push(order);
                addedOrders++;
            });

            if (addedOrders > 0) {
                localStorage.setItem('ww_orders', JSON.stringify(orders));
                alert(`✅ Éxito Inteligente: Se detectaron y separaron ${addedOrders} Órdenes de Compra distintas.`);
                renderOrders();
                updateAnalysis();
            } else {
                alert('⚠️ No se pudieron detectar órdenes. Verifica que el Excel tenga las columnas ID, Cliente, Producto, Talla y Cantidad.');
            }
        }

        // Utils visuales para la IA
        function showLoadingToast(msg) {
            const div = document.createElement('div');
            div.id = 'loading-toast';
            div.className = 'fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-4 rounded shadow-2xl z-50 flex items-center animate-pulse';
            div.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-3 text-yellow-500"></i> ${msg}`;
            document.body.appendChild(div);
        }
        function removeToast() {
            const el = document.getElementById('loading-toast');
            if(el) el.remove();
        }

        // --- UTILS GENERALES ---
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function deleteOrder(idx) { if(confirm('¿Eliminar?')) { orders.splice(idx, 1); localStorage.setItem('ww_orders', JSON.stringify(orders)); renderOrders(); updateAnalysis(); } }
        function confirmReset(t) { if(confirm('¿Resetear ' + t + '?')) { localStorage.removeItem('ww_' + t); location.reload(); } }
        function confirmFullReset() { if(confirm('¿BORRAR TODO?')) { localStorage.clear(); location.reload(); } }
        
        function generateCompanyReport() {
            window.print(); 
        }

    </script>
</body>
</html>
