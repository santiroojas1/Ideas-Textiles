<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IDEAS TEXTILES</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --dark: #0f172a; --gold: #d97706; --bg: #f8fafc; 
            --prod: #4f46e5; --danger: #ef4444; --success: #10b981;
        }
        * { box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); margin: 0; padding-bottom: 120px; color: var(--dark); user-select: none; }
        
        /* HEADER */
        header { 
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%); 
            color: white; padding: 25px 20px; border-bottom: 3px solid var(--gold); 
            border-radius: 0 0 30px 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100;
        }
        .corp-title { font-weight: 900; font-size: 1.5rem; margin: 0; display: flex; align-items: center; gap: 12px; }
        .corp-subtitle { font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; color: #94a3b8; margin-top: 5px; margin-left: 36px; }
        
        /* TABS NAVEGACI√ìN */
        .tabs { display: flex; gap: 8px; margin-top: 20px; background: rgba(255,255,255,0.08); padding: 5px; border-radius: 14px; }
        .tab-btn { flex: 1; background: transparent; border: none; color: #94a3b8; padding: 10px; border-radius: 10px; font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--gold); color: white; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4); }

        /* VISTAS */
        .view { display: none; padding: 20px 15px; max-width: 800px; margin: auto; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card { background: white; border-radius: 18px; padding: 20px; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; position: relative; }
        .sku-tag { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: var(--dark); color: var(--gold); padding: 4px 8px; border-radius: 6px; font-weight: bold; }
        
        /* BOTONES */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 0.85rem; text-transform: uppercase; transition: transform 0.1s; }
        .btn:active { transform: scale(0.96); }
        .btn-pri { background: var(--dark); color: white; }
        .btn-gold { background: var(--gold); color: white; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3); }
        .btn-sec { background: white; border: 2px solid #e2e8f0; color: var(--dark); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        
        /* INPUTS */
        .search-input { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid #cbd5e1; margin-bottom: 20px; font-size: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }

        /* CHIPS & STEPS */
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; justify-content: center; }
        .chip { background: #f1f5f9; border: 1px solid #cbd5e1; padding: 8px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; color: #64748b; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .chip.selected { background: var(--dark); color: white; border-color: var(--dark); }
        .chip-num { background: var(--gold); color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; }

        .step-progress { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; position: relative; }
        .step-line-bg { position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: #e2e8f0; z-index: 0; border-radius: 2px; }
        .step-node { width: 26px; height: 26px; background: white; border: 2px solid #cbd5e1; border-radius: 50%; z-index: 1; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #cbd5e1; font-weight: bold; }
        .step-node.done { background: var(--gold); border-color: var(--gold); color: white; }
        .step-node.current { border-color: var(--prod); color: var(--prod); transform: scale(1.3); background: white; border-width: 3px; }

        /* TIEMPO & ALERTAS */
        .time-badge { font-size: 0.7rem; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: #f1f5f9; color: #64748b; margin-top: 5px; display: inline-block; }
        .time-badge.alert { background: #fee2e2; color: #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* CALENDARIO */
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid #f1f5f9; position: relative; cursor: pointer; font-size: 0.9rem; }
        .cal-dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 2px; }
        .dot-info { background: var(--gold); }
        .dot-oc { background: var(--danger); }

        /* MATRIX OVERLAY */
        #matrix-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 5000; display: none; flex-direction: column; padding: 20px; padding-top: env(safe-area-inset-top); }
        #matrix-overlay.active { display: flex; }
        .matrix-container { flex: 1; overflow: auto; border: 1px solid #cbd5e1; background: white; border-radius: 12px; margin: 15px 0; }
        table.matrix { width: 100%; border-collapse: collapse; min-width: 900px; }
        table.matrix th { background: var(--dark); color: white; padding: 12px; text-align: left; position: sticky; top: 0; font-size: 0.75rem; }
        table.matrix td { border: 1px solid #e2e8f0; padding: 0; }
        table.matrix input { width: 100%; border: none; padding: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; background: transparent; }

        /* DOCK */
        .dock { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: #0f172a; padding: 18px 40px; border-radius: 50px; display: flex; gap: 40px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); z-index: 2000; border: 1px solid rgba(255,255,255,0.1); }
        .dock i { font-size: 1.5rem; color: #64748b; cursor: pointer; transition: 0.2s; }
        .dock i.active { color: var(--gold); transform: translateY(-5px); }
    </style>
</head>
<body>

<header>
    <div class="corp-title">
        <i class="fa-solid fa-scissors" style="color:var(--gold)"></i> IDEAS TEXTILES
    </div>
    <div class="corp-subtitle">WORKWEAR AND CORPORATE</div>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="App.UI.switchTab('bodega')">BODEGA</button>
        <button class="tab-btn" onclick="App.UI.switchTab('fabrica')">F√ÅBRICA <span id="fab-count" style="background:#ef4444;color:white;padding:1px 6px;border-radius:10px;font-size:0.8em;margin-left:5px;">0</span></button>
    </div>
</header>

<section id="v-bodega" class="view active">
    <div id="mod-bodega">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-pri" onclick="App.Actions.modalInv()">‚ûï NUEVO ITEM</button>
            <button class="btn btn-gold" onclick="App.Matrix.open('INV')"><i class="fa-solid fa-table"></i> EXCEL</button>
        </div>
        <input type="text" id="search-inv" class="search-input" placeholder="üîç Buscar SKU o Nombre..." oninput="App.Render.bodega()">
        <div id="list-bodega"></div>
    </div>

    <div id="mod-fabrica" style="display:none;">
        <h3 style="text-align:center; color:#64748b; margin-bottom:20px; font-weight:400; font-size:0.9rem;">
            <i class="fa-solid fa-industry"></i> CONTROL DE PROCESOS EN TIEMPO REAL
        </h3>
        <div id="list-fabrica"></div>
    </div>
</section>

<section id="v-ordenes" class="view">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0">PEDIDOS (OC)</h2>
        <button class="btn btn-gold" style="width:auto;" onclick="App.Actions.createOC()"><i class="fa-solid fa-file-invoice"></i> NUEVA OC</button>
    </div>
    <div id="list-ordenes"></div>
</section>

<section id="v-agenda" class="view">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">CALENDARIO</h3>
            <span id="cal-month" style="font-weight:900; color:var(--gold);"></span>
        </div>
        <div style="display:flex; gap:15px; margin:10px 0; font-size:0.7rem;">
            <span style="display:flex; align-items:center; gap:5px;"><div class="cal-dot dot-oc"></div> Entrega OC</span>
            <span style="display:flex; align-items:center; gap:5px;"><div class="cal-dot dot-info"></div> Nota/Idea</span>
        </div>
        <div id="cal-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px; text-align:center; margin-top:15px;"></div>
    </div>
    
    <div class="card" style="border: 2px dashed #ef4444; background: #fff1f2;">
        <h3 style="color:#ef4444; margin-top:0;"><i class="fa-solid fa-lock"></i> ZONA SEGURA</h3>
        <button class="btn btn-pri" onclick="App.Backup.download()">1. DESCARGAR RESPALDO TOTAL (PDF)</button>
        <button id="btn-reset" class="btn btn-danger" style="margin-top:10px;" onclick="App.Actions.reset()" disabled><i class="fa-solid fa-triangle-exclamation"></i> 2. RESET DE F√ÅBRICA</button>
    </div>
</section>

<div id="matrix-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="mtx-title" style="margin:0;"><i class="fa-solid fa-table-cells"></i> MODO MATRIX</h2>
        <button class="btn btn-sec" style="width:auto; padding:8px 15px;" onclick="App.Matrix.close()">CERRAR</button>
    </div>
    <div class="matrix-container">
        <table class="matrix">
            <thead id="mtx-head"></thead>
            <tbody id="mtx-body"></tbody>
        </table>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-sec" onclick="App.Matrix.addRow()">+ FILA</button>
        <button class="btn btn-gold" onclick="App.Matrix.save()">GUARDAR CAMBIOS</button>
    </div>
</div>

<nav class="dock">
    <i class="fa-solid fa-warehouse active" onclick="App.UI.go('bodega', this)"></i>
    <i class="fa-solid fa-list-check" onclick="App.UI.go('ordenes', this)"></i>
    <i class="fa-solid fa-calendar-days" onclick="App.UI.go('agenda', this)"></i>
</nav>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew", authDomain: "ideastextilesapp.firebaseapp.com", databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com", projectId: "ideastextilesapp", storageBucket: "ideastextilesapp.firebasestorage.app", messagingSenderId: "268995530035", appId: "1:268995530035:web:1890f45ac761cc81eb0246" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const App = {
        data: { inv: [], ord: [], fab: [], logs: {} },
        state: { mtxType: null, editIdx: null, backupOk: false, date: new Date() },

        init() {
            db.ref('/').on('value', s => {
                const v = s.val() || {};
                App.data.inv = v.inv || [];
                App.data.ord = v.ord || [];
                App.data.fab = v.fab || [];
                App.data.logs = v.logs || {};

                // Migraci√≥n V10: Asegurar fechas de actualizaci√≥n en f√°brica
                App.data.fab.forEach(f => { if(!f.lastUpdate) f.lastUpdate = Date.now(); });
                // Migraci√≥n V10: Asegurar fecha de entrega en OC
                App.data.ord.forEach(o => { if(!o.deadline) o.deadline = o.date; });

                document.getElementById('fab-count').innerText = App.data.fab.length;
                App.Render.all();
            });
        },
        save() { db.ref('/').update(App.data); },

        // --- MOTOR MATRIX ---
        Matrix: {
            open(type, idx = null) {
                App.state.mtxType = type;
                App.state.editIdx = idx;
                document.getElementById('matrix-overlay').classList.add('active');
                const head = document.getElementById('mtx-head');
                const body = document.getElementById('mtx-body');
                body.innerHTML = '';

                if (type === 'INV') {
                    document.getElementById('mtx-title').innerText = 'MATRIX BODEGA';
                    head.innerHTML = '<tr><th>SKU (A)</th><th>PRODUCTO (B)</th><th>TALLA (C)</th><th>CANTIDAD (D)</th></tr>';
                    for(let i=0; i<15; i++) App.Matrix.addRow();
                } else {
                    document.getElementById('mtx-title').innerText = idx !== null ? `EDITANDO OC: ${App.data.ord[idx].c}` : 'CARGA MASIVA OC';
                    head.innerHTML = '<tr><th>PRODUCTO (A)</th><th>TALLA (B)</th><th>CANTIDAD (C)</th><th>NOTA/OBS (D)</th></tr>';
                    if(idx!==null) {
                        const o = App.data.ord[idx];
                        o.items.forEach(it => App.Matrix.addRow([it.p, it.sz, it.q, it.obs]));
                        App.Matrix.addRow(['','','','']);
                    } else {
                        // En modo masivo OC, usamos estructura diferente en save() si fuera multi-cliente, 
                        // pero aqu√≠ simplificaremos a creaci√≥n de OC individual por seguridad.
                        // Para este c√≥digo, usaremos la Matrix para editar Items de una OC ya creada.
                         for(let i=0; i<15; i++) App.Matrix.addRow();
                    }
                }
            },
            addRow(vals = []) {
                const tr = document.createElement('tr');
                const cols = 4; // Simplificado 4 cols para ambos casos en esta vista
                for(let i=0; i<cols; i++) {
                    const td = document.createElement('td');
                    const inp = document.createElement('input');
                    inp.value = vals[i] || '';
                    inp.onpaste = (e) => App.Matrix.handlePaste(e, inp);
                    td.appendChild(inp);
                    tr.appendChild(td);
                }
                document.getElementById('mtx-body').appendChild(tr);
            },
            handlePaste(e, inp) {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                const rows = text.split(/\r\n|\n|\r/).filter(r => r.trim());
                let curTr = inp.parentElement.parentElement;
                let startCol = Array.from(curTr.children).indexOf(inp.parentElement);
                rows.forEach((rStr) => {
                    const cells = rStr.split('\t');
                    if(!curTr) { App.Matrix.addRow(); curTr = document.getElementById('mtx-body').lastElementChild; }
                    cells.forEach((val, cI) => {
                        const cell = curTr.children[startCol + cI];
                        if(cell) cell.querySelector('input').value = val.trim();
                    });
                    curTr = curTr.nextElementSibling;
                });
            },
            save() {
                const rows = document.querySelectorAll('#mtx-body tr');
                if(App.state.mtxType === 'INV') {
                    rows.forEach(tr => {
                        const v = i => tr.children[i]?.querySelector('input').value.trim();
                        const sku = v(0); const name = v(1).toUpperCase(); const sz = v(2).toUpperCase() || 'UNICA'; const q = parseInt(v(3));
                        if(name && !isNaN(q)) {
                            let p = App.data.inv.find(x => x.n === name || (sku && x.sku === sku));
                            if(!p) { p = { n: name, sku: sku || 'SKU-'+Math.floor(Math.random()*99999), s: {} }; App.data.inv.push(p); }
                            p.s[sz] = q; 
                        }
                    });
                } else {
                    // Edici√≥n de Items de OC
                    if(App.state.editIdx !== null) {
                        const items = [];
                        rows.forEach(tr => {
                             const v = i => tr.children[i]?.querySelector('input').value.trim();
                             const p = v(0).toUpperCase(); const sz = v(1).toUpperCase() || 'UNICA'; const q = parseInt(v(2)); const obs = v(3);
                             if(p && !isNaN(q)) items.push({p, sz, q, obs, st:'PENDIENTE'});
                        });
                        if(items.length) App.data.ord[App.state.editIdx].items = items;
                    }
                }
                App.save(); App.Matrix.close(); Swal.fire('Guardado', 'Datos actualizados', 'success');
            }
            , close() { document.getElementById('matrix-overlay').classList.remove('active'); }
        },

        // --- ACCIONES ---
        Actions: {
            async modalInv(idx=null) {
                const p = idx!==null ? App.data.inv[idx] : {n:'', sku:'SKU-'+Math.floor(Math.random()*99999), s:{}};
                const {value} = await Swal.fire({
                    title: idx?'EDITAR':'NUEVO ITEM',
                    html: `<input id="sw-n" class="swal2-input" value="${p.n}" placeholder="Nombre"><input id="sw-sku" class="swal2-input" value="${p.sku}" placeholder="SKU">`,
                    preConfirm: () => ({n:document.getElementById('sw-n').value.toUpperCase(), sku:document.getElementById('sw-sku').value, s:p.s})
                });
                if(value) { if(idx!==null) App.data.inv[idx]=value; else App.data.inv.push(value); App.save(); }
            },
            delInv(i) { Swal.fire({title:'¬øBorrar?', showCancelButton:true}).then(r=>{if(r.isConfirmed){App.data.inv.splice(i,1);App.save()}}); },

            // OC CREATION WIZARD (FECHA ENTREGA INTEGRADA)
            async createOC() {
                const {value: head} = await Swal.fire({
                    title: 'NUEVA OC',
                    html: `<input id="oc-c" class="swal2-input" placeholder="Nombre Cliente">
                           <label style="display:block;margin-top:10px;text-align:left;font-weight:bold;">Fecha de Entrega:</label>
                           <input id="oc-d" type="date" class="swal2-input">`,
                    preConfirm: () => {
                        const c = document.getElementById('oc-c').value.toUpperCase();
                        const d = document.getElementById('oc-d').value;
                        if(!c || !d) return Swal.showValidationMessage('Datos incompletos');
                        return {c, d};
                    }
                });
                if(head) {
                    App.data.ord.push({ c: head.c, date: new Date().toLocaleDateString(), deadline: head.d, st: 'PROCESO', items: [] });
                    App.save();
                    // Abrir Matrix inmediatamente para llenar items
                    App.Matrix.open('OC', App.data.ord.length - 1);
                }
            },

            editOCDate(i) {
                Swal.fire({
                    title: 'Editar Fecha Entrega',
                    html: `<input id="new-d" type="date" class="swal2-input" value="${App.data.ord[i].deadline}">`,
                    preConfirm: () => document.getElementById('new-d').value
                }).then(r => { if(r.value) { App.data.ord[i].deadline = r.value; App.save(); App.Render.ordenes(); }});
            },

            // LOGICA FABRICA V10
            async sendFab(i) {
                const p = App.data.inv[i];
                let steps = [];
                window.togS = (e) => {
                    const t = e.innerText;
                    if(steps.includes(t)) steps = steps.filter(x=>x!==t); else steps.push(t);
                    document.querySelectorAll('.chip').forEach(c=>{
                       const txt=c.innerText; const idx=steps.indexOf(txt);
                       if(idx>-1) { c.classList.add('selected'); c.innerHTML=`${txt} <span class="chip-num">${idx+1}</span>`; }
                       else { c.classList.remove('selected'); c.innerHTML=txt; }
                    });
                };

                const {value: cfg} = await Swal.fire({
                    title: 'ENVIAR A PRODUCCI√ìN', text: p.n, width: 600,
                    html: `<div style="display:flex;gap:10px;"><input id="f-sz" class="swal2-input" placeholder="Talla"><input id="f-q" type="number" class="swal2-input" placeholder="Cant"></div>
                           <p style="text-align:left;font-weight:bold;margin-top:10px;">SELECCIONA RUTA:</p>
                           <div class="chip-container">${['CORTE','BORDADO','ESTAMPADO','COSTURA','TERMINADO','EMPAQUE'].map(s=>`<div class="chip" onclick="togS(this)">${s}</div>`).join('')}</div>`,
                    preConfirm: () => {
                        const sz = document.getElementById('f-sz').value.toUpperCase()||'UNICA';
                        const q = document.getElementById('f-q').value;
                        if(!q || !steps.length) return Swal.showValidationMessage('Falta cantidad o pasos');
                        return {sz, q};
                    }
                });

                if(!cfg) return;

                // Asignar Talleres
                const inputs = steps.map((s,k) => `<div><label style="font-size:0.8rem;font-weight:bold;">${s}:</label><input id="loc-${k}" class="swal2-input" placeholder="Taller Responsable" style="margin:5px 0 10px;"></div>`).join('');
                const {value: locs} = await Swal.fire({ title: 'ASIGNAR TALLERES', html: `<div style="text-align:left;">${inputs}</div>`, preConfirm: () => {
                    const res = [];
                    for(let k=0; k<steps.length; k++) {
                        const t = document.getElementById(`loc-${k}`).value;
                        if(!t) return Swal.showValidationMessage('Define todos los talleres');
                        res.push({n:steps[k], t});
                    }
                    return res;
                }});

                if(locs) {
                    App.data.fab.push({ n:p.n, date: new Date().toLocaleDateString(), lastUpdate: Date.now(), items:[{sz:cfg.sz, q:cfg.q}], steps:locs, stepIndex:0 });
                    App.save(); App.UI.switchTab('fabrica');
                    App.Helpers.log(`Inicia producci√≥n: ${p.n} (${cfg.q} un.)`);
                }
            },

            editStepLoc(i) {
                const f = App.data.fab[i];
                const cur = f.steps[f.stepIndex];
                Swal.fire({title:`Reasignar: ${cur.n}`, input:'text', inputValue:cur.t, confirmButtonText:'Cambiar'}).then(r=>{
                    if(r.value) { f.steps[f.stepIndex].t = r.value; App.save(); App.Render.fabrica(); }
                });
            },

            async advanceFab(i, btn) {
                btn.disabled = true; // Anti doble click
                const f = App.data.fab[i];
                if(f.stepIndex < f.steps.length - 1) {
                    f.stepIndex++; 
                    f.lastUpdate = Date.now();
                    App.save(); App.Render.fabrica();
                } else {
                    // FINALIZAR CON CONTROL DE MERMAS
                    const totalEnv = f.items.reduce((a,b)=>a+parseInt(b.q),0);
                    const {value: realQ} = await Swal.fire({
                        title: 'FINALIZAR LOTE',
                        html: `Se enviaron <b>${totalEnv}</b> unidades.<br>¬øCu√°ntas ingresan a Bodega?`,
                        input: 'number', inputValue: totalEnv
                    });

                    if(realQ) {
                        const diff = totalEnv - parseInt(realQ);
                        let p = App.data.inv.find(x => x.n === f.n);
                        if(p) {
                            f.items.forEach(it => {
                                // Ajuste proporcional o directo si es 1 item
                                p.s[it.sz] = (p.s[it.sz]||0) + parseInt(realQ);
                            });
                            
                            if(diff > 0) App.Helpers.log(`‚ö†Ô∏è MERMA: ${diff} unidades perdidas en ${f.n} (Taller: ${f.steps[f.steps.length-1].t})`);
                            else App.Helpers.log(`Producci√≥n OK: ${f.n} ingres√≥ completo.`);
                            
                            App.data.fab.splice(i,1);
                            App.save(); App.Render.all();
                            Swal.fire('Proceso Terminado', diff>0?`Se registraron ${diff} mermas.`:'Lote completo ingresado.', diff>0?'warning':'success');
                        }
                    } else {
                         btn.disabled = false; // Cancelado
                    }
                }
            },

            setItemStatus(oIdx, iIdx, st) { App.data.ord[oIdx].items[iIdx].st = st; App.save(); },
            
            logDay(dateStr) {
                Swal.fire({
                    title: `Notas: ${dateStr}`,
                    input: 'textarea',
                    inputValue: App.data.logs[dateStr] || '',
                    placeholder: 'Escribe ideas o recordatorios...'
                }).then(r => {
                    if(r.value !== undefined) {
                        App.data.logs[dateStr] = r.value;
                        App.save(); App.Render.calendar();
                    }
                });
            },

            reset() {
                if(!App.state.backupOk) return;
                Swal.fire({title:'RESET TOTAL', text:'Escribe BORRAR TODO', input:'text'}).then(r=>{
                    if(r.value==='BORRAR TODO') { db.ref('/').set({}); location.reload(); }
                });
            }
        },

        UI: {
            go(id, el) {
                document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
                document.querySelectorAll('.dock i').forEach(i=>i.classList.remove('active'));
                document.getElementById('v-'+id).classList.add('active');
                el.classList.add('active');
            },
            switchTab(t) {
                document.getElementById('mod-bodega').style.display = t==='bodega'?'block':'none';
                document.getElementById('mod-fabrica').style.display = t==='fabrica'?'block':'none';
                document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                event.target.classList.add('active');
            }
        },

        Render: {
            all() { this.bodega(); this.fabrica(); this.ordenes(); this.calendar(); },
            
            bodega() {
                const q = document.getElementById('search-inv').value.toUpperCase();
                const list = App.data.inv.filter(x => x.n.includes(q) || x.sku.includes(q));
                document.getElementById('list-bodega').innerHTML = list.map((p, i) => {
                    const st = Object.entries(p.s).map(([k,v]) => `<span style="background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin:2px;"><b>${k}:</b>${v}</span>`).join('');
                    const realIdx = App.data.inv.indexOf(p);
                    return `<div class="card">
                        <div style="display:flex;justify-content:space-between;">
                            <span class="sku-tag">${p.sku}</span>
                            <div><i class="fa-solid fa-pen" style="color:#94a3b8;cursor:pointer;margin-right:10px;" onclick="App.Actions.modalInv(${realIdx})"></i><i class="fa-solid fa-trash" style="color:#ef4444;cursor:pointer;" onclick="App.Actions.delInv(${realIdx})"></i></div>
                        </div>
                        <h3 style="margin:5px 0;">${p.n}</h3>
                        <div style="margin-bottom:10px;">${st||'<small>Sin Stock</small>'}</div>
                        <button class="btn btn-sec" onclick="App.Actions.sendFab(${realIdx})">ENVIAR A PRODUCCI√ìN</button>
                    </div>`;
                }).join('');
            },

            fabrica() {
                document.getElementById('list-fabrica').innerHTML = App.data.fab.map((f, i) => {
                    const cur = f.steps[f.stepIndex];
                    const stepsHTML = f.steps.map((s, idx) => {
                        let cls = 'step-node';
                        if(idx < f.stepIndex) cls += ' done';
                        if(idx === f.stepIndex) cls += ' current';
                        return `<div class="${cls}">${idx+1}</div>`;
                    }).join('');
                    
                    // Calculo de tiempo
                    const diff = Date.now() - (f.lastUpdate || Date.now());
                    const days = Math.floor(diff / (1000*60*60*24));
                    const timeAlert = days > 2 ? 'alert' : ''; // Alerta si pasa m√°s de 2 d√≠as

                    return `<div class="card" style="border-left:4px solid var(--prod);">
                        <div style="display:flex;justify-content:space-between;">
                            <b>${f.n}</b>
                            <i class="fa-solid fa-pen" style="color:#94a3b8;cursor:pointer;" onclick="App.Actions.editStepLoc(${i})"></i>
                        </div>
                        <div style="font-size:0.8rem;color:#64748b;margin:5px 0;">${f.items.map(it=>`${it.q} (${it.sz})`).join(', ')}</div>
                        
                        <div class="step-progress">
                            <div class="step-line-bg"></div>
                            ${stepsHTML}
                        </div>
                        <div style="text-align:center; margin-bottom:10px;">
                            <div style="font-size:0.9rem; font-weight:800;">${cur.n}</div>
                            <div style="font-size:0.8rem; color:#64748b;">${cur.t}</div>
                            <div class="time-badge ${timeAlert}"><i class="fa-regular fa-clock"></i> Hace ${days} d√≠as</div>
                        </div>

                        <button class="btn btn-pri" onclick="App.Actions.advanceFab(${i}, this)">
                            ${f.stepIndex >= f.steps.length-1 ? 'FINALIZAR' : 'AVANZAR ETAPA'}
                        </button>
                    </div>`;
                }).join('');
            },

            ordenes() {
                // Ordenar por deadline si existe
                const sorted = [...App.data.ord].sort((a,b) => new Date(a.deadline) - new Date(b.deadline));
                document.getElementById('list-ordenes').innerHTML = sorted.map((o) => {
                    const realIdx = App.data.ord.indexOf(o);
                    const items = o.items.map((it, ii) => `
                        <div style="display:flex;justify-content:space-between;border-bottom:1px solid #f1f5f9;padding:6px 0;font-size:0.85rem;">
                            <span><b>${it.q}</b> ${it.p} (${it.sz}) <br><small style="color:var(--gold)">${it.obs||''}</small></span>
                            <select style="border:none;font-weight:bold;color:${it.st==='LISTO'?'var(--success)':'var(--gold)'}" onchange="App.Actions.setItemStatus(${realIdx},${ii},this.value)">
                                <option>PENDIENTE</option><option>CORTE</option><option>CONFECCION</option><option>LISTO</option>
                            </select>
                        </div>`).join('');
                    
                    // Alerta fecha
                    const today = new Date().toISOString().split('T')[0];
                    const isLate = o.deadline < today && o.st !== 'done';

                    return `<div class="card" style="border:1px solid ${isLate?'#ef4444':'#e2e8f0'}">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <div>
                                <h3 style="margin:0;">${o.c}</h3>
                                <div style="font-size:0.75rem; color:${isLate?'red':'gray'}; cursor:pointer;" onclick="App.Actions.editOCDate(${realIdx})">
                                    <i class="fa-regular fa-calendar"></i> Entrega: ${o.deadline} ${isLate?'(ATRASADO)':''}
                                </div>
                            </div>
                            <button class="btn btn-sec" style="width:auto;padding:5px 10px;" onclick="App.Matrix.open('OC',${realIdx})"><i class="fa-solid fa-pen"></i></button>
                        </div>
                        <div style="background:#f8fafc;padding:10px;border-radius:10px;">${items}</div>
                        <div style="margin-top:10px;">
                            <button class="btn btn-gold" onclick="App.Backup.printOrder(${realIdx})"><i class="fa-solid fa-print"></i> PDF</button>
                        </div>
                    </div>`;
                }).join('');
            },

            calendar() {
                const d = new Date();
                document.getElementById('cal-month').innerText = d.toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
                const days = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
                let h='';
                
                // Mapear OCs por fecha
                const deadlines = {};
                App.data.ord.forEach(o => { if(o.st !== 'done') deadlines[o.deadline] = true; });

                for(let i=1;i<=days;i++) {
                    const m = String(d.getMonth()+1).padStart(2,'0');
                    const day = String(i).padStart(2,'0');
                    const key = `${d.getFullYear()}-${m}-${day}`; // Formato YYYY-MM-DD para OCs
                    const logKey = `${i}-${d.getMonth()}-${d.getFullYear()}`; // Formato legacy logs

                    const hasLog = App.data.logs[logKey];
                    const hasOC = deadlines[key];

                    h+=`<div class="cal-day" onclick="App.Actions.logDay('${logKey}')" style="background:${hasOC?'#fff1f2':(hasLog?'#fffbeb':'white')}">
                            ${i}
                            <div style="display:flex; gap:2px;">
                                ${hasOC ? '<div class="cal-dot dot-oc"></div>' : ''}
                                ${hasLog ? '<div class="cal-dot dot-info"></div>' : ''}
                            </div>
                        </div>`;
                }
                document.getElementById('cal-grid').innerHTML = h;
            }
        },

        Backup: {
            download() {
                const doc = new window.jspdf.jsPDF();
                doc.setFontSize(18); doc.text("REPORTE MAESTRO DE SISTEMA", 10, 20);
                doc.setFontSize(10); doc.text(`Fecha: ${new Date().toLocaleString()}`, 10, 26);
                
                // 1. Logs de Calendario
                const logData = Object.entries(App.data.logs).map(([k,v]) => [k, v]);
                doc.text("1. BIT√ÅCORA Y NOTAS", 10, 35);
                doc.autoTable({ startY:40, head:[['FECHA','NOTA']], body:logData });

                // 2. Fechas de Entrega Pendientes
                const pending = App.data.ord.filter(o => o.st !== 'done').map(o => [o.deadline, o.c, o.items.length]);
                doc.text("2. ENTREGAS PENDIENTES", 10, doc.lastAutoTable.finalY + 10);
                doc.autoTable({ startY: doc.lastAutoTable.finalY + 15, head:[['DEADLINE','CLIENTE','ITEMS']], body:pending, headStyles:{fillColor:[239, 68, 68]} });

                doc.save('BACKUP_MASTER_V10.pdf');
                App.state.backupOk = true;
                document.getElementById('btn-reset').disabled = false;
            },
            printOrder(i) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const o = App.data.ord[i];
                doc.setFontSize(22); doc.setTextColor(217, 119, 6); doc.text("ORDEN DE COMPRA", 105, 20, null, null, 'center');
                doc.setTextColor(0); doc.setFontSize(12);
                doc.text(`CLIENTE: ${o.c}`, 15, 40);
                doc.text(`FECHA ORDEN: ${o.date}`, 15, 46);
                doc.text(`FECHA ENTREGA: ${o.deadline}`, 15, 52);
                
                const body = o.items.map(it => [it.q, it.p, it.sz, it.obs, it.st]);
                doc.autoTable({ startY:60, head:[['CANT','ITEM','TALLA','NOTA','ESTADO']], body:body, headStyles:{fillColor:[15, 23, 42]} });
                doc.save(`OC_${o.c}.pdf`);
            }
        },
        Helpers: { 
            genSKU: () => 'SKU-'+Math.floor(Math.random()*100000),
            log: (msg) => { /* Helper log interno si se requiere */ }
        }
    };

    App.init();
</script>
</body>
</html>
