<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEAS TEXTILES SPA | ERP SYSTEM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --brand-dark: #0f172a;
            --brand-primary: #2563eb;
            --brand-accent: #3b82f6;
            --bg-app: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --border-light: #e2e8f0;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: #334155;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* --- COMPONENTES DE UI --- */
        .nav-bubble {
            position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden; border: 1px solid transparent;
        }
        .nav-bubble:hover {
            transform: translateY(-2px); background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .nav-bubble.active {
            background: white; color: var(--brand-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-weight: 800;
        }
        .nav-bubble.active i { color: var(--brand-primary); }

        .card-glass {
            background: white; border-radius: 16px; border: 1px solid var(--border-light);
            padding: 24px; transition: all 0.3s ease; position: relative;
            box-shadow: var(--shadow-soft);
        }
        .card-glass:hover {
            transform: translateY(-2px); box-shadow: var(--shadow-hover);
            border-color: #cbd5e1;
        }

        .search-input {
            background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 10px 16px; font-size: 0.85rem; font-weight: 600; color: #334155;
            transition: all 0.3s; width: 100%;
        }
        .search-input:focus {
            background: white; border-color: var(--brand-primary); outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-action { transition: all 0.2s active; cursor: pointer; user-select: none; }
        .btn-action:active { transform: scale(0.97); }

        /* --- CALENDARIO & PLANNER --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day {
            min-height: 120px; background: white; border-radius: 12px;
            border: 1px solid #f1f5f9; padding: 6px; display: flex; flex-direction: column;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .cal-day:hover { border-color: var(--brand-primary); background: #f8fafc; z-index: 10; }
        .cal-day.today { background: #eff6ff; border: 2px solid var(--brand-primary); }
        .cal-event {
            font-size: 0.65rem; padding: 3px 6px; border-radius: 4px; margin-top: 2px;
            font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 4px; border-left-width: 3px;
        }
        
        /* --- PIPELINE VISUAL --- */
        .st-pendiente { background-color: #f1f5f9; color: #64748b; border-color: #cbd5e1; }
        .st-proceso { background-color: #fff7ed; color: #c2410c; border-color: #fdba74; }
        .st-empaquetado { background-color: #eff6ff; color: #1e40af; border-color: #93c5fd; }
        .st-despachado { background-color: #f0fdf4; color: #15803d; border-color: #86efac; }
        
        .task-item { transition: all 0.2s; }
        .task-item.done span { text-decoration: line-through; color: #94a3b8; }
        .task-item:hover { background-color: #f8fafc; }

        /* --- ADUANA DE VALIDACIÓN (SPLIT VIEW) --- */
        .split-view { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 70vh; }
        .evidence-panel { background: #0f172a; border-radius: 12px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        .evidence-img { max-width: 100%; max-height: 100%; transition: transform 0.2s; cursor: grab; }
        .data-panel { background: #fff; border-radius: 12px; padding: 20px; overflow-y: auto; border: 1px solid #e2e8f0; }
        
        /* GEMINI STYLES */
        .gemini-glow { animation: geminiPulse 2s infinite; }
        @keyframes geminiPulse { 0% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); } 100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); } }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed; bottom: 0; left: 0; width: 100%; height: auto;
                flex-direction: row; justify-content: space-evenly;
                border-radius: 24px 24px 0 0; padding: 12px; z-index: 50;
                background: #0f172a; box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            }
            .sidebar-logo, .nav-label, .sidebar-footer { display: none; }
            .nav-bubble { padding: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
            main { padding-bottom: 120px; }
            .split-view { grid-template-columns: 1fr; height: auto; }
            .evidence-panel { height: 300px; }
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col justify-center items-center text-white transition-opacity duration-700">
        <div class="relative mb-6">
            <div class="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"></div>
            <i class="fas fa-brain absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xl text-white"></i>
        </div>
        <h2 class="font-black text-2xl tracking-[6px] uppercase">Ideas Textiles</h2>
        <p class="text-[10px] font-bold text-slate-500 mt-2 uppercase tracking-widest">Iniciando...</p>
    </div>

    <div id="config-modal" class="fixed inset-0 bg-slate-900/90 z-[95] hidden p-4 flex items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 animate__animated animate__fadeInDown">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-key text-purple-600"></i> Configurar IA</h3>
                <button onclick="document.getElementById('config-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-xs text-slate-500 mb-4">Ingresa tu API Key de Google Gemini para habilitar la inteligencia artificial. Se guardará de forma segura en tu navegador.</p>
            <input type="password" id="gemini-api-key" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm font-mono mb-4 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Pegar API Key aquí...">
            <button onclick="App.Logic.Gemini.saveKey()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition">GUARDAR Y ACTIVAR</button>
            <p class="text-[10px] text-center mt-4 text-slate-400 cursor-pointer hover:text-blue-500" onclick="window.open('https://aistudio.google.com/app/apikey')">¿No tienes una Key? Consíguela gratis aquí</p>
        </div>
    </div>

    <div id="validation-modal" class="fixed inset-0 bg-slate-900/90 z-[90] hidden p-4 flex items-center justify-center">
        <div class="bg-white w-full max-w-6xl h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate__animated animate__zoomIn">
            
            <div class="bg-slate-100 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                <div>
                    <h3 class="font-black text-slate-800 text-lg flex items-center gap-2">
                        <i class="fas fa-sparkles text-purple-600 animate-pulse"></i> GEMINI ANALYSIS
                    </h3>
                    <p class="text-xs text-slate-500">Revisa la interpretación de la IA antes de guardar.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="App.Logic.Validation.zoom(0.1)" class="w-8 h-8 rounded bg-white border shadow flex items-center justify-center hover:bg-slate-50"><i class="fas fa-search-plus"></i></button>
                    <button onclick="App.Logic.Validation.zoom(-0.1)" class="w-8 h-8 rounded bg-white border shadow flex items-center justify-center hover:bg-slate-50"><i class="fas fa-search-minus"></i></button>
                    <button onclick="App.Logic.Validation.close()" class="w-8 h-8 rounded bg-red-100 text-red-500 hover:bg-red-200 flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="flex-1 p-6 overflow-hidden">
                <div class="split-view h-full">
                    <div class="evidence-panel group border border-slate-700">
                        <img id="evidence-img" src="" class="evidence-img" alt="Evidencia">
                        <div id="evidence-text-overlay" class="hidden absolute inset-0 bg-white p-4 font-mono text-xs overflow-auto whitespace-pre-wrap"></div>
                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-3 py-1 rounded-full text-xs opacity-0 group-hover:opacity-100 transition pointer-events-none">Scroll para Zoom</div>
                    </div>
                    
                    <div class="data-panel flex flex-col shadow-inner bg-slate-50/50">
                        <div id="validation-form-container" class="flex-1 space-y-4">
                            </div>
                        
                        <div class="mt-6 pt-4 border-t border-slate-200 grid grid-cols-2 gap-4">
                            <button onclick="App.Logic.Validation.reject()" class="py-3 rounded-xl border-2 border-red-100 text-red-500 font-bold hover:bg-red-50 transition">
                                <i class="fas fa-trash-alt mr-2"></i> RECHAZAR
                            </button>
                            <button onclick="App.Logic.Validation.confirm()" class="py-3 rounded-xl bg-purple-600 text-white font-bold shadow-lg hover:bg-purple-700 transition gemini-glow">
                                <i class="fas fa-check-circle mr-2"></i> CONFIRMAR E IMPORTAR
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="connection-widget" class="fixed top-4 right-4 z-50 bg-white/90 backdrop-blur px-3 py-1.5 rounded-full border border-slate-200 shadow-lg flex items-center gap-2 transition-all">
        <span class="relative flex h-2.5 w-2.5">
          <span id="ping-dot" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
          <span id="static-dot" class="relative inline-flex rounded-full h-2.5 w-2.5 bg-slate-500"></span>
        </span>
        <span id="conn-text" class="text-[10px] font-bold text-slate-600">CONECTANDO</span>
    </div>

    <div class="flex flex-col lg:flex-row min-h-screen">
        <aside class="sidebar bg-[#0f172a] text-slate-300 w-full lg:w-72 lg:p-6 flex lg:flex-col justify-between relative shadow-2xl z-40">
            <div class="sidebar-logo z-10 mb-8">
                <div class="flex items-center gap-3 text-white">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/40">
                        <i class="fas fa-scissors text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-black italic text-lg leading-none tracking-tight">IDEAS<br><span class="text-blue-500">TEXTILES</span></h1>
                    </div>
                </div>
            </div>

            <nav class="flex lg:flex-col gap-2 w-full lg:flex-1 z-10 overflow-x-auto lg:overflow-visible pb-2 lg:pb-0">
                <div onclick="App.Router.go('dashboard')" id="nav-dashboard" class="nav-bubble active p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400 shrink-0">
                    <i class="fas fa-chart-pie w-6 text-center"></i> <span class="nav-label">Dashboard</span>
                </div>
                <div onclick="App.Router.go('inventory')" id="nav-inventory" class="nav-bubble p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400 shrink-0">
                    <i class="fas fa-tshirt w-6 text-center"></i> <span class="nav-label">Bodega</span>
                </div>
                <div onclick="App.Router.go('movements')" id="nav-movements" class="nav-bubble p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400 shrink-0">
                    <i class="fas fa-exchange-alt w-6 text-center"></i> <span class="nav-label">Movimientos</span>
                </div>
                <div onclick="App.Router.go('orders')" id="nav-orders" class="nav-bubble p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400 shrink-0">
                    <i class="fas fa-file-invoice w-6 text-center"></i> <span class="nav-label">Órdenes</span>
                </div>
                <div onclick="App.Router.go('scanner')" id="nav-scanner" class="nav-bubble p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400 shrink-0">
                    <i class="fas fa-microchip w-6 text-center text-purple-400"></i> <span class="nav-label">Cerebro AI</span>
                </div>
                <div onclick="App.Router.go('calendar')" id="nav-calendar" class="nav-bubble p-3 rounded-xl cursor-pointer flex items-center gap-3 text-sm font-bold text-slate-400 shrink-0">
                    <i class="fas fa-calendar-alt w-6 text-center"></i> <span class="nav-label">Agenda</span>
                </div>
            </nav>

            <div class="sidebar-footer z-10 mt-auto pt-4 border-t border-slate-800">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white cursor-pointer hover:bg-slate-600" onclick="document.getElementById('config-modal').classList.remove('hidden')"><i class="fas fa-cog"></i></div>
                    <div><p class="text-xs font-bold text-white">Gemini</p><p class="text-[10px] text-slate-500">Modo Online </p></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-4 lg:p-8 overflow-y-auto relative scroll-smooth">
            
            <section id="view-dashboard" class="fade-in">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">Panel de Control</h2>
                        <p class="text-slate-500 text-sm font-medium mt-1">Resumen de operaciones diarias</p>
                    </div>
                    <button onclick="App.PDF.generateManagementReport()" class="btn-action bg-slate-800 text-white px-5 py-3 rounded-xl font-bold text-xs shadow-lg flex items-center gap-2 hover:bg-slate-900 border border-slate-700">
                        <i class="fas fa-file-contract"></i> REPORTE GERENCIAL
                    </button>
                </header>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card-glass bg-gradient-to-br from-slate-800 to-slate-900 text-white border-none">
                        <div class="flex justify-between">
                            <div><p class="text-xs font-bold opacity-60 uppercase">Stock Total</p><h3 class="text-4xl font-black mt-2" id="dash-stock">0</h3></div>
                            <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center"><i class="fas fa-box text-lg"></i></div>
                        </div>
                    </div>
                    <div class="card-glass">
                        <div class="flex justify-between">
                            <div><p class="text-xs font-bold text-slate-400 uppercase">Órdenes Activas</p><h3 class="text-4xl font-black text-slate-800 mt-2" id="dash-pending">0</h3></div>
                            <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-clock text-lg"></i></div>
                        </div>
                    </div>
                    <div class="card-glass">
                        <div class="flex justify-between">
                            <div><p class="text-xs font-bold text-slate-400 uppercase">Despachos Mes</p><h3 class="text-4xl font-black text-slate-800 mt-2" id="dash-dispatch">0</h3></div>
                            <div class="w-10 h-10 bg-green-50 text-green-600 rounded-full flex items-center justify-center"><i class="fas fa-check-circle text-lg"></i></div>
                        </div>
                    </div>
                </div>

                <div class="card-glass border-l-4 border-l-purple-500">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i class="fas fa-tasks mr-2 text-purple-500"></i>Planner Diario</h3>
                        <span class="text-xs text-slate-400 font-mono" id="current-date-display"></span>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-task-input" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-purple-500" placeholder="Escribe una tarea nueva y presiona Enter..." onkeypress="if(event.key==='Enter') App.Logic.Planner.add()">
                        <button onclick="App.Logic.Planner.add()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="tasks-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                </div>
            </section>

            <section id="view-inventory" class="hidden fade-in">
                <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div><h2 class="text-3xl font-black text-slate-800">Bodega</h2><p class="text-slate-500 text-sm">Gestión de inventario SKU</p></div>
                    <div class="flex gap-3 w-full md:w-auto items-center">
                        <div class="relative w-full md:w-64">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="text" class="search-input pl-9" placeholder="Buscar por Nombre o SKU..." oninput="App.Actions.filter('inventory', this.value)">
                        </div>
                        
                        <button onclick="App.Logic.Gemini.trigger('inventory')" class="btn-action bg-emerald-600 text-white px-4 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm hover:bg-emerald-700 whitespace-nowrap">
                            <i class="fas fa-robot"></i> SCAN STOCK
                        </button>
                        
                        <button onclick="App.UI.Modals.newProduct()" class="btn-action bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm hover:bg-slate-800 whitespace-nowrap"><i class="fas fa-plus"></i> NUEVO</button>
                    </div>
                </header>
                <div id="inventory-grid" class="grid grid-cols-1 gap-4"></div>
            </section>

            <section id="view-movements" class="hidden fade-in">
                <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div><h2 class="text-3xl font-black text-slate-800">Movimientos</h2><p class="text-slate-500 text-sm">Kárdex de Entradas y Salidas</p></div>
                    <button onclick="App.UI.Modals.registerMovement()" class="btn-action bg-slate-800 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg flex items-center gap-2 hover:bg-slate-700">
                        <i class="fas fa-exchange-alt"></i> REGISTRO MANUAL
                    </button>
                </header>
                <div class="card-glass overflow-x-auto p-0">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50">
                            <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-200">
                                <th class="py-4 px-6">FECHA</th>
                                <th class="py-4 px-4">TIPO</th>
                                <th class="py-4 px-4">PRODUCTO</th>
                                <th class="py-4 px-4">CANTIDAD</th>
                                <th class="py-4 px-6">MOTIVO / REFERENCIA</th>
                            </tr>
                        </thead>
                        <tbody id="movements-list" class="text-sm divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <section id="view-orders" class="hidden fade-in">
                <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div><h2 class="text-3xl font-black text-slate-800">Órdenes</h2><p class="text-slate-500 text-sm">Flujo de Trabajo (Pipeline)</p></div>
                    <div class="flex gap-3 w-full md:w-auto items-center">
                        <div class="relative w-full md:w-72">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="text" class="search-input pl-9" placeholder="Buscar Cliente, OC, Fac o Estado..." oninput="App.Actions.filter('orders', this.value)">
                        </div>
                        
                        <button onclick="App.Logic.Gemini.trigger('orders')" class="btn-action bg-purple-600 text-white px-4 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm hover:bg-purple-700 whitespace-nowrap">
                            <i class="fas fa-magic"></i> SCAN OC
                        </button>

                        <button onclick="App.UI.Modals.newOrder()" class="btn-action bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm hover:bg-blue-700 whitespace-nowrap"><i class="fas fa-cart-shopping"></i> CREAR OC</button>
                    </div>
                </header>
                <div id="orders-grid" class="grid grid-cols-1 gap-6"></div>
            </section>

            <section id="view-scanner" class="hidden fade-in">
                <header class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">Motores de IA</h2>
                        <p class="text-slate-500 text-sm">Seleccione el modo de operación</p>
                    </div>
                    <button onclick="document.getElementById('config-modal').classList.remove('hidden')" class="bg-slate-100 p-2 rounded-full hover:bg-slate-200 transition"><i class="fas fa-cog text-slate-500"></i></button>
                </header>
                
                <div id="key-status-msg" class="mb-4 text-xs font-bold text-red-500 bg-red-50 p-3 rounded hidden">⚠️ La API Key no está configurada. Pulsa el engranaje.</div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card-glass border-l-4 border-l-emerald-500 flex flex-col items-center justify-center p-12 text-center group cursor-pointer hover:bg-emerald-50 transition" onclick="App.Logic.Gemini.trigger('inventory')">
                        <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mb-4 text-emerald-600 group-hover:scale-110 transition"><i class="fas fa-box-open text-3xl"></i></div>
                        <h4 class="font-bold text-slate-700 text-xl">Ingreso de Stock</h4>
                        <p class="text-xs text-slate-400 mt-2">Fotos, Listas, Excel, PDF</p>
                        <p class="text-[10px] text-emerald-600 mt-2 font-bold uppercase">Suma Inventario</p>
                    </div>

                    <div class="card-glass border-l-4 border-l-purple-500 flex flex-col items-center justify-center p-12 text-center group cursor-pointer hover:bg-purple-50 transition" onclick="App.Logic.Gemini.trigger('orders')">
                        <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mb-4 text-purple-600 group-hover:scale-110 transition"><i class="fas fa-file-invoice-dollar text-3xl"></i></div>
                        <h4 class="font-bold text-slate-700 text-xl">Ingreso de Pedidos</h4>
                        <p class="text-xs text-slate-400 mt-2">OCs, Correos, Excel, PDF</p>
                        <p class="text-[10px] text-purple-600 mt-2 font-bold uppercase">Crea Órdenes</p>
                    </div>
                </div>
            </section>

            <section id="view-calendar" class="hidden fade-in">
                <div class="card-glass p-6 mb-6 flex justify-between items-center">
                    <button onclick="App.Logic.Calendar.move(-1)" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center hover:bg-white hover:shadow transition"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-xl font-black text-slate-800 uppercase tracking-widest" id="cal-month-title">MES AÑO</h2>
                    <button onclick="App.Logic.Calendar.move(1)" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center hover:bg-white hover:shadow transition"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendar-grid" class="cal-grid"></div>
            </section>
        </main>
    </div>

    <input type="file" id="gemini-upload" class="hidden" accept="image/*,.pdf,.xlsx,.xls,.csv" onchange="App.Logic.Gemini.handleFile(this)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew", authDomain: "ideastextilesapp.firebaseapp.com", databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com", projectId: "ideastextilesapp", storageBucket: "ideastextilesapp.firebasestorage.app", messagingSenderId: "268995530035", appId: "1:268995530035:web:1890f45ac761cc81eb0246" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ESTADO GLOBAL ---
        const State = {
            inventory: [],
            orders: [],
            calendar: {},
            movements: [],
            tasks: [], 
            dateContext: new Date(),
            filters: { inventory: '', orders: '' },
            aiBuffer: {
                data: null,
                context: null,
                imageSrc: null,
                rawText: null // Para debug o Excel
            }
        };

        const ORDER_STATUS_FLOW = ['Pendiente', 'En Proceso', 'Empaquetado', 'Despachado'];
        
        window.App = {
            init: () => {
                onValue(ref(db, 'inventory'), s => { State.inventory = s.val() || []; App.UI.renderInventory(); App.UI.updateDashboard(); });
                onValue(ref(db, 'orders'), s => { State.orders = s.val() || []; App.UI.renderOrders(); App.UI.updateDashboard(); App.Logic.Calendar.render(); });
                onValue(ref(db, 'calendar'), s => { State.calendar = s.val() || {}; App.Logic.Calendar.render(); });
                onValue(ref(db, 'movements'), s => { State.movements = s.val() || []; App.UI.renderMovements(); });
                onValue(ref(db, 'tasks'), s => { State.tasks = s.val() || []; App.UI.renderTasks(); App.Logic.Calendar.render(); });
                
                onValue(ref(db, ".info/connected"), s => {
                    const txt = document.getElementById('conn-text');
                    const dot = document.getElementById('ping-dot');
                    if(s.val()){ txt.innerText = "ONLINE"; dot.classList.add('bg-green-400'); dot.classList.remove('bg-red-400'); }
                    else { txt.innerText = "OFFLINE"; dot.classList.add('bg-red-400'); dot.classList.remove('bg-green-400'); }
                });

                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('es-ES', options);

                // Check Gemini Key on Load
                if(!App.Logic.Gemini.getKey()) {
                    document.getElementById('key-status-msg').classList.remove('hidden');
                    // Auto-open modal if no key (optional, maybe annoying)
                }

                setTimeout(()=> document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none'), 1200);
            },

            Router: {
                go: (page) => {
                    document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
                    document.getElementById('view-'+page).classList.remove('hidden');
                    document.querySelectorAll('.nav-bubble').forEach(n => n.classList.remove('active'));
                    document.getElementById('nav-'+page).classList.add('active');
                    if(page === 'calendar') App.Logic.Calendar.render();
                }
            },

            UI: {
                updateDashboard: () => {
                    document.getElementById('dash-stock').innerText = State.inventory.length;
                    document.getElementById('dash-pending').innerText = State.orders.filter(o => o.status !== 'Despachado').length;
                    const month = new Date().toISOString().slice(0, 7);
                    document.getElementById('dash-dispatch').innerText = State.orders.filter(o => o.status === 'Despachado' && o.dispatchDate?.startsWith(month)).length;
                },

                renderTasks: () => {
                    const container = document.getElementById('tasks-list');
                    container.innerHTML = State.tasks.map((t, i) => `
                        <div class="task-item flex items-center justify-between p-2 rounded cursor-pointer ${t.done ? 'done bg-slate-50' : 'bg-white border border-slate-100'}" onclick="App.Logic.Planner.toggle(${i})">
                            <div class="flex items-center gap-3">
                                <div class="w-5 h-5 rounded border flex items-center justify-center ${t.done ? 'bg-purple-500 border-purple-500' : 'border-slate-300'}">
                                    ${t.done ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                                </div>
                                <span class="text-sm font-medium text-slate-700 select-none">${t.text}</span>
                            </div>
                            <button onclick="event.stopPropagation(); App.Logic.Planner.delete(${i})" class="text-slate-300 hover:text-red-400 px-2"><i class="fas fa-times"></i></button>
                        </div>
                    `).join('');
                },

                renderInventory: () => {
                    const grid = document.getElementById('inventory-grid');
                    const searchTerm = State.filters.inventory.toUpperCase();
                    const filtered = State.inventory.filter(p => p.name.includes(searchTerm) || p.sku.includes(searchTerm));

                    if(filtered.length === 0) { grid.innerHTML = '<div class="text-center text-slate-400 py-10">No se encontraron productos.</div>'; return; }
                    
                    grid.innerHTML = filtered.map((p, i) => {
                        let badges = ''; let total = 0;
                        if(p.stock) Object.entries(p.stock).forEach(([sz, qty]) => {
                            badges += `<span class="bg-slate-100 text-slate-600 border border-slate-200 px-2 py-1 rounded text-[10px] font-black mr-2 mb-1 inline-block min-w-[30px] text-center">${sz}: ${qty}</span>`;
                            total += qty;
                        });
                        const realIndex = State.inventory.indexOf(p);
                        return `
                        <div class="card-glass flex flex-col md:flex-row justify-between items-center group hover:border-blue-300 transition-colors animate__animated animate__fadeIn">
                            <div class="flex items-center gap-4 w-full md:w-auto">
                                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center font-bold text-xl shadow-inner">${p.name.charAt(0)}</div>
                                <div>
                                    <div class="font-bold text-slate-800 text-lg">${p.name}</div>
                                    <div class="text-[10px] text-slate-400 font-mono tracking-wide bg-slate-50 px-2 py-0.5 rounded inline-block border border-slate-100">SKU: ${p.sku}</div>
                                    <div class="mt-2 flex flex-wrap">${badges}</div>
                                </div>
                            </div>
                            <div class="text-right flex items-center gap-8 mt-4 md:mt-0 w-full md:w-auto justify-between md:justify-end">
                                <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Stock</div><div class="text-3xl font-black text-slate-700">${total}</div></div>
                                <div class="flex gap-2">
                                    <button onclick="App.UI.Modals.editProduct(${realIndex})" class="w-10 h-10 rounded-full bg-slate-50 hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition shadow-sm border border-slate-100"><i class="fas fa-pencil-alt"></i></button>
                                    <button onclick="App.Actions.deleteProduct(${realIndex})" class="w-10 h-10 rounded-full bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-600 transition shadow-sm border border-slate-100"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                },

                renderMovements: () => {
                    const list = document.getElementById('movements-list');
                    const sorted = [...State.movements].reverse().slice(0, 50);
                    list.innerHTML = sorted.map(m => `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="py-4 px-6 text-xs text-slate-500 font-mono">${m.date}</td>
                            <td class="py-4 px-4"><span class="px-2 py-1 rounded text-[10px] font-black uppercase ${m.type==='Ingreso'?'bg-green-100 text-green-700 border border-green-200':'bg-red-50 text-red-700 border border-red-200'}">${m.type}</span></td>
                            <td class="py-4 px-4 font-bold text-slate-700 text-sm">${m.product} <span class="text-slate-400 font-normal">(${m.size})</span></td>
                            <td class="py-4 px-4 font-black text-slate-800">${m.qty}</td>
                            <td class="py-4 px-6 text-slate-500 italic text-xs border-l border-slate-50">${m.reason}</td>
                        </tr>
                    `).join('');
                },

                renderOrders: () => {
                    const grid = document.getElementById('orders-grid');
                    const searchTerm = State.filters.orders.toUpperCase();
                    const filtered = State.orders.filter(o => 
                        o.client.includes(searchTerm) || o.id.toString().includes(searchTerm) || o.status.toUpperCase().includes(searchTerm) || (o.invoice && o.invoice.toString().includes(searchTerm))
                    );

                    grid.innerHTML = filtered.map((o) => {
                        const idx = State.orders.indexOf(o);
                        const itemsHtml = o.items.map(it => `
                            <div class="text-xs py-2 border-b border-slate-100 last:border-0 flex justify-between items-center group-hover:bg-white/50 transition">
                                <span class="flex items-center gap-2"><span class="font-black text-blue-600 w-6 text-right">${it.qty}</span> x ${it.name} <span class="bg-slate-200 px-1.5 rounded text-[10px] font-bold text-slate-600">${it.size}</span></span>
                                ${it.msg ? `<span class="text-[9px] text-amber-600 bg-amber-50 px-2 py-0.5 rounded border border-amber-100 italic max-w-[150px] truncate" title="${it.msg}"><i class="fas fa-sticky-note mr-1"></i>${it.msg}</span>` : ''}
                            </div>`).join('');
                        
                        const deliveryTag = o.deliveryDate ? `<span class="ml-2 text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 font-bold"><i class="fas fa-calendar-check mr-1"></i>Entrega: ${o.deliveryDate}</span>` : '';
                        let statusClass = o.status === 'En Proceso' ? 'st-proceso' : o.status === 'Empaquetado' ? 'st-empaquetado' : o.status === 'Despachado' ? 'st-despachado' : 'st-pendiente';

                        // EDICIÓN FACTURA Y REVERSA
                        let actionBtn = '';
                        if (o.status === 'Despachado') {
                            actionBtn = `
                                <div class="flex items-center gap-2">
                                    <button onclick="App.Actions.changeStatus(${idx}, -1)" class="w-8 h-8 rounded bg-slate-100 hover:bg-slate-200 text-slate-500 transition" title="Reversar Despacho"><i class="fas fa-undo"></i></button>
                                    <div onclick="App.Actions.editInvoice(${idx})" class="cursor-pointer bg-green-50 border border-green-200 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-100 transition" title="Clic para editar factura">
                                        <i class="fas fa-file-invoice mr-1"></i>FAC: ${o.invoice}
                                    </div>
                                </div>`;
                        } else {
                            actionBtn = `
                            <div class="flex items-center bg-slate-100 rounded-lg p-1 gap-1">
                                <button onclick="App.Actions.changeStatus(${idx}, -1)" class="w-8 h-8 rounded hover:bg-white hover:shadow text-slate-400 hover:text-slate-600 transition" title="Retroceder"><i class="fas fa-arrow-left"></i></button>
                                <span class="text-[10px] font-bold px-2 text-slate-500 uppercase">ESTADO</span>
                                <button onclick="App.Actions.changeStatus(${idx}, 1)" class="w-8 h-8 rounded hover:bg-white hover:shadow text-blue-500 hover:text-blue-700 transition" title="Avanzar"><i class="fas fa-arrow-right"></i></button>
                            </div>`;
                        }

                        return `
                        <div class="card-glass border-l-4 ${o.status==='Despachado'?'border-l-green-500 bg-slate-50/50':'border-l-blue-500'} transition-all hover:shadow-lg animate__animated animate__fadeIn">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <h3 class="font-bold text-lg text-slate-800">${o.client}</h3>
                                        <button onclick="App.UI.Modals.editFullOrder(${idx})" class="w-6 h-6 rounded-full bg-slate-100 hover:bg-blue-100 text-slate-400 hover:text-blue-600 text-xs transition flex items-center justify-center"><i class="fas fa-pencil-alt"></i></button>
                                    </div>
                                    <div class="flex items-center mt-2">
                                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest border-r border-slate-200 pr-2 mr-2">OC #${o.id}</span>
                                        <span class="text-[10px] text-slate-500"><i class="far fa-clock mr-1"></i>${o.date}</span>
                                        ${deliveryTag}
                                    </div>
                                </div>
                                <span class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wide border ${statusClass}">${o.status}</span>
                            </div>
                            <div class="bg-slate-50/80 rounded-xl p-4 mb-4 max-h-48 overflow-y-auto border border-slate-100 shadow-inner custom-scrollbar">${itemsHtml}</div>
                            <div class="flex flex-wrap justify-between items-center gap-4 mt-2 pt-2 border-t border-slate-50">
                                <div>${actionBtn}</div>
                                <div class="flex gap-2">
                                    <button onclick="App.PDF.downloadTachas(${idx})" class="btn-action bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md hover:bg-slate-900"><i class="fas fa-tags mr-2"></i>PDF MASTER</button>
                                    <button onclick="App.Actions.deleteOrder(${idx})" class="w-8 h-8 rounded-lg text-red-300 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                },

                Modals: {
                    newProduct: async () => {
                        let nextNum = 1;
                        if(State.inventory.length > 0) {
                            const nums = State.inventory.map(p => { const m = p.sku.match(/ITEX(\d+)/); return m ? parseInt(m[1]) : 0; });
                            nextNum = Math.max(...nums) + 1;
                        }
                        const autoSku = `ITEX${String(nextNum).padStart(3, '0')}`;

                        const { value: res } = await Swal.fire({
                            title: 'Nuevo Producto',
                            html: `
                            <div class="text-left"><label class="text-xs font-bold text-slate-400">SKU (AUTO)</label><input id="np-sku" class="swal2-input m-0 mb-3 bg-slate-100 text-slate-500 font-mono" value="${autoSku}" readonly></div>
                            <div class="text-left"><label class="text-xs font-bold text-slate-400">NOMBRE</label><input id="np-name" class="swal2-input m-0 mb-3" placeholder="Ej: POLERA PIQUE"></div>
                            <div id="size-rows-container"></div>
                            <button type="button" onclick="App.UI.Helpers.addSizeRow()" class="mt-2 w-full py-2 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold text-slate-600 transition">+ AGREGAR TALLA</button>`,
                            didOpen: () => App.UI.Helpers.addSizeRow(),
                            preConfirm: () => {
                                const name = document.getElementById('np-name').value.toUpperCase();
                                const sku = document.getElementById('np-sku').value;
                                let stock = {};
                                document.querySelectorAll('.size-row').forEach(r => {
                                    const sz = r.querySelector('.sz-in').value.toUpperCase() || 'ÚNICA';
                                    const qt = parseInt(r.querySelector('.qt-in').value) || 0;
                                    stock[sz] = qt;
                                });
                                if(!name) return Swal.showValidationMessage('El nombre es obligatorio');
                                return { sku, name, stock };
                            }
                        });
                        if(res) App.Logic.Inventory.add(res);
                    },

                    editProduct: async (index) => {
                        const p = State.inventory[index];
                        let rowsHtml = '';
                        if (p.stock) Object.entries(p.stock).forEach(([size, qty]) => {
                            rowsHtml += `<div class="flex gap-2 mb-2 size-row items-center animate__animated animate__fadeIn"><input class="swal2-input m-0 text-sm sz-in bg-slate-50" value="${size}" placeholder="Talla" style="width:40%"><input type="number" class="swal2-input m-0 text-sm qt-in bg-slate-50" value="${qty}" placeholder="Cant" style="width:40%"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 hover:bg-red-50 rounded w-[10%] h-10 flex items-center justify-center transition"><i class="fas fa-trash-alt"></i></button></div>`;
                        });

                        const { value: form } = await Swal.fire({
                            title: 'Editar Stock & Producto',
                            width: '600px',
                            html: `
                                <div class="text-left mb-6"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Nombre del Producto</label><input id="ep-name" class="swal2-input m-0 w-full font-bold text-slate-700" value="${p.name}"></div>
                                <div class="bg-white p-4 rounded-xl border border-slate-200 text-left shadow-sm">
                                    <div class="flex justify-between items-center mb-3"><label class="text-[10px] font-bold text-slate-400 uppercase">Matriz de Tallas</label><span class="text-[10px] text-blue-500 bg-blue-50 px-2 py-1 rounded cursor-pointer hover:bg-blue-100" onclick="App.UI.Helpers.addEditRow()">+ Agregar Fila</span></div>
                                    <div id="ep-rows-container" class="max-h-60 overflow-y-auto pr-1 custom-scrollbar">${rowsHtml}</div>
                                </div>`,
                            preConfirm: () => {
                                const name = document.getElementById('ep-name').value.toUpperCase();
                                let newStock = {};
                                document.querySelectorAll('#ep-rows-container .size-row').forEach(r => {
                                    let s = r.querySelector('.sz-in').value.trim().toUpperCase();
                                    const q = parseInt(r.querySelector('.qt-in').value);
                                    if (!isNaN(q)) { if (s === "") s = "ÚNICA"; newStock[s] = q; }
                                });
                                if (!name) return Swal.showValidationMessage('Nombre requerido');
                                if (Object.keys(newStock).length === 0) newStock["ÚNICA"] = 0;
                                return { name, stock: newStock };
                            }
                        });

                        if (form) {
                            State.inventory[index] = { ...p, ...form }; 
                            set(ref(db, 'inventory'), State.inventory);
                            Swal.fire({ icon: 'success', title: 'Inventario Actualizado', timer: 1500, showConfirmButton: false });
                        }
                    },

                    registerMovement: async () => {
                        const prods = State.inventory.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
                        const { value: res } = await Swal.fire({
                            title: 'Movimiento de Bodega',
                            html: `
                                <div class="grid grid-cols-2 gap-4 text-left">
                                    <div class="col-span-2"><label class="text-[10px] font-bold text-slate-400 uppercase">Producto</label><select id="m-prod" class="swal2-input m-0 w-full" onchange="App.UI.Helpers.updateSizeSelect(this.value)"><option value="">Seleccionar...</option>${prods}</select></div>
                                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Talla</label><select id="m-size" class="swal2-input m-0 w-full bg-slate-50"><option value="">...</option></select></div>
                                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Cantidad</label><input id="m-qty" type="number" class="swal2-input m-0 w-full" placeholder="0"></div>
                                    <div class="col-span-2"><label class="text-[10px] font-bold text-slate-400 uppercase">Tipo</label><div class="flex gap-4 mt-1"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="mtype" value="Ingreso" checked> <span class="text-sm font-bold text-green-600">INGRESO (+)</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="mtype" value="Egreso"> <span class="text-sm font-bold text-red-600">EGRESO (-)</span></label></div></div>
                                    <div class="col-span-2"><label class="text-[10px] font-bold text-slate-400 uppercase">Motivo</label><input id="m-reason" class="swal2-input m-0 w-full" placeholder="Ej: Compra, Merma..."></div>
                                </div>`,
                            preConfirm: () => {
                                const p = document.getElementById('m-prod').value;
                                const s = document.getElementById('m-size').value;
                                const t = document.querySelector('input[name="mtype"]:checked').value;
                                const q = parseInt(document.getElementById('m-qty').value);
                                const r = document.getElementById('m-reason').value;
                                if(!p || !s || !q || !r) return Swal.showValidationMessage('Complete todos los campos');
                                return { p, s, t, q, r };
                            }
                        });
                        if(res) App.Actions.registerMovement(res);
                    },

                    editFullOrder: async (idx) => {
                        const o = State.orders[idx];
                        let itemsBuffer = JSON.parse(JSON.stringify(o.items || [])); 

                        const renderBuffer = () => {
                            const container = document.getElementById('edit-cart');
                            if(!container) return;
                            container.innerHTML = itemsBuffer.map((it, i) => `
                                <div class="flex justify-between items-center text-xs p-3 border-b bg-white first:rounded-t last:border-0 hover:bg-slate-50 transition animate__animated animate__fadeIn">
                                    <div><span class="font-bold text-blue-600 text-sm mr-2">${it.qty}</span><span class="font-bold text-slate-700">${it.name}</span><span class="ml-2 bg-slate-200 px-1.5 rounded text-[10px] font-bold text-slate-500">${it.size}</span>${it.msg ? `<div class="text-[10px] text-amber-600 mt-1 italic"><i class="fas fa-comment-alt mr-1"></i>${it.msg}</div>` : ''}</div>
                                    <button onclick="document.getElementById('hidden-remove-trigger').setAttribute('data-index', ${i}); document.getElementById('hidden-remove-trigger').click();" class="text-red-400 hover:text-red-600 p-2"><i class="fas fa-times-circle text-lg"></i></button>
                                </div>`).join('');
                        };

                        const { value: res } = await Swal.fire({
                            title: 'Editar Orden Compra',
                            width: '700px',
                            html: `
                                <button id="hidden-remove-trigger" style="display:none"></button>
                                <div class="grid grid-cols-2 gap-4 mb-4 text-left bg-slate-50 p-4 rounded-xl border border-slate-100">
                                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Cliente</label><input id="eo-client" class="swal2-input m-0 w-full h-10 text-sm" value="${o.client}"></div>
                                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">ID Interno</label><input id="eo-id" class="swal2-input m-0 w-full h-10 text-sm bg-slate-100" value="${o.id}" readonly></div>
                                    <div class="col-span-2"><label class="text-[10px] font-bold text-slate-400 uppercase">Fecha de Entrega</label><input type="date" id="eo-date" class="swal2-input m-0 w-full h-10 text-sm" value="${o.deliveryDate || ''}"></div>
                                </div>
                                <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 text-left mb-4">
                                    <label class="text-[10px] font-bold text-blue-400 uppercase mb-2 block">Agregar / Modificar Items</label>
                                    <div class="grid grid-cols-12 gap-2">
                                        <div class="col-span-5"><input id="eo-prod" class="swal2-input m-0 h-9 text-xs w-full" placeholder="Producto"></div>
                                        <div class="col-span-3"><input id="eo-size" class="swal2-input m-0 h-9 text-xs w-full" placeholder="Talla"></div>
                                        <div class="col-span-4"><input id="eo-qty" type="number" class="swal2-input m-0 h-9 text-xs w-full" placeholder="Cant"></div>
                                        <div class="col-span-12"><input id="eo-msg" class="swal2-input m-0 h-9 text-xs w-full" placeholder="Nota/Mensaje"></div>
                                    </div>
                                    <button type="button" id="btn-add-buffer" class="mt-3 w-full bg-slate-800 hover:bg-slate-900 text-white py-2 rounded-lg font-bold text-xs transition shadow">+ AÑADIR AL CARRITO</button>
                                </div>
                                <div class="text-left"><label class="text-[10px] font-bold text-slate-400 uppercase">Contenido</label><div id="edit-cart" class="mt-1 max-h-48 overflow-y-auto border border-slate-200 rounded-xl bg-slate-50 min-h-[100px]"></div></div>`,
                            didOpen: () => {
                                renderBuffer();
                                document.getElementById('btn-add-buffer').onclick = () => {
                                    const n = document.getElementById('eo-prod').value.toUpperCase();
                                    const s = document.getElementById('eo-size').value.toUpperCase() || 'ÚNICA';
                                    const q = parseInt(document.getElementById('eo-qty').value);
                                    const m = document.getElementById('eo-msg').value;
                                    if(n && q) { itemsBuffer.push({name:n, size:s, qty:q, msg:m}); renderBuffer(); document.getElementById('eo-prod').value = ''; document.getElementById('eo-qty').value = ''; document.getElementById('eo-msg').value = ''; document.getElementById('eo-prod').focus(); }
                                };
                                document.getElementById('hidden-remove-trigger').onclick = (e) => { itemsBuffer.splice(parseInt(e.target.getAttribute('data-index')), 1); renderBuffer(); };
                            },
                            preConfirm: () => {
                                const client = document.getElementById('eo-client').value;
                                const deliveryDate = document.getElementById('eo-date').value;
                                if(!client || itemsBuffer.length === 0) return Swal.showValidationMessage('Datos incompletos');
                                return { client, deliveryDate, items: itemsBuffer };
                            }
                        });

                        if(res) {
                            State.orders[idx] = { ...o, ...res };
                            set(ref(db, 'orders'), State.orders);
                            Swal.fire('Guardado Exitoso', 'La orden ha sido reestructurada.', 'success');
                        }
                    },

                    newOrder: async () => {
                        let cart = [];
                        const render = () => {
                            document.getElementById('new-cart').innerHTML = cart.map((it, i) => `
                                <div class="flex justify-between items-center text-xs p-2 border-b bg-white first:rounded-t">
                                    <span><span class="font-bold text-blue-600">${it.qty}</span> x ${it.name} (${it.size}) <span class="text-gray-400 italic">${it.msg || ''}</span></span>
                                    <button onclick="document.getElementById('rm-new-${i}').click()" class="text-red-500 hover:text-red-700 px-2">X</button>
                                    <button id="rm-new-${i}" style="display:none" onclick="window.tempRemoveNew(${i})"></button>
                                </div>`).join('');
                        };
                        window.tempRemoveNew = (i) => { cart.splice(i,1); render(); };

                        await Swal.fire({
                            title: 'Nueva Orden',
                            width: '700px',
                            html: `
                                <div class="grid grid-cols-2 gap-4 text-left">
                                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Cliente</label><input id="no-client" class="swal2-input m-0 w-full" placeholder="Nombre"></div>
                                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Fecha Entrega</label><input id="no-date" type="date" class="swal2-input m-0 w-full"></div>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mt-4 text-left">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Detalle</label>
                                    <div class="grid grid-cols-12 gap-2">
                                        <div class="col-span-5"><input id="no-prod" class="swal2-input m-0 h-10 text-xs w-full" placeholder="Producto"></div>
                                        <div class="col-span-3"><input id="no-sz" class="swal2-input m-0 h-10 text-xs w-full" placeholder="Talla"></div>
                                        <div class="col-span-4"><input id="no-qt" type="number" class="swal2-input m-0 h-10 text-xs w-full" placeholder="Cant"></div>
                                        <div class="col-span-12"><input id="no-msg" class="swal2-input m-0 h-10 text-xs w-full" placeholder="Nota"></div>
                                    </div>
                                    <button type="button" id="btn-no-add" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-2 rounded-lg mt-3 font-bold text-xs transition shadow">AGREGAR ITEM</button>
                                </div>
                                <div id="new-cart" class="mt-4 border border-slate-200 rounded-xl max-h-40 overflow-y-auto bg-slate-50 min-h-[80px]"></div>`,
                            didOpen: () => {
                                document.getElementById('btn-no-add').onclick = () => {
                                    const n = document.getElementById('no-prod').value.toUpperCase();
                                    const s = document.getElementById('no-sz').value.toUpperCase() || 'ÚNICA';
                                    const q = parseInt(document.getElementById('no-qt').value);
                                    const m = document.getElementById('no-msg').value;
                                    if(n && q) { cart.push({name:n, size:s, qty:q, msg:m}); render(); }
                                    document.getElementById('no-prod').value = ''; document.getElementById('no-qt').value = ''; document.getElementById('no-msg').value = ''; document.getElementById('no-prod').focus();
                                };
                            },
                            preConfirm: () => {
                                const client = document.getElementById('no-client').value;
                                const date = document.getElementById('no-date').value;
                                if(!client || cart.length === 0) return Swal.showValidationMessage('Falta cliente o productos');
                                return { client, date, items: cart };
                            }
                        }).then(r => {
                            if(r.isConfirmed) {
                                const order = { id: Date.now().toString().slice(-6), client: r.value.client.toUpperCase(), date: new Date().toISOString().split('T')[0], deliveryDate: r.value.date, items: r.value.items, status: 'Pendiente' };
                                State.orders.push(order);
                                set(ref(db, 'orders'), State.orders);
                                Swal.fire('Orden Creada', `ID: ${order.id}`, 'success');
                            }
                        });
                    }
                },

                Helpers: {
                    addSizeRow: () => {
                        const div = document.createElement('div');
                        div.className = 'flex gap-2 mb-2 size-row';
                        div.innerHTML = `<input class="swal2-input m-0 text-sm sz-in" placeholder="Talla" style="width:50%"><input type="number" class="swal2-input m-0 text-sm qt-in" placeholder="Cant" style="width:50%">`;
                        document.getElementById('size-rows-container').appendChild(div);
                    },
                    addEditRow: () => {
                        const div = document.createElement('div');
                        div.className = 'flex gap-2 mb-2 size-row items-center animate__animated animate__fadeIn';
                        div.innerHTML = `<input class="swal2-input m-0 text-sm sz-in bg-slate-50" placeholder="Nueva Talla" style="width:40%"><input type="number" class="swal2-input m-0 text-sm qt-in bg-slate-50" placeholder="0" style="width:40%"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 hover:bg-red-50 rounded w-[10%] h-10 flex items-center justify-center transition"><i class="fas fa-trash-alt"></i></button>`;
                        document.getElementById('ep-rows-container').appendChild(div);
                    },
                    updateSizeSelect: (prodName) => {
                        const p = State.inventory.find(x => x.name === prodName);
                        const sel = document.getElementById('m-size');
                        if(p && p.stock) sel.innerHTML = Object.keys(p.stock).map(s => `<option value="${s}">${s}</option>`).join('');
                    }
                }
            },

            Logic: {
                Inventory: {
                    add: (data) => {
                        let p = State.inventory.find(x => x.name === data.name);
                        if(p) { Object.keys(data.stock).forEach(s => p.stock[s] = (p.stock[s]||0) + data.stock[s]); }
                        else { State.inventory.push({ sku: data.sku, name: data.name, stock: data.stock }); }
                        set(ref(db, 'inventory'), State.inventory);
                        Swal.fire('Guardado', 'Inventario actualizado', 'success');
                    }
                },
                
                Planner: {
                    add: () => {
                        const input = document.getElementById('new-task-input');
                        const text = input.value.trim();
                        if(text) {
                            State.tasks.push({ text: text, done: false, date: new Date().toISOString().split('T')[0] });
                            set(ref(db, 'tasks'), State.tasks);
                            input.value = '';
                        }
                    },
                    toggle: (idx) => { State.tasks[idx].done = !State.tasks[idx].done; set(ref(db, 'tasks'), State.tasks); },
                    delete: (idx) => { State.tasks.splice(idx, 1); set(ref(db, 'tasks'), State.tasks); }
                },

                Calendar: {
                    move: (d) => { State.dateContext.setMonth(State.dateContext.getMonth()+d); App.Logic.Calendar.render(); },
                    render: () => {
                        const y = State.dateContext.getFullYear(), m = State.dateContext.getMonth();
                        document.getElementById('cal-month-title').innerText = new Date(y,m).toLocaleString('es-ES',{month:'long',year:'numeric'});
                        const days = new Date(y,m+1,0).getDate();
                        const start = new Date(y,m,1).getDay() || 7;
                        let html = '';
                        for(let i=1; i<start; i++) html+=`<div></div>`;
                        for(let i=1; i<=days; i++) {
                            const k = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                            const isToday = k === new Date().toISOString().split('T')[0] ? 'today' : '';
                            let content = '';
                            State.orders.filter(o => o.deliveryDate === k).forEach(o => content += `<div class="cal-event evt-delivery">📦 ${o.client.substring(0,10)}...</div>`);
                            if(State.tasks.some(t => t.date === k && !t.done)) content += `<div class="cal-event bg-purple-100 text-purple-700 border-purple-300">⚡ Tareas</div>`;
                            html += `<div class="cal-day ${isToday}"><span class="text-[10px] font-black text-slate-400 self-end">${i}</span><div class="w-full flex flex-col gap-1 overflow-hidden">${content}</div></div>`;
                        }
                        document.getElementById('calendar-grid').innerHTML = html;
                    }
                },

                // =========================================================================
                // GEMINI AI ENGINE (CEREBRO V11)
                // =========================================================================
                Gemini: {
                    getKey: () => localStorage.getItem('GEMINI_API_KEY'),
                    saveKey: () => {
                        const k = document.getElementById('gemini-api-key').value.trim();
                        if(k) { localStorage.setItem('GEMINI_API_KEY', k); document.getElementById('config-modal').classList.add('hidden'); Swal.fire('Configurado', 'API Key guardada.', 'success'); document.getElementById('key-status-msg').classList.add('hidden'); }
                    },
                    
                    trigger: (context) => {
                        const key = App.Logic.Gemini.getKey();
                        if(!key) { document.getElementById('config-modal').classList.remove('hidden'); return; }
                        // Guardar contexto temporalmente
                        document.getElementById('gemini-upload').setAttribute('data-context', context);
                        document.getElementById('gemini-upload').click();
                    },

                    handleFile: async (input) => {
                        const file = input.files[0];
                        if(!file) return;
                        const context = input.getAttribute('data-context'); // 'inventory' or 'orders'
                        input.value = ''; // Reset

                        Swal.fire({
                            title: 'Gemini Pensando...',
                            text: 'Analizando estructura y contenido...',
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading()
                        });

                        try {
                            let payloadPart = null;
                            let mimeType = file.type;
                            let previewSrc = null;

                            // 1. PROCESAR EXCEL
                            if(file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv')) {
                                const textData = await App.Logic.Gemini.utils.excelToCSV(file);
                                payloadPart = { text: "ANALIZA ESTOS DATOS CSV:\n" + textData };
                                previewSrc = "https://cdn-icons-png.flaticon.com/512/732/732220.png"; // Icono Excel
                            } 
                            // 2. PROCESAR PDF
                            else if(file.type === 'application/pdf') {
                                const base64Img = await App.Logic.Gemini.utils.pdfToImage(file);
                                payloadPart = { inline_data: { mime_type: "image/jpeg", data: base64Img } };
                                previewSrc = "data:image/jpeg;base64," + base64Img;
                            }
                            // 3. PROCESAR IMAGEN
                            else {
                                const base64Img = await App.Logic.Gemini.utils.fileToBase64(file);
                                payloadPart = { inline_data: { mime_type: file.type, data: base64Img } };
                                previewSrc = "data:" + file.type + ";base64," + base64Img;
                            }

                            // LLAMADA A API
                            const responseData = await App.Logic.Gemini.callAPI(payloadPart, context);
                            
                            // ABRIR ADUANA
                            App.Logic.Validation.open(responseData, context, previewSrc);

                        } catch (e) {
                            console.error(e);
                            Swal.fire('Error IA', 'Gemini no pudo procesar el archivo. Revisa tu API Key o el formato.', 'error');
                        }
                    },

                    callAPI: async (part, context) => {
                        const key = App.Logic.Gemini.getKey();
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${key}`;
                        
                        // SYSTEM PROMPTS (PERSONALIDADES)
                        const PROMPTS = {
                            inventory: `Actúa como Experto en Inventario Textil. Tu misión es extraer una lista de productos de la imagen o texto provisto.
                            REGLAS:
                            1. Ignora precios, códigos de barra inútiles o direcciones.
                            2. Normaliza nombres (ej: "P0lera" -> "POLERA").
                            3. Si ves "S, M, L" cerca de números, asocia la cantidad a la talla.
                            4. SALIDA OBLIGATORIA: Un JSON Array estricto.
                            FORMATO: [{"name": "NOMBRE PRODUCTO", "size": "TALLA", "qty": 0}]`,
                            
                            orders: `Actúa como Administrador de Pedidos. Tu misión es extraer los datos de una Orden de Compra.
                            REGLAS:
                            1. Busca el nombre del CLIENTE (Empresa o Persona).
                            2. Busca la FECHA de entrega o emisión.
                            3. Extrae la lista de items.
                            4. SALIDA OBLIGATORIA: Un JSON Object estricto.
                            FORMATO: {"client": "NOMBRE", "deliveryDate": "YYYY-MM-DD", "items": [{"name": "PROD", "size": "TALLA", "qty": 0}]}`
                        };

                        const body = {
                            contents: [{
                                parts: [
                                    { text: PROMPTS[context] }, // Instrucción del Sistema
                                    part // El archivo (Imagen o Texto)
                                ]
                            }],
                            generationConfig: {
                                temperature: 0.1, // Creatividad baja para precisión
                                response_mime_type: "application/json" // Forzar JSON
                            }
                        };

                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });

                        const json = await res.json();
                        if(json.error) throw new Error(json.error.message);
                        
                        const textResponse = json.candidates[0].content.parts[0].text;
                        // Limpiar posible markdown ```json ... ```
                        const cleanJson = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                        return JSON.parse(cleanJson);
                    },

                    utils: {
                        fileToBase64: (file) => new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.readAsDataURL(file);
                            reader.onload = () => resolve(reader.result.split(',')[1]);
                            reader.onerror = error => reject(error);
                        }),
                        excelToCSV: (file) => new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, {type: 'array'});
                                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                                const csv = XLSX.utils.sheet_to_csv(sheet);
                                resolve(csv);
                            };
                            reader.readAsArrayBuffer(file);
                        }),
                        pdfToImage: async (file) => {
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                            const page = await pdf.getPage(1); // Solo página 1 para preview/scan rápido
                            const viewport = page.getViewport({scale: 2.0});
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({canvasContext: ctx, viewport: viewport}).promise;
                            return canvas.toDataURL('image/jpeg').split(',')[1];
                        }
                    }
                },

                // =========================================================================
                // ADUANA DE VALIDACIÓN (LA INTERFAZ QUE CONECTA IA -> HUMANO -> DB)
                // =========================================================================
                Validation: {
                    open: (data, context, imgSrc) => {
                        Swal.close();
                        State.aiBuffer.context = context;
                        State.aiBuffer.imageSrc = imgSrc;
                        State.aiBuffer.data = data; // Raw data from Gemini

                        const modal = document.getElementById('validation-modal');
                        const img = document.getElementById('evidence-img');
                        const overlay = document.getElementById('evidence-text-overlay');
                        const formContainer = document.getElementById('validation-form-container');

                        // Si es Excel, mostrar texto en lugar de imagen
                        if(imgSrc.includes('flaticon')) {
                            img.classList.add('hidden');
                            overlay.classList.remove('hidden');
                            overlay.innerText = "ARCHIVO EXCEL/CSV PROCESADO.\nGemini ha analizado las filas matemáticamente.";
                        } else {
                            img.src = imgSrc;
                            img.classList.remove('hidden');
                            overlay.classList.add('hidden');
                        }

                        modal.classList.remove('hidden');

                        // GENERAR FORMULARIO DINÁMICO
                        let html = '';
                        let items = [];

                        if(context === 'orders') {
                            items = data.items || [];
                            html += `
                            <div class="bg-blue-50 p-4 rounded border border-blue-100 mb-4 animate__animated animate__fadeIn">
                                <h4 class="font-bold text-blue-800 text-xs mb-2 uppercase">Cabecera Detectada</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-[10px] text-slate-500 font-bold">CLIENTE</label><input id="val-client" class="w-full text-sm font-bold border rounded p-1" value="${data.client || ''}"></div>
                                    <div><label class="text-[10px] text-slate-500 font-bold">FECHA</label><input type="date" id="val-date" class="w-full text-sm font-bold border rounded p-1" value="${data.deliveryDate || new Date().toISOString().split('T')[0]}"></div>
                                </div>
                            </div>`;
                        } else {
                            // Inventory: Gemini devuelve array directo
                            items = Array.isArray(data) ? data : (data.items || []);
                        }

                        html += `<div class="space-y-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">`;
                        items.forEach((item, idx) => {
                            html += `
                            <div class="flex items-center gap-2 p-2 rounded border bg-white border-slate-100 item-row hover:bg-slate-50 transition" data-idx="${idx}">
                                <input class="flex-1 text-xs font-bold bg-transparent border-b border-dashed border-slate-300 focus:border-purple-500 focus:outline-none val-name uppercase" value="${item.name || ''}">
                                <input class="w-16 text-xs text-center font-bold bg-white border rounded focus:outline-none val-size uppercase" value="${item.size || 'ÚNICA'}">
                                <input type="number" class="w-16 text-xs text-center font-bold bg-white border rounded focus:outline-none val-qty" value="${item.qty || 0}">
                                <button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
                            </div>`;
                        });
                        html += `</div><button onclick="App.Logic.Validation.addRow()" class="w-full py-2 mt-2 text-xs font-bold text-purple-500 border border-dashed border-purple-200 rounded hover:bg-purple-50 transition">+ Agregar Fila Manual</button>`;

                        formContainer.innerHTML = html;
                    },

                    addRow: () => {
                        const container = document.querySelector('#validation-form-container .space-y-2');
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-2 p-2 rounded border bg-white border-slate-100 item-row animate__animated animate__fadeIn";
                        div.innerHTML = `<input class="flex-1 text-xs font-bold bg-transparent border-b border-dashed border-slate-300 focus:border-purple-500 focus:outline-none val-name uppercase" placeholder="PRODUCTO"><input class="w-16 text-xs text-center font-bold bg-white border rounded focus:outline-none val-size uppercase" placeholder="TALLA"><input type="number" class="w-16 text-xs text-center font-bold bg-white border rounded focus:outline-none val-qty" value="1"><button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-times"></i></button>`;
                        container.appendChild(div);
                    },

                    close: () => { document.getElementById('validation-modal').classList.add('hidden'); },
                    
                    zoom: (delta) => {
                        const img = document.getElementById('evidence-img');
                        const currentScale = parseFloat(img.style.transform.replace('scale(', '').replace(')', '')) || 1;
                        img.style.transform = `scale(${Math.max(0.5, currentScale + delta)})`;
                    },

                    reject: () => {
                        App.Logic.Validation.close();
                        Swal.fire('Escaneo Rechazado', 'No se realizaron cambios en la base de datos.', 'info');
                    },

                    confirm: () => {
                        const context = State.aiBuffer.context;
                        const rows = document.querySelectorAll('.item-row');
                        let items = [];
                        rows.forEach(r => {
                            const n = r.querySelector('.val-name').value.toUpperCase();
                            const s = r.querySelector('.val-size').value.toUpperCase();
                            const q = parseInt(r.querySelector('.val-qty').value) || 0;
                            if(n && q > 0) items.push({name: n, size: s, qty: q});
                        });

                        if(items.length === 0) return Swal.fire('Error', 'No hay items válidos para importar', 'warning');

                        if(context === 'inventory') {
                            items.forEach(it => {
                                let p = State.inventory.find(x => x.name === it.name);
                                if(p) { p.stock[it.size] = (p.stock[it.size]||0) + it.qty; }
                                else { 
                                    // Crear nuevo si no existe
                                    let newStock = {}; newStock[it.size] = it.qty;
                                    State.inventory.push({ sku: 'IA-'+Date.now().toString().slice(-4), name: it.name, stock: newStock });
                                }
                            });
                            set(ref(db, 'inventory'), State.inventory);
                            Swal.fire('Inventario Actualizado', `${items.length} productos procesados.`, 'success');
                        } else {
                            const client = document.getElementById('val-client').value.toUpperCase() || "CLIENTE GENERAL";
                            const date = document.getElementById('val-date').value;
                            const newOrder = {
                                id: Date.now().toString().slice(-6),
                                client: client,
                                date: new Date().toISOString().split('T')[0],
                                deliveryDate: date,
                                items: items,
                                status: 'Pendiente'
                            };
                            State.orders.push(newOrder);
                            set(ref(db, 'orders'), State.orders);
                            Swal.fire('Orden Creada', `OC #${newOrder.id} generada con éxito.`, 'success');
                        }
                        App.Logic.Validation.close();
                    }
                }
            },

            Actions: {
                filter: (context, value) => {
                    State.filters[context] = value;
                    if(context === 'inventory') App.UI.renderInventory();
                    if(context === 'orders') App.UI.renderOrders();
                },

                registerMovement: (data) => {
                    const p = State.inventory.find(x => x.name === data.p);
                    if(data.t === 'Ingreso') p.stock[data.s] += data.q;
                    else {
                        p.stock[data.s] -= data.q;
                        if(p.stock[data.s] < 0) p.stock[data.s] = 0;
                    }
                    State.movements.push({ date: new Date().toLocaleString(), ...data, product: data.p, size: data.s, qty: data.q, reason: data.r });
                    set(ref(db, 'inventory'), State.inventory);
                    set(ref(db, 'movements'), State.movements);
                    Swal.fire('Registrado', 'Kárdex actualizado.', 'success');
                },

                changeStatus: async (index, direction) => {
                    const o = State.orders[index];
                    const currentIdx = ORDER_STATUS_FLOW.indexOf(o.status);
                    const nextIdx = currentIdx + direction;

                    if (direction === -1 && o.status === 'Despachado') {
                        o.status = 'Empaquetado';
                        o.invoice = ''; 
                        o.dispatchDate = '';
                        set(ref(db, 'orders'), State.orders);
                        Swal.fire('Reversado', 'Orden volvió a Empaquetado. Factura borrada.', 'info');
                        return;
                    }

                    if (nextIdx < 0 || nextIdx >= ORDER_STATUS_FLOW.length) return;
                    const nextStatus = ORDER_STATUS_FLOW[nextIdx];

                    if (o.status === 'Empaquetado' && nextStatus === 'Despachado') {
                        const { value: fac } = await Swal.fire({
                            title: 'Despacho Final',
                            text: 'Ingrese N° Factura / Guía:',
                            input: 'text',
                            showCancelButton: true,
                            inputValidator: (v) => !v && 'Requerido'
                        });

                        if (fac) {
                            o.items.forEach(it => {
                                const p = State.inventory.find(x => x.name === it.name);
                                if(p && p.stock && p.stock[it.size] !== undefined) {
                                    p.stock[it.size] = Math.max(0, p.stock[it.size] - it.qty);
                                }
                            });
                            o.status = 'Despachado';
                            o.invoice = fac;
                            o.dispatchDate = new Date().toISOString().split('T')[0];
                            set(ref(db, 'inventory'), State.inventory);
                            set(ref(db, 'orders'), State.orders);
                            Swal.fire('Despachado', 'Stock descontado.', 'success');
                        }
                    } else {
                        o.status = nextStatus;
                        set(ref(db, 'orders'), State.orders);
                    }
                },

                editInvoice: async (idx) => {
                    const o = State.orders[idx];
                    const { value: newFac } = await Swal.fire({
                        title: 'Corregir Factura',
                        input: 'text',
                        inputValue: o.invoice,
                        text: 'Edite el número sin cambiar el estado de la orden.'
                    });
                    if (newFac && newFac !== o.invoice) {
                        o.invoice = newFac;
                        set(ref(db, 'orders'), State.orders);
                        Swal.fire('Actualizado', 'Número de factura corregido.', 'success');
                    }
                },

                deleteProduct: (i) => { 
                    Swal.fire({ title: '¿Eliminar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((r) => { if (r.isConfirmed) { State.inventory.splice(i,1); set(ref(db,'inventory'),State.inventory); } });
                },
                deleteOrder: (i) => { 
                    Swal.fire({ title: '¿Eliminar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((r) => { if (r.isConfirmed) { State.orders.splice(i,1); set(ref(db,'orders'),State.orders); } });
                }
            },

            PDF: {
                generateManagementReport: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const now = new Date();

                    doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.text("IDEAS TEXTILES SPA", 15, 20);
                    doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("REPORTE DE GESTIÓN ", 15, 26); doc.text(`Emitido: ${now.toLocaleString()}`, 15, 31);
                    doc.line(15, 35, 195, 35);

                    let totalItems = 0; State.inventory.forEach(p => { if(p.stock) totalItems += Object.values(p.stock).reduce((a,b)=>a+b,0); });
                    const pendingOrders = State.orders.filter(o => o.status !== 'Despachado');
                    
                    const startY = 45;
                    doc.rect(15, startY, 40, 25); doc.setFontSize(8); doc.text("STOCK TOTAL", 35, startY+6, {align:'center'}); doc.setFontSize(14); doc.text(String(totalItems), 35, startY+16, {align:'center'});
                    doc.rect(60, startY, 40, 25); doc.setFontSize(8); doc.text("EN PROCESO", 80, startY+6, {align:'center'}); doc.setFontSize(14); doc.text(String(pendingOrders.length), 80, startY+16, {align:'center'});
                    
                    doc.setFontSize(11); doc.text("ESTADO DE BODEGA", 15, startY+35);
                    const invRows = State.inventory.map(p => [p.sku, p.name, p.stock ? Object.entries(p.stock).map(([k,v])=>`${k}:${v}`).join(', ') : '0']);
                    doc.autoTable({ startY: startY+40, head: [['SKU', 'Producto', 'Detalle']], body: invRows, theme: 'plain', headStyles: { fillColor: [220, 220, 220], fontStyle: 'bold' } });

                    let finalY = doc.lastAutoTable.finalY + 15;

                    doc.text("DETALLE DE ÓRDENES EN CURSO (PRIORIDAD)", 15, finalY);
                    
                    const sortedOrders = pendingOrders.sort((a,b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));
                    const orderRows = sortedOrders.map(o => {
                        const vol = o.items.reduce((acc, it) => acc + it.qty, 0);
                        return [o.deliveryDate, o.client, `OC-${o.id}`, o.status, `${vol} Un.`];
                    });

                    doc.autoTable({
                        startY: finalY + 5,
                        head: [['Fecha Entrega', 'Cliente', 'Referencia', 'Estado', 'Volumen']],
                        body: orderRows,
                        theme: 'grid',
                        headStyles: { fillColor: [50, 50, 50], textColor: 255 },
                        styles: { fontSize: 8 }
                    });

                    finalY = doc.lastAutoTable.finalY + 15;

                    doc.text("BITÁCORA DE MOVIMIENTOS", 15, finalY);
                    const movRows = State.movements.slice(-10).reverse().map(m => [m.date, m.type, m.product, m.qty, m.reason]);
                    doc.autoTable({ startY: finalY + 5, head: [['Fecha', 'Tipo', 'Producto', 'Cant', 'Motivo']], body: movRows, theme: 'plain', styles: { fontSize: 7 } });

                    doc.save(`Reporte_${now.toISOString().slice(0,10)}.pdf`);
                },

                downloadTachas: (idx) => {
                    const o = State.orders[idx];
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ unit: 'mm', format: [216, 356] }); // Oficio
                    const cols = 1; 
                    const rows = 2; 
                    const margin = 10;
                    const w = 196; 
                    const h = 160;
                    
                    let x = margin; let y = margin; let count = 0;

                    const groupedItems = {};
                    o.items.forEach(it => {
                        if(!groupedItems[it.name]) groupedItems[it.name] = { name: it.name, sizes: {}, total: 0 };
                        groupedItems[it.name].sizes[it.size] = (groupedItems[it.name].sizes[it.size] || 0) + it.qty;
                        groupedItems[it.name].total += it.qty;
                    });

                    Object.values(groupedItems).forEach((prod, i) => {
                        doc.setDrawColor(0); doc.setLineWidth(0.5); doc.rect(x, y, w, h);
                        
                        doc.setFont("helvetica", "bold"); doc.setFontSize(20); doc.text("IDEAS TEXTILES SPA", x + w/2, y + 15, { align: "center" });
                        doc.setFontSize(12); doc.text(`CLIENTE: ${o.client}`, x + 10, y + 30);
                        doc.text(`OC: ${o.id}`, x + 10, y + 38);
                        doc.text(`DESTINO/FAC: ${o.invoice || 'PENDIENTE'}`, x + 100, y + 38);

                        doc.setFontSize(24); doc.text(prod.name, x + w/2, y + 60, { align: "center" });

                        let matrixY = y + 80;
                        doc.setFontSize(14);
                        doc.text("DETALLE DE CONTENIDO:", x + 10, matrixY);
                        matrixY += 10;

                        let cellX = x + 10;
                        Object.entries(prod.sizes).forEach(([size, qty]) => {
                            doc.rect(cellX, matrixY, 30, 20);
                            doc.setFontSize(10); doc.text(size, cellX + 15, matrixY + 8, {align:'center'});
                            doc.setFontSize(14); doc.text(String(qty), cellX + 15, matrixY + 16, {align:'center'});
                            cellX += 35;
                            if(cellX > x + w - 30) { cellX = x + 10; matrixY += 25; }
                        });

                        doc.setFontSize(30); 
                        doc.text(`TOTAL: ${prod.total} UN.`, x + w/2, y + h - 20, { align: "center" });

                        count++;
                        if (count % rows === 0 && i < Object.keys(groupedItems).length - 1) { doc.addPage(); y = margin; } 
                        else { y += h + margin; }
                    });

                    doc.save(`TACHA_OCNRO${o.id}.pdf`);
                }
            }
        };

        App.init();
    </script>
</body>
</html>
