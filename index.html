<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IDEAS TEXTILES - WORKWEAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Playfair+Display:ital,wght@1,500&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --corp-dark: #0f172a; --corp-black: #020617; --gold: #d97706; --gold-light: #fbbf24;
            --bg: #f8fafc; --card-bg: #ffffff;
            --danger: #ef4444; --success: #10b981; --prod: #6366f1;
            --font-main: 'Outfit', sans-serif;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea, select { user-select: text; font-family: var(--font-main); }
        body { font-family: var(--font-main); background: var(--bg); color: var(--corp-dark); margin: 0; padding: 0; padding-bottom: 100px; padding-top: env(safe-area-inset-top); height: 100vh; overflow-y: scroll; overscroll-behavior-y: none; }

        /* HEADER */
        header { 
            background: linear-gradient(135deg, var(--corp-black) 0%, var(--corp-dark) 100%); 
            color: white; padding: 25px 20px 35px 20px; position: sticky; top: 0; z-index: 100; 
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; 
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.25); border-bottom: 2px solid var(--gold);
        }
        .corp-brand { text-align: center; position: relative; }
        .corp-title { 
            font-size: 1.8rem; font-weight: 900; letter-spacing: -1px; margin: 0; 
            text-transform: uppercase; color: white; display: flex; align-items: center; justify-content: center; gap: 12px;
        }
        .corp-title i { color: var(--gold); font-size: 1.5rem; transform: rotate(-90deg); }
        .corp-subtitle { 
            font-family: 'Outfit', sans-serif; font-weight: 300; font-size: 0.75rem; 
            color: #cbd5e1; margin-top: 5px; letter-spacing: 3px; text-transform: uppercase;
        }
        .import-btn { position: absolute; right: 0; top: 5px; background: rgba(255,255,255,0.1); width: 35px; height: 35px; border-radius: 50%; color: var(--gold); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* VISTAS Y CARDS */
        .view { display: none; padding: 20px; max-width: 650px; margin: 0 auto; animation: fadeUp 0.35s ease-out; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        .card { 
            background: var(--card-bg); border-radius: 16px; padding: 18px; margin-bottom: 15px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid white; position: relative; 
        }
        .sku-badge { font-family: 'JetBrains Mono', monospace; background: var(--corp-black); color: var(--gold); padding: 3px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; }

        /* BOTONES */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 800; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; transition: transform 0.1s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn:active { transform: scale(0.97); }
        .btn-pri { background: var(--corp-dark); color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        .btn-sec { background: white; border: 2px solid #e2e8f0; color: var(--corp-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-prod { background: var(--prod); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;}

        .search-bar { 
            width:100%; padding:15px; border-radius:12px; border:none; margin-bottom:20px; 
            background: white; font-size: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.03); color: var(--corp-dark);
        }

        /* CHIPS & LISTAS */
        .chip-container { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
        .chip { 
            background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; 
            cursor: pointer; border: 1px solid #e2e8f0; transition: 0.2s; color: #64748b;
        }
        .chip.selected { background: var(--corp-dark); color: white; border-color: var(--corp-dark); }
        
        .mini-list-container { background: #f8fafc; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; max-height: 150px; overflow-y: auto; margin-top: 10px; }
        .mini-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }

        /* UI TABS */
        .toggle-fabrica { display: flex; background: #e2e8f0; border-radius: 12px; padding: 4px; margin-bottom: 20px; }
        .toggle-fabrica button { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 10px; font-weight: 700; color: #64748b; font-size: 0.85rem; transition: 0.3s; }
        .toggle-fabrica button.active { background: white; color: var(--corp-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .toggle-fabrica button.active-prod { background: var(--prod); color: white; }

        /* UI EXTRAS */
        .dock { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: 15px 40px; border-radius: 50px; display: flex; gap: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 999; border: 1px solid rgba(255,255,255,0.1); }
        .dock i { font-size: 1.4rem; color: #94a3b8; transition: 0.3s; cursor: pointer; }
        .dock i.active { color: var(--gold); transform: translateY(-5px); }

        .ist-pill { font-size: 0.6rem; padding: 3px 6px; border-radius: 4px; font-weight: 800; margin-left: 5px; text-transform: uppercase; }
        .ist-ok { background: #dcfce7; color: #15803d; }
        .ist-no { background: #fee2e2; color: #b91c1c; }
        .ist-pend { background: #fef9c3; color: #a16207; }

        footer { text-align: center; color: #cbd5e1; font-size: 0.7rem; padding: 20px; margin-top: 40px; font-weight: 300; letter-spacing: 1px; }

        /* Loader */
        #loader { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:2000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #cbd5e1; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p style="margin-top:20px; font-weight:700; color:#64748b; font-size:0.8rem;">TITANIUM V2.0</p></div>

<header>
    <div class="corp-brand">
        <h1 class="corp-title"><i class="fa-solid fa-scissors"></i> IDEAS TEXTILES</h1>
        <div class="corp-subtitle">WORKWEAR AND CORPORATE</div>
        <div class="import-btn" onclick="App.IA.trigger()"><i class="fa-solid fa-cloud-arrow-up"></i></div>
    </div>
</header>

<section id="v-bodega" class="view active">
    <div class="toggle-fabrica">
        <button id="tab-stock" class="active" onclick="App.UI.toggleFabrica('stock')">BODEGA</button>
        <button id="tab-fabrica" onclick="App.UI.toggleFabrica('fabrica')">F√ÅBRICA <span id="fab-badge" style="background:rgba(0,0,0,0.2);padding:1px 6px;border-radius:10px;font-size:0.8em;">0</span></button>
    </div>

    <div id="sub-stock">
        <input type="text" id="search-inv" class="search-bar" placeholder="üîç Buscar c√≥digo, nombre..." oninput="App.Render.bodega()">
        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 12px;">
            <button class="btn btn-pri" style="margin:0;" onclick="App.Actions.modalProd()"><i class="fa-solid fa-shirt"></i> NUEVO</button>
            <button class="btn btn-sec" style="margin:0; border-color:var(--gold); color:var(--gold);" onclick="App.Actions.tachaManual()"><i class="fa-solid fa-scissors"></i> SALIDA</button>
        </div>
        <div id="list-bodega" style="margin-top:20px;"></div>
    </div>

    <div id="sub-fabrica" style="display:none;">
        <div style="text-align:center; padding:15px; margin-bottom:15px; color:#64748b; font-size:0.85rem; font-style:italic;">
            <i class="fa-solid fa-industry"></i> Control de Procesos y Externos
        </div>
        <div id="list-fabrica"></div>
    </div>
</section>

<section id="v-ordenes" class="view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; font-size:1.4rem; font-weight:900;">PEDIDOS</h2>
        <button class="btn btn-pri" style="width:auto; padding:10px 15px; margin:0;" onclick="App.Actions.modalOrder()"><i class="fa-solid fa-plus"></i> CREAR OC</button>
    </div>
    
    <div id="bulk-tools" style="display:none; background:var(--corp-dark); color:white; padding:10px 15px; border-radius:10px; margin-bottom:15px; align-items:center; justify-content:space-between;">
        <span style="font-weight:700; font-size:0.85rem;"><i class="fa-solid fa-check"></i> <span id="sel-count">0</span> Marcados</span>
        <button onclick="App.Actions.printBulk()" style="background:white; color:var(--corp-dark); border:none; padding:6px 12px; border-radius:6px; font-weight:800; font-size:0.75rem;">IMPRIMIR</button>
    </div>
    <div id="list-ordenes"></div>
</section>

<section id="v-agenda" class="view">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button onclick="App.Calendar.move(-1)" style="border:none; background:none; font-size:1.2rem;"><i class="fa-solid fa-chevron-left"></i></button>
            <span id="cal-title" style="font-weight:900; font-size:1.1rem;">MES A√ëO</span>
            <button onclick="App.Calendar.move(1)" style="border:none; background:none; font-size:1.2rem;"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
        <div id="cal-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px; text-align:center;"></div>
    </div>

    <div class="card" style="text-align:center; background:#f8fafc; border:1px dashed #cbd5e1;">
        <h3 style="margin-top:0; font-size:1rem;">ZONA DE DATOS</h3>
        <button class="btn btn-pri" onclick="App.Backup.generatePDF()">DESCARGAR RESPALDO</button>
        <button id="btn-reset" class="btn" style="background:#e2e8f0; color:#94a3b8; margin-top:10px;" onclick="App.Actions.factoryReset()">RESET FABRICA</button>
    </div>
</section>

<footer>
    &copy; 2026 IDEAS TEXTILES SPA<br>Derechos Reservados
</footer>

<nav class="dock">
    <i class="fa-solid fa-box active" onclick="App.UI.go('bodega', this)"></i>
    <i class="fa-solid fa-clipboard-check" onclick="App.UI.go('ordenes', this)"></i>
    <i class="fa-regular fa-calendar-days" onclick="App.UI.go('agenda', this)"></i>
</nav>

<input type="file" id="ai-input" hidden accept=".xlsx,.xls">

<script>
    const firebaseConfig = { apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew", authDomain: "ideastextilesapp.firebaseapp.com", databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com", projectId: "ideastextilesapp", storageBucket: "ideastextilesapp.firebasestorage.app", messagingSenderId: "268995530035", appId: "1:268995530035:web:1890f45ac761cc81eb0246" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const App = {
        data: { inv: [], ord: [], fab: [], log: {} },
        state: { backupDone: false, calDate: new Date() },

        init() {
            db.ref('/').on('value', (s) => {
                const v = s.val() || {};
                App.data.inv = Object.values(v.inv || []).filter(x=>x);
                App.data.ord = Object.values(v.ord || []).filter(x=>x);
                App.data.fab = Object.values(v.fab || []).filter(x=>x);
                App.data.log = v.log || {};
                
                // Limpieza datos
                App.data.inv.forEach(p => { if(!p.s)p.s={}; if(!p.n)p.n="?"; if(!p.sku)p.sku="000"; });
                
                document.getElementById('fab-badge').innerText = App.data.fab.length;
                App.Render.bodega(); App.Render.ordenes(); App.Render.fabrica(); App.Calendar.render();
                
                const l = document.getElementById('loader'); if(l){ l.style.opacity='0'; setTimeout(()=>l.style.display='none',500); }
            });
        },

        save() { db.ref('/').update({ inv: App.data.inv, ord: App.data.ord, fab: App.data.fab, log: App.data.log }); },

        UI: {
            go(id, el) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.dock i').forEach(i => i.classList.remove('active'));
                document.getElementById('v-'+id).classList.add('active');
                el.classList.add('active');
            },
            toggleFabrica(m) {
                document.getElementById('sub-stock').style.display = m==='stock'?'block':'none';
                document.getElementById('sub-fabrica').style.display = m==='fabrica'?'block':'none';
                document.getElementById('tab-stock').className = m==='stock'?'active':'';
                document.getElementById('tab-fabrica').className = m==='fabrica'?'active active-prod':'';
            },
            updateBulk() {
                const c = document.querySelectorAll('.chk-bulk:checked').length;
                const b = document.getElementById('bulk-tools');
                if(b) { b.style.display = c > 0 ? 'flex' : 'none'; document.getElementById('sel-count').innerText = c; }
            }
        },

        Helpers: {
            getNextSKU: () => String(App.data.inv.reduce((m,p)=>Math.max(m,parseInt(p.sku)||0),0)+1).padStart(3,'0'),
            addToLog(msg) {
                const d = new Date(); const k = `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`;
                App.data.log[k] = (App.data.log[k]||'') + `‚Ä¢ ${msg} [${d.getHours()}:${d.getMinutes()}]\n`;
                App.save(); App.Calendar.render();
            },
            createPDF(type, docs) {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ format: 'legal', unit: 'mm' });
                const quadrants = [[10,10], [110,10], [10,150], [110,150]];

                docs.forEach((d, i) => {
                    if (i > 0 && i % 4 === 0) pdf.addPage();
                    const [x, y] = quadrants[i % 4];
                    
                    pdf.setDrawColor(200); pdf.rect(x-5, y-5, 95, 135);
                    pdf.setFont("helvetica", "bold"); pdf.setFontSize(10); pdf.text("IDEAS TEXTILES", x, y+5);
                    pdf.setFontSize(8); pdf.text(type==='prod'?'HOJA DE RUTA / PROCESO':'ORDEN DE SALIDA', x, y+10);
                    
                    pdf.setFontSize(7); pdf.setFont("helvetica", "normal");
                    pdf.text(`FECHA: ${new Date().toLocaleDateString()}`, x, y+16);
                    pdf.text(`DESTINO: ${(d.dest||d.c||'INTERNO').substring(0,25)}`, x, y+20);
                    if(d.trans) pdf.text(`RESP: ${d.trans.substring(0,25)}`, x, y+24);

                    let cy = y+30;
                    pdf.setFillColor(240); pdf.rect(x, cy, 85, 5, 'F');
                    pdf.text("CANT  ITEM / DETALLE", x+2, cy+3.5);
                    
                    (d.items||[]).forEach(it => {
                        cy+=5; if(cy>y+100) return;
                        pdf.text(`${it.q}`, x+2, cy+3);
                        pdf.text(`${it.p} (${it.sz})`.substring(0,30), x+12, cy+3);
                    });
                    
                    cy+=8; pdf.setFont("helvetica","bold");
                    pdf.text(`OBS: ${(d.obs||'').substring(0,80)}`, x, cy+10);
                });
                pdf.save(`DOC_${Date.now()}.pdf`);
            }
        },

        Render: {
            bodega() {
                const q = (document.getElementById('search-inv').value||'').toUpperCase();
                const list = App.data.inv.filter(i => (i.n||'').toUpperCase().includes(q) || (i.sku||'').includes(q));
                document.getElementById('list-bodega').innerHTML = list.length ? list.map((p, idx) => {
                    const realIdx = App.data.inv.indexOf(p);
                    const stockHtml = Object.keys(p.s||{}).map(k => 
                        `<div style="font-size:0.75rem;background:#f1f5f9;padding:2px 6px;border-radius:4px;margin:2px;display:inline-block;"><b>${k}:</b>${p.s[k]}</div>`
                    ).join('');
                    return `<div class="card">
                        <div style="display:flex;justify-content:space-between;">
                            <span class="sku-badge">SKU: ${p.sku}</span>
                            <div><i class="fa-solid fa-pen" onclick="App.Actions.modalProd(${realIdx})" style="color:#94a3b8;margin-right:10px;"></i><i class="fa-solid fa-trash" onclick="App.Actions.delProd(${realIdx})" style="color:#cbd5e1;"></i></div>
                        </div>
                        <h3 style="margin:5px 0;font-size:1rem;">${p.n}</h3>
                        <div style="margin-bottom:10px;">${stockHtml||'<small style="color:#cbd5e1">Sin stock</small>'}</div>
                        <button class="btn-prod" style="width:100%;border:none;padding:8px;border-radius:8px;font-weight:700;color:white;font-size:0.8rem;" onclick="App.Actions.startProduction(${realIdx})"><i class="fa-solid fa-gears"></i> PRODUCIR LOTE</button>
                    </div>`;
                }).join('') : '<div style="text-align:center;color:#cbd5e1;">Sin resultados</div>';
            },

            fabrica() {
                const el = document.getElementById('list-fabrica');
                if(!App.data.fab.length) { el.innerHTML='<div style="text-align:center;color:#cbd5e1;padding:20px;">Sin producci√≥n activa.</div>'; return; }
                el.innerHTML = App.data.fab.map((f, i) => {
                    const steps = f.steps || ['Pendiente'];
                    const pct = Math.round(((f.stepIndex+1)/steps.length)*100);
                    // Items breakdown
                    const itemsTxt = f.items.map(x=>`${x.q} ${x.sz}`).join(', ');
                    
                    return `<div class="card" style="border-left:5px solid ${f.type==='EXT'?'var(--gold)':'var(--prod)'};">
                        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                            <span style="font-size:0.65rem;font-weight:700;background:#f1f5f9;padding:2px 6px;border-radius:4px;">${f.type==='EXT'?'EXTERNO / SALIDA':'INTERNO / TALLER'}</span>
                            <i class="fa-solid fa-pen" style="font-size:0.8rem;color:#94a3b8;cursor:pointer;" onclick="App.Actions.editFab(${i})"></i>
                        </div>
                        <h3 style="margin:0;font-size:1rem;">${f.n}</h3>
                        <div style="font-size:0.8rem;color:#64748b;margin-bottom:5px;">${itemsTxt}</div>
                        <div style="font-size:0.75rem;color:#475569;"><b>Taller:</b> ${f.trans||'N/A'}</div>
                        
                        <div style="margin:8px 0;height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden;">
                            <div style="height:100%;width:${pct}%;background:${f.type==='EXT'?'var(--gold)':'var(--prod)'};transition:width 0.5s;"></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:0.7rem;font-weight:800;color:#64748b;">
                            <span>${steps[f.stepIndex]}</span><span>${pct}%</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sec" style="padding:8px;font-size:0.7rem;" onclick="App.Helpers.createPDF('prod', [{dest:f.trans||'TALLER', obs:steps.join('>'), items:f.items.map(x=>({...x, p:f.n}))}])">üìÑ HOJA RUTA</button>
                            <button class="btn btn-prod" style="padding:8px;font-size:0.7rem;background:${f.type==='EXT'?'var(--gold)':'var(--prod)'};" onclick="App.Actions.advanceFab(${i})">AVANZAR ‚û°</button>
                        </div>
                    </div>`;
                }).join('');
            },

            ordenes() {
                const el = document.getElementById('list-ordenes');
                if(!App.data.ord.length) { el.innerHTML='<div style="text-align:center;color:#cbd5e1;padding:20px;">Sin pedidos.</div>'; return; }
                el.innerHTML = App.data.ord.slice().reverse().map((o, idx) => {
                    const realIdx = App.data.ord.length - 1 - idx;
                    const items = o.items.map(x => `<div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:2px;"><span>${x.p} (${x.sz})</span><span>x${x.q} ${x.st!=='OK'?`<span class="ist-pill ${x.st==='NO'?'ist-no':'ist-pend'}">${x.st}</span>`:''}</span></div>`).join('');
                    return `<div class="card" style="display:flex;gap:10px;">
                        <input type="checkbox" class="chk-bulk" value="${realIdx}" onchange="App.UI.updateBulk()">
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h3 style="margin:0;font-size:1.1rem;">${o.c}</h3>
                                ${o.st!=='done'?`<i class="fa-solid fa-pen" style="background:#f1f5f9;padding:6px;border-radius:50%;font-size:0.8rem;cursor:pointer;" onclick="App.Actions.modalOrder(${realIdx})"></i>`:''}
                            </div>
                            <small style="color:#94a3b8;">${o.fac||'En proceso'}</small>
                            <div style="background:#f8fafc;padding:8px;border-radius:8px;margin:8px 0;">${items}</div>
                            <div class="btn-group">
                                <button class="btn btn-sec" style="padding:8px;font-size:0.7rem;" onclick="App.Actions.tachaFromOrder(${realIdx})">IMPRIMIR</button>
                                ${o.st!=='done'?`<button class="btn btn-pri" style="padding:8px;font-size:0.7rem;" onclick="App.Actions.changeStatus(${realIdx})">ESTADO</button>`:''}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
        },

        Actions: {
            // --- NUEVO SISTEMA DE PRODUCCI√ìN MULTI-TALLA ---
            async startProduction(i) {
                const p = App.data.inv[i];
                let prodCart = [];
                let selectedChips = ['CORTE', 'CONFECCION', 'TERMINACION'];

                window.addPC = () => {
                    const sz = (document.getElementById('ps-sz').value||'UNICA').toUpperCase();
                    const q = parseInt(document.getElementById('ps-q').value);
                    if(q>0) { prodCart.push({sz,q}); renderPC(); document.getElementById('ps-sz').value=''; document.getElementById('ps-sz').focus(); }
                };
                window.renderPC = () => document.getElementById('pc-list').innerHTML = prodCart.map((x,k)=>`<div class="mini-row"><span>Talla <b>${x.sz}</b>: ${x.q} un.</span><i class="fa-solid fa-xmark" style="color:var(--danger);cursor:pointer;" onclick="prodCart.splice(${k},1);renderPC()"></i></div>`).join('');
                window.toggleChip = (el) => { el.classList.toggle('selected'); const t=el.innerText; if(selectedChips.includes(t))selectedChips=selectedChips.filter(x=>x!==t); else selectedChips.push(t); };

                const {value} = await Swal.fire({
                    title: p.n,
                    width: 600,
                    html: `
                        <div style="text-align:left;">
                            <label style="font-size:0.75rem;font-weight:700;">TALLER / RESPONSABLE</label>
                            <input id="ps-tr" class="swal2-input" placeholder="Ej: Taller Juanito" style="margin-top:5px;">
                            
                            <label style="font-size:0.75rem;font-weight:700;">CARGA DE TALLAS</label>
                            <div style="display:flex;gap:5px;margin-top:5px;">
                                <input id="ps-sz" class="swal2-input" placeholder="Talla" style="margin:0;">
                                <input id="ps-q" type="number" class="swal2-input" placeholder="Cant" style="margin:0;width:80px;">
                                <button onclick="addPC()" class="btn btn-pri" style="margin:0;width:auto;">+</button>
                            </div>
                            <div id="pc-list" class="mini-list-container"></div>

                            <label style="font-size:0.75rem;font-weight:700;margin-top:15px;display:block;">RUTA DE PROCESO</label>
                            <div class="chip-container">
                                <div class="chip selected" onclick="toggleChip(this)">CORTE</div>
                                <div class="chip" onclick="toggleChip(this)">BORDADO</div>
                                <div class="chip" onclick="toggleChip(this)">ESTAMPADO</div>
                                <div class="chip selected" onclick="toggleChip(this)">CONFECCION</div>
                                <div class="chip selected" onclick="toggleChip(this)">TERMINACION</div>
                                <div class="chip" onclick="toggleChip(this)">EMPAQUE</div>
                            </div>
                        </div>
                    `,
                    preConfirm: () => {
                        const tr = document.getElementById('ps-tr').value;
                        if(!prodCart.length) return Swal.showValidationMessage('Agrega al menos una talla');
                        return { trans: tr, items: prodCart, steps: selectedChips };
                    }
                });

                if(value) {
                    App.data.fab.push({
                        n: p.n, sku: p.sku, type: 'INT',
                        trans: value.trans || 'Interno',
                        items: value.items, // Guardamos el array de tallas
                        q: value.items.reduce((a,b)=>a+b.q,0), // Total para visualizaci√≥n r√°pida
                        steps: value.steps, stepIndex: 0
                    });
                    App.save(); App.UI.toggleFabrica('fabrica'); App.Render.fabrica();
                    Swal.fire({icon:'success', title:'Enviado a Planta', timer:1500, showConfirmButton:false});
                }
            },

            // EDICI√ìN DE F√ÅBRICA
            async editFab(i) {
                const f = App.data.fab[i];
                const {value} = await Swal.fire({
                    title: 'EDITAR PROCESO',
                    html: `<input id="ef-tr" class="swal2-input" value="${f.trans||''}" placeholder="Responsable"><textarea id="ef-st" class="swal2-textarea" placeholder="Pasos separados por coma">${f.steps.join(',')}</textarea>`,
                    preConfirm: () => ({ trans: document.getElementById('ef-tr').value, steps: document.getElementById('ef-st').value.split(',').map(s=>s.trim()).filter(s=>s) })
                });
                if(value) { App.data.fab[i].trans=value.trans; App.data.fab[i].steps=value.steps; App.save(); App.Render.fabrica(); }
            },

            // SALIDA MANUAL CON RETORNO
            async tachaManual() {
                let cart = [];
                window.mixAdd = () => {
                    const p = document.getElementById('m-p').value.toUpperCase();
                    const sz = (document.getElementById('m-sz').value||'UNICA').toUpperCase();
                    const q = parseInt(document.getElementById('m-q').value);
                    if(p && q>0) { cart.push({p,sz,q}); mixRender(); document.getElementById('m-p').value=''; }
                };
                window.mixRender = () => document.getElementById('m-list').innerHTML = cart.map((x,i)=>`<div class="mini-row"><span>${x.q} ${x.p} (${x.sz})</span><i class="fa-solid fa-xmark" style="color:red;cursor:pointer;" onclick="cart.splice(${i},1);mixRender()"></i></div>`).join('');
                
                const opts = App.data.inv.map(x=>`<option value="${x.n}">`).join('');
                const {value} = await Swal.fire({
                    title: 'SALIDA / TACHA',
                    html: `
                        <input id="m-dst" class="swal2-input" placeholder="Destino (Ej: Bordadur√≠a)">
                        <input id="m-tr" class="swal2-input" placeholder="Responsable">
                        <div style="background:#f8fafc;padding:10px;border-radius:10px;border:1px dashed #cbd5e1;margin:10px 0;">
                            <input id="m-p" list="dl-m" class="swal2-input" placeholder="Producto" style="margin-top:0;">
                            <datalist id="dl-m">${opts}</datalist>
                            <div style="display:flex;gap:5px;">
                                <input id="m-sz" class="swal2-input" placeholder="Talla">
                                <input id="m-q" type="number" class="swal2-input" placeholder="Cant">
                                <button onclick="mixAdd()" class="btn btn-pri" style="margin:0;width:auto;">+</button>
                            </div>
                        </div>
                        <div id="m-list" class="mini-list-container"></div>
                        <div style="margin-top:15px;display:flex;flex-direction:column;gap:10px;text-align:left;padding-left:10px;">
                             <div><input type="checkbox" id="m-trk"> <label for="m-trk" style="font-weight:bold;color:var(--gold);">Seguimiento en F√°brica (Retorno)</label></div>
                             <div><input type="checkbox" id="m-ded" checked> <label for="m-ded">Descontar Stock ahora</label></div>
                        </div>
                    `,
                    preConfirm: () => {
                        const dest = document.getElementById('m-dst').value;
                        if(!dest || !cart.length) return Swal.showValidationMessage('Faltan datos');
                        return { dest, trans:document.getElementById('m-tr').value, trk:document.getElementById('m-trk').checked, ded:document.getElementById('m-ded').checked, items:cart };
                    }
                });

                if(value) {
                    // 1. Descuento
                    if(value.ded) {
                        value.items.forEach(it => { const p=App.data.inv.find(x=>x.n===it.p); if(p) p.s[it.sz]=(p.s[it.sz]||0)-it.q; });
                    }
                    // 2. Si es tracking, crear entrada en f√°brica tipo 'EXT'
                    if(value.trk) {
                        value.items.forEach(it => {
                            App.data.fab.push({
                                n: it.p, sku: 'EXT', type: 'EXT', trans: value.dest,
                                items: [{sz:it.sz, q:it.q}], q:it.q,
                                steps: ['EN PROCESO EXTERNO', 'REINGRESO BODEGA'], stepIndex: 0
                            });
                        });
                        App.Helpers.addToLog(`Salida externa con retorno: ${value.dest}`);
                    }
                    App.save(); App.Render.bodega(); App.Render.fabrica();
                    App.Helpers.createPDF('taller', [{dest:value.dest, trans:value.trans, obs:'SALIDA MANUAL', items:value.items}]);
                }
            },

            async advanceFab(i) {
                const f = App.data.fab[i];
                if(f.stepIndex < f.steps.length-1) { f.stepIndex++; App.save(); App.Render.fabrica(); }
                else {
                    const confirm = await Swal.fire({title:'¬øFinalizar Proceso?', text:'Los productos se sumar√°n al stock de bodega.', icon:'question', showCancelButton:true, confirmButtonText:'S√≠, Reingresar'});
                    if(confirm.isConfirmed) {
                        // Reingreso inteligente loop items
                        f.items.forEach(it => {
                            let p = App.data.inv.find(x => x.n === f.n); // Busca por nombre
                            if(p) p.s[it.sz] = (p.s[it.sz]||0) + it.q;
                        });
                        App.data.fab.splice(i,1); App.save(); App.Render.bodega(); App.UI.toggleFabrica('stock');
                        App.Helpers.addToLog(`Producci√≥n finalizada: ${f.n}`);
                    }
                }
            },

            // ORDENES DE COMPRA - DELETE SEGURO
            async modalOrder(idx = null) {
                const isEdit = idx !== null;
                let cart = isEdit ? JSON.parse(JSON.stringify(App.data.ord[idx].items)) : [];
                
                window.addC = () => {
                    const p = document.getElementById('o-p').value.toUpperCase();
                    const q = parseInt(document.getElementById('o-q').value);
                    const sz = (document.getElementById('o-sz').value||'UNICA').toUpperCase();
                    const st = document.getElementById('o-st').value;
                    if(p && q>0) { cart.push({p,q,sz,st}); renderC(); document.getElementById('o-p').value=''; }
                };

                // L√≥gica de borrado seguro dentro de la modal
                window.removeC = async (i) => {
                    if(isEdit) {
                        const {value:reason} = await Swal.fire({title:'¬øEliminar Item?', text:'Esta acci√≥n quedar√° registrada. Indica el motivo:', input:'text', inputPlaceholder:'Ej: Cliente cancel√≥', showCancelButton:true});
                        if(reason) {
                            App.Helpers.addToLog(`Item eliminado de OC ${App.data.ord[idx].c}: ${cart[i].p} (Motivo: ${reason})`);
                            cart.splice(i,1); renderC();
                        }
                    } else {
                        cart.splice(i,1); renderC();
                    }
                };

                window.renderC = () => {
                    document.getElementById('o-list').innerHTML = cart.map((x,i)=>
                        `<div class="mini-row">
                            <span><b>${x.p}</b> (${x.sz}) x${x.q}</span>
                            <span onclick="removeC(${i})" style="color:var(--danger);font-weight:bold;cursor:pointer;font-size:0.7rem;">QUITAR</span>
                        </div>`
                    ).join('');
                };

                const opts = App.data.inv.map(x=>`<option value="${x.n}">`).join('');
                setTimeout(() => { if(isEdit) renderC(); }, 100);

                const {value} = await Swal.fire({
                    title: isEdit ? 'EDITAR OC' : 'NUEVA OC',
                    width: 600,
                    html: `
                        <input id="o-c" class="swal2-input" placeholder="Cliente" value="${isEdit?App.data.ord[idx].c:''}">
                        <div style="background:#f8fafc;padding:10px;border:1px solid #e2e8f0;border-radius:10px;margin:10px 0;">
                            <input id="o-p" list="dl-o" class="swal2-input" placeholder="Producto" style="margin-top:0;">
                            <datalist id="dl-o">${opts}</datalist>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;">
                                <input id="o-sz" class="swal2-input" placeholder="Talla" style="margin:0;">
                                <input id="o-q" type="number" class="swal2-input" value="1" style="margin:0;">
                                <select id="o-st" class="swal2-input" style="margin:0;padding:0;font-size:0.8rem;"><option value="OK">OK</option><option value="PEND">PEND</option><option value="NO">NO</option></select>
                            </div>
                            <button onclick="addC()" class="btn btn-pri" style="margin-top:10px;padding:8px;">AGREGAR</button>
                        </div>
                        <div id="o-list" class="mini-list-container"></div>
                    `,
                    preConfirm: () => {
                        const c = document.getElementById('o-c').value.toUpperCase();
                        return (c && cart.length) ? {c, items:cart} : false;
                    }
                });

                if(value) {
                    if(isEdit) { App.data.ord[idx].c = value.c; App.data.ord[idx].items = value.items; }
                    else App.data.ord.push({c: value.c, items: value.items, st:'bodega', date: new Date().toLocaleDateString()});
                    App.save(); App.Render.ordenes();
                }
            },

            // OTROS HELPERS
            modalProd(i=null) {
                // L√≥gica simplificada para producto (mismo concepto de render)
                // ... (Implementaci√≥n est√°ndar mantenida por robustez)
                const p = i===null ? {n:'', s:{}, sku:App.Helpers.getNextSKU()} : JSON.parse(JSON.stringify(App.data.inv[i]));
                let tempStock = Object.entries(p.s).map(([k,v]) => ({sz:k, q:v}));
                
                window.addS = () => {
                    const sz=(document.getElementById('ts-sz').value||'UNICA').toUpperCase();
                    const q=parseInt(document.getElementById('ts-q').value);
                    if(!isNaN(q)){ const ex=tempStock.find(x=>x.sz===sz); if(ex)ex.q=q; else tempStock.push({sz,q}); renderS(); document.getElementById('ts-sz').value=''; document.getElementById('ts-sz').focus(); }
                };
                window.renderS = () => document.getElementById('ts-list').innerHTML=tempStock.map((x,k)=>`<div class="mini-row"><span>${x.sz}: ${x.q}</span><i class="fa-solid fa-times" onclick="tempStock.splice(${k},1);renderS()"></i></div>`).join('');
                
                Swal.fire({
                    title: i===null?'NUEVO':'EDITAR',
                    html: `<input id="sw-n" class="swal2-input" value="${p.n}" placeholder="Nombre Item">
                           <div style="background:#f8fafc;padding:10px;margin-top:10px;">
                                <div style="display:flex;gap:5px;"><input id="ts-sz" class="swal2-input" placeholder="Talla" style="margin:0;"><input id="ts-q" type="number" class="swal2-input" placeholder="Cant" style="margin:0;width:70px;"><button onclick="addS()" class="btn btn-pri" style="margin:0;width:auto;">OK</button></div>
                                <div id="ts-list" class="mini-list-container"></div>
                           </div>`,
                    didOpen: renderS,
                    preConfirm: () => ({n:document.getElementById('sw-n').value.toUpperCase(), s:tempStock.reduce((a,c)=>({...a,[c.sz]:c.q}),{}), sku:p.sku})
                }).then(r=>{ if(r.value){ if(i===null)App.data.inv.push(r.value); else App.data.inv[i]=r.value; App.save(); App.Render.bodega(); } });
            },

            quickStock(i,k,d) { App.data.inv[i].s[k]=(App.data.inv[i].s[k]||0)+d; App.save(); App.Render.bodega(); },
            changeStatus(i) { Swal.fire({input:'select', inputOptions:{'bodega':'Bodega','prod':'Proceso','pack':'Empaque','done':'Entregar'}, title:'Estado'}).then(r=>{ if(r.value){ if(r.value==='done'){ Swal.fire({input:'text',title:'N¬∞ Doc'}).then(d=>{ if(d.isConfirmed){ App.data.ord[i].st='done'; App.data.ord[i].fac=d.value||'S/N'; App.data.ord[i].items.forEach(x=>{ const p=App.data.inv.find(y=>y.n===x.p); if(p) p.s[x.sz]=(p.s[x.sz]||0)-x.q; }); App.save(); App.Render.ordenes(); App.Render.bodega(); } }); } else { App.data.ord[i].st=r.value; App.save(); App.Render.ordenes(); } } }); },
            printBulk() { const chk=document.querySelectorAll('.chk-bulk:checked'); if(chk.length) { App.Helpers.createPDF('order', Array.from(chk).map(c=>App.data.ord[c.value])); chk.forEach(c=>c.checked=false); App.UI.updateBulk(); } },
            delProd(i) { Swal.fire({title:'Eliminar?',icon:'warning',showCancelButton:true}).then(r=>{if(r.isConfirmed){App.data.inv.splice(i,1);App.save();App.Render.bodega();}}) },
            delOrd(i) { Swal.fire({title:'Eliminar Pedido?',text:'Se requiere autorizaci√≥n',icon:'warning',showCancelButton:true}).then(r=>{if(r.isConfirmed){App.data.ord.splice(i,1);App.save();App.Render.ordenes();}}) },
            tachaFromOrder(i) { const o=App.data.ord[i]; Swal.fire({title:'Datos Despacho', html:`<input id="tt" class="swal2-input" placeholder="Responsable"><input id="to" class="swal2-input" placeholder="Obs">`, preConfirm:()=>({trans:document.getElementById('tt').value, obs:document.getElementById('to').value})}).then(r=>{if(r.value){o.trans=r.value.trans; o.obs=r.value.obs; App.save(); App.Helpers.createPDF('order',[o])}}) },
            factoryReset() { if(App.state.backupDone) Swal.fire({title:'RESET',input:'text',text:'Escribe ELIMINAR'}).then(r=>{if(r.value==='ELIMINAR'){db.ref('/').set({});location.reload();}}) },
        },
        Calendar: { move(d){App.state.calDate.setMonth(App.state.calDate.getMonth()+d);this.render()}, render(){const d=App.state.calDate;const m=d.getMonth();const y=d.getFullYear();document.getElementById('cal-title').innerText=`${m+1}/${y}`;const dim=new Date(y,m+1,0).getDate();const fd=new Date(y,m,1).getDay()||7;let h='';for(let i=1;i<fd;i++)h+='<div></div>';for(let i=1;i<=dim;i++){const k=`${i}-${m}-${y}`;h+=`<div onclick="App.Calendar.show('${k}')" style="background:${App.data.log[k]?'#fffbeb':'white'};border:${App.data.log[k]?'1px solid var(--gold)':'1px solid #eee'};padding:10px;border-radius:8px;cursor:pointer;">${i}</div>`}document.getElementById('cal-grid').innerHTML=h;}, show(k){if(App.data.log[k])Swal.fire({title:k,text:App.data.log[k]})} },
        Backup: { generatePDF(){ const{jsPDF}=window.jspdf;const doc=new jsPDF();doc.text("RESPALDO",10,10);doc.autoTable({head:[['SKU','ITEM','DATA']],body:App.data.inv.map(x=>[x.sku,x.n,JSON.stringify(x.s)])});doc.save('BKP.pdf');App.state.backupDone=true;document.getElementById('btn-reset').style.background='var(--danger)';document.getElementById('btn-reset').style.color='white'; } },
        IA: { trigger:()=>document.getElementById('ai-input').click() }
    };
    App.init();
</script>
</body>
</html>
