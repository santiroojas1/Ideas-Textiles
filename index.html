<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDEASTEXTILESSpa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Estilos específicos para impresión y calendario */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .page-break { page-break-after: always; }
        }
        .print-only { display: none; }
        
        /* Grid del Calendario */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .calendar-day {
            background-color: white;
            min-height: 100px;
            padding: 4px;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .calendar-day:hover { background-color: #f9fafb; }
        
        /* Estilos personalizados de Scroll */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden flex">

    <aside class="w-64 bg-gray-900 text-white flex-col flex-shrink-0 hidden md:flex z-20 shadow-2xl no-print">
        <div class="p-6 flex items-center justify-center border-b border-gray-800">
            <i class="fas fa-scissors text-3xl text-yellow-500 mr-3"></i>
            <h1 class="text-lg font-bold tracking-wider">IDEASTEXTILES</h1>
        </div>
        
        <nav class="mt-6 flex-1 px-4 space-y-2">
            <button onclick="showSection('inventory')" class="nav-item w-full text-left py-3 px-4 rounded hover:bg-gray-800 transition flex items-center bg-gray-800 text-yellow-500">
                <i class="fas fa-boxes w-6"></i> Inventario
            </button>
            <button onclick="showSection('orders')" class="nav-item w-full text-left py-3 px-4 rounded hover:bg-gray-800 transition flex items-center">
                <i class="fas fa-file-invoice w-6"></i> Órdenes (OC)
            </button>
            <button onclick="showSection('calendar')" class="nav-item w-full text-left py-3 px-4 rounded hover:bg-gray-800 transition flex items-center">
                <i class="fas fa-calendar-alt w-6"></i> Calendario
            </button>
            <button onclick="showSection('analysis')" class="nav-item w-full text-left py-3 px-4 rounded hover:bg-gray-800 transition flex items-center">
                <i class="fas fa-brain w-6"></i> IA / Análisis
            </button>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <button onclick="confirmFullReset()" class="w-full bg-red-900 hover:bg-red-700 text-xs py-2 rounded text-red-200 transition">
                <i class="fas fa-bomb mr-1"></i> RESET TOTAL SISTEMA
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-full relative">
        
        <header class="bg-white shadow-md z-10 p-4 flex justify-between items-center border-b-4 border-yellow-500 no-print">
            <div class="flex items-center">
                <button class="md:hidden mr-4 text-gray-600"><i class="fas fa-bars"></i></button>
                <h2 class="text-2xl font-black text-gray-800 tracking-wider uppercase flex items-center">
                    WORKWEAR AND CORPORATE 
                    <i class="fas fa-scissors ml-3 text-yellow-600"></i>
                </h2>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="generateCompanyReport()" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm flex items-center">
                    <i class="fas fa-file-pdf mr-2"></i> Reporte Profesional
                </button>
                <div class="h-8 w-8 rounded-full bg-yellow-500 flex items-center justify-center text-white font-bold">A</div>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6 no-print">
            
            <div id="inventory" class="section-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Inventario</h2>
                        <p class="text-sm text-gray-500">Gestión de productos, tallas dinámicas y stock.</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="invMagicInput" class="hidden" accept="image/*, .xlsx, .xls" onchange="processInventoryFile(this)">
                        <button onclick="document.getElementById('invMagicInput').click()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded shadow flex items-center transition transform hover:scale-105" title="Subir Foto de Cuaderno o Excel">
                            <i class="fas fa-magic mr-2"></i> IA Import
                        </button>
                        
                        <button onclick="confirmReset('inventory')" class="bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 text-sm">
                            <i class="fas fa-trash-alt mr-1"></i>
                        </button>
                        <button onclick="openProductModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow-lg flex items-center transition transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i> Nuevo
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                    <table class="min-w-full leading-normal">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">SKU</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Producto</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Categoría</th>
                                <th class="px-5 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Distribución Tallas</th>
                                <th class="px-5 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Total</th>
                                <th class="px-5 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body">
                            </tbody>
                    </table>
                    <div id="empty-inventory" class="p-10 text-center text-gray-400 hidden">
                        <i class="fas fa-box-open text-4xl mb-3"></i>
                        <p>No hay productos en inventario.</p>
                    </div>
                </div>
            </div>

            <div id="orders" class="section-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Órdenes de Compra</h2>
                        <p class="text-sm text-gray-500">Seguimiento de producción y despachos.</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="orderMagicInput" class="hidden" accept=".xlsx, .xls, image/*" onchange="processOrdersFile(this)">
                        <button onclick="document.getElementById('orderMagicInput').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow flex items-center transition transform hover:scale-105" title="Importar Excel, Foto o Captura de PDF">
                            <i class="fas fa-file-import mr-2"></i> Importar OCs
                        </button>

                        <button onclick="confirmReset('orders')" class="bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 text-sm">
                            <i class="fas fa-trash-alt mr-1"></i>
                        </button>
                        <button onclick="openOrderModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow-lg flex items-center transition transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i> Nueva OC
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                    <table class="min-w-full leading-normal">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ID OC</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Cliente</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Entrega</th>
                                <th class="px-5 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Estado</th>
                                <th class="px-5 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Detalles</th>
                                <th class="px-5 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            </tbody>
                    </table>
                    <div id="empty-orders" class="p-10 text-center text-gray-400 hidden">
                        <i class="fas fa-clipboard-list text-4xl mb-3"></i>
                        <p>No hay órdenes registradas.</p>
                    </div>
                </div>
            </div>

            <div id="calendar" class="section-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-gray-800">Calendario de Despachos</h2>
                    <div class="flex items-center space-x-4">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="calendar-header" class="text-xl font-bold uppercase w-48 text-center">Enero 2026</h3>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-7 text-center font-bold text-gray-500 bg-gray-200 py-2 rounded-t-lg">
                    <div>DOM</div><div>LUN</div><div>MAR</div><div>MIE</div><div>JUE</div><div>VIE</div><div>SAB</div>
                </div>
                <div id="calendar-grid" class="calendar-grid bg-white shadow-lg rounded-b-lg border-l border-r border-b">
                    </div>
            </div>

            <div id="analysis" class="section-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-brain text-purple-600 mr-3"></i> Inteligencia de Negocio (IA)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500 flex items-center justify-between">
                        <div><p class="text-sm text-gray-500 font-bold uppercase">Salud Operativa</p><h3 id="ia-health-score" class="text-3xl font-black text-gray-800">100%</h3></div>
                        <i class="fas fa-heartbeat text-3xl text-purple-200"></i>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500 flex items-center justify-between">
                        <div><p class="text-sm text-gray-500 font-bold uppercase">En Producción</p><h3 id="ia-production-count" class="text-3xl font-black text-gray-800">0</h3></div>
                        <i class="fas fa-tshirt text-3xl text-blue-200"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500 flex items-center justify-between">
                        <div><p class="text-sm text-gray-500 font-bold uppercase">Total Despachado</p><h3 id="ia-shipped-count" class="text-3xl font-black text-gray-800">0</h3></div>
                        <i class="fas fa-shipping-fast text-3xl text-green-200"></i>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4 text-gray-700 border-b pb-2">Diagnóstico del Sistema</h3>
                        <div id="ia-diagnosis-list" class="space-y-4"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4 text-gray-700 border-b pb-2 flex items-center"><i class="fas fa-magic text-yellow-500 mr-2"></i> Sugerencias de Reposición</h3>
                        <p class="text-xs text-gray-400 mb-3">Basado en stock actual vs umbral de seguridad (20 un.)</p>
                        <div id="ia-suggestion-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="productModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800" id="productModalTitle">Gestión de Producto</h3>
                <button onclick="closeModal('productModal')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="productForm">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">SKU (Auto)</label>
                        <input type="text" id="prodSku" readonly class="w-full bg-gray-100 border border-gray-300 rounded px-3 py-2 text-gray-600 font-mono">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Categoría</label>
                        <select id="prodCat" class="w-full border border-gray-300 rounded px-3 py-2">
                            <option>Ropa Ignífuga</option><option>Corporativo</option><option>EPP</option><option>Calzado</option><option>Accesorios</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Nombre Producto</label>
                    <input type="text" id="prodName" required class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-yellow-400 outline-none">
                </div>
                
                <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="hasSizes" class="mr-2 h-4 w-4" checked onchange="toggleSizeInputs()">
                        <label for="hasSizes" class="text-sm font-semibold text-gray-700">Producto con Tallas</label>
                    </div>
                    <button type="button" id="btnAddSize" onclick="addCustomSizeInput()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold hover:bg-blue-200 hidden">+ Nueva Talla</button>
                </div>

                <div id="dynamicSizeContainer" class="grid grid-cols-4 gap-2 mb-4 bg-gray-50 p-3 rounded border border-gray-200 max-h-40 overflow-y-auto"></div>

                <div id="singleStockInput" class="mb-4 hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Stock Total</label>
                    <input type="number" id="stockUnique" value="0" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>

                <div class="flex justify-end pt-4 border-t">
                    <button type="button" onclick="closeModal('productModal')" class="mr-3 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold shadow">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl p-6 h-5/6 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800" id="orderModalTitle">Nueva Orden de Compra</h3>
                <button onclick="closeModal('orderModal')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <form id="orderForm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded border">
                        <div><label class="block text-xs font-bold text-gray-600 uppercase">ID Orden</label><input type="text" id="orderId" required class="w-full bg-white border rounded px-3 py-2 font-mono"></div>
                        <div><label class="block text-xs font-bold text-gray-600 uppercase">Cliente</label><input type="text" id="orderClient" required class="w-full bg-white border rounded px-3 py-2"></div>
                        <div><label class="block text-xs font-bold text-gray-600 uppercase">Fecha Entrega</label><input type="date" id="orderDate" required class="w-full bg-white border rounded px-3 py-2"></div>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-bold text-gray-700 mb-2 border-b">Agregar Productos a la Orden</h4>
                        <div class="flex gap-2 mb-2">
                            <select id="orderProductSelect" class="flex-1 border rounded px-2 py-2" onchange="updateOrderSizeInputs()"><option value="">Seleccione un producto del Inventario...</option></select>
                            <button type="button" onclick="addProductToOrder()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="orderSizeInputs" class="flex flex-wrap gap-2 items-end hidden bg-blue-50 p-2 rounded mb-2"></div>
                        <div id="orderItemNoteContainer" class="hidden mt-2">
                             <input type="text" id="addOrder_Note" placeholder="Añadir nota al producto: (ej: Logo bordado izq, Basta +2cm, etc.)" class="w-full border-2 border-yellow-200 rounded px-3 py-2 text-sm bg-yellow-50 focus:border-yellow-400 outline-none">
                        </div>
                    </div>
                    <div class="bg-white border rounded shadow-inner min-h-[150px] overflow-hidden">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr><th class="px-4 py-2 text-left">Producto</th><th class="px-4 py-2 text-center">Detalle Cantidades</th><th class="px-4 py-2 text-right">Total</th><th class="px-4 py-2"></th></tr>
                            </thead>
                            <tbody id="orderItemsList"></tbody>
                        </table>
                        <div id="no-order-items" class="text-center p-4 text-gray-400 text-sm">Sin productos agregados.</div>
                    </div>
                </form>
            </div>
            <div class="pt-4 border-t flex justify-between items-center">
                <span class="text-xs text-gray-500">* Verifica stock antes de guardar.</span>
                <div class="flex">
                    <button type="button" onclick="closeModal('orderModal')" class="mr-3 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="button" onclick="saveOrder()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow">Guardar Orden</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dispatchModal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[60] flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl w-96 p-6 border-l-4 border-green-600">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Confirmar Despacho</h3>
            <p class="text-sm text-gray-600 mb-4">Ingrese datos de facturación para cerrar la orden.</p>
            <div class="mb-3"><label class="block text-sm font-bold text-gray-700">Nro. Factura</label><input type="text" id="dispatchInvoice" class="w-full border-2 border-green-100 rounded px-3 py-2 focus:border-green-500 outline-none"></div>
            <div class="mb-4"><label class="block text-sm font-bold text-gray-700">Cantidad de Cajas</label><input type="number" id="dispatchBoxes" class="w-full border-2 border-green-100 rounded px-3 py-2 focus:border-green-500 outline-none"></div>
            <div class="flex justify-end"><button onclick="closeModal('dispatchModal')" class="mr-2 text-gray-500 hover:text-gray-700 px-3 py-1">Cancelar</button><button onclick="confirmDispatch()" class="bg-green-600 text-white font-bold px-4 py-2 rounded hover:bg-green-700 shadow">Confirmar</button></div>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-4 rounded shadow-lg w-80">
            <h3 class="font-bold mb-2">Nota para el día</h3>
            <textarea id="calendarNoteText" class="w-full border rounded p-2 mb-2" rows="3"></textarea>
            <div class="flex justify-end"><button onclick="saveCalendarNote()" class="bg-blue-600 text-white px-3 py-1 rounded">Guardar</button></div>
        </div>
    </div>

    <div id="print-area" class="print-only p-8"></div>

    <script>
        // --- 1. DATOS ---
        let inventory = JSON.parse(localStorage.getItem('ww_inventory')) || [];
        let orders = JSON.parse(localStorage.getItem('ww_orders')) || [];
        let calendarNotes = JSON.parse(localStorage.getItem('ww_notes')) || {};
        
        let tempOrderItems = []; 
        let currentDispatchOrderId = null;
        let currentDate = new Date();
        let currentNoteDate = null;
        let editingOrderIndex = null;
        let editingProductIndex = null; // NUEVO: Para saber qué producto se edita

        const defaultSizes = ['S', 'M', 'L', 'XL', 'XXL'];

        // --- 2. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            showSection('inventory');
            renderInventory();
            updateAnalysis();
        });

        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'orders') renderOrders();
            if(id === 'calendar') renderCalendar();
            if(id === 'analysis') updateAnalysis();
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-gray-800', 'text-yellow-500');
                if(btn.getAttribute('onclick').includes(id)) btn.classList.add('bg-gray-800', 'text-yellow-500');
            });
        }

        // --- 3. INVENTARIO (CON EDICIÓN + AUDITORIA) ---
        
        function openProductModal(editIndex = null) {
            document.getElementById('productForm').reset();
            editingProductIndex = editIndex; // Guardamos índice si es edición

            if (editIndex !== null) {
                // MODO EDICIÓN: Cargar datos
                const p = inventory[editIndex];
                document.getElementById('productModalTitle').innerText = "Editar Producto";
                document.getElementById('prodSku').value = p.sku;
                document.getElementById('prodName').value = p.name;
                document.getElementById('prodCat').value = p.cat;
                document.getElementById('hasSizes').checked = p.hasSizes;
                
                // Cargar stock
                toggleSizeInputs();
                if(p.hasSizes) {
                    // Recrear inputs dinámicos basados en lo que hay guardado
                    renderDynamicSizeInputs(Object.keys(p.stockData), p.stockData);
                } else {
                    document.getElementById('stockUnique').value = p.total;
                }

            } else {
                // MODO NUEVO
                document.getElementById('productModalTitle').innerText = "Nuevo Producto";
                let nextId = inventory.length + 1;
                document.getElementById('prodSku').value = `WW-${String(nextId).padStart(4, '0')}`;
                renderDynamicSizeInputs(defaultSizes, {});
                toggleSizeInputs();
            }
            document.getElementById('productModal').classList.remove('hidden');
        }

        function renderDynamicSizeInputs(sizesArray, valuesObj) {
            const container = document.getElementById('dynamicSizeContainer');
            container.innerHTML = '';
            sizesArray.forEach(size => {
                const val = valuesObj[size] || 0;
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="text-xs font-bold text-center block text-gray-600">${size}</label>
                    <input type="number" name="size_${size}" value="${val}" class="w-full border rounded px-1 py-1 text-center font-mono focus:border-blue-500 outline-none size-input-field" data-size="${size}">
                `;
                container.appendChild(div);
            });
        }

        function addCustomSizeInput() {
            const sizeName = prompt("Nombre nueva talla (ej: XS, 40):");
            if(sizeName && sizeName.trim() !== "") {
                const cleanName = sizeName.trim().toUpperCase();
                if(document.querySelector(`input[data-size="${cleanName}"]`)) return alert("Ya existe.");
                const container = document.getElementById('dynamicSizeContainer');
                const div = document.createElement('div');
                div.innerHTML = `<label class="text-xs font-bold text-center block text-blue-600">${cleanName}</label><input type="number" value="0" class="w-full border-2 border-blue-100 rounded px-1 py-1 text-center font-mono focus:border-blue-500 outline-none size-input-field" data-size="${cleanName}">`;
                container.appendChild(div);
            }
        }

        function toggleSizeInputs() {
            const hasSizes = document.getElementById('hasSizes').checked;
            const container = document.getElementById('dynamicSizeContainer');
            const btn = document.getElementById('btnAddSize');
            const single = document.getElementById('singleStockInput');
            if(hasSizes) {
                container.classList.remove('hidden'); container.classList.add('grid'); btn.classList.remove('hidden'); single.classList.add('hidden');
            } else {
                container.classList.add('hidden'); container.classList.remove('grid'); btn.classList.add('hidden'); single.classList.remove('hidden');
            }
        }

        document.getElementById('productForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const sku = document.getElementById('prodSku').value;
            const name = document.getElementById('prodName').value;
            const cat = document.getElementById('prodCat').value;
            const hasSizes = document.getElementById('hasSizes').checked;
            
            // VALIDACIÓN DE EDICIÓN
            if (editingProductIndex !== null) {
                const reason = prompt("⚠️ Estás editando un producto existente.\nPor favor, ingresa el motivo del cambio para el registro:");
                if (!reason) return alert("Debes ingresar un motivo para guardar los cambios.");
                
                // Registrar en Calendario
                const todayKey = new Date().toISOString().split('T')[0];
                const auditNote = `Modificación Inv (${name}): ${reason}`;
                calendarNotes[todayKey] = (calendarNotes[todayKey] ? calendarNotes[todayKey] + " | " : "") + auditNote;
                localStorage.setItem('ww_notes', JSON.stringify(calendarNotes));
            }

            let stockData = {};
            let total = 0;

            if(hasSizes) {
                document.querySelectorAll('.size-input-field').forEach(input => {
                    const size = input.getAttribute('data-size');
                    const qty = parseInt(input.value) || 0;
                    if(qty > 0 || defaultSizes.includes(size)) { stockData[size] = qty; total += qty; }
                });
            } else {
                total = parseInt(document.getElementById('stockUnique').value) || 0;
                stockData = { unique: total };
            }

            const productObj = { sku, name, cat, hasSizes, stockData, total };

            if (editingProductIndex !== null) {
                inventory[editingProductIndex] = productObj;
            } else {
                inventory.push(productObj);
            }

            localStorage.setItem('ww_inventory', JSON.stringify(inventory));
            renderInventory();
            closeModal('productModal');
        });

        function renderInventory() {
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';
            if(inventory.length === 0) {
                document.getElementById('empty-inventory').classList.remove('hidden');
            } else {
                document.getElementById('empty-inventory').classList.add('hidden');
                inventory.forEach((item, index) => {
                    let sizeStr = item.hasSizes ? `<div class="flex flex-wrap justify-center gap-1 text-xs">` + Object.entries(item.stockData).map(([k,v])=>`<span class="bg-gray-100 border border-gray-200 px-1 rounded text-gray-600">${k}:${v}</span>`).join('') + `</div>` : '<span class="text-gray-400 text-xs">Sin Talla</span>';
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 border-b border-gray-100";
                    tr.innerHTML = `
                        <td class="px-5 py-3 text-sm font-mono text-gray-600">${item.sku}</td>
                        <td class="px-5 py-3 text-sm font-bold text-gray-800">${item.name}</td>
                        <td class="px-5 py-3 text-sm text-gray-600">${item.cat}</td>
                        <td class="px-5 py-3">${sizeStr}</td>
                        <td class="px-5 py-3 text-sm font-bold text-right ${item.total < 10 ? 'text-red-600' : 'text-green-600'}">${item.total}</td>
                        <td class="px-5 py-3 text-center flex justify-center space-x-3">
                            <button onclick="openProductModal(${index})" class="text-blue-500 hover:text-blue-700 transition" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteItem(${index})" class="text-red-500 hover:text-red-700 transition" title="Borrar"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            updateOrderProductSelect();
        }

        function deleteItem(index) { if(confirm('¿Eliminar producto?')) { inventory.splice(index, 1); localStorage.setItem('ww_inventory', JSON.stringify(inventory)); renderInventory(); } }

        // --- 4. ÓRDENES ---
        function openOrderModal(editIndex = null) {
            document.getElementById('orderForm').reset();
            document.getElementById('orderSizeInputs').innerHTML = '';
            document.getElementById('orderSizeInputs').classList.add('hidden');
            document.getElementById('orderItemNoteContainer').classList.add('hidden');
            editingOrderIndex = editIndex;
            if(editIndex !== null) {
                const ord = orders[editIndex];
                document.getElementById('orderModalTitle').innerText = "Editar Orden " + ord.id;
                document.getElementById('orderId').value = ord.id; document.getElementById('orderId').readOnly = true;
                document.getElementById('orderClient').value = ord.client; document.getElementById('orderDate').value = ord.date;
                tempOrderItems = JSON.parse(JSON.stringify(ord.items));
            } else {
                document.getElementById('orderModalTitle').innerText = "Nueva Orden de Compra";
                document.getElementById('orderId').readOnly = false;
                tempOrderItems = [];
            }
            renderTempOrderItems();
            document.getElementById('orderModal').classList.remove('hidden');
        }

        function updateOrderProductSelect() {
            const select = document.getElementById('orderProductSelect');
            select.innerHTML = '<option value="">Seleccione Producto...</option>';
            inventory.forEach((p, idx) => {
                const opt = document.createElement('option'); opt.value = idx; opt.text = `${p.sku} - ${p.name}`; select.appendChild(opt);
            });
        }

        function updateOrderSizeInputs() {
            const idx = document.getElementById('orderProductSelect').value;
            const container = document.getElementById('orderSizeInputs');
            const noteContainer = document.getElementById('orderItemNoteContainer');
            container.innerHTML = '';
            if(idx === "") { container.classList.add('hidden'); noteContainer.classList.add('hidden'); return; }
            
            const product = inventory[idx];
            container.classList.remove('hidden'); noteContainer.classList.remove('hidden');
            
            if(product.hasSizes) {
                for (const sizeKey of Object.keys(product.stockData)) {
                    container.innerHTML += `<div class="flex flex-col"><span class="text-[10px] text-center font-bold text-gray-600">${sizeKey}</span><input type="number" id="addOrder_${sizeKey}" placeholder="0" class="w-12 text-center border rounded text-sm focus:border-blue-500" data-size-key="${sizeKey}"></div>`;
                }
            } else {
                 container.innerHTML += `<div class="flex flex-col flex-1"><span class="text-[10px] font-bold">Cantidad</span><input type="number" id="addOrder_Unique" placeholder="0" class="w-full text-center border rounded text-sm"></div>`;
            }
        }

        function addProductToOrder() {
            const idx = document.getElementById('orderProductSelect').value; if(idx === "") return;
            const product = inventory[idx];
            const note = document.getElementById('addOrder_Note').value;
            let itemEntry = { sku: product.sku, name: product.name, hasSizes: product.hasSizes, quantities: {}, totalItem: 0, note: note || '' };

            if(product.hasSizes) {
                document.querySelectorAll('#orderSizeInputs input').forEach(inp => {
                    const val = parseInt(inp.value) || 0;
                    if(val > 0) { itemEntry.quantities[inp.getAttribute('data-size-key')] = val; itemEntry.totalItem += val; }
                });
            } else {
                let q = parseInt(document.getElementById('addOrder_Unique').value) || 0;
                itemEntry.quantities = { unique: q }; itemEntry.totalItem = q;
            }

            if(itemEntry.totalItem > 0) {
                tempOrderItems.push(itemEntry); renderTempOrderItems();
                document.getElementById('orderProductSelect').value = "";
                document.getElementById('orderSizeInputs').classList.add('hidden');
                document.getElementById('orderItemNoteContainer').classList.add('hidden');
                document.getElementById('addOrder_Note').value = "";
            }
        }

        function renderTempOrderItems() {
            const tbody = document.getElementById('orderItemsList'); tbody.innerHTML = '';
            if(tempOrderItems.length === 0) { document.getElementById('no-order-items').classList.remove('hidden'); } else {
                document.getElementById('no-order-items').classList.add('hidden');
                tempOrderItems.forEach((item, idx) => {
                    let detail = item.hasSizes ? Object.entries(item.quantities).map(([s,c])=>`<span class="mr-2 text-xs bg-gray-200 px-1 rounded">${s}:${c}</span>`).join('') : `${item.quantities.unique} Unidades`;
                    let noteHtml = item.note ? `<div class="text-[10px] text-blue-600 font-bold mt-1 bg-blue-50 p-1 inline-block rounded"><i class="fas fa-comment-dots mr-1"></i>${item.note}</div>` : '';
                    tbody.innerHTML += `<tr class="border-b"><td class="px-4 py-2 font-bold text-gray-700">${item.name}<br>${noteHtml}</td><td class="px-4 py-2 text-center text-gray-600">${detail}</td><td class="px-4 py-2 text-right font-bold">${item.totalItem}</td><td class="px-4 py-2 text-right"><button onclick="tempOrderItems.splice(${idx},1); renderTempOrderItems()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
                });
            }
        }

        function saveOrder() {
            const id = document.getElementById('orderId').value; const client = document.getElementById('orderClient').value; const date = document.getElementById('orderDate').value;
            if(!id || !client || !date || tempOrderItems.length === 0) { alert('Faltan datos o productos.'); return; }
            const orderObj = { id, client, date, items: tempOrderItems, status: editingOrderIndex !== null ? orders[editingOrderIndex].status : 'Pendiente', invoice: editingOrderIndex !== null ? orders[editingOrderIndex].invoice : '', boxes: editingOrderIndex !== null ? orders[editingOrderIndex].boxes : '' };
            if(editingOrderIndex !== null) orders[editingOrderIndex] = orderObj; else orders.push(orderObj);
            localStorage.setItem('ww_orders', JSON.stringify(orders)); closeModal('orderModal'); renderOrders(); updateAnalysis();
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-table-body'); tbody.innerHTML = '';
            if(orders.length === 0) { document.getElementById('empty-orders').classList.remove('hidden'); } else {
                document.getElementById('empty-orders').classList.add('hidden');
                orders.forEach((o, idx) => {
                    let statusColor = o.status === 'En Producción' ? "bg-blue-100 text-blue-800" : o.status === 'Listo' ? "bg-green-100 text-green-800" : o.status === 'Despachado' ? "bg-green-600 text-white" : "bg-gray-200 text-gray-800";
                    let dispatchInfo = o.status === 'Despachado' ? `<div class="text-xs"><p class="font-bold">FAC: ${o.invoice}</p><p>Cajas: ${o.boxes}</p></div>` : '<span class="text-gray-300 text-xs">-</span>';
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 border-b";
                    tr.innerHTML = `
                        <td class="px-5 py-3 font-bold">${o.id}</td><td class="px-5 py-3 text-sm">${o.client}</td><td class="px-5 py-3 text-xs text-gray-500">${o.date}</td>
                        <td class="px-5 py-3 text-center"><button onclick="cycleStatus(${idx})" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide cursor-pointer ${statusColor} shadow-sm transition hover:opacity-80">${o.status}</button></td>
                        <td class="px-5 py-3">${dispatchInfo}</td>
                        <td class="px-5 py-3 text-center flex justify-center space-x-2">
                             <button onclick="openOrderModal(${idx})" class="text-blue-500 hover:text-blue-700" title="Editar OC"><i class="fas fa-edit"></i></button>
                             <button onclick="printTachas(${idx})" class="text-gray-600 hover:text-black" title="Imprimir Tachas"><i class="fas fa-print"></i></button>
                             <button onclick="deleteOrder(${idx})" class="text-red-500 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function cycleStatus(index) {
            const states = ['Pendiente', 'En Producción', 'Listo', 'Despachado']; const current = orders[index].status; let nextIndex = states.indexOf(current) + 1;
            if (states[nextIndex] === 'Despachado') { currentDispatchOrderId = index; document.getElementById('dispatchModal').classList.remove('hidden'); return; }
            if (nextIndex >= states.length) nextIndex = 0; 
            orders[index].status = states[nextIndex]; localStorage.setItem('ww_orders', JSON.stringify(orders)); renderOrders(); updateAnalysis();
        }

        function confirmDispatch() {
            const inv = document.getElementById('dispatchInvoice').value; const boxes = document.getElementById('dispatchBoxes').value;
            if(!inv || !boxes) return alert("Datos incompletos.");
            orders[currentDispatchOrderId].status = 'Despachado'; orders[currentDispatchOrderId].invoice = inv; orders[currentDispatchOrderId].boxes = boxes;
            localStorage.setItem('ww_orders', JSON.stringify(orders)); closeModal('dispatchModal');
            document.getElementById('dispatchInvoice').value = ''; document.getElementById('dispatchBoxes').value = ''; renderOrders(); updateAnalysis();
        }

        // --- 5. CALENDARIO ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); const header = document.getElementById('calendar-header'); grid.innerHTML = '';
            const year = currentDate.getFullYear(); const month = currentDate.getMonth();
            header.innerText = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="bg-gray-100"></div>`;
            for(let day=1; day<=daysInMonth; day++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                let eventsHtml = '';
                orders.filter(o => o.status === 'Despachado' && o.date === dateKey).forEach(o => { eventsHtml += `<div class="bg-green-100 text-green-800 text-[9px] p-1 mb-1 rounded border border-green-200 truncate"><i class="fas fa-check"></i> ${o.client} (#${o.invoice})</div>`; });
                if(calendarNotes[dateKey]) { eventsHtml += `<div class="bg-yellow-100 text-yellow-800 text-[9px] p-1 rounded border border-yellow-200 truncate"><i class="fas fa-sticky-note"></i> ${calendarNotes[dateKey]}</div>`; }
                const dayEl = document.createElement('div'); dayEl.className = 'calendar-day relative group';
                dayEl.innerHTML = `<div class="flex justify-between items-start"><span class="font-bold text-gray-700 ml-1 ${day === new Date().getDate() && month === new Date().getMonth() ? 'text-blue-600' : ''}">${day}</span><button onclick="openNoteModal('${dateKey}')" class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-blue-500 mr-1"><i class="fas fa-edit"></i></button></div><div class="flex-1 overflow-y-auto mt-1 px-1">${eventsHtml}</div>`;
                grid.appendChild(dayEl);
            }
        }
        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); }
        function openNoteModal(d) { currentNoteDate = d; document.getElementById('calendarNoteText').value = calendarNotes[d] || ''; document.getElementById('noteModal').classList.remove('hidden'); }
        function saveCalendarNote() { const txt = document.getElementById('calendarNoteText').value; if(txt.trim()) calendarNotes[currentNoteDate] = txt; else delete calendarNotes[currentNoteDate]; localStorage.setItem('ww_notes', JSON.stringify(calendarNotes)); closeModal('noteModal'); renderCalendar(); }

        // --- 6. IMPRESIÓN REPORTE PROFESIONAL ---
        function generateCompanyReport() {
            const area = document.getElementById('print-area');
            const date = new Date().toLocaleDateString();
            const totalInv = inventory.length;
            const totalOrders = orders.length;
            const despachadas = orders.filter(o => o.status === 'Despachado').length;
            
            // HTML PROFESIONAL
            area.innerHTML = `
                <div class="w-full max-w-5xl mx-auto p-10 bg-white border-2 border-gray-300 relative">
                    <div class="flex justify-between items-center border-b-4 border-yellow-500 pb-6 mb-8">
                        <div>
                            <h1 class="text-4xl font-black uppercase text-gray-800 tracking-wider">WORKWEAR & CORP <i class="fas fa-scissors text-yellow-500"></i></h1>
                            <p class="text-sm text-gray-500 font-bold mt-1">SISTEMA INTEGRAL DE GESTIÓN Y PRODUCCIÓN</p>
                        </div>
                        <div class="text-right">
                            <h2 class="text-2xl font-bold text-gray-700">REPORTE GERENCIAL</h2>
                            <p class="text-sm text-gray-600">Fecha Emisión: ${date}</p>
                            <p class="text-xs text-gray-400">ID Reporte: #RPT-${Date.now().toString().slice(-6)}</p>
                        </div>
                    </div>

                    <div class="mb-10">
                        <h3 class="text-lg font-bold text-gray-700 uppercase mb-4 border-l-4 border-gray-800 pl-3">1. Resumen Ejecutivo</h3>
                        <div class="grid grid-cols-3 gap-6">
                            <div class="bg-gray-50 p-6 rounded border border-gray-200 text-center">
                                <p class="text-xs font-bold text-gray-500 uppercase tracking-widest">Inventario Total</p>
                                <p class="text-5xl font-black text-gray-800 mt-2">${totalInv}</p>
                                <p class="text-xs text-gray-400 mt-2">SKUs Únicos</p>
                            </div>
                            <div class="bg-blue-50 p-6 rounded border border-blue-200 text-center">
                                <p class="text-xs font-bold text-blue-500 uppercase tracking-widest">En Producción</p>
                                <p class="text-5xl font-black text-blue-700 mt-2">${orders.filter(o => o.status !== 'Despachado').length}</p>
                                <p class="text-xs text-blue-400 mt-2">Órdenes Activas</p>
                            </div>
                            <div class="bg-green-50 p-6 rounded border border-green-200 text-center">
                                <p class="text-xs font-bold text-green-500 uppercase tracking-widest">Despachos Exit.</p>
                                <p class="text-5xl font-black text-green-700 mt-2">${despachadas}</p>
                                <p class="text-xs text-green-400 mt-2">Ciclo Completado</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-10">
                        <h3 class="text-lg font-bold text-gray-700 uppercase mb-4 border-l-4 border-red-500 pl-3">2. Alertas de Stock Crítico</h3>
                        <div class="bg-white border border-gray-200 rounded overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
                                    <tr><th class="p-3">SKU</th><th class="p-3">Producto</th><th class="p-3 text-right">Stock</th><th class="p-3 text-center">Estado</th></tr>
                                </thead>
                                <tbody>
                                    ${inventory.filter(i => i.total < 20).map(i => `
                                    <tr class="border-b">
                                        <td class="p-3 font-mono">${i.sku}</td>
                                        <td class="p-3 font-bold">${i.name}</td>
                                        <td class="p-3 text-right text-red-600 font-bold">${i.total}</td>
                                        <td class="p-3 text-center"><span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded font-bold">BAJO</span></td>
                                    </tr>`).join('') || '<tr><td colspan="4" class="p-4 text-center text-green-600 font-bold">Inventario Saludable. Sin alertas.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="border-t-2 border-gray-300 pt-6 flex justify-between items-end">
                        <div class="text-xs text-gray-400">
                            <p>Generado automáticamente por Plataforma WW.</p>
                            <p>Confidencial - Uso interno exclusivo.</p>
                        </div>
                        <div class="text-right">
                             <h1 class="font-black text-xl uppercase text-gray-300">WORKWEAR & CORP</h1>
                        </div>
                    </div>
                </div>
            `;
            window.print();
        }

        function printTachas(idx) {
            const order = orders[idx]; const area = document.getElementById('print-area');
            let html = `<div class="grid grid-cols-2 gap-8 w-full">`;
            order.items.forEach(item => {
                let tallas = item.hasSizes ? `<table class="w-full text-xs border mt-2 text-center"><tr class="bg-gray-200 font-bold">${Object.keys(item.quantities).map(k=>`<td>${k}</td>`).join('')}</tr><tr>${Object.values(item.quantities).map(v=>`<td class="border p-1">${v}</td>`).join('')}</tr></table>` : `<div class="mt-2 font-bold text-center border p-2">CANT: ${item.quantities.unique}</div>`;
                let note = item.note ? `<div class="mt-2 border-2 border-dashed border-gray-400 bg-gray-50 p-2 text-sm font-bold uppercase text-gray-800">NOTA: ${item.note}</div>` : '';
                html += `<div class="border-4 border-gray-800 p-4 bg-white flex flex-col justify-between" style="min-height: 400px; page-break-inside: avoid;"><div class="flex justify-between border-b-2 border-gray-800 pb-2 mb-2"><div><h1 class="font-black text-xl uppercase">WW CORP <i class="fas fa-scissors"></i></h1><p class="text-xs">Producción</p></div><div class="text-right"><p class="font-bold text-lg">OC: ${order.id}</p><p class="text-xs">${order.client}</p></div></div><div class="mb-4"><p class="font-bold text-lg">${item.name}</p><p class="text-xs font-mono mb-2">${item.sku}</p>${tallas}${note}</div><div class="grid grid-cols-3 gap-2 text-center text-xs font-bold mb-4"><div class="border p-2 pt-6 relative">CORTE</div><div class="border p-2 pt-6 relative">CONFECCIÓN</div><div class="border p-2 pt-6 relative">TERMINACIÓN</div></div><div class="border-t-2 border-gray-800 pt-2 mt-auto text-xs"><div class="flex justify-between mb-4"><span>Factura: ____________</span><span>Cajas: ____/____</span></div></div></div>`;
            });
            html += `</div>`; area.innerHTML = html; window.print();
        }

        // --- 7. IA UNIVERSAL (OCR + EXCEL) ---
        
        async function processInventoryFile(input) { processUniversalFile(input, 'inventory'); }
        async function processOrdersFile(input) { processUniversalFile(input, 'orders'); }

        async function processUniversalFile(input, type) {
            const file = input.files[0]; if (!file) return;
            showLoadingToast('Analizando archivo (' + file.type + ')...');

            try {
                if (file.type.includes('image')) {
                    // OCR (TESSERACT)
                    const worker = Tesseract.createWorker();
                    await worker.load(); await worker.loadLanguage('spa'); await worker.initialize('spa');
                    const { data: { text } } = await worker.recognize(file);
                    await worker.terminate();
                    
                    if(type === 'inventory') parseInventoryText(text);
                    else parseOrdersTextOCR(text); // Nueva función para texto OCR de OCs

                } else if (file.name.includes('.xls') || file.name.includes('.xlsx')) {
                    // EXCEL (SHEETJS)
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                    
                    if(type === 'inventory') parseInventoryExcel(jsonData);
                    else parseComplexOrderExcel(jsonData);

                } else {
                    alert("Formato no soportado directo. Para PDF, por favor suba una CAPTURA DE PANTALLA (Imagen) o conviértalo a Excel.");
                }
            } catch (e) { alert('Error: ' + e.message); } 
            finally { removeToast(); input.value = ''; }
        }

        // --- LOGICA PARSING ---

        // 1. Inventario
        function parseInventoryText(text) {
            let count=0; text.split('\n').forEach(line => {
                if(line.length>3 && line.match(/\d+/)) {
                    const numbers = line.match(/\d+/g); const qty = parseInt(numbers[numbers.length-1]);
                    const name = line.replace(qty, '').replace(/[^\w\s]/g, '').trim();
                    if(name.length > 2) { addOrUpdateInventory(name, qty); count++; }
                }
            });
            alert(`✅ IA Inventario (Foto): ${count} items detectados.`); renderInventory();
        }
        function parseInventoryExcel(rows) {
            let count=0; rows.forEach((r,i)=>{ if(i>0 && r[0]) { addOrUpdateInventory(String(r[0]), parseInt(r[1])||0); count++; }});
            alert(`✅ IA Inventario (Excel): ${count} items importados.`); renderInventory();
        }
        function addOrUpdateInventory(name, qty) {
            const idx = inventory.findIndex(p=>p.name.toLowerCase()===name.toLowerCase());
            if(idx>=0) { inventory[idx].total+=qty; if(!inventory[idx].hasSizes) inventory[idx].stockData.unique+=qty; }
            else { inventory.push({sku:`WW-IMP-${inventory.length+1}`, name, cat:'Importado', hasSizes:false, stockData:{unique:qty}, total:qty}); }
            localStorage.setItem('ww_inventory', JSON.stringify(inventory));
        }

        // 2. Órdenes (OCR Imagen) - INTENTO DE LEER TABLA
        function parseOrdersTextOCR(text) {
            // Lógica simple: Busca líneas con "OC" o números largos y trata de extraer producto
            // Esto es aproximado ya que OCR pierde estructura de tabla
            let possibleOrders = 0;
            const lines = text.split('\n');
            let currentId = "OC-FOTO-" + Date.now().toString().slice(-4); // ID Temporal si no detecta uno
            
            lines.forEach(line => {
                // Si detecta un numero largo tipo orden (ej: 4500...)
                const idMatch = line.match(/4500\d+/);
                if(idMatch) currentId = idMatch[0];

                // Si detecta producto probable (texto largo + numero corto al final)
                // Ej: "Delantal Junaeb 200"
                if (line.length > 10 && line.match(/\d+$/)) {
                    const numbers = line.match(/\d+/g);
                    const qty = parseInt(numbers[numbers.length-1]);
                    const name = line.replace(qty, '').trim();
                    
                    if(qty > 0 && name.length > 3) {
                        // Agregar como OC
                        addComplexOrderItem(currentId, "Cliente Detectado", name, "UNICA", qty);
                        possibleOrders++;
                    }
                }
            });
            
            if(possibleOrders > 0) {
                alert(`✅ IA Foto OC: Se detectaron posibles items. Revisa las Órdenes.`);
                localStorage.setItem('ww_orders', JSON.stringify(orders));
                renderOrders(); updateAnalysis();
            } else {
                alert("⚠️ No se detectaron datos claros en la foto. Intenta con una foto más nítida o Excel.");
            }
        }

        // 3. Órdenes (Excel Complejo)
        function parseComplexOrderExcel(rows) {
            const ordersMap = {};
            rows.forEach((row, index) => {
                if (index < 1 || !row[1]) return;
                const idRaw = String(row[1]).trim(); const clientRaw = String(row[3] || "Cliente Import").split('$')[0].trim();
                const prodName = row[4]; const sizeRaw = String(row[5] || "UNICA").trim().toUpperCase(); const qty = parseInt(row[6]) || 0;
                if (idRaw && prodName && qty > 0) addComplexOrderItem(idRaw, clientRaw, prodName, sizeRaw, qty, ordersMap);
            });
            // Guardar Map
            if (Object.keys(ordersMap).length > 0) {
                Object.values(ordersMap).forEach(o => orders.push(o));
                localStorage.setItem('ww_orders', JSON.stringify(orders));
                alert(`✅ Excel OC: ${Object.keys(ordersMap).length} órdenes importadas.`);
                renderOrders(); updateAnalysis();
            }
        }

        // Helper para agregar items a OCs (usado por Excel y OCR)
        function addComplexOrderItem(id, client, prodName, size, qty, map = null) {
            // Si no pasamos mapa (caso OCR), usamos el array global buscando si ya existe
            let targetOrder;
            
            if (map) {
                if (!map[id]) map[id] = { id, client, date: new Date().toISOString().split('T')[0], status: 'Pendiente', items: [], invoice: '', boxes: '' };
                targetOrder = map[id];
            } else {
                targetOrder = orders.find(o => o.id === id);
                if (!targetOrder) {
                    targetOrder = { id, client, date: new Date().toISOString().split('T')[0], status: 'Pendiente', items: [], invoice: '', boxes: '' };
                    orders.push(targetOrder);
                }
            }

            let existingItem = targetOrder.items.find(i => i.name === prodName);
            if (existingItem) {
                if (existingItem.hasSizes) { existingItem.quantities[size] = (existingItem.quantities[size] || 0) + qty; existingItem.totalItem += qty; }
            } else {
                let newItem = { sku: 'OC-IMP', name: prodName, hasSizes: true, quantities: {}, totalItem: qty, note: '' };
                newItem.quantities[size] = qty; targetOrder.items.push(newItem);
            }
        }

        // Utils
        function showLoadingToast(msg) { const div = document.createElement('div'); div.id = 'loading-toast'; div.className = 'fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-4 rounded shadow-2xl z-50 flex items-center animate-pulse'; div.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-3 text-yellow-500"></i> ${msg}`; document.body.appendChild(div); }
        function removeToast() { const el = document.getElementById('loading-toast'); if(el) el.remove(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function deleteOrder(idx) { if(confirm('¿Eliminar?')) { orders.splice(idx, 1); localStorage.setItem('ww_orders', JSON.stringify(orders)); renderOrders(); updateAnalysis(); } }
        function confirmReset(t) { if(confirm('¿Resetear ' + t + '?')) { localStorage.removeItem('ww_' + t); location.reload(); } }
        function confirmFullReset() { if(confirm('¿BORRAR TODO?')) { localStorage.clear(); location.reload(); } }
        function updateAnalysis() { /* ...Misma lógica anterior... */ 
             // Simplificado para ahorrar espacio en visualización, mantiene lógica original de conteo
             let pending = orders.filter(o => o.status === 'Pendiente').length; let production = orders.filter(o => o.status === 'En Producción').length; let shipped = orders.filter(o => o.status === 'Despachado').length;
             document.getElementById('ia-production-count').innerText = production; document.getElementById('ia-shipped-count').innerText = shipped;
             let score = 100; if (production > 5) score -= 20; if (pending > 10) score -= 10; if (shipped > 0) score += 5; if (score > 100) score = 100;
             const scoreEl = document.getElementById('ia-health-score'); scoreEl.innerText = score + '%'; scoreEl.className = `text-3xl font-black ${score > 80 ? 'text-green-600' : score > 50 ? 'text-yellow-600' : 'text-red-600'}`;
             
             // Sugerencias
             const suggestList = document.getElementById('ia-suggestion-list'); suggestList.innerHTML = '';
             inventory.forEach(p => { if(p.total < 20) suggestList.innerHTML += `<div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200 text-sm"><div><span class="font-bold text-gray-700">${p.sku}</span> <span class="text-xs text-gray-500">${p.name}</span><div class="text-xs text-red-500">Stock actual: ${p.total}</div></div><div class="text-right"><span class="block text-[10px] text-gray-400 uppercase">Sugerencia</span><span class="font-bold text-blue-600">+${50-p.total} un.</span></div></div>`; });
             if(suggestList.innerHTML === '') suggestList.innerHTML = '<div class="text-gray-400 text-sm text-center italic">Inventario suficiente.</div>';
        }

    </script>
</body>
</html>
