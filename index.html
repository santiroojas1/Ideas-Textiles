<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Workwear & Corporate - Sistema Maestro v.Final (Full Stack)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    
    <script src="//mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script>
        // Configuración del Worker para PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';
    </script>

    <style>
        /* Base */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #f1f5f9;
            color: #1e293b;
        }
        
        /* CORRECCIÓN MÓVIL: Tablas con Scroll Horizontal */
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
        }
        
        /* Botones táctiles optimizados */
        button { 
            touch-action: manipulation; 
            transition: all 0.2s ease-in-out;
        }
        button:active {
            transform: scale(0.95);
        }

        /* Scrollbars personalizados */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* CALENDARIO: GRID RESPONSIVO */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #cbd5e1; 
            border: 1px solid #cbd5e1;
        }
        .calendar-day {
            background-color: white;
            min-height: 100px;
            padding: 4px;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .calendar-day.today { background-color: #eff6ff; }
        .calendar-day:hover { background-color: #f8fafc; }
        
        .day-number { font-weight: bold; padding: 2px; }
        .day-number.today-num {
            background-color: #3b82f6; color: white;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        /* AJUSTES ESPECÍFICOS PARA MÓVIL */
        @media (max-width: 768px) {
            .calendar-day { 
                min-height: 60px !important; 
                font-size: 0.65rem !important; 
            }
            input, select { 
                font-size: 16px !important; /* Evita zoom en iOS */
            }
            .btn-mobile { 
                padding: 12px 16px !important; /* Área de toque más grande */
            }
            /* Ocultar scrollbar en menú lateral móvil para estética */
            #sidebar::-webkit-scrollbar { width: 0px; }
        }

        /* ESTILOS DE PRODUCCIÓN (WORKFLOW) */
        .stage-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 0.5rem; padding: 0.5rem;
            border-radius: 0.375rem; border-width: 1px;
            transition: background-color 0.3s ease;
        }
        .stage-row.completed { 
            background-color: #f0fdf4; 
            border-color: #86efac; 
        }
        .stage-row.pending {
            background-color: #ffffff;
            border-color: #e2e8f0;
        }
        
        /* Checkbox grande para selección múltiple */
        .oc-check { 
            width: 20px; height: 20px; 
            cursor: pointer; accent-color: #1e293b; 
        }

        /* ========================================= */
        /* ESTILOS DE IMPRESIÓN            */
        /* ========================================= */
        @media print {
            @page { margin: 0.5cm; size: auto; }
            body { background-color: white; -webkit-print-color-adjust: exact; overflow: visible !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            /* Grid Multitachas (6 por hoja) */
            .multitacha-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 32vh 32vh 32vh;
                gap: 10px;
                width: 100%;
                page-break-after: always;
            }
            .tacha-card {
                border: 2px solid #000;
                padding: 10px;
                font-size: 11px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                page-break-inside: avoid;
                height: 100%;
                background: white;
            }
            .inv-tacha {
                border: 4px solid #000;
                padding: 40px;
                margin: 50px auto;
                width: 90%;
                font-family: 'Courier New', Courier, monospace;
                text-transform: uppercase;
                background: white;
            }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex">

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl no-print flex flex-col h-full">
        <div class="p-6 flex items-center justify-center border-b border-slate-800 relative">
            <i class="fas fa-scissors text-3xl text-yellow-500 mr-3"></i>
            <div>
                <h1 class="text-lg font-bold tracking-wider">WORKWEAR</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Sistema Maestro</p>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden absolute top-6 right-4 text-slate-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <nav class="mt-6 flex-1 px-4 space-y-3 overflow-y-auto">
            <button onclick="showSection('inventory')" class="nav-item w-full text-left py-4 px-4 rounded hover:bg-slate-800 transition flex items-center group border-l-4 border-yellow-500 bg-slate-800">
                <i class="fas fa-boxes w-6 text-yellow-500 text-lg"></i> 
                <span class="ml-3 font-medium group-hover:text-yellow-500 transition">Inventario & Taller</span>
            </button>
            
            <button onclick="showSection('orders')" class="nav-item w-full text-left py-4 px-4 rounded hover:bg-slate-800 transition flex items-center group">
                <i class="fas fa-file-invoice w-6 text-slate-400 group-hover:text-yellow-500 text-lg"></i> 
                <span class="ml-3 font-medium group-hover:text-yellow-500 transition">Órdenes (OC)</span>
            </button>
            
            <button onclick="showSection('calendar')" class="nav-item w-full text-left py-4 px-4 rounded hover:bg-slate-800 transition flex items-center group">
                <i class="fas fa-calendar-alt w-6 text-slate-400 group-hover:text-yellow-500 text-lg"></i> 
                <span class="ml-3 font-medium group-hover:text-yellow-500 transition">Calendario</span>
            </button>
            
            <button onclick="showSection('analysis')" class="nav-item w-full text-left py-4 px-4 rounded hover:bg-slate-800 transition flex items-center group">
                <i class="fas fa-brain w-6 text-slate-400 group-hover:text-yellow-500 text-lg"></i> 
                <span class="ml-3 font-medium group-hover:text-yellow-500 transition">IA / Análisis</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button onclick="confirmFullReset()" class="w-full bg-red-900 hover:bg-red-700 text-xs py-3 rounded text-red-200 transition font-bold flex items-center justify-center shadow-inner btn-mobile">
                <i class="fas fa-database mr-2"></i> RESET CON RESPALDO
            </button>
        </div>
    </aside>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden transition-opacity"></div>

    <div class="flex-1 flex flex-col h-full relative w-full">
        
        <header class="bg-white shadow-md z-30 p-4 flex justify-between items-center border-b-4 border-yellow-500 no-print h-16 sticky top-0">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="md:hidden mr-4 text-slate-600 p-2 rounded hover:bg-gray-100 focus:outline-none transition active:bg-gray-200">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <h2 class="text-lg md:text-2xl font-black text-slate-800 tracking-wider uppercase flex items-center truncate">
                    WW & CORP <i class="fas fa-scissors ml-2 text-yellow-600"></i>
                </h2>
            </div>
            <div class="flex items-center space-x-3">
                <span class="hidden md:inline text-xs text-slate-500 font-bold uppercase" id="currentDateDisplay"></span>
                <button onclick="generateCompanyReport()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded text-xs font-bold flex items-center transition shadow-lg transform active:scale-95 btn-mobile">
                    <i class="fas fa-file-pdf md:mr-2"></i> <span class="hidden md:inline">Reporte</span>
                </button>
                <div class="h-9 w-9 rounded-full bg-yellow-500 flex items-center justify-center text-white font-bold shadow-md border-2 border-white text-sm">A</div>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-50 p-3 md:p-6 no-print relative">
            
            <div id="inventory" class="section-content">
                
                <div class="mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800 flex items-center">
                                <i class="fas fa-industry text-orange-500 mr-2"></i> TALLER DE CONFECCIÓN
                            </h3>
                            <p class="text-xs text-slate-500">Lotes en proceso (Corte -> Bodega)</p>
                        </div>
                        <button onclick="openProductionModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded shadow text-xs font-bold flex items-center justify-center w-full md:w-auto btn-mobile transition transform active:scale-95">
                            <i class="fas fa-plus-circle mr-2"></i> NUEVA ORDEN DE TRABAJO
                        </button>
                    </div>
                    
                    <div id="production-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </div>

                <hr class="border-slate-300 my-8">

                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Bodega de Productos</h2>
                        <p class="text-sm text-slate-500">Stock físico disponible para despacho.</p>
                    </div>
                    
                    <div class="flex flex-wrap items-center bg-white p-2 rounded-lg shadow-sm border border-slate-200 gap-2 w-full md:w-auto">
                        <input type="file" id="invPhotoInput" class="hidden" accept="image/*" capture="environment" onchange="processInventoryFile(this)">
                        <input type="file" id="invFileInput" class="hidden" accept=".xlsx, .xls, .pdf" onchange="processInventoryFile(this)">
                        
                        <button onclick="document.getElementById('invPhotoInput').click()" class="flex-1 md:flex-none bg-purple-100 text-purple-700 hover:bg-purple-200 px-3 py-2 rounded text-xs font-bold flex items-center justify-center transition btn-mobile shadow-sm">
                            <i class="fas fa-camera mr-2"></i> Foto IA
                        </button>
                        <button onclick="document.getElementById('invFileInput').click()" class="flex-1 md:flex-none bg-purple-100 text-purple-700 hover:bg-purple-200 px-3 py-2 rounded text-xs font-bold flex items-center justify-center transition btn-mobile shadow-sm">
                            <i class="fas fa-file-upload mr-2"></i> Archivo IA
                        </button>
                        
                        <div class="h-6 w-px bg-slate-300 mx-1 hidden md:block"></div>
                        
                        <button onclick="openProductModal()" class="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-xs font-bold shadow flex items-center justify-center transition transform active:scale-95 btn-mobile">
                            <i class="fas fa-plus mr-2"></i> Nuevo Item
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200 mb-8">
                    <div class="table-responsive">
                        <table class="min-w-full leading-normal text-sm">
                            <thead class="bg-slate-100 border-b border-slate-200">
                                <tr>
                                    <th class="px-5 py-3 text-left font-bold text-slate-600 uppercase tracking-wider">SKU</th>
                                    <th class="px-5 py-3 text-left font-bold text-slate-600 uppercase tracking-wider">Producto</th>
                                    <th class="px-5 py-3 text-center font-bold text-slate-600 uppercase tracking-wider">Tallas</th>
                                    <th class="px-5 py-3 text-right font-bold text-slate-600 uppercase tracking-wider">Total</th>
                                    <th class="px-5 py-3 text-center font-bold text-slate-600 uppercase tracking-wider">Control (Tachas)</th>
                                    <th class="px-5 py-3 text-center font-bold text-slate-600 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                </tbody>
                        </table>
                    </div>
                    <div id="empty-inventory" class="p-10 text-center text-slate-400 hidden">
                        <i class="fas fa-box-open text-4xl mb-3 block"></i>
                        <p>Bodega vacía. Usa "Nuevo Item" o carga una Foto con IA.</p>
                    </div>
                </div>
            </div>

            <div id="orders" class="section-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">Órdenes de Compra</h2>
                        <p class="text-sm text-slate-500">Gestión de Pedidos, Facturación y Despacho.</p>
                    </div>
                    <div class="flex flex-wrap items-center bg-white p-2 rounded-lg shadow-sm border border-slate-200 gap-2 w-full md:w-auto">
                        <input type="file" id="orderMagicInput" class="hidden" accept=".xlsx, .xls, .pdf, image/*" onchange="processOrdersFile(this)">
                        
                        <button onclick="document.getElementById('orderMagicInput').click()" class="flex-1 md:flex-none bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-2 rounded text-xs font-bold flex items-center justify-center transition btn-mobile">
                            <i class="fas fa-file-import mr-2"></i> IA OC (PDF/XLS)
                        </button>
                        
                        <div class="h-6 w-px bg-slate-300 mx-1 hidden md:block"></div>

                        <button onclick="confirmReset('orders')" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="Limpiar Solo Órdenes">
                            <i class="fas fa-trash-alt"></i>
                        </button>

                        <button onclick="openOrderModal()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-xs font-bold shadow flex items-center justify-center transition transform active:scale-95 btn-mobile">
                            <i class="fas fa-plus mr-2"></i> Nueva OC
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200 mb-4">
                    <div class="p-3 bg-slate-50 border-b flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" id="selectAllOC" class="oc-check mr-2" onchange="toggleAllOCs(this)">
                            <span class="text-xs font-bold text-slate-600">Seleccionar Todo</span>
                        </div>
                        <button onclick="printSelectedTachas()" class="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold hover:bg-slate-900 transition flex items-center shadow btn-mobile">
                            <i class="fas fa-print mr-2"></i> Imprimir Tachas (Lote)
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="min-w-full leading-normal text-sm">
                            <thead class="bg-slate-100 border-b border-slate-200">
                                <tr>
                                    <th class="px-3 py-3 w-10 text-center">✓</th>
                                    <th class="px-5 py-3 text-left font-bold text-slate-600 uppercase">ID OC</th>
                                    <th class="px-5 py-3 text-left font-bold text-slate-600 uppercase">Cliente</th>
                                    <th class="px-5 py-3 text-left font-bold text-slate-600 uppercase">Entrega</th>
                                    <th class="px-5 py-3 text-center font-bold text-slate-600 uppercase">Estado</th>
                                    <th class="px-5 py-3 text-left font-bold text-slate-600 uppercase">Items / Notas</th>
                                    <th class="px-5 py-3 text-center font-bold text-slate-600 uppercase">Gestión</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                </tbody>
                        </table>
                    </div>
                    <div id="empty-orders" class="p-10 text-center text-slate-400 hidden">
                        <i class="fas fa-clipboard-list text-4xl mb-3 block"></i> No hay órdenes registradas.
                    </div>
                </div>
            </div>

            <div id="calendar" class="section-content hidden">
                <div id="calendar-alerts" class="mb-6 hidden transition-all duration-500"></div>

                <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800">Calendario</h2>
                    <div class="flex items-center space-x-4">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-100 rounded-full transition active:bg-slate-200"><i class="fas fa-chevron-left text-slate-600"></i></button>
                        <h3 id="calendar-header" class="text-lg font-bold uppercase w-40 text-center text-slate-700"></h3>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-100 rounded-full transition active:bg-slate-200"><i class="fas fa-chevron-right text-slate-600"></i></button>
                    </div>
                </div>
                
                <div class="grid grid-cols-7 text-center font-bold text-slate-500 bg-slate-200 py-2 rounded-t-lg text-xs border border-slate-300">
                    <div>DOM</div><div>LUN</div><div>MAR</div><div>MIE</div><div>JUE</div><div>VIE</div><div>SAB</div>
                </div>
                <div id="calendar-grid" class="calendar-grid bg-white shadow-lg rounded-b-lg border-l border-r border-b border-slate-300">
                    </div>
            </div>

            <div id="analysis" class="section-content hidden">
                <h2 class="text-3xl font-bold text-slate-800 mb-6 flex items-center">
                    <i class="fas fa-chart-line text-purple-600 mr-3"></i> Dashboard Inteligente
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-purple-500 flex justify-between items-center">
                        <div><p class="text-xs text-slate-500 font-bold uppercase">Salud Operativa</p><h3 id="ia-health-score" class="text-4xl font-black text-slate-800">100%</h3></div>
                        <i class="fas fa-heartbeat text-4xl text-purple-100"></i>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500 flex justify-between items-center">
                        <div><p class="text-xs text-slate-500 font-bold uppercase">Producción Activa</p><h3 id="ia-production-count" class="text-4xl font-black text-slate-800">0</h3></div>
                        <i class="fas fa-tshirt text-4xl text-blue-100"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-green-500 flex justify-between items-center">
                        <div><p class="text-xs text-slate-500 font-bold uppercase">Despachados Mes</p><h3 id="ia-shipped-count" class="text-4xl font-black text-slate-800">0</h3></div>
                        <i class="fas fa-truck-loading text-4xl text-green-100"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100">
                        <h3 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2">Diagnóstico de Flujo (IA)</h3>
                        <div id="ia-diagnosis-list" class="space-y-3 text-sm"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100">
                        <h3 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2 flex items-center">
                            <i class="fas fa-magic text-yellow-500 mr-2"></i> Sugerencias de Reposición
                        </h3>
                        <div id="ia-suggestion-list" class="space-y-3 max-h-64 overflow-y-auto text-sm"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="prodItemModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-2xl transform transition-all">
            <h3 class="font-bold text-xl mb-4 text-orange-600 flex items-center border-b pb-2">
                <i class="fas fa-cut mr-2"></i> Nuevo Lote de Producción
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Descripción / Lote</label>
                    <input type="text" id="prodWorkName" placeholder="Ej: Lote Pantalones Cargo (OC-4500)" class="w-full border-2 rounded p-2 text-sm focus:border-orange-400 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Cantidad Total</label>
                    <input type="number" id="prodWorkQty" placeholder="Unidades" class="w-full border-2 rounded p-2 text-sm font-bold focus:border-orange-400 outline-none">
                </div>
                <div class="bg-orange-50 p-3 rounded border border-orange-100 text-xs text-orange-800">
                    <p class="font-bold">Flujo de Trabajo Automático:</p>
                    <ul class="list-disc pl-4 mt-1">
                        <li>Corte</li>
                        <li>Confección</li>
                        <li>Bordado/Terminación</li>
                        <li><strong>Ingreso a Bodega</strong> (Automático al finalizar)</li>
                    </ul>
                </div>
            </div>
            <div class="flex justify-end mt-6 pt-4 border-t">
                <button onclick="closeModal('prodItemModal')" class="mr-3 text-slate-500 font-bold text-sm hover:text-slate-700 btn-mobile">Cancelar</button>
                <button onclick="createWorkOrder()" class="bg-orange-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-orange-700 transition transform active:scale-95 btn-mobile">Crear Lote</button>
            </div>
        </div>
    </div>

    <div id="productModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 transform transition-all overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-slate-800" id="productModalTitle">Gestión de Producto</h3>
                <button onclick="closeModal('productModal')" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <form id="productForm">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase">SKU (Automático)</label>
                    <input type="text" id="prodSku" readonly class="w-full bg-slate-100 border border-slate-300 rounded px-3 py-2 text-slate-600 font-mono text-sm">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Nombre del Producto</label>
                    <input type="text" id="prodName" required class="w-full border-2 border-slate-200 rounded px-3 py-2 focus:border-yellow-400 outline-none transition">
                </div>
                
                <div class="mb-3 flex items-center justify-between bg-slate-50 p-2 rounded">
                    <div class="flex items-center">
                        <input type="checkbox" id="hasSizes" class="mr-2 h-5 w-5 text-yellow-500 rounded border-gray-300 focus:ring-yellow-500" checked onchange="toggleSizeInputs()">
                        <label for="hasSizes" class="text-sm font-bold text-slate-700 cursor-pointer">¿Tiene Tallas?</label>
                    </div>
                    <button type="button" id="btnAddSize" onclick="addCustomSizeInput()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded font-bold hover:bg-blue-200 transition border border-blue-200">+ Agregar Talla</button>
                </div>

                <div id="dynamicSizeContainer" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 bg-slate-50 p-3 rounded border border-slate-200 max-h-40 overflow-y-auto transition-all">
                    </div>

                <div id="singleStockInput" class="mb-4 hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Stock Único</label>
                    <input type="number" id="stockUnique" value="0" class="w-full border-2 border-slate-200 rounded px-3 py-2 text-center font-bold">
                </div>

                <div class="flex justify-end pt-4 border-t">
                    <button type="button" onclick="closeModal('productModal')" class="mr-3 px-4 py-2 text-slate-600 hover:bg-slate-100 rounded text-sm font-bold btn-mobile">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded text-sm font-bold shadow transform active:scale-95 transition btn-mobile">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="moveStockModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 border-l-8 border-yellow-500 shadow-2xl">
            <h3 class="text-xl font-bold mb-2 text-slate-800">Movimiento de Bodega</h3>
            <p class="text-xs text-slate-500 mb-4 bg-yellow-50 p-2 rounded border border-yellow-100">⚠️ Se generará una Tacha de Control obligatoria.</p>
            
            <input type="hidden" id="moveIdx"><input type="hidden" id="moveType">
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-600 uppercase">Cantidad</label>
                    <input type="number" id="moveQty" class="w-full border-2 rounded p-2 focus:border-yellow-500 outline-none font-bold text-lg text-center">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-600 uppercase">Origen / Destino</label>
                    <input type="text" id="moveDestination" class="w-full border rounded p-2" placeholder="Ej: Taller Costura 1 / Cliente X">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-600 uppercase">Responsable</label>
                    <input type="text" id="moveResponsible" class="w-full border rounded p-2">
                </div>
            </div>

            <div class="flex justify-end pt-6 mt-2">
                <button onclick="closeModal('moveStockModal')" class="mr-3 text-slate-500 font-bold text-sm btn-mobile">Cancelar</button>
                <button onclick="executeStockMove()" class="bg-yellow-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-yellow-700 transition btn-mobile">Confirmar e Imprimir</button>
            </div>
        </div>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg w-full max-w-4xl p-6 h-5/6 flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-slate-800" id="orderModalTitle">Nueva Orden de Compra</h3>
                <button onclick="closeModal('orderModal')" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            
            <div class="flex-1 overflow-y-auto pr-2">
                <form id="orderForm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 bg-slate-50 p-4 rounded border border-slate-200">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase">ID Orden</label><input type="text" id="orderId" class="w-full bg-white border rounded px-3 py-2 font-mono focus:border-blue-500 outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase">Cliente</label><input type="text" id="orderClient" class="w-full bg-white border rounded px-3 py-2 focus:border-blue-500 outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase">F. Entrega</label><input type="date" id="orderDate" class="w-full bg-white border rounded px-3 py-2 focus:border-blue-500 outline-none"></div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-bold text-slate-700 mb-2 border-b pb-1">Agregar Productos</h4>
                        <div class="flex flex-col md:flex-row gap-2 mb-3">
                            <select id="orderProductSelect" class="flex-1 border rounded p-2 text-sm focus:border-blue-500 outline-none" onchange="updateOrderSizeInputs()"><option value="">Seleccione Producto...</option></select>
                            <button type="button" onclick="addProductToOrder()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 shadow flex items-center justify-center btn-mobile">
                                <i class="fas fa-plus mr-1"></i> Agregar
                            </button>
                        </div>
                        
                        <div id="orderSizeInputs" class="flex flex-wrap gap-2 items-end hidden bg-blue-50 p-3 rounded mb-2 border border-blue-100"></div>
                        
                        <div id="orderItemNoteContainer" class="hidden mt-2">
                             <input type="text" id="addOrder_Note" placeholder="Nota específica para este producto (ej: Logo bordado, basta +2cm)..." class="w-full border-2 border-yellow-200 rounded px-3 py-2 text-sm bg-yellow-50 focus:border-yellow-400 outline-none text-yellow-900 placeholder-yellow-600">
                        </div>
                    </div>

                    <div class="bg-white border rounded shadow-inner min-h-[150px] overflow-hidden">
                        <table class="min-w-full text-sm">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr><th class="px-4 py-2 text-left">Producto / Nota</th><th class="px-4 py-2 text-center">Cantidades</th><th class="px-4 py-2 text-right">Total</th><th class="px-4 py-2"></th></tr>
                            </thead>
                            <tbody id="orderItemsList"></tbody>
                        </table>
                        <div id="no-order-items" class="text-center p-8 text-slate-400 text-sm italic">Sin productos agregados.</div>
                    </div>
                </form>
            </div>

            <div class="pt-4 border-t flex justify-end">
                <button type="button" onclick="closeModal('orderModal')" class="mr-3 text-slate-500 font-bold hover:text-slate-700 btn-mobile">Cancelar</button>
                <button type="button" onclick="saveOrder()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-700 transform active:scale-95 transition btn-mobile">Guardar Orden</button>
            </div>
        </div>
    </div>

    <div id="dispatchModal" class="fixed inset-0 bg-slate-900 bg-opacity-80 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 border-t-8 border-green-600 shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-slate-800">Finalizar Despacho</h3>
            
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-600 uppercase">Nro Factura</label><input type="text" id="dispInv" class="w-full border-2 border-green-100 rounded p-2 focus:border-green-500 outline-none"></div>
                <div><label class="text-xs font-bold text-slate-600 uppercase">Cantidad Cajas</label><input type="number" id="dispBox" class="w-full border-2 border-green-100 rounded p-2 focus:border-green-500 outline-none"></div>
                
                <div class="bg-slate-100 p-3 rounded border border-dashed border-slate-400 text-center">
                    <label class="text-xs font-bold text-slate-600 block mb-2 cursor-pointer">
                        <i class="fas fa-camera text-2xl mb-1 block text-slate-400"></i>
                        FOTO TACHA FIRMADA (Evidencia)
                    </label>
                    <input type="file" id="dispPhoto" class="w-full text-xs" accept="image/*" capture="environment">
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button onclick="closeModal('dispatchModal')" class="mr-3 text-slate-500 font-bold btn-mobile">Cancelar</button>
                <button onclick="confirmDispatch()" class="bg-green-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-green-700 transition btn-mobile">DESPACHAR</button>
            </div>
        </div>
    </div>

    <div id="printOcModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold mb-4 text-slate-800 text-lg border-b pb-2">Datos para Tacha (OC)</h3>
            <div class="space-y-3">
                <input type="text" id="printBultos" placeholder="Nro Bultos (Manual)" class="w-full border rounded p-2 text-sm focus:border-blue-500 outline-none">
                <input type="text" id="printCarrier" placeholder="Quién Lleva (Chofer)" class="w-full border rounded p-2 text-sm focus:border-blue-500 outline-none">
                <input type="text" id="printReceiver" placeholder="Quién Recibe" class="w-full border rounded p-2 text-sm focus:border-blue-500 outline-none">
            </div>
            <button onclick="executePrintOc()" class="w-full bg-slate-800 hover:bg-black text-white py-3 rounded font-bold mt-6 shadow-lg transition transform active:scale-95 btn-mobile">
                <i class="fas fa-print mr-2"></i> IMPRIMIR
            </button>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-4 rounded-lg shadow-lg w-full max-w-xs">
            <h3 class="font-bold mb-2 text-slate-800">Nota del Día</h3>
            <textarea id="calendarNoteText" class="w-full border rounded p-2 mb-2 bg-yellow-50 focus:outline-none focus:bg-white transition" rows="3"></textarea>
            <div class="flex justify-end"><button onclick="saveCalendarNote()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold shadow hover:bg-blue-700 btn-mobile">Guardar</button></div>
        </div>
    </div>

    <div id="loading-toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-4 rounded shadow-2xl z-[100] hidden items-center animate-pulse">
        <i class="fas fa-brain fa-spin mr-3 text-purple-400"></i> <span id="loading-text">Cargando Cerebro IA...</span>
    </div>

    <div id="print-area" class="print-only"></div>

    <script>
        // --- 1. GESTIÓN DE DATOS ---
        // Recuperamos datos del almacenamiento local o iniciamos vacíos
        let inventory = JSON.parse(localStorage.getItem('ww_inventory')) || [];
        let orders = JSON.parse(localStorage.getItem('ww_orders')) || [];
        let calendarNotes = JSON.parse(localStorage.getItem('ww_notes')) || {};
        let productionWorks = JSON.parse(localStorage.getItem('ww_production_works')) || [];
        
        // Variables Temporales de Sesión
        let tempOrderItems = [];
        let currentDispatchId = null;
        let currentDate = new Date();
        let currentNoteDate = null;
        let editingOrderIdx = null; 
        let editingProdIdx = null;
        let currentMoveIdx = null;
        let currentMoveType = null;
        let currentPrintList = []; // Lista para impresión masiva

        const defaultSizes = ['S', 'M', 'L', 'XL', 'XXL'];

        // --- 2. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            showSection('inventory'); 
            renderInventory();
            renderProductionDashboard();
            updateAnalysis();
            document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('es-CL', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        });

        // --- 3. UI Y NAVEGACIÓN ---
        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'orders') renderOrders();
            if(id === 'calendar') renderCalendar();
            if(id === 'analysis') updateAnalysis();
            // Cerrar menú móvil
            if(window.innerWidth < 768) {
                const sb = document.getElementById('sidebar');
                if(!sb.classList.contains('-translate-x-full')) sb.classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full'); ov.classList.add('hidden');
            }
        }

        // --- 4. PRODUCCIÓN (WORKFLOW POR ETAPAS) ---
        function openProductionModal() { document.getElementById('prodWorkName').value = ''; document.getElementById('prodWorkQty').value = ''; document.getElementById('prodItemModal').classList.remove('hidden'); }
        
        function createWorkOrder() {
            const name = document.getElementById('prodWorkName').value;
            const qty = parseInt(document.getElementById('prodWorkQty').value) || 0;
            if(!name || qty <= 0) return alert("Nombre y cantidad requeridos");
            
            const newWork = {
                id: Date.now(), name: name, qty: qty,
                stages: [
                    { key: 'corte', label: 'Corte', done: false, resp: '' },
                    { key: 'confeccion', label: 'Confección', done: false, resp: '' },
                    { key: 'bordado', label: 'Bordado', done: false, resp: '' },
                    { key: 'bodega', label: 'A Bodega', done: false, resp: '' }
                ]
            };
            productionWorks.push(newWork);
            localStorage.setItem('ww_production_works', JSON.stringify(productionWorks));
            renderProductionDashboard();
            closeModal('prodItemModal');
        }

        function renderProductionDashboard() {
            const container = document.getElementById('production-grid');
            container.innerHTML = '';
            
            productionWorks.forEach((work, workIdx) => {
                const completed = work.stages.filter(s => s.done).length;
                const progress = Math.round((completed / 4) * 100);
                let stagesHtml = '';
                work.stages.forEach((stage, stageIdx) => {
                    const isDone = stage.done;
                    const icon = isDone ? 'fa-check-circle' : 'fa-circle';
                    stagesHtml += `
                    <div class="stage-row ${isDone ? 'completed' : 'pending'}">
                        <div class="flex items-center cursor-pointer" onclick="toggleStage(${workIdx}, ${stageIdx})">
                            <i class="fas ${icon} mr-2 ${isDone ? 'text-green-600' : 'text-slate-300'}"></i>
                            <span class="text-xs font-bold ${isDone ? 'text-green-800' : 'text-slate-500'}">${stage.label}</span>
                        </div>
                        <input type="text" placeholder="Resp." value="${stage.resp}" class="text-[10px] w-20 bg-white border rounded px-1" onchange="updateResp(${workIdx}, ${stageIdx}, this.value)" onclick="event.stopPropagation()">
                    </div>`;
                });
                container.innerHTML += `
                <div class="bg-white rounded-lg shadow border border-slate-200 p-4 transition hover:shadow-md">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="font-bold text-slate-700 text-sm uppercase">${work.name}</h4><p class="text-xs text-slate-500 font-mono">ID: ${work.id} | <strong>${work.qty} Unid.</strong></p></div>
                        <button onclick="deleteWork(${workIdx})" class="text-slate-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2 mb-4 overflow-hidden"><div class="bg-orange-500 h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div></div>
                    <div class="space-y-1">${stagesHtml}</div>
                </div>`;
            });
        }

        function toggleStage(workIdx, stageIdx) {
            const work = productionWorks[workIdx];
            const stage = work.stages[stageIdx];
            if(stage.key === 'bodega' && !stage.done) {
                if(!confirm(`¿Finalizar "${work.name}" e ingresar ${work.qty} unidades?`)) return;
                const targetName = prompt("Nombre exacto para Inventario:", work.name);
                if(!targetName) return;
                addToInventoryFromProduction(targetName, work.qty);
                stage.done = true; stage.resp = "SISTEMA";
                if(confirm("Lote ingresado. ¿Eliminar de la lista?")) { deleteWork(workIdx); return; }
            } else { stage.done = !stage.done; }
            localStorage.setItem('ww_production_works', JSON.stringify(productionWorks));
            renderProductionDashboard();
        }

        function updateResp(idx, sIdx, val) { productionWorks[idx].stages[sIdx].resp = val; localStorage.setItem('ww_production_works', JSON.stringify(productionWorks)); }
        function deleteWork(idx) { if(confirm("¿Eliminar orden de trabajo?")) { productionWorks.splice(idx, 1); localStorage.setItem('ww_production_works', JSON.stringify(productionWorks)); renderProductionDashboard(); } }

        function addToInventoryFromProduction(name, qty) {
            const existingIdx = inventory.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
            if (existingIdx >= 0) {
                inventory[existingIdx].total += qty;
                if(!inventory[existingIdx].hasSizes) inventory[existingIdx].stockData.unique += qty;
                alert(`✅ Se sumaron ${qty} unidades a "${inventory[existingIdx].name}".`);
            } else {
                let nextId = inventory.length + 1;
                inventory.push({ sku: `WW-PROD-${String(nextId).padStart(3,'0')}`, name: name, hasSizes: false, stockData: { unique: qty }, total: qty });
                alert(`✅ Se creó "${name}" con ${qty} unidades.`);
            }
            localStorage.setItem('ww_inventory', JSON.stringify(inventory)); renderInventory();
        }

        // --- 5. INVENTARIO ---
        function openProductModal(idx = null) {
            document.getElementById('productForm').reset(); editingProdIdx = idx;
            if(idx !== null) {
                let p = inventory[idx];
                document.getElementById('productModalTitle').innerText = "Editar: " + p.name;
                document.getElementById('prodSku').value = p.sku; document.getElementById('prodName').value = p.name;
                document.getElementById('hasSizes').checked = p.hasSizes; toggleSizeInputs();
                if(p.hasSizes) renderDynamicSizeInputs(Object.keys(p.stockData), p.stockData); else document.getElementById('stockUnique').value = p.total;
            } else {
                document.getElementById('productModalTitle').innerText = "Nuevo Item";
                document.getElementById('prodSku').value = 'WW-' + String(inventory.length + 1).padStart(4,'0');
                renderDynamicSizeInputs(defaultSizes, {}); toggleSizeInputs();
            }
            document.getElementById('productModal').classList.remove('hidden');
        }

        function renderDynamicSizeInputs(sizes, vals) {
            let c = document.getElementById('dynamicSizeContainer'); c.innerHTML = '';
            sizes.forEach(s => {
                let v = vals[s] || 0;
                c.innerHTML += `<div class="flex flex-col items-center"><label class="text-[10px] font-bold text-slate-500">${s}</label><input type="number" name="size_${s}" value="${v}" data-size="${s}" class="size-input w-full border text-center p-1 text-sm rounded"></div>`;
            });
        }
        function addCustomSizeInput() {
            let s = prompt("Nombre Talla Nueva:");
            if(s) { s = s.toUpperCase().trim(); let c = document.getElementById('dynamicSizeContainer'); c.innerHTML += `<div class="flex flex-col items-center"><label class="text-[10px] font-bold text-blue-600">${s}</label><input type="number" name="size_${s}" value="0" data-size="${s}" class="size-input w-full border-2 border-blue-100 text-center p-1 text-sm rounded"></div>`; }
        }
        function toggleSizeInputs() {
            let on = document.getElementById('hasSizes').checked;
            document.getElementById('dynamicSizeContainer').classList.toggle('hidden', !on);
            document.getElementById('singleStockInput').classList.toggle('hidden', on);
            document.getElementById('btnAddSize').classList.toggle('hidden', !on);
        }
        document.getElementById('productForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if(editingProdIdx !== null) { if(!prompt("AUDITORÍA: Motivo del cambio?")) return alert("Motivo requerido."); }
            let name = document.getElementById('prodName').value;
            let hasSizes = document.getElementById('hasSizes').checked;
            let stockData = {}, total = 0;
            if(hasSizes) {
                document.querySelectorAll('.size-input').forEach(i => {
                    let v = parseInt(i.value) || 0;
                    if(v > 0 || defaultSizes.includes(i.dataset.size)) { stockData[i.dataset.size] = v; total += v; }
                });
            } else { total = parseInt(document.getElementById('stockUnique').value) || 0; stockData = { unique: total }; }
            let item = { sku: document.getElementById('prodSku').value, name, hasSizes, stockData, total };
            if(editingProdIdx !== null) inventory[editingProdIdx] = item; else inventory.push(item);
            localStorage.setItem('ww_inventory', JSON.stringify(inventory)); closeModal('productModal'); renderInventory();
        });

        function renderInventory() {
            let t = document.getElementById('inventory-table-body'); t.innerHTML = '';
            if(inventory.length === 0) { document.getElementById('empty-inventory').classList.remove('hidden'); return; }
            document.getElementById('empty-inventory').classList.add('hidden');
            inventory.forEach((p, i) => {
                let sizeHtml = p.hasSizes ? Object.entries(p.stockData).map(([k,v]) => `<span class="text-[10px] bg-slate-100 border px-1 rounded mx-1">${k}:${v}</span>`).join('') : '<span class="text-xs text-slate-400">Único</span>';
                // Corrección de los botones + y - para que funcionen con el índice 'i'
                t.innerHTML += `<tr class="border-b hover:bg-slate-50 transition"><td class="px-5 py-3 text-xs font-mono text-slate-500 font-bold">${p.sku}</td><td class="px-5 py-3 text-sm font-bold text-slate-800">${p.name}</td><td class="px-5 py-3 text-center flex flex-wrap justify-center gap-1">${sizeHtml}</td><td class="px-5 py-3 text-right text-sm font-black ${p.total < 10 ? 'text-red-600' : 'text-green-600'}">${p.total}</td><td class="px-5 py-3 text-center"><div class="flex justify-center space-x-2"><button onclick="openMoveStock(${i}, 'in')" class="bg-green-100 text-green-700 w-8 h-8 rounded-full font-bold hover:bg-green-200 shadow-sm">+</button><button onclick="openMoveStock(${i}, 'out')" class="bg-red-100 text-red-700 w-8 h-8 rounded-full font-bold hover:bg-red-200 shadow-sm">-</button></div></td><td class="px-5 py-3 text-center"><button onclick="openProductModal(${i})" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pencil-alt"></i></button><button onclick="deleteInv(${i})" class="text-red-400 hover:text-red-600 p-2"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            updateOrderProductSelect();
        }
        function deleteInv(i) { if(confirm("¿Eliminar?")) { inventory.splice(i, 1); localStorage.setItem('ww_inventory', JSON.stringify(inventory)); renderInventory(); } }

        // --- 6. MOVIMIENTOS ---
        function openMoveStock(idx, type) {
            currentMoveIdx = idx; currentMoveType = type;
            document.getElementById('moveQty').value = ''; document.getElementById('moveDestination').value = ''; document.getElementById('moveResponsible').value = '';
            document.getElementById('moveStockModal').classList.remove('hidden');
        }
        function executeStockMove() {
            let q = parseInt(document.getElementById('moveQty').value) || 0, dest = document.getElementById('moveDestination').value, resp = document.getElementById('moveResponsible').value;
            if(q <= 0 || !dest || !resp) return alert("Datos obligatorios.");
            let p = inventory[currentMoveIdx];
            if(currentMoveType === 'out' && p.total < q) return alert("Stock insuficiente.");
            if(currentMoveType === 'in') { p.total += q; if(!p.hasSizes) p.stockData.unique += q; } else { p.total -= q; if(!p.hasSizes) p.stockData.unique -= q; }
            localStorage.setItem('ww_inventory', JSON.stringify(inventory));
            document.getElementById('print-area').innerHTML = `<div class="inv-tacha"><h1 style="text-align:center; border-bottom: 2px solid black;">CONTROL BODEGA</h1><p>MOVIMIENTO: ${currentMoveType === 'in' ? 'INGRESO' : 'SALIDA'}</p><p>PRODUCTO: ${p.name}</p><p>CANTIDAD: ${q}</p><p>DESTINO: ${dest}</p><p>RESPONSABLE: ${resp}</p><br><div style="text-align:center; border-top:1px solid black">FIRMA</div></div>`;
            window.print(); closeModal('moveStockModal'); renderInventory();
        }

        // --- 7. ÓRDENES ---
        function openOrderModal(idx = null) {
            document.getElementById('orderForm').reset(); editingOrderIdx = idx; tempOrderItems = [];
            document.getElementById('orderSizeInputs').innerHTML = ''; document.getElementById('orderItemsList').innerHTML = '';
            document.getElementById('orderSizeInputs').classList.add('hidden'); document.getElementById('orderItemNoteContainer').classList.add('hidden');
            if(idx !== null) {
                let o = orders[idx]; document.getElementById('orderModalTitle').innerText = "Editar OC: " + o.id;
                document.getElementById('orderId').value = o.id; document.getElementById('orderClient').value = o.client; document.getElementById('orderDate').value = o.date;
                tempOrderItems = JSON.parse(JSON.stringify(o.items)); renderOrderItems();
            } else { document.getElementById('orderModalTitle').innerText = "Nueva OC"; }
            document.getElementById('orderModal').classList.remove('hidden');
        }
        function updateOrderProductSelect() { let s = document.getElementById('orderProductSelect'); s.innerHTML = '<option value="">Seleccione...</option>'; inventory.forEach((p, i) => s.innerHTML += `<option value="${i}">${p.sku} - ${p.name}</option>`); }
        function updateOrderSizeInputs() {
            let idx = document.getElementById('orderProductSelect').value, c = document.getElementById('orderSizeInputs'), n = document.getElementById('orderItemNoteContainer'); c.innerHTML = '';
            if(!idx) { c.classList.add('hidden'); n.classList.add('hidden'); return; }
            c.classList.remove('hidden'); n.classList.remove('hidden');
            let p = inventory[idx];
            if(p.hasSizes) { Object.keys(p.stockData).forEach(k => { c.innerHTML += `<div class="flex flex-col"><span class="text-[9px] font-bold text-center">${k}</span><input type="number" data-size="${k}" class="oc-size w-10 text-center border p-1 text-xs rounded"></div>`; }); } 
            else { c.innerHTML = `<div class="flex flex-col flex-1"><span class="text-[9px] font-bold">Cantidad</span><input type="number" id="ocUniqueQty" class="w-full text-center border p-1 text-xs rounded"></div>`; }
        }
        function addProductToOrder() {
            let idx = document.getElementById('orderProductSelect').value; if(!idx) return;
            let p = inventory[idx], note = document.getElementById('addOrder_Note').value;
            let item = { name: p.name, sku: p.sku, hasSizes: p.hasSizes, quantities: {}, total: 0, note: note };
            if(p.hasSizes) { document.querySelectorAll('.oc-size').forEach(i => { let v = parseInt(i.value) || 0; if(v > 0) { item.quantities[i.dataset.size] = v; item.total += v; } }); } 
            else { item.total = parseInt(document.getElementById('ocUniqueQty').value) || 0; item.quantities.unique = item.total; }
            if(item.total > 0) { tempOrderItems.push(item); renderOrderItems(); }
        }
        function renderOrderItems() {
            let l = document.getElementById('orderItemsList'); l.innerHTML = '';
            tempOrderItems.forEach((it, i) => {
                let det = it.hasSizes ? Object.entries(it.quantities).map(([k,v])=>`${k}:${v}`).join(', ') : it.total;
                let noteHtml = it.note ? `<div class="text-[10px] text-blue-600 bg-blue-50 px-1 rounded inline-block">${it.note}</div>` : '';
                l.innerHTML += `<tr class="border-b"><td class="px-4 py-2 font-bold">${it.name} <br> ${noteHtml}</td><td class="px-4 py-2 text-center text-xs">${det}</td><td class="px-4 py-2 text-right font-bold">${it.total}</td><td class="px-4 py-2 text-right"><button onclick="tempOrderItems.splice(${i},1);renderOrderItems()" class="text-red-400">×</button></td></tr>`;
            });
        }
        function saveOrder() {
            let id = document.getElementById('orderId').value; if(!id || tempOrderItems.length === 0) return alert("Faltan datos");
            let obj = { id, client: document.getElementById('orderClient').value, date: document.getElementById('orderDate').value, items: tempOrderItems, status: editingOrderIdx !== null ? orders[editingOrderIdx].status : 'Pendiente', evidence: editingOrderIdx !== null ? orders[editingOrderIdx].evidence : '' };
            if(editingOrderIdx !== null) orders[editingOrderIdx] = obj; else orders.push(obj);
            localStorage.setItem('ww_orders', JSON.stringify(orders)); closeModal('orderModal'); renderOrders();
        }
        function renderOrders() {
            let t = document.getElementById('orders-table-body'); t.innerHTML = '';
            if(orders.length === 0) { document.getElementById('empty-orders').classList.remove('hidden'); return; }
            document.getElementById('empty-orders').classList.add('hidden');
            orders.forEach((o, i) => {
                let st = o.status, color = st==='Despachado'?'bg-green-600 text-white':st==='Pendiente'?'bg-slate-200 text-slate-600':'bg-blue-100 text-blue-800';
                let notesSum = o.items.filter(it => it.note).map(it => `<span class="block text-[9px] text-gray-500">• ${it.note}</span>`).join('');
                t.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="p-3 text-center"><input type="checkbox" class="oc-check" value="${i}"></td><td class="px-4 py-3 font-bold text-xs">${o.id}</td><td class="px-4 py-3 text-xs">${o.client}</td><td class="px-4 py-3 text-xs">${o.date}</td><td class="px-4 py-3 text-center"><button onclick="cycleStatus(${i})" class="${color} px-2 py-1 rounded text-[10px] font-bold shadow uppercase">${st}</button></td><td class="px-4 py-3 text-xs"><span class="font-bold">${o.items.length} items</span>${notesSum}</td><td class="px-4 py-3 text-center flex justify-center gap-2"><button onclick="openPrintOcSingle(${i})" class="text-slate-600"><i class="fas fa-print"></i></button><button onclick="openOrderModal(${i})" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteOrd(${i})" class="text-red-400"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }
        function cycleStatus(i) {
            let s = ['Pendiente','En Producción','Listo','Despachado'], n = s.indexOf(orders[i].status)+1;
            if(s[n]==='Despachado'){ currentDispatchId=i; document.getElementById('dispatchModal').classList.remove('hidden'); }
            else { orders[i].status=s[n]||s[0]; localStorage.setItem('ww_orders', JSON.stringify(orders)); renderOrders(); }
        }
        function confirmDispatch() {
            let f=document.getElementById('dispPhoto').files[0], r=new FileReader();
            r.onload=e=>{ orders[currentDispatchId].status='Despachado'; orders[currentDispatchId].invoice=document.getElementById('dispInv').value; orders[currentDispatchId].boxes=document.getElementById('dispBox').value; orders[currentDispatchId].evidence=f?e.target.result:null; localStorage.setItem('ww_orders',JSON.stringify(orders)); closeModal('dispatchModal'); renderOrders(); renderCalendar(); }; if(f)r.readAsDataURL(f); else r.onload({target:{result:null}});
        }
        function deleteOrd(i) { if(confirm("¿Borrar?")) { orders.splice(i, 1); localStorage.setItem('ww_orders', JSON.stringify(orders)); renderOrders(); } }
        function toggleAllOCs(el) { document.querySelectorAll('.oc-check').forEach(c => c.checked = el.checked); }
        function printSelectedTachas() { let sel=[]; document.querySelectorAll('.oc-check:checked').forEach(c => sel.push(parseInt(c.value))); if(sel.length===0)return alert("Selecciona OC"); currentPrintList=sel; document.getElementById('printOcModal').classList.remove('hidden'); }
        function openPrintOcSingle(i) { currentPrintList=[i]; document.getElementById('printOcModal').classList.remove('hidden'); }
        function executePrintOc() {
            let b=document.getElementById('printBultos').value, c=document.getElementById('printCarrier').value, r=document.getElementById('printReceiver').value, html=`<div class="multitacha-grid">`;
            currentPrintList.forEach(idx => {
                let o = orders[idx];
                o.items.forEach(it => {
                    let sizes = it.hasSizes ? Object.entries(it.quantities).map(([k,v])=>`<b>${k}:</b>${v}`).join(' ') : `Cant: ${it.total}`;
                    html += `<div class="tacha-card"><div style="border-bottom:2px solid black;"><span>OC: ${o.id}</span><span style="float:right">${o.client}</span></div><div style="flex-grow:1"><h2 style="font-size:16px;font-weight:bold">${it.name}</h2><p>${sizes}</p><p style="font-style:italic; font-size:10px;">${it.note||''}</p></div><div style="border-top:1px solid black"><div style="display:grid;grid-template-columns:1fr 1fr"><span>Bultos: ${b}</span><span>Chofer: ${c}</span></div><div style="text-align:center;margin-top:5px">FIRMA</div></div></div>`;
                });
            });
            html += `</div>`; document.getElementById('print-area').innerHTML = html; window.print(); closeModal('printOcModal');
        }

        // --- CALENDARIO ---
        function renderCalendar() {
            let g = document.getElementById('calendar-grid'), m = currentDate.getMonth(), y = currentDate.getFullYear(); g.innerHTML = '';
            let months = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
            document.getElementById('calendar-header').innerText = `${months[m]} ${y}`;
            let f = new Date(y, m, 1).getDay(), d = new Date(y, m + 1, 0).getDate(), today = new Date(), nextW = new Date(); nextW.setDate(today.getDate() + 7);
            let alertHtml = '';
            for(let i=0; i<f; i++) g.innerHTML += `<div class="bg-gray-100"></div>`;
            for(let i=1; i<=d; i++) {
                let k = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`, dateObj = new Date(y, m, i), isT = (i === today.getDate() && m === today.getMonth());
                let ocEvents = orders.filter(o => o.date === k).map(o => `<div class="text-[9px] bg-blue-100 text-blue-800 rounded px-1 mb-1 truncate">OC:${o.client}</div>`).join('');
                let shEvents = orders.filter(o => o.status === 'Despachado' && o.date === k).map(o => `<div class="text-[9px] bg-green-100 text-green-800 rounded px-1 mb-1 font-bold truncate">📦${o.client}</div>`).join('');
                let nEvent = calendarNotes[k] ? `<div class="text-[9px] bg-yellow-100 text-yellow-800 rounded px-1 truncate">📝 Nota</div>` : '';
                if(dateObj >= today && dateObj <= nextW && ocEvents) alertHtml += `<div class="bg-blue-50 border-l-4 border-blue-400 p-2 mb-1 text-xs">📅 ${i}/${m+1}: Entregas pendientes</div>`;
                g.innerHTML += `<div class="calendar-day group ${isT?'today':''}" onclick="openNoteModal('${k}')"><div class="flex justify-between"><span class="day-number ${isT?'today-num':''}">${i}</span></div><div class="flex-1 overflow-y-auto">${ocEvents}${shEvents}${nEvent}</div></div>`;
            }
            let ab = document.getElementById('calendar-alerts'); if(alertHtml){ ab.innerHTML = alertHtml; ab.classList.remove('hidden'); } else ab.classList.add('hidden');
        }
        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); }
        function openNoteModal(d) { currentNoteDate = d; document.getElementById('calendarNoteText').value = calendarNotes[d] || ''; document.getElementById('noteModal').classList.remove('hidden'); }
        function saveCalendarNote() { let t = document.getElementById('calendarNoteText').value; if(t) calendarNotes[currentNoteDate] = t; else delete calendarNotes[currentNoteDate]; localStorage.setItem('ww_notes', JSON.stringify(calendarNotes)); closeModal('noteModal'); renderCalendar(); }

        // --- IA ROBUSTA ---
        async function processInventoryFile(i) { await runAI(i, 'inv'); }
        async function processOrdersFile(i) { await runAI(i, 'oc'); }
        async function runAI(inp, mode) {
            let f = inp.files[0]; if(!f) return;
            document.getElementById('loading-toast').classList.remove('hidden'); document.getElementById('loading-toast').classList.add('flex');
            try {
                let text = "";
                if(f.type.includes('pdf')) {
                    let d = await f.arrayBuffer(), p = await pdfjsLib.getDocument(d).promise;
                    for(let i=1; i<=p.numPages; i++) { let pg = await p.getPage(i), c = await pg.getTextContent(); text += c.items.map(s => s.str).join(" ") + "\n"; }
                    mode === 'inv' ? parseTxtInv(text) : parseTxtOc(text);
                } else if(f.type.includes('image')) {
                    let r = await Tesseract.recognize(f, 'spa');
                    mode === 'inv' ? parseTxtInv(r.data.text) : parseTxtOc(r.data.text);
                } else {
                    let d = await f.arrayBuffer(), wb = XLSX.read(d), j = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    mode === 'inv' ? parseXlsInv(j) : parseComplexOrderExcel(j);
                }
            } catch(e) { alert("Error IA: " + e.message); } 
            finally { document.getElementById('loading-toast').classList.add('hidden'); document.getElementById('loading-toast').classList.remove('flex'); inp.value = ''; }
        }
        function parseTxtInv(t) {
            let c = 0;
            t.split('\n').forEach(l => { if(l.match(/\d+/)) { let n = l.match(/\d+/g), q = parseInt(n.pop()), nm = l.replace(q, '').trim(); if(nm.length > 3) { inventory.push({sku: 'IA-'+Date.now()+c, name: nm, hasSizes: false, stockData: {unique: q}, total: q}); c++; } } });
            localStorage.setItem('ww_inventory', JSON.stringify(inventory)); renderInventory(); alert("IA: " + c + " items.");
        }
        function parseTxtOc(t) {
            let matches = t.match(/4500\d+/g) || [];
            let uniqueIds = [...new Set(matches)];
            uniqueIds.forEach(id => orders.push({id, client: 'IA Detect', date: new Date().toISOString().split('T')[0], status: 'Pendiente', items: [{name: 'Revisar Detalle', total: 0, hasSizes: false, quantities: {}}], invoice: '', evidence: ''}));
            localStorage.setItem('ww_orders', JSON.stringify(orders)); renderOrders(); alert("IA: " + uniqueIds.length + " OCs.");
        }
        function parseComplexOrderExcel(r) {
            let map = {}, c = 0;
            r.forEach((x, i) => {
                if(i > 0 && x[1]) {
                    let id = String(x[1]).trim(), p = x[4], s = x[5] || 'U', q = parseInt(x[6]) || 0;
                    if(id && p && q > 0) {
                        if(!map[id]) { map[id] = {id, client: x[3], date: new Date().toISOString().split('T')[0], status: 'Pendiente', items: []}; c++; }
                        let ex = map[id].items.find(i => i.name === p);
                        if(ex) { if(ex.hasSizes) { ex.quantities[s] = (ex.quantities[s] || 0) + q; ex.totalItem += q; } } 
                        else { let ni = {name: p, hasSizes: true, quantities: {}, totalItem: q, note: ''}; ni.quantities[s] = q; map[id].items.push(ni); }
                    }
                }
            });
            Object.values(map).forEach(o => orders.push(o)); localStorage.setItem('ww_orders', JSON.stringify(orders)); renderOrders(); alert("Excel: " + c + " OCs.");
        }
        function parseXlsInv(r) {
            let c = 0; r.forEach((x, i) => { if(i > 0 && x[0]) { inventory.push({sku: 'XLS-'+i, name: x[0], hasSizes: false, stockData: {unique: parseInt(x[1]) || 0}, total: parseInt(x[1]) || 0}); c++; } });
            localStorage.setItem('ww_inventory', JSON.stringify(inventory)); renderInventory(); alert("Excel: " + c + " items.");
        }

        // --- UTILS ---
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function confirmFullReset() { if(confirm("⚠ BORRAR TODO. Se descargará respaldo.")) { html2pdf().from(document.body).save('Respaldo_WW.pdf'); setTimeout(() => { if(confirm("Confirmar borrado")) { localStorage.clear(); location.reload(); } }, 2000); } }
        function generateCompanyReport() { window.print(); }
        function updateAnalysis() { document.getElementById('ia-production-count').innerText = productionWorks.length; document.getElementById('ia-shipped-count').innerText = orders.filter(o => o.status === 'Despachado').length; 
            let sList = document.getElementById('ia-suggestion-list'); sList.innerHTML = ''; inventory.filter(p => p.total < 10).forEach(p => sList.innerHTML += `<div class="p-2 border-b text-xs flex justify-between bg-red-50 text-red-700"><span>${p.name}</span> <strong>${p.total}</strong></div>`);
        }

    </script>
</body>
</html>
