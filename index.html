<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel de Producci√≥n | Ideas Textiles</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS PROFESIONALES --- */
        :root {
            --primary: #2563eb;       /* Azul Moderno */
            --primary-dark: #1e40af;  /* Azul Oscuro */
            --bg-body: #f3f4f6;       /* Gris muy suave fondo */
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif; /* Fuente Premium */
            background: var(--bg-body);
            color: var(--text-main);
            padding: 20px;
            padding-bottom: 80px;
            line-height: 1.5;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        /* HEADER ELEGANTE */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; background: white; padding: 15px 20px; 
            border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .brand { font-weight: 800; font-size: 1.2em; color: var(--primary-dark); letter-spacing: -0.5px; }
        .date-badge { 
            background: #eff6ff; color: var(--primary); padding: 6px 12px; 
            border-radius: 30px; font-weight: 600; font-size: 0.85em; 
        }

        /* 1. KPIs (M√©tricas) */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;
        }
        .kpi-card {
            background: var(--card-bg); padding: 20px 15px; border-radius: 16px;
            text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-2px); }
        .kpi-number { font-size: 1.8em; font-weight: 800; color: var(--text-main); line-height: 1.1; }
        .kpi-label { font-size: 0.75em; text-transform: uppercase; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; margin-top: 5px; }

        /* 2. BUSCADOR (LUPA) */
        .search-wrapper { position: relative; margin-bottom: 25px; }
        .search-icon { 
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%); 
            font-size: 1.2em; opacity: 0.5; 
        }
        .search-input {
            width: 100%; padding: 16px 20px 16px 50px; 
            border: 2px solid transparent; border-radius: 12px;
            background: white; font-family: 'Inter', sans-serif; font-size: 1em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); outline: none; transition: 0.3s;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 4px 20px rgba(37, 99, 235, 0.1); }

        /* TABS NAVEGACI√ìN */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab {
            padding: 8px 20px; background: white; border-radius: 30px; border: 1px solid #e5e7eb;
            color: var(--text-muted); font-weight: 600; font-size: 0.9em; cursor: pointer; white-space: nowrap;
        }
        .tab.active { background: var(--text-main); color: white; border-color: var(--text-main); }
        .refresh-icon { font-size: 1.2em; vertical-align: middle; }

        /* TARJETAS DE ORDEN */
        .order-card {
            background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04); position: relative;
        }
        .card-top { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .client-tag { 
            font-size: 0.75em; text-transform: uppercase; font-weight: 700; 
            color: var(--primary); background: #eff6ff; padding: 4px 8px; border-radius: 6px; 
        }
        .order-title { font-size: 1.4em; font-weight: 800; margin-top: 8px; color: var(--text-main); }
        .price-tag { font-weight: 600; color: var(--text-muted); font-size: 0.95em; }

        /* BARRA DE PROGRESO MINIMALISTA */
        .progress-container { margin: 20px 0; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 0.85em; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; }
        .bar-track { width: 100%; height: 10px; background: #f3f4f6; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 1s ease; }
        
        .bg-low { background: var(--warning); }
        .bg-mid { background: #3b82f6; }
        .bg-high { background: var(--success); }

        /* BOT√ìN WHATSAPP */
        .btn-wa {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; background: #25D366; color: white; text-decoration: none;
            padding: 14px; border-radius: 12px; font-weight: 700; margin-top: 20px;
            transition: transform 0.1s;
        }
        .btn-wa:active { transform: scale(0.98); }

        /* TABLA LIMPIA */
        .table-scroll { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; font-size: 0.75em; color: var(--text-muted); text-transform: uppercase; padding: 10px; border-bottom: 2px solid #f3f4f6; }
        td { padding: 12px 10px; border-bottom: 1px solid #f9fafb; font-size: 0.9em; vertical-align: middle; }
        
        .product-name { font-weight: 600; color: var(--text-main); }
        .pill { padding: 4px 10px; border-radius: 20px; font-size: 0.7em; font-weight: 700; text-transform: uppercase; }
        .pill-gray { background: #f3f4f6; color: #4b5563; }
        .pill-status { background: #eef2ff; color: #4f46e5; }
        
        /* BIT√ÅCORA */
        .notebook { background: #fffbeb; padding: 25px; border-radius: 16px; border: 1px solid #fcd34d; height: 60vh; }
        textarea { width: 100%; height: 100%; background: transparent; border: none; outline: none; font-family: 'Inter', sans-serif; font-size: 1.1em; line-height: 1.6; color: #4b5563; resize: none; }

        /* ESTADOS DE VISIBILIDAD */
        .hidden { display: none; }
        #loading { text-align: center; padding: 40px; font-weight: 600; color: var(--text-muted); }

    </style>
</head>
<body>

<div class="container">
    
    <div class="header">
        <div class="brand">IDEAS TEXTILES</div>
        <div class="date-badge">‚è≥ <span id="daysLeft">--</span> d√≠as para entrega</div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-number" id="kpiTotal">0</div>
            <div class="kpi-label">Total Prendas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-number" style="color:var(--success)" id="kpiDone">0</div>
            <div class="kpi-label">Entregadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-number" style="color:var(--danger)" id="kpiPending">0</div>
            <div class="kpi-label">Pendientes</div>
        </div>
    </div>

    <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Buscar por cliente, orden o producto..." onkeyup="filterOrders()">
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchView('dashboard', this)">üè≠ Producci√≥n</div>
        <div class="tab" onclick="switchView('notes', this)">üìù Notas</div>
        <div class="tab" onclick="window.location.reload()"><span class="refresh-icon">üîÑ</span></div>
    </div>

    <div id="loading">Conectando con la base de datos...</div>

    <div id="dashboard">
        <div id="ordersContainer"></div>
    </div>

    <div id="notes" class="hidden">
        <div class="notebook">
            <h3 style="margin-bottom:15px; color:#d97706">‚úçÔ∏è Bit√°cora Personal</h3>
            <textarea id="localNotes" placeholder="Escribe aqu√≠ tus apuntes r√°pidos..."></textarea>
        </div>
    </div>

</div>

<script>
    // --- CONEXI√ìN ---
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR709g0cB4EtdROEnIWBrK2O4FQrKHUd3jXNUTWwdWvT1F5UraKHGOr6dDQHsJtgrdv4-ARqow_jKi0/pub?output=csv";
    const PROXY = "https://api.allorigins.win/raw?url=";

    let allOrders = [];

    async function init() {
        try {
            const res = await fetch(PROXY + encodeURIComponent(SHEET_URL) + "&t=" + Date.now());
            const text = await res.text();
            parseData(text);
        } catch (e) {
            document.getElementById('loading').innerHTML = "‚ö†Ô∏è Error de conexi√≥n. Recarga la p√°gina.";
        }
    }

    function parseData(csv) {
        const rows = csv.split('\n').slice(1);
        const temp = {};

        rows.forEach(row => {
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if(cols.length < 6) return;

            const clean = t => t ? t.replace(/"/g, '').trim() : '';
            const id = clean(cols[0]);

            if(!temp[id]) {
                temp[id] = {
                    id, 
                    name: clean(cols[1]), 
                    client: clean(cols[2]), 
                    price: clean(cols[3]),
                    items: []
                };
            }
            temp[id].items.push({
                product: clean(cols[4]),
                size: clean(cols[5]),
                qty: parseInt(cols[6]) || 0,
                status: clean(cols[7]),
                done: parseInt(cols[8]) || 0
            });
        });

        allOrders = Object.values(temp);
        updateKPIs();
        renderOrders(allOrders);
        document.getElementById('loading').style.display = 'none';
        
        // Fecha entrega
        const days = Math.ceil((new Date('2026-02-16') - new Date()) / (86400000));
        document.getElementById('daysLeft').innerText = days;
    }

    function updateKPIs() {
        let t=0, d=0;
        allOrders.forEach(o => o.items.forEach(i => { t+=i.qty; d+=i.done; }));
        document.getElementById('kpiTotal').innerText = t;
        document.getElementById('kpiDone').innerText = d;
        document.getElementById('kpiPending').innerText = t - d;
    }

    function renderOrders(list) {
        const container = document.getElementById('ordersContainer');
        if(list.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#9ca3af; margin-top:30px;">No se encontraron resultados.</div>';
            return;
        }

        container.innerHTML = list.map(o => {
            const total = o.items.reduce((s,i)=>s+i.qty,0);
            const done = o.items.reduce((s,i)=>s+i.done,0);
            const pending = total - done;
            const progress = total===0 ? 0 : Math.round((done/total)*100);
            
            let barColor = 'bg-low';
            if(progress > 40) barColor = 'bg-mid';
            if(progress > 90) barColor = 'bg-high';

            // Mensaje WhatsApp
            const waMsg = `Reporte *${o.name}*: Avance ${progress}%. Entregadas: ${done}/${total}. Pendientes: ${pending}.`;
            
            return `
            <div class="order-card">
                <div class="card-top">
                    <div>
                        <span class="client-tag">${o.client}</span>
                        <div class="order-title">${o.name}</div>
                    </div>
                    <div class="price-tag">${o.price}</div>
                </div>

                <div class="progress-container">
                    <div class="progress-labels">
                        <span>Avance de Entrega</span>
                        <span>${progress}%</span>
                    </div>
                    <div class="bar-track">
                        <div class="bar-fill ${barColor}" style="width:${progress}%"></div>
                    </div>
                    <div style="text-align:right; font-size:0.8em; color:#6b7280; margin-top:5px;">
                        Faltan <b>${pending}</b> prendas
                    </div>
                </div>

                <div class="table-scroll">
                    <table>
                        <thead><tr><th>Producto</th><th>Talla</th><th>Cant</th><th>Estado</th><th>Falta</th></tr></thead>
                        <tbody>
                            ${o.items.map(i => `
                            <tr style="${i.qty===i.done ? 'opacity:0.4' : ''}">
                                <td class="product-name">${i.product}</td>
                                <td><span class="pill pill-gray">${i.size}</span></td>
                                <td>${i.qty}</td>
                                <td><span class="pill pill-status">${i.status}</span></td>
                                <td style="font-weight:bold; color:${(i.qty-i.done)>0?'#ef4444':'#10b981'}">
                                    ${i.qty - i.done}
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <a href="https://wa.me/?text=${encodeURIComponent(waMsg)}" target="_blank" class="btn-wa">
                    <span>üì±</span> Enviar Reporte WA
                </a>
            </div>
            `;
        }).join('');
    }

    function filterOrders() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allOrders.filter(o => {
            const prods = o.items.map(i=>i.product).join(' ').toLowerCase();
            return o.name.toLowerCase().includes(q) || o.client.toLowerCase().includes(q) || prods.includes(q);
        });
        renderOrders(filtered);
    }

    function switchView(view, btn) {
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('notes').classList.add('hidden');
        document.getElementById(view).classList.remove('hidden');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
    }

    // Notas locales
    const noteEl = document.getElementById('localNotes');
    noteEl.value = localStorage.getItem('notes') || '';
    noteEl.addEventListener('input', () => localStorage.setItem('notes', noteEl.value));

    init();
</script>
</body>
</html>
