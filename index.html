<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideas Textiles ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="min-h-screen pb-20 md:pb-0 bg-slate-50">

    <!-- HEADER -->
    <header class="bg-gradient-to-r from-slate-900 to-blue-900 text-white sticky top-0 z-50 shadow-xl">
        <div class="max-w-7xl mx-auto px-4 md:px-8 py-4 md:py-6">
            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-500 rounded-xl">
                        <i data-lucide="package" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-black">IDEAS TEXTILES SPA</h1>
                        <p id="syncStatus" class="text-amber-300 text-xs font-bold">Cargando...</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="generateBackup()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Descargar</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="bg-white border-b shadow-sm sticky top-16 z-40">
        <div class="max-w-7xl mx-auto px-4 md:px-8 flex gap-4 overflow-x-auto">
            <button onclick="switchTab('productos')" class="tab-btn active px-6 py-4 font-bold text-slate-600 border-b-2 border-blue-600 whitespace-nowrap" data-tab="productos">
                <i data-lucide="package" class="w-4 h-4 inline mr-2"></i>Productos
            </button>
            <button onclick="switchTab('ordenes')" class="tab-btn px-6 py-4 font-bold text-slate-600 border-b-2 border-transparent hover:border-slate-300 whitespace-nowrap" data-tab="ordenes">
                <i data-lucide="shopping-cart" class="w-4 h-4 inline mr-2"></i>Órdenes
            </button>
            <button onclick="switchTab('calendario')" class="tab-btn px-6 py-4 font-bold text-slate-600 border-b-2 border-transparent hover:border-slate-300 whitespace-nowrap" data-tab="calendario">
                <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>Calendario
            </button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="max-w-7xl mx-auto px-4 md:px-8 py-8">

        <!-- PRODUCTOS TAB -->
        <section id="productos" class="tab-content active space-y-6">
            <div class="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div>
                    <h2 class="text-2xl font-black text-slate-800">Inventario de Productos</h2>
                    <p class="text-sm text-slate-500">Gestión centralizada de stock</p>
                </div>
                <button onclick="openProductModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2">
                    <i data-lucide="plus" class="w-5 h-5"></i>Nuevo Producto
                </button>
            </div>

            <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="col-span-full text-center py-12 text-slate-400">
                    <i data-lucide="package" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                    <p class="font-bold">Cargando productos...</p>
                </div>
            </div>
        </section>

        <!-- ORDENES TAB -->
        <section id="ordenes" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- NUEVA ORDEN -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200 space-y-6">
                    <h3 class="text-xl font-black text-slate-800">Nueva Orden de Compra</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">Cliente</label>
                            <input id="orderCustomer" type="text" placeholder="Nombre del cliente" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">Dirección</label>
                            <input id="orderAddress" type="text" placeholder="Dirección de despacho" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <label class="block text-sm font-bold text-slate-600 mb-3">Agregar Productos</label>
                        <div id="catalogGrid" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4"></div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h4 class="font-bold text-slate-800 mb-4">Productos en Orden</h4>
                        <div id="cartItems" class="space-y-3"></div>
                    </div>

                    <button onclick="saveOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-5 h-5"></i>Crear Orden
                    </button>
                </div>

                <!-- RESUMEN Y ÓRDENES -->
                <div class="space-y-6">
                    <div class="bg-gradient-to-br from-slate-900 to-blue-900 text-white p-6 rounded-xl shadow-lg sticky top-32">
                        <h4 class="font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="calculator" class="w-5 h-5"></i>Total Orden
                        </h4>
                        <div id="orderTotal" class="text-4xl font-black mb-4">$0</div>
                        <p class="text-sm text-slate-300">Se imprimirán 4 etiquetas por hoja</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="history" class="w-5 h-5"></i>Órdenes Recientes
                        </h4>
                        <div id="recentOrders" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CALENDARIO TAB -->
        <section id="calendario" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <h3 class="text-xl font-black text-slate-800 mb-6">Calendario de Movimientos</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-slate-100 border-b-2 border-slate-300">
                                <th class="px-4 py-3 text-left font-bold text-slate-700">Fecha</th>
                                <th class="px-4 py-3 text-left font-bold text-slate-700">Tipo</th>
                                <th class="px-4 py-3 text-left font-bold text-slate-700">Descripción</th>
                                <th class="px-4 py-3 text-left font-bold text-slate-700">Detalles</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- MODAL PRODUCTO -->
    <div id="productModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-xl w-full max-w-md p-6 my-8">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-black text-slate-800">Nuevo Producto</h3>
                <button onclick="closeModal('productModal')" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="productForm" class="space-y-4">
                <input type="hidden" id="productId">
                
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-1">Nombre del Producto</label>
                    <input id="productName" required type="text" placeholder="Ej: Polera Algodón" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-1">Stock</label>
                        <input id="productStock" required type="number" min="0" placeholder="0" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-1">Precio ($)</label>
                        <input id="productPrice" required type="number" min="0" placeholder="0" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-2">Tallas Disponibles</label>
                    <div id="sizeList" class="space-y-2 mb-3"></div>
                    <button type="button" onclick="addSizeField()" class="text-blue-600 font-bold text-sm flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i>Agregar Talla
                    </button>
                </div>

                <div id="reasonField" class="hidden">
                    <label class="block text-sm font-bold text-slate-600 mb-1">Motivo del Cambio</label>
                    <textarea id="productReason" placeholder="Descripción del cambio de inventario" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" rows="3"></textarea>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">
                    Guardar Producto
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL ORDEN DETALLE -->
    <div id="orderDetailModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-xl w-full max-w-2xl p-6 my-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-slate-800">Detalle de Orden</h3>
                <button onclick="closeModal('orderDetailModal')" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="orderDetailContent" class="space-y-6"></div>

            <div class="flex gap-3 mt-6">
                <button onclick="printOrder()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                    <i data-lucide="printer" class="w-5 h-5"></i>Imprimir
                </button>
                <button onclick="editOrder()" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                    <i data-lucide="edit" class="w-5 h-5"></i>Editar
                </button>
            </div>
        </div>
    </div>

    <!-- PRINT AREA -->
    <div id="printArea" style="display:none;"></div>

    <script type="module">
        // STATE MANAGEMENT
        let state = {
            products: [],
            orders: [],
            events: [],
            cart: [],
            currentOrder: null,
            currentUser: null,
            sizeFields: []
        };

        // FIREBASE CONFIG - USES LOCAL STORAGE AS FALLBACK
        const useLocalStorage = true; // Set to false when Firebase is ready
        const STORAGE_KEYS = {
            products: 'IT_PRODUCTS',
            orders: 'IT_ORDERS',
            events: 'IT_EVENTS'
        };

        // INITIALIZE
        function initApp() {
            document.getElementById('syncStatus').textContent = '✓ Sistema Listo';
            document.getElementById('syncStatus').className = 'text-emerald-300 text-xs font-bold';
            
            loadData();
            renderProducts();
            renderCatalog();
            renderRecentOrders();
            renderCalendar();
            lucide.createIcons();
        }

        // DATA PERSISTENCE
        function saveData(key, data) {
            if (useLocalStorage) {
                localStorage.setItem(key, JSON.stringify(data));
            }
        }

        function loadData() {
            if (useLocalStorage) {
                state.products = JSON.parse(localStorage.getItem(STORAGE_KEYS.products)) || [];
                state.orders = JSON.parse(localStorage.getItem(STORAGE_KEYS.orders)) || [];
                state.events = JSON.parse(localStorage.getItem(STORAGE_KEYS.events)) || [];
            }
        }

        // PRODUCTOS
        window.openProductModal = (id = null) => {
            state.sizeFields = [];
            document.getElementById('productId').value = id || '';
            document.getElementById('reasonField').classList.toggle('hidden', !id);
            
            if (id) {
                const p = state.products.find(x => x.id === id);
                document.getElementById('modalTitle').textContent = 'Editar Producto';
                document.getElementById('productName').value = p.name;
                document.getElementById('productStock').value = p.stock;
                document.getElementById('productPrice').value = p.price;
                state.sizeFields = [...p.sizes];
            } else {
                document.getElementById('modalTitle').textContent = 'Nuevo Producto';
                document.getElementById('productForm').reset();
                state.sizeFields = [''];
            }
            
            renderSizeFields();
            document.getElementById('productModal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.addSizeField = () => {
            state.sizeFields.push('');
            renderSizeFields();
        };

        function renderSizeFields() {
            const container = document.getElementById('sizeList');
            container.innerHTML = state.sizeFields.map((size, i) => `
                <div class="flex gap-2">
                    <input type="text" value="${size}" placeholder="S, M, L, XL, etc" 
                        onchange="state.sizeFields[${i}] = this.value" 
                        class="flex-1 p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <button type="button" onclick="state.sizeFields.splice(${i}, 1); renderSizeFields()" class="px-2 py-2 text-red-600 hover:bg-red-50 rounded">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        document.getElementById('productForm').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value || `PROD-${Date.now()}`;
            const product = {
                id,
                name: document.getElementById('productName').value,
                stock: parseInt(document.getElementById('productStock').value),
                price: parseInt(document.getElementById('productPrice').value),
                sizes: state.sizeFields.filter(s => s.trim())
            };

            const existing = state.products.findIndex(p => p.id === id);
            if (existing >= 0) {
                state.products[existing] = product;
                addEvent('Producto Actualizado', `${product.name} - Stock: ${product.stock}`);
            } else {
                state.products.push(product);
                addEvent('Producto Creado', product.name);
            }

            saveData(STORAGE_KEYS.products, state.products);
            renderProducts();
            renderCatalog();
            closeModal('productModal');
        };

        window.deleteProduct = (id) => {
            if (confirm('¿Eliminar este producto?')) {
                state.products = state.products.filter(p => p.id !== id);
                saveData(STORAGE_KEYS.products, state.products);
                renderProducts();
                renderCatalog();
            }
        };

        function renderProducts() {
            const grid = document.getElementById('productGrid');
            if (state.products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400"><i data-lucide="package" class="w-12 h-12 mx-auto mb-4 opacity-50"></i><p class="font-bold">No hay productos. Crea uno nuevo.</p></div>';
                return;
            }
            grid.innerHTML = state.products.map(p => `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-bold text-slate-500 uppercase">ID: ${p.id}</p>
                            <h4 class="text-lg font-black text-slate-800">${p.name}</h4>
                        </div>
                        <button onclick="openProductModal('${p.id}')" class="p-2 text-slate-400 hover:bg-blue-50 hover:text-blue-600 rounded">
                            <i data-lucide="edit" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-4">
                        ${p.sizes.map(s => `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded">${s}</span>`).join('')}
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                        <div>
                            <p class="text-xs text-slate-500 uppercase font-bold">Stock</p>
                            <p class="text-2xl font-black ${p.stock < 10 ? 'text-red-600' : 'text-slate-800'}">${p.stock}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 uppercase font-bold">Precio</p>
                            <p class="text-xl font-black text-blue-600">$${p.price.toLocaleString()}</p>
                        </div>
                    </div>
                    <button onclick="deleteProduct('${p.id}')" class="w-full mt-4 py-2 text-red-600 hover:bg-red-50 rounded font-bold text-sm flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>Eliminar
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // ÓRDENES
        function renderCatalog() {
            const grid = document.getElementById('catalogGrid');
            grid.innerHTML = state.products.map(p => `
                <button onclick="addToCart('${p.id}')" class="p-3 bg-slate-100 hover:bg-blue-100 border border-slate-300 rounded-lg text-left transition font-bold text-sm">
                    ${p.name} <span class="text-xs text-slate-600">(${p.stock})</span>
                </button>
            `).join('');
            lucide.createIcons();
        }

        window.addToCart = (productId) => {
            const product = state.products.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                alert('Producto sin stock');
                return;
            }

            const item = {
                ...product,
                cartId: `CART-${Date.now()}`,
                selectedSize: product.sizes[0] || 'Único',
                qty: 1
            };
            state.cart.push(item);
            renderCart();
        };

        window.removeFromCart = (cartId) => {
            state.cart = state.cart.filter(i => i.cartId !== cartId);
            renderCart();
        };

        window.updateCartQty = (cartId, qty) => {
            const item = state.cart.find(i => i.cartId === cartId);
            if (item) {
                item.qty = Math.min(parseInt(qty), item.stock);
                renderCart();
            }
        };

        window.updateCartSize = (cartId, size) => {
            const item = state.cart.find(i => i.cartId === cartId);
            if (item) item.selectedSize = size;
            renderCart();
        };

        function renderCart() {
            const container = document.getElementById('cartItems');
            if (state.cart.length === 0) {
                container.innerHTML = '<p class="text-center py-6 text-slate-400 italic">Carrito vacío</p>';
                updateOrderTotal();
                return;
            }
            container.innerHTML = state.cart.map(item => `
                <div class="bg-white p-4 rounded-lg border border-slate-200 flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <p class="font-bold text-slate-800">${item.name}</p>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            ${item.sizes.length > 0 ? `
                                <div>
                                    <label class="text-xs text-slate-600 font-bold block mb-1">Talla</label>
                                    <select onchange="updateCartSize('${item.cartId}', this.value)" class="w-full p-1 border border-slate-300 rounded text-xs">
                                        ${item.sizes.map(s => `<option value="${s}" ${s === item.selectedSize ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            ` : ''}
                            <div>
                                <label class="text-xs text-slate-600 font-bold block mb-1">Cantidad</label>
                                <input type="number" min="1" max="${item.stock}" value="${item.qty}" 
                                    onchange="updateCartQty('${item.cartId}', this.value)" 
                                    class="w-full p-1 border border-slate-300 rounded text-xs">
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-600">$${(item.price * item.qty).toLocaleString()}</p>
                        <button onclick="removeFromCart('${item.cartId}')" class="mt-2 text-red-600 hover:bg-red-50 p-2 rounded">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            updateOrderTotal();
            lucide.createIcons();
        }

        function updateOrderTotal() {
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('orderTotal').textContent = `$${total.toLocaleString()}`;
        }

        window.saveOrder = () => {
            const customer = document.getElementById('orderCustomer').value;
            const address = document.getElementById('orderAddress').value;

            if (!customer || !address || state.cart.length === 0) {
                alert('Completa todos los campos y agrega productos');
                return;
            }

            const order = {
                id: `OC-${Date.now()}`,
                customer,
                address,
                items: state.cart.map(i => ({
                    productId: i.id,
                    name: i.name,
                    size: i.selectedSize,
                    qty: i.qty,
                    price: i.price
                })),
                total: state.cart.reduce((sum, i) => sum + (i.price * i.qty), 0),
                date: new Date().toLocaleDateString('es-CL'),
                status: 'Pendiente'
            };

            state.orders.push(order);
            saveData(STORAGE_KEYS.orders, state.orders);
            addEvent('Orden Creada', `${order.customer} - ${order.items.length} productos`);

            state.cart = [];
            document.getElementById('orderCustomer').value = '';
            document.getElementById('orderAddress').value = '';
            renderCart();
            renderRecentOrders();
            renderCalendar();
            
            printOrderLabels(order);
            alert('Orden creada exitosamente');
        };

        function renderRecentOrders() {
            const container = document.getElementById('recentOrders');
            if (state.orders.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm italic">Sin órdenes</p>';
                return;
            }
            container.innerHTML = state.orders.slice(-10).reverse().map(o => `
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-blue-50 transition" onclick="viewOrderDetail('${o.id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-slate-800 text-sm">${o.customer}</p>
                            <p class="text-xs text-slate-500">${o.id}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-blue-600">$${o.total.toLocaleString()}</p>
                            <p class="text-xs text-slate-500">${o.date}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.viewOrderDetail = (orderId) => {
            const order = state.orders.find(o => o.id === orderId);
            state.currentOrder = order;

            let html = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 p-4 bg-slate-100 rounded-lg">
                        <div>
                            <p class="text-xs text-slate-600 font-bold">ORDEN</p>
                            <p class="text-lg font-black text-slate-800">${order.id}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-600 font-bold">FECHA</p>
                            <p class="text-lg font-black text-slate-800">${order.date}</p>
                        </div>
                        <div>
                            <p class="text-xs text-slate-600 font-bold">CLIENTE</p>
