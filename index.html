<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDEAS TEXTILES WORKWEAR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        /* ESTILOS BASE */
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f1f5f9; }
        .glass-panel { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        
        /* SIDEBAR & NAV */
        .sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-link:hover, .sidebar-link.active { background: #eff6ff; border-left-color: #f59e0b; color: #1e293b; }
        
        /* TABLES */
        .custom-table th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 12px; }
        .custom-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        
        /* LOADING OVERLAY */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); z-index: 9999; 
            display: none; flex-direction: column; justify-content: center; align-items: center; 
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ESTILOS PDF (INVISIBLE PERO RENDERIZABLE) --- */
        #pdf-container {
            position: fixed;
            left: -5000px;
            top: 0;
            width: 210mm;
            min-height: 297mm;
            background: white;
            z-index: -100; /* Detrás de todo */
        }

        /* --- FORMATO 6 POR PÁGINA (Ahorro de Papel) --- */
        .pdf-sheet-6up {
            width: 100%;
            height: 270mm; /* Ajuste para A4 */
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px;
            box-sizing: border-box;
            page-break-after: always;
        }
        .pdf-sheet-6up:last-child { page-break-after: avoid; }

        .tacha-card-6up {
            border: 2px dashed #94a3b8; /* Línea de corte */
            background: #fff;
            padding: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-radius: 6px;
            overflow: hidden;
            height: 100%;
        }

        /* HEADER REPORTES GENERALES (Estilo Viernes) */
        .pdf-pro-header { display: flex; justify-content: space-between; border-bottom: 4px solid #f59e0b; padding-bottom: 10px; margin-bottom: 20px; }
        .pdf-pro-title { font-size: 20px; font-weight: 900; color: #1e293b; }
        .pdf-table-pro { width: 100%; border-collapse: collapse; font-size: 10px; }
        .pdf-table-pro th { background: #1e293b; color: white; padding: 5px; }
        .pdf-table-pro td { border-bottom: 1px solid #ddd; padding: 5px; }

    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="loader">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold text-gray-700" id="loading-text">Procesando...</h2>
        <p class="text-gray-500 text-sm">La IA está trabajando</p>
    </div>

    <div id="pdf-container"></div>

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-10">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">
                WORK<span class="text-amber-500">WEAR</span>
            </h1>
            <p class="text-xs text-slate-400 mt-1">IDEAS TEXTILES</p>
        </div>
        
        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <a onclick="ui.showSection('dashboard')" class="sidebar-link active flex items-center p-3 rounded-lg cursor-pointer">
                <i class="fas fa-chart-pie w-6 text-center"></i> <span class="font-medium">Dashboard</span>
            </a>
            <a onclick="ui.showSection('inventory')" class="sidebar-link flex items-center p-3 rounded-lg cursor-pointer">
                <i class="fas fa-boxes w-6 text-center"></i> <span class="font-medium">Inventario</span>
            </a>
            <a onclick="ui.showSection('orders')" class="sidebar-link flex items-center p-3 rounded-lg cursor-pointer">
                <i class="fas fa-clipboard-list w-6 text-center"></i> <span class="font-medium">Órdenes (OC)</span>
            </a>
            <div class="pt-4 mt-4 border-t border-gray-100">
                <p class="px-3 text-xs font-bold text-gray-400 uppercase">Herramientas</p>
                <a onclick="generateGeneralPDFReport()" class="sidebar-link flex items-center p-3 rounded-lg cursor-pointer text-slate-600 hover:text-amber-600">
                    <i class="fas fa-file-pdf w-6 text-center"></i> <span>Reporte General</span>
                </a>
            </div>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-8 relative">
        
        <section id="dashboard" class="space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Resumen Operativo</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass-panel p-6 border-l-4 border-blue-500">
                    <p class="text-gray-500 text-sm font-bold uppercase">Total Productos</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-2" id="dash-total-items">0</h3>
                </div>
                <div class="glass-panel p-6 border-l-4 border-amber-500">
                    <p class="text-gray-500 text-sm font-bold uppercase">Stock Crítico</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-2" id="dash-low-stock">0</h3>
                </div>
                <div class="glass-panel p-6 border-l-4 border-green-500">
                    <p class="text-gray-500 text-sm font-bold uppercase">Órdenes Activas</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-2" id="dash-active-orders">0</h3>
                </div>
                <div class="glass-panel p-6 border-l-4 border-purple-500">
                    <p class="text-gray-500 text-sm font-bold uppercase">Despachadas (Mes)</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-2" id="dash-shipped">0</h3>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-panel p-6">
                    <h4 class="font-bold text-gray-700 mb-4">Estado de Órdenes</h4>
                    <canvas id="chartOrders"></canvas>
                </div>
                <div class="glass-panel p-6">
                    <h4 class="font-bold text-gray-700 mb-4">Top 5 Productos</h4>
                    <canvas id="chartTopProducts"></canvas>
                </div>
            </div>
        </section>

        <section id="inventory" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800">Inventario Bodega</h2>
                <div class="space-x-2">
                    <button onclick="document.getElementById('fileInv').click()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm transition">
                        <i class="fas fa-robot mr-2"></i>IA Importar (Excel/Foto)
                    </button>
                    <input type="file" id="fileInv" hidden onchange="ai.ingest(this, 'inv')">
                    <button onclick="ui.openModal('itemModal')" class="bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600 shadow-sm transition">
                        <i class="fas fa-plus mr-2"></i>Nuevo Item
                    </button>
                </div>
            </div>
            <div class="glass-panel overflow-hidden">
                <table class="w-full custom-table text-left">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Producto</th>
                            <th>Stock Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body"></tbody>
                </table>
            </div>
        </section>

        <section id="orders" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800">Gestión de Órdenes (OC)</h2>
                <div class="space-x-2">
                    <button onclick="document.getElementById('fileOc').click()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm transition">
                        <i class="fas fa-robot mr-2"></i>IA Leer OC (Excel/Foto)
                    </button>
                    <input type="file" id="fileOc" hidden onchange="ai.ingest(this, 'oc')">
                    
                    <button onclick="ui.printSelectedOrders()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 shadow-sm transition">
                        <i class="fas fa-print mr-2"></i>Imprimir Tachas
                    </button>
                    
                    <button onclick="ui.openModal('orderModal')" class="bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600 shadow-sm transition">
                        <i class="fas fa-plus mr-2"></i>Nueva OC
                    </button>
                </div>
            </div>
            
            <div class="glass-panel overflow-hidden">
                <table class="w-full custom-table text-left">
                    <thead>
                        <tr>
                            <th class="w-10"><input type="checkbox" onchange="ui.selectAll(this)"></th>
                            <th>ID OC</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Items</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6 animate-fade-in-up">
            <h3 class="text-xl font-bold mb-4 text-slate-800">Nuevo Producto</h3>
            <input id="newSku" placeholder="SKU / Código" class="w-full mb-3 p-3 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            <input id="newName" placeholder="Nombre del Producto" class="w-full mb-3 p-3 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            <input id="newStock" type="number" placeholder="Cantidad Inicial" class="w-full mb-4 p-3 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="ui.closeModal('itemModal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button onclick="actions.addItem()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <div id="printOcModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6">
            <h3 class="text-xl font-bold mb-4 text-slate-800"><i class="fas fa-print mr-2"></i>Datos de Despacho</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-bold text-gray-500">TOTAL BULTOS</label>
                    <input id="printBultos" type="text" placeholder="Ej: 3 cajas, 1 bolsa" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">CHOFER / TRANSPORTE</label>
                    <input id="printCarrier" type="text" placeholder="Ej: Juan Pérez / Starken" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">RECIBE (CLIENTE)</label>
                    <input id="printReceiver" type="text" placeholder="Nombre de quien recibe" class="w-full p-2 border rounded">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="ui.closeModal('printOcModal')" class="px-4 py-2 text-gray-500">Cancelar</button>
                <button onclick="executePrintOc()" class="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-900">Generar PDF</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. GESTIÓN DE ESTADO Y BASE DE DATOS
        // ==========================================
        const db = {
            save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            load: (key) => JSON.parse(localStorage.getItem(key)) || []
        };

        let state = {
            inventory: db.load('ww_inventory'),
            orders: db.load('ww_orders')
        };
        let currentPrintList = [];

        // ==========================================
        // 2. IA PIPELINE (VERSION VIERNES + OCR)
        // ==========================================
        class AIPipeline {
            async ingest(input, type) {
                const file = input.files[0];
                if (!file) return;
                
                ui.toggleLoader(true);
                document.getElementById('loading-text').innerText = "IA Analizando Patrones...";

                try {
                    let rawData = [];

                    // RUTA A: EXCEL
                    if (file.name.match(/\.(xlsx|xls)$/i)) {
                        rawData = await this.parseExcel(file);
                    } 
                    // RUTA B: IMAGEN (OCR)
                    else if (file.name.match(/\.(jpg|jpeg|png|bmp)$/i)) {
                        document.getElementById('loading-text').innerText = "IA Leyendo Imagen (OCR)...";
                        const text = await this.performOCR(file);
                        rawData = this.textToMatrix(text);
                    } 
                    else {
                        throw new Error("Formato no soportado. Usa Excel o Fotos.");
                    }

                    // CEREBRO DIFUSO (FUZZY LOGIC)
                    if (type === 'oc') this.processOrdersFuzzy(rawData);
                    else this.processInventoryFuzzy(rawData);

                } catch (e) {
                    alert("⚠️ Error IA: " + e.message);
                    console.error(e);
                } finally {
                    ui.toggleLoader(false);
                    input.value = '';
                }
            }

            // --- LECTORES ---
            parseExcel(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const wb = XLSX.read(e.target.result, {type: 'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(ws, {header: 1}));
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            async performOCR(file) {
                const worker = Tesseract.createWorker();
                await worker.load();
                await worker.loadLanguage('spa');
                await worker.initialize('spa');
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();
                return text;
            }

            textToMatrix(text) {
                return text.split('\n').map(line => line.trim().split(/\s{2,}|\t/));
            }

            // --- HERRAMIENTAS DE DETECCIÓN ---
            detectDate(str) {
                if (!str || typeof str !== 'string') return null;
                const match = str.match(/(\d{1,2}[-/]\d{1,2}[-/]\d{2,4})/);
                return match ? match[0] : null;
            }

            isNumber(val) {
                if (!val) return false;
                const n = String(val).replace(/[^0-9.,]/g, '').replace(',', '.');
                return !isNaN(parseFloat(n)) && isFinite(n);
            }

            cleanNumber(val) {
                return parseInt(String(val).replace(/[^0-9]/g, '')) || 0;
            }

            // --- LÓGICA DE ÓRDENES (FUZZY) ---
            processOrdersFuzzy(rows) {
                let detectedOrders = {};
                let lastId = null;
                let count = 0;

                rows.forEach(row => {
                    if (!Array.isArray(row) || row.length === 0) return;

                    let dateCandidate = null;
                    let qtyCandidate = 0;
                    let textSegments = [];
                    let idCandidate = null;

                    // Escanear fila
                    row.forEach(cell => {
                        let str = String(cell).trim();
                        if (!str) return;

                        if (!dateCandidate) {
                            let d = this.detectDate(str);
                            if (d) { dateCandidate = d; return; }
                        }

                        if (!idCandidate && (str.toUpperCase().includes('OC') || (str.length > 2 && str.length < 10 && /\d/.test(str) && /[a-zA-Z]/.test(str)))) {
                            idCandidate = str.replace(/[:#]/g, '').trim();
                            return;
                        }

                        if (this.isNumber(str)) {
                            let n = this.cleanNumber(str);
                            if (n > 0 && n < 10000) { qtyCandidate = n; return; }
                        }

                        if (str.length > 2) textSegments.push(str);
                    });

                    // Agrupar
                    if (idCandidate) lastId = idCandidate;

                    if (qtyCandidate > 0 && textSegments.length > 0) {
                        if (!lastId) lastId = 'IA-GEN-' + new Date().getDate();

                        if (!detectedOrders[lastId]) {
                            detectedOrders[lastId] = {
                                id: lastId,
                                client: "Cliente Detectado",
                                date: dateCandidate || new Date().toISOString().split('T')[0],
                                status: 'Pendiente',
                                items: [], invoice: '', boxes: ''
                            };
                            count++;
                        }

                        let prodName = textSegments.join(' ');
                        let existingItem = detectedOrders[lastId].items.find(i => i.name === prodName);
                        
                        if (existingItem) {
                            existingItem.quantities['unique'] += qtyCandidate;
                            existingItem.total += qtyCandidate;
                        } else {
                            detectedOrders[lastId].items.push({
                                name: prodName,
                                sku: 'IA-FUZZY',
                                hasSizes: false,
                                quantities: { unique: qtyCandidate },
                                total: qtyCandidate,
                                note: 'Importado IA'
                            });
                        }
                    }
                });

                if (count === 0) return alert("IA: No pude detectar órdenes claras. Revisa el archivo.");
                Object.values(detectedOrders).forEach(o => state.orders.push(o));
                db.save('ww_orders', state.orders);
                ui.renderOrders();
                alert(`✅ IA: ${count} Órdenes procesadas.`);
            }

            // --- LÓGICA INVENTARIO (FUZZY) ---
            processInventoryFuzzy(rows) {
                let count = 0;
                rows.forEach(row => {
                    if (!Array.isArray(row) || row.length === 0) return;
                    let nameParts = [];
                    let stockFound = 0;

                    row.forEach(cell => {
                        let str = String(cell).trim();
                        if(!str) return;
                        if (this.isNumber(str)) {
                            let n = this.cleanNumber(str);
                            if (n >= 0 && n < 50000) stockFound = n;
                        } else {
                            if (!['SKU','STOCK','CANT','NOMBRE','TOTAL','PRECIO'].includes(str.toUpperCase())) {
                                nameParts.push(str);
                            }
                        }
                    });

                    if (nameParts.length > 0 && stockFound > 0) {
                        state.inventory.push({
                            sku: 'IMP-' + Math.floor(Math.random()*10000),
                            name: nameParts.join(' '),
                            hasSizes: false,
                            stockData: { unique: stockFound },
                            total: stockFound
                        });
                        count++;
                    }
                });
                db.save('ww_inventory', state.inventory);
                ui.renderInventory();
                alert(`✅ IA: ${count} Productos ingresados.`);
            }
        }
        const ai = new AIPipeline();

        // ==========================================
        // 3. GENERADORES PDF Y TACHAS
        // ==========================================
        
        // --- TACHAS: 6 POR PÁGINA + BRANDING ---
        async function executePrintOc() {
            ui.toggleLoader(true);
            document.getElementById('loading-text').innerText = "Generando Etiquetas Ideas Textiles...";
            
            let bultosVal = document.getElementById('printBultos').value || "---";
            let choferVal = document.getElementById('printCarrier').value || "---";
            let recibeVal = document.getElementById('printReceiver').value || "---";
            let container = document.getElementById('pdf-container');
            
            // Recolectar Items
            let allItemsToPrint = [];
            currentPrintList.forEach(idx => {
                let order = state.orders[idx];
                order.items.forEach(item => {
                    allItemsToPrint.push({
                        orderId: order.id,
                        client: order.client,
                        product: item.name,
                        sizes: item.hasSizes ? item.quantities : null,
                        total: item.total,
                        note: item.note
                    });
                });
            });

            if (allItemsToPrint.length === 0) {
                ui.toggleLoader(false);
                return alert("No hay ítems seleccionados.");
            }

            // Dividir en grupos de 6
            const chunkArray = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
            let pages = chunkArray(allItemsToPrint, 6);

            // Construir HTML
            let html = `<div style="font-family: Arial, sans-serif;">`;

            pages.forEach((pageItems) => {
                html += `<div class="pdf-sheet-6up">`;
                
                pageItems.forEach(it => {
                    // Tallas
                    let sizeHtml = '';
                    if (it.sizes) {
                        let keys = Object.keys(it.sizes);
                        let fontSize = keys.length > 5 ? '9px' : '10px';
                        sizeHtml = Object.entries(it.sizes)
                            .map(([t, c]) => `<span style="border:1px solid #ccc; padding:1px 3px; margin:1px; border-radius:3px; display:inline-block;"><b>${t}:</b>${c}</span>`)
                            .join(' ');
                        sizeHtml = `<div style="font-size:${fontSize}; line-height:1.2;">${sizeHtml}</div>`;
                    } else {
                        sizeHtml = `<div style="font-weight:bold; font-size:12px;">CANT: ${it.total} UN</div>`;
                    }

                    // Tarjeta
                    html += `
                    <div class="tacha-card-6up" style="position:relative;">
                        <div style="text-align:center; background:#1e293b; color:#fff; padding:4px; font-weight:bold; font-size:12px; border-radius:4px 4px 0 0; margin:-10px -10px 5px -10px;">
                            IDEAS TEXTILES WORKWEAR
                        </div>
                        <div style="border-bottom:1px solid #f59e0b; padding-bottom:2px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:end;">
                            <div style="width:75%;">
                                <div style="font-weight:900; font-size:14px;">OC #${it.orderId}</div>
                                <div style="font-size:10px; color:#475569; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${it.client}</div>
                            </div>
                            <div style="font-size:16px; font-weight:bold; color:#f59e0b;">${it.total}<span style="font-size:10px; color:#000;">un</span></div>
                        </div>
                        <div class="tacha-body" style="flex-grow:1;">
                            <div style="font-weight:bold; font-size:11px; margin-bottom:4px; line-height:1.2;">${it.product}</div>
                            ${sizeHtml}
                            ${it.note ? `<div style="background:#fee2e2; color:#991b1b; font-size:9px; padding:2px; margin-top:2px; border-radius:2px;">⚠️ ${it.note}</div>` : ''}
                        </div>
                        <div class="tacha-footer" style="background:#f1f5f9; padding:4px; border-radius:4px; font-size:9px; margin-top:5px; border:1px solid #cbd5e1;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                                <div><b>BULTOS:</b> ${bultosVal}</div>
                                <div><b>CHOFER:</b> ${choferVal.substring(0,10)}</div>
                            </div>
                            <div style="border-top:1px solid #cbd5e1; margin-top:2px; padding-top:2px; text-align:center;">
                                <b>RECIBE:</b> ${recibeVal}
                            </div>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            });

            html += `</div>`;
            container.innerHTML = html;

            await new Promise(resolve => setTimeout(resolve, 1000)); // Espera Render

            const opt = { 
                margin: 0, 
                filename: `Tachas_Lote_${Date.now()}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            
            await html2pdf().set(opt).from(container).save();
            container.innerHTML = '';
            ui.closeModal('printOcModal');
            ui.toggleLoader(false);
        }

        // --- REPORTE GENERAL PROFESIONAL ---
        async function generateGeneralPDFReport() {
            ui.toggleLoader(true);
            let container = document.getElementById('pdf-container');
            
            let invRows = state.inventory.map(p => `<tr><td>${p.sku}</td><td>${p.name}</td><td>${p.total}</td></tr>`).join('');
            let pendRows = state.orders.filter(o => o.status !== 'Despachado').map(o => `<tr><td>${o.id}</td><td>${o.client}</td><td>${o.date}</td><td>${o.status}</td></tr>`).join('');

            container.innerHTML = `
            <div style="font-family: 'Helvetica', sans-serif; color: #333; padding: 30px;">
                <div class="pdf-pro-header">
                    <div>
                        <div class="pdf-pro-title">IDEAS TEXTILES WORKWEAR</div>
                        <div>Reporte General de Operaciones</div>
                    </div>
                    <div>${new Date().toLocaleDateString()}</div>
                </div>

                <h3 style="background:#1e293b; color:white; padding:5px;">1. INVENTARIO ACTUAL</h3>
                <table class="pdf-table-pro">
                    <thead><tr><th width="20%">SKU</th><th width="60%">PRODUCTO</th><th width="20%">TOTAL</th></tr></thead>
                    <tbody>${invRows || '<tr><td colspan="3">Vacio</td></tr>'}</tbody>
                </table>

                <h3 style="background:#1e293b; color:white; padding:5px; margin-top:20px;">2. ÓRDENES PENDIENTES</h3>
                <table class="pdf-table-pro">
                    <thead><tr><th width="20%">ID</th><th width="40%">CLIENTE</th><th width="20%">FECHA</th><th width="20%">ESTADO</th></tr></thead>
                    <tbody>${pendRows || '<tr><td colspan="4">Al día</td></tr>'}</tbody>
                </table>
            </div>`;

            await new Promise(resolve => setTimeout(resolve, 1000));

            const opt = { margin: 0.5, filename: `Reporte_General.pdf`, image: { type: 'jpeg' }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter' } };
            await html2pdf().set(opt).from(container).save();
            container.innerHTML = '';
            ui.toggleLoader(false);
        }

        // ==========================================
        // 4. INTERFAZ DE USUARIO (UI)
        // ==========================================
        const ui = {
            toggleLoader: (show) => document.getElementById('loader').style.display = show ? 'flex' : 'none',
            showSection: (id) => {
                document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                event.currentTarget.classList.add('active');
                if(id === 'dashboard') this.renderDashboard();
            },
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            
            renderInventory: () => {
                const tbody = document.getElementById('inventory-table-body');
                tbody.innerHTML = state.inventory.map((item, index) => `
                    <tr class="hover:bg-slate-50">
                        <td class="font-mono text-xs font-bold text-slate-500">${item.sku}</td>
                        <td class="font-medium">${item.name}</td>
                        <td><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${item.total}</span></td>
                        <td><button onclick="actions.deleteItem(${index})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `).join('');
                this.renderDashboard();
            },

            renderOrders: () => {
                const tbody = document.getElementById('orders-table-body');
                tbody.innerHTML = state.orders.map((order, index) => `
                    <tr class="hover:bg-slate-50 border-l-4 ${order.status === 'Pendiente' ? 'border-amber-400' : 'border-green-500'}">
                        <td><input type="checkbox" class="order-check" value="${index}"></td>
                        <td class="font-bold">#${order.id}</td>
                        <td>${order.client}</td>
                        <td class="text-xs text-gray-500">${order.date}</td>
                        <td><span class="text-xs bg-gray-200 px-2 py-1 rounded">${order.items.length} items</span></td>
                        <td><span class="${order.status === 'Pendiente' ? 'text-amber-600' : 'text-green-600'} font-bold text-xs uppercase">${order.status}</span></td>
                        <td>
                             <button onclick="actions.deleteOrder(${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                this.renderDashboard();
            },

            selectAll: (source) => document.querySelectorAll('.order-check').forEach(c => c.checked = source.checked),
            
            printSelectedOrders: () => {
                currentPrintList = Array.from(document.querySelectorAll('.order-check:checked')).map(c => parseInt(c.value));
                if (currentPrintList.length === 0) return alert("Selecciona al menos una orden.");
                ui.openModal('printOcModal');
            }
        };

        const renderDashboard = () => {
             document.getElementById('dash-total-items').innerText = state.inventory.length;
             document.getElementById('dash-active-orders').innerText = state.orders.filter(o => o.status === 'Pendiente').length;
             
             // Gráficos simples
             if(window.myChart1) window.myChart1.destroy();
             const ctx1 = document.getElementById('chartOrders').getContext('2d');
             window.myChart1 = new Chart(ctx1, {
                 type: 'doughnut',
                 data: { labels: ['Pendiente', 'Despachado'], datasets: [{ data: [state.orders.filter(o=>o.status==='Pendiente').length, state.orders.filter(o=>o.status==='Despachado').length], backgroundColor: ['#f59e0b', '#10b981'] }] }
             });
        };
        ui.renderDashboard = renderDashboard; // Vincular

        const actions = {
            addItem: () => {
                const sku = document.getElementById('newSku').value;
                const name = document.getElementById('newName').value;
                const qty = parseInt(document.getElementById('newStock').value) || 0;
                if(sku && name) {
                    state.inventory.push({sku, name, total: qty, hasSizes: false, stockData: {unique: qty}});
                    db.save('ww_inventory', state.inventory);
                    ui.renderInventory();
                    ui.closeModal('itemModal');
                }
            },
            deleteItem: (idx) => { if(confirm('¿Borrar?')) { state.inventory.splice(idx, 1); db.save('ww_inventory', state.inventory); ui.renderInventory(); } },
            deleteOrder: (idx) => { if(confirm('¿Borrar OC?')) { state.orders.splice(idx, 1); db.save('ww_orders', state.orders); ui.renderOrders(); } }
        };

        // Inicializar
        ui.renderInventory();
        ui.renderOrders();
        ui.renderDashboard();

    </script>
</body>
</html>
