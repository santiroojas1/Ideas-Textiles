<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEAS TEXTILES </title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --dark: #0f172a; --primary: #3b82f6; --accent: #6366f1;
            --success: #10b981; --danger: #ef4444; --warn: #f59e0b;
            --prod: #8b5cf6; --bg: #f8fafc; --card-bg: #ffffff;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--dark); margin: 0; padding-bottom: 120px; }

        /* HEADER */
        header { background: var(--dark); color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .brand h1 { font-size: 1.1rem; font-weight: 800; margin: 0; display: flex; align-items: center; gap: 8px; }
        /* PUNTO VERDE DE CONEXI√ìN */
        .live-dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .btn-scan { background: linear-gradient(135deg, var(--primary), var(--accent)); border: none; padding: 8px 12px; border-radius: 8px; color: white; font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 6px; cursor: pointer; }

        /* VISTAS */
        .view { display: none; padding: 20px; max-width: 900px; margin: 0 auto; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* CARDS */
        .card { background: var(--card-bg); border-radius: 12px; padding: 16px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; position: relative; }
        
        /* SKU BADGE */
        .sku-badge { font-family: 'JetBrains Mono', monospace; background: var(--dark); color: #fbbf24; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-bottom: 4px; }

        /* ESTADOS (CHIPS) */
        .status { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; }
        .st-bodega { background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; }
        .st-pack { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }
        .st-done { background: #ecfdf5; color: var(--success); border: 1px solid #a7f3d0; }
        .st-prod { background: #f5f3ff; color: var(--prod); border: 1px solid #ddd6fe; }
        .st-nostock { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }

        /* CALENDARIO */
        .cal-ctrl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: var(--dark); color: white; padding: 10px; border-radius: 10px; }
        .cal-ctrl button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .cal-select { background: rgba(255,255,255,0.1); border: none; color: white; font-weight: bold; padding: 5px; border-radius: 4px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-head { text-align: center; font-size: 0.7rem; font-weight: 800; color: #64748b; padding-bottom: 5px; }
        .day { aspect-ratio: 1; background: white; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; cursor: pointer; position: relative; }
        .day:active { background: #f1f5f9; transform: scale(0.95); }
        .day.today { border: 2px solid var(--primary); font-weight: 800; color: var(--primary); }
        .day.has-note::after { content: ''; position: absolute; bottom: 4px; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

        /* BOTONES */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 700; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 5px; transition: 0.2s; }
        .btn-pri { background: var(--dark); color: white; }
        .btn-sec { background: white; border: 1px solid #cbd5e1; color: var(--dark); }
        .btn-pdf { background: var(--danger); color: white; }
        .btn-reset { background: #fee2e2; border: 2px solid #ef4444; color: #ef4444; }

        .dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--dark); padding: 12px 30px; border-radius: 40px; display: flex; gap: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 999; }
        .dock i { font-size: 1.4rem; color: #94a3b8; transition: 0.2s; cursor: pointer; }
        .dock i.active { color: white; transform: translateY(-3px); text-shadow: 0 0 15px var(--primary); }
        .item-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.85rem; }

        /* PANTALLA DE CARGA */
        #loader { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:2000; display:flex; flex-direction:column; justify-content:center; align-items:center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:10px; font-weight:bold; color:#64748b;">CONECTANDO AL SISTEMA...</p>
</div>

<header>
    <div class="brand">
        <h1>IDEAS TEXTILES SPA <div class="live-dot" title="En Vivo"></div></h1>
    </div>
    <button class="btn-scan" onclick="App.IA.trigger()">
        <i class="fa-solid fa-wand-magic-sparkles"></i> IMPORTAR
    </button>
</header>

<section id="v-bodega" class="view active">
    <input type="text" id="search-inv" class="search-bar" style="width:100%; padding:12px; border-radius:10px; border:1px solid #cbd5e1; margin-bottom:15px;" placeholder="üîç Buscar por nombre o SKU..." oninput="App.Render.bodega()">
    <button class="btn btn-pri" onclick="App.Actions.modalProd()">+ AGREGAR PRODUCTO MANUAL</button>
    <br><br>
    <div id="list-bodega"></div>
</section>

<section id="v-ordenes" class="view">
    <h2 style="margin:0 0 15px; font-size:1.2rem;">PEDIDOS ACTIVOS (NUBE)</h2>
    <button class="btn btn-pri" style="background:var(--primary); box-shadow:0 4px 10px rgba(59,130,246,0.3);" onclick="App.Actions.modalOrder()">
        <i class="fa-solid fa-cart-shopping"></i> NUEVO PEDIDO
    </button>
    <br><br>
    <div id="list-ordenes"></div>
</section>

<section id="v-agenda" class="view">
    <div class="cal-ctrl">
        <button onclick="App.Calendar.moveMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
        <div style="text-align:center;">
            <span id="cal-month-name" style="font-weight:800; font-size:1.1rem; display:block;">ENERO</span>
            <select id="cal-year-select" class="cal-select" onchange="App.Calendar.setYear(this.value)">
                <option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option>
                <option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option>
            </select>
        </div>
        <button onclick="App.Calendar.moveMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
    <div class="card">
        <div class="cal-grid">
            <div class="cal-head">LUN</div><div class="cal-head">MAR</div><div class="cal-head">MIE</div>
            <div class="cal-head">JUE</div><div class="cal-head">VIE</div><div class="cal-head">SAB</div><div class="cal-head">DOM</div>
        </div>
        <div id="cal-days" class="cal-grid" style="margin-top:5px;"></div>
    </div>

    <div class="card" style="margin-top:20px; text-align:center; border:2px dashed #cbd5e1;">
        <h3>CONFIGURACI√ìN</h3>
        <button class="btn btn-pdf" onclick="App.Backup.generatePDF()"><i class="fa-solid fa-file-pdf"></i> REPORTE PDF</button>
        
        <div style="margin-top:20px; padding-top:15px; border-top:1px solid #e2e8f0;">
            <h4 style="color:#ef4444; margin:0 0 10px;">ZONA DE PELIGRO</h4>
            <button class="btn btn-reset" onclick="App.Actions.factoryReset()">
                <i class="fa-solid fa-skull"></i> BORRAR TODO (RESET NUBE)
            </button>
            <p style="font-size:0.7rem; color:#ef4444; margin-top:5px;">‚ö†Ô∏è Cuidado: Se borra en todos los celulares.</p>
        </div>
    </div>
</section>

<nav class="dock">
    <i class="fa-solid fa-warehouse active" onclick="App.UI.go('bodega', this)"></i>
    <i class="fa-solid fa-clipboard-list" onclick="App.UI.go('ordenes', this)"></i>
    <i class="fa-solid fa-calendar-days" onclick="App.UI.go('agenda', this)"></i>
</nav>

<input type="file" id="ai-input" hidden accept="image/*,.xlsx,.xls,.csv">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // 1. TUS CREDENCIALES (YA INTEGRADAS)
    const firebaseConfig = {
        apiKey: "AIzaSyBg-Cx9SqZw35TyyMxtpVBEFlwZTjBXBew",
        authDomain: "ideastextilesapp.firebaseapp.com",
        databaseURL: "https://ideastextilesapp-default-rtdb.firebaseio.com",
        projectId: "ideastextilesapp",
        storageBucket: "ideastextilesapp.firebasestorage.app",
        messagingSenderId: "268995530035",
        appId: "1:268995530035:web:1890f45ac761cc81eb0246"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const App = {
        db: { inv: [], ord: [], log: {}, calDate: new Date() },

        init() {
            // ESCUCHA EN TIEMPO REAL
            const dbRef = ref(db, '/');
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    App.db.inv = data.inv || [];
                    App.db.ord = data.ord || [];
                    App.db.log = data.log || {};
                }
                // Ocultar Loader
                const l = document.getElementById('loader');
                if(l) { l.style.opacity=0; setTimeout(()=>l.style.display='none',500); }
                
                App.Render.bodega();
                App.Render.ordenes();
                App.Calendar.render();
            });
        },

        save() {
            // GUARDAR EN LA NUBE
            update(ref(db, '/'), { inv: App.db.inv, ord: App.db.ord, log: App.db.log });
        },

        UI: {
            go(id, el) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.dock i').forEach(i => i.classList.remove('active'));
                document.getElementById('v-'+id).classList.add('active');
                el.classList.add('active');
            }
        },

        Helpers: {
            getNextSKU() {
                if(App.db.inv.length === 0) return '001';
                const max = App.db.inv.reduce((acc, p) => Math.max(acc, parseInt(p.sku || 0)), 0);
                return String(max + 1).padStart(3, '0');
            },
            getStatusLabel(st) {
                switch(st) {
                    case 'bodega': return '<span class="status st-bodega">üì¶ EN BODEGA</span>';
                    case 'prod': return '<span class="status st-prod">üßµ EN CONFECCI√ìN</span>';
                    case 'nostock': return '<span class="status st-nostock">‚ö†Ô∏è SIN STOCK</span>';
                    case 'pack': return '<span class="status st-pack">üéÅ EMPAQUETADO</span>';
                    case 'done': return '<span class="status st-done">üöö DESPACHADO</span>';
                    default: return '<span class="status st-bodega">PENDIENTE</span>';
                }
            }
        },

        Render: {
            bodega() {
                const q = document.getElementById('search-inv').value.toUpperCase();
                const list = App.db.inv.filter(i => i.n.toUpperCase().includes(q) || (i.sku && i.sku.includes(q)));
                document.getElementById('list-bodega').innerHTML = list.map((p, i) => {
                    const sizes = Object.entries(p.s).map(([k,v]) => `<span style="background:#e2e8f0; padding:2px 6px; border-radius:4px; font-size:0.75rem;"><b>${k}:</b>${v}</span>`).join(' ');
                    return `<div class="card"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><span class="sku-badge">SKU: ${p.sku}</span><h3 style="margin:4px 0;">${p.n}</h3><div style="margin-top:5px; display:flex; flex-wrap:wrap; gap:5px;">${sizes}</div></div><i class="fa-solid fa-pen" style="color:var(--primary); cursor:pointer; padding:10px;" onclick="window.App.Actions.modalProd(${App.db.inv.indexOf(p)})"></i></div></div>`;
                }).join('') || '<div style="text-align:center;color:#94a3b8">Sin inventario</div>';
            },
            ordenes() {
                const list = App.db.ord;
                document.getElementById('list-ordenes').innerHTML = list.slice().reverse().map((o, idx) => {
                    const realIdx = list.length - 1 - idx;
                    const itemsHtml = o.items.map(it => `<div class="item-row"><span>${it.p} (T:${it.sz})</span><b>x${it.q}</b></div>`).join('');
                    const actionBtn = o.st!=='done' ? `<button class="btn btn-sec" onclick="window.App.Actions.changeStatus(${realIdx})"><i class="fa-solid fa-arrows-rotate"></i> CAMBIAR ESTADO</button>` : '';
                    return `<div class="card"><div style="display:flex; justify-content:space-between; margin-bottom:5px;">${App.Helpers.getStatusLabel(o.st || 'bodega')}<div><i class="fa-solid fa-pen" style="color:var(--dark); margin-right:10px; cursor:pointer;" onclick="window.App.Actions.modalOrder(${realIdx})"></i><i class="fa-solid fa-trash" style="color:#cbd5e1; cursor:pointer;" onclick="window.App.Actions.delOrd(${realIdx})"></i></div></div><h3 style="margin:0;">${o.c}</h3>${o.fac ? `<small style="color:var(--success); font-weight:bold;">FAC: ${o.fac}</small>` : ''}<div style="background:#f8fafc; padding:8px; border-radius:8px; margin:10px 0; border:1px dashed #cbd5e1;">${itemsHtml}</div>${actionBtn}</div>`;
                }).join('') || '<div style="text-align:center;color:#94a3b8">Sin pedidos</div>';
            }
        },

        Actions: {
            async changeStatus(i) {
                const { value: newSt } = await Swal.fire({
                    title: 'CAMBIAR ESTADO', input: 'select',
                    inputOptions: { 'bodega': 'üì¶ En Bodega', 'prod': 'üßµ En Confecci√≥n', 'nostock': '‚ö†Ô∏è Sin Stock', 'pack': 'üéÅ Empaquetado', 'done': 'üöö Despachado' },
                    showCancelButton: true
                });
                if (newSt) {
                    if (newSt === 'done') this.despachar(i);
                    else { App.db.ord[i].st = newSt; App.save(); }
                }
            },
            async modalProd(i = null) {
                const isNew = i === null;
                const item = isNew ? {n:'', s:{}, sku: App.Helpers.getNextSKU()} : App.db.inv[i];
                const sTxt = Object.entries(item.s).map(([k,v])=>`${k}:${v}`).join(', ');
                const {value} = await Swal.fire({
                    title: isNew ? 'PRODUCTO' : 'EDITAR',
                    html: `<input id="sw-n" class="swal2-input" placeholder="Nombre" value="${item.n}"><input id="sw-s" class="swal2-input" placeholder="Talla:Cant, Talla:Cant" value="${sTxt}">`,
                    preConfirm: () => {
                        const n = document.getElementById('sw-n').value.toUpperCase();
                        const s = {}; document.getElementById('sw-s').value.split(',').forEach(x => { const [k,v]=x.split(':'); if(k&&v) s[k.trim().toUpperCase()]=Number(v); });
                        return {n, s, sku: item.sku};
                    }
                });
                if(value) {
                    if(!isNew) App.db.inv[i]=value; else App.db.inv.push(value);
                    const {value:reason} = await Swal.fire({title: 'MOTIVO', input: 'text'});
                    if(reason) {
                        const d = new Date(); const k = `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`;
                        App.db.log[k] = (App.db.log[k] || '') + `‚öôÔ∏è ${value.n}: ${reason}\n`;
                    }
                    App.save();
                }
            },
            async modalOrder(i = null) {
                let ord = i !== null ? JSON.parse(JSON.stringify(App.db.ord[i])) : {c:'', items:[], st:'bodega'};
                let cart = ord.items;
                const prodOpts = App.db.inv.map(p=>`<option value="${p.n}">`).join('');
                window.delCartItem = (idx) => { cart.splice(idx,1); Swal.getPopup().querySelector('#cart-div').innerHTML = cart.map((x,ix)=>`<div>${x.p} (${x.sz}) x${x.q} <span onclick="window.delCartItem(${ix})" style="color:red;cursor:pointer;">X</span></div>`).join(''); };
                
                await Swal.fire({
                    title: 'PEDIDO', width: 600,
                    html: `
                        <input id="sw-c" class="swal2-input" placeholder="Cliente" value="${ord.c}">
                        <div style="background:#f1f5f9; padding:10px; margin:10px 0;">
                            <input id="sw-p" list="dl" class="swal2-input" placeholder="Producto"><datalist id="dl">${prodOpts}</datalist>
                            <input id="sw-sz" class="swal2-input" placeholder="Talla" style="width:40%"> <input id="sw-q" type="number" class="swal2-input" value="1" style="width:20%">
                            <button type="button" class="btn btn-pri" onclick="const p=document.getElementById('sw-p').value.toUpperCase(), s=document.getElementById('sw-sz').value.toUpperCase(), q=Number(document.getElementById('sw-q').value); if(p&&s&&q>0){ cart.push({p,sz:s,q}); window.delCartItem(-1); document.getElementById('sw-p').value=''; }">+ ADD</button>
                        </div>
                        <div id="cart-div">${cart.map((x,ix)=>`<div>${x.p} (${x.sz}) x${x.q}</div>`).join('')}</div>
                    `,
                    preConfirm: () => { return {c: document.getElementById('sw-c').value.toUpperCase(), items:cart}; }
                }).then(r => {
                    if(r.isConfirmed && r.value.c && r.value.items.length) {
                        ord.c = r.value.c; ord.items = r.value.items;
                        if(i!==null) App.db.ord[i]=ord; else App.db.ord.push(ord);
                        App.save();
                    }
                });
            },
            delOrd(i){ Swal.fire({title:'¬øBorrar?', showCancelButton:true}).then(r=>{if(r.isConfirmed){App.db.ord.splice(i,1); App.save();}}); },
            async despachar(i){
                const {value:f} = await Swal.fire({title:'N¬∞ FACTURA', input:'text'});
                if(f) {
                    const o = App.db.ord[i]; o.st='done'; o.fac=f;
                    o.items.forEach(it => { const p=App.db.inv.find(x=>x.n===it.p); if(p && p.s[it.sz]!==undefined) p.s[it.sz]-=it.q; });
                    App.save();
                }
            },
            async factoryReset() {
                const { isConfirmed } = await Swal.fire({
                    title: '¬øEST√ÅS SEGURO?',
                    text: 'Se borrar√°n TODOS los datos de la Nube. Irreversible.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    confirmButtonText: 'S√ç, BORRAR TODO'
                });
                if (isConfirmed) {
                    set(ref(db, '/'), { inv: [], ord: [], log: {} });
                    Swal.fire('SISTEMA LIMPIO', '', 'success');
                }
            }
        },

        IA: {
            trigger(){ document.getElementById('ai-input').click(); },
            
            // üî• L√ìGICA INTELIGENTE RESTAURADA DE V117 üî•
            detectHeadersAndMap(jsonSheet) {
               let mapping = { prod: 4, size: 5, qty: 6, client: -1 }, headerRowIndex = 0;
               for(let i=0; i<Math.min(jsonSheet.length, 10); i++) {
                   const row = jsonSheet[i]; 
                   let foundP = -1, foundS = -1, foundQ = -1, foundC = -1;
                   
                   row.forEach((cell, idx) => { 
                       if(!cell) return; 
                       const txt = String(cell).toUpperCase(); 
                       // B√∫squeda agresiva de columnas
                       if(txt.includes('PRODUCTO') || txt.includes('DESCRIPCION') || txt.includes('ITEM')) foundP=idx; 
                       if(txt.includes('TALLA') || txt.includes('SIZE') || txt.includes('MEDIDA')) foundS=idx; 
                       if(txt.includes('CANT') || txt.includes('SOLICITADA') || txt.includes('CTD')) foundQ=idx; 
                       if(txt.includes('CLIENTE') || txt.includes('NOMBRE ORDEN') || txt.includes('TIENDA') || txt.includes('ID ORDEN')) foundC=idx; 
                   });

                   if(foundP!==-1 && (foundS!==-1 || foundQ!==-1)){ 
                       mapping = {
                           prod: foundP, 
                           size: foundS!==-1 ? foundS : foundP+1, 
                           qty: foundQ!==-1 ? foundQ : foundP+2, 
                           client: foundC 
                       }; 
                       headerRowIndex = i + 1; 
                       break; 
                   }
               }
               return {mapping, headerRowIndex};
            },

            async process(f) {
                if(!f) return;
                // MODO EXCEL (El m√°s potente)
                if(f.name.match(/\.(xlsx|xls|csv)$/i)) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const wb = XLSX.read(e.target.result, {type:'array'});
                        const js = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                        
                        // Detectar columnas
                        const { mapping, headerRowIndex } = this.detectHeadersAndMap(js);
                        
                        let ordersMap = {}; 
                        let cnt = 0;

                        // Iterar y Agrupar
                        for(let i = headerRowIndex; i < js.length; i++) {
                            const row = js[i];
                            // Si tiene producto y cantidad
                            if(row[mapping.prod] && row[mapping.qty]) {
                                const n = String(row[mapping.prod]).toUpperCase().trim();
                                const sz = row[mapping.size] ? String(row[mapping.size]).toUpperCase().trim() : 'UNICA';
                                const q = parseInt(row[mapping.qty]);
                                
                                // ¬øTiene Cliente?
                                let clientName = null;
                                if(mapping.client !== -1 && row[mapping.client]) {
                                    clientName = String(row[mapping.client]).toUpperCase().trim();
                                }

                                if(n && q > 0) {
                                    // Asegurar producto en inventario
                                    let p = App.db.inv.find(x => x.n === n);
                                    if(!p){ p={n, s:{}, sku: App.Helpers.getNextSKU()}; App.db.inv.push(p); }
                                    
                                    if(clientName) { 
                                        // Es Pedido
                                        if(!ordersMap[clientName]) ordersMap[clientName] = []; 
                                        ordersMap[clientName].push({p:n, sz:sz, q:q}); 
                                    } else { 
                                        // Es Stock directo
                                        p.s[sz] = (p.s[sz]||0) + q; 
                                    }
                                    cnt++;
                                }
                            }
                        }

                        // Crear pedidos agrupados
                        Object.keys(ordersMap).forEach(client => {
                            App.db.ord.push({
                                c: client, 
                                items: ordersMap[client], 
                                st: 'bodega', 
                                fac: null
                            });
                        });

                        App.save(); 
                        Swal.fire('Importado', `${cnt} items procesados.\n(${Object.keys(ordersMap).length} Pedidos nuevos)`, 'success');
                    };
                    reader.readAsArrayBuffer(f);
                } 
                // MODO FOTO (B√°sico)
                else {
                    Swal.fire({title:'Procesando Imagen...', didOpen:()=>{Swal.showLoading()}});
                    try {
                        const {data:{text}} = await Tesseract.recognize(f,'spa');
                        Swal.fire({title:'Texto Detectado', input:'textarea', inputValue:text});
                    } catch(e) { Swal.fire('Error','No se pudo leer la imagen','error'); }
                }
            }
        },

        Backup: {
            generatePDF() {
                const { jsPDF } = window.jspdf; const doc = new jsPDF();
                const now = new Date(); const dateStr = now.toLocaleDateString('es-CL', {day: 'numeric', month: 'long', year: 'numeric'}).toUpperCase();
                
                doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 30, 'F');
                doc.setTextColor(255, 255, 255); doc.setFont("helvetica", "bold"); doc.setFontSize(18);
                doc.text("REPORTE DE IDEAS TEXTILES SPA", 105, 12, { align: "center" });
                doc.setFontSize(10); doc.setFont("helvetica", "normal");
                doc.text(`GENERADO EL: ${dateStr}`, 105, 22, { align: "center" });

                let y = 45;
                // INVENTARIO
                doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.setTextColor(15, 23, 42);
                doc.text("1. INVENTARIO ACTUAL", 14, y); y += 6; doc.line(14, y, 196, y); y += 5;
                const bodyInv = App.db.inv.map(p => [p.sku, p.n, Object.entries(p.s).map(([k, v]) => `${k}:${v}`).join(', ')]);
                doc.autoTable({ startY: y, head: [['SKU', 'PRODUCTO', 'STOCK']], body: bodyInv, theme: 'striped' });
                y = doc.lastAutoTable.finalY + 15;

                // PEDIDOS
                doc.text("2. PEDIDOS EN PROCESO", 14, y); y += 6; doc.line(14, y, 196, y); y += 5;
                const bodyOrd = App.db.ord.filter(o => o.st !== 'done').map(o => [o.c, o.items.map(i => `${i.p} (${i.sz}) x${i.q}`).join('\n'), o.st]);
                if(bodyOrd.length) { doc.autoTable({ startY: y, head: [['CLIENTE', 'ITEMS', 'ESTADO']], body: bodyOrd, theme: 'grid' }); y = doc.lastAutoTable.finalY + 15; }

                doc.save(`REPORTE_${now.getDate()}.pdf`);
            }
        },

        Calendar: {
            moveMonth(dir) { App.db.calDate.setMonth(App.db.calDate.getMonth() + dir); this.render(); },
            setYear(y) { App.db.calDate.setFullYear(parseInt(y)); this.render(); },
            render() {
                const d = App.db.calDate;
                document.getElementById('cal-month-name').innerText = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"][d.getMonth()];
                document.getElementById('cal-year-select').value = d.getFullYear();
                const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                let html = '';
                for(let i=0; i<new Date(d.getFullYear(), d.getMonth(), 1).getDay()-1; i++) html += '<div></div>';
                for(let i=1; i<=daysInMonth; i++) {
                    const k = `${i}-${d.getMonth()}-${d.getFullYear()}`;
                    html += `<div class="day ${App.db.log[k]?'has-note':''}" onclick="window.App.Calendar.openDay('${k}')">${i}</div>`;
                }
                document.getElementById('cal-days').innerHTML = html;
            },
            async openDay(k) {
                const { value } = await Swal.fire({ title: 'NOTA', input: 'textarea', inputValue: App.db.log[k] || '' });
                if (value !== undefined) { App.db.log[k] = value; App.save(); }
            }
        }
    };

    // HACER ACCESIBLE LA APP AL HTML
    window.App = App;
    document.getElementById('ai-input').addEventListener('change', (e) => App.IA.process(e.target.files[0]));
    
    // INICIAR TODO
    App.init();
</script>
</body>
</html>
